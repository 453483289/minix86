<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 425</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:14px;font-family:Times;color:#0860a8;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page425-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a425.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:781px;white-space:nowrap" class="ft00">Vol. 1&#160;D-3</p>
<p style="position:absolute;top:47px;left:500px;white-space:nowrap" class="ft01">GUIDELINES&#160;FOR WRITING X87&#160;FPU EXCEPTION HANDLERS</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft05">The Pentium,&#160;P6&#160;family,&#160;and&#160;Pentium&#160;4 processors offer the&#160;same mechanism&#160;(the NE&#160;bit and&#160;the FERR#&#160;and&#160;<br/>IGNNE#&#160;pins) as&#160;the Intel486&#160;processors for generating&#160;x87&#160;FPU&#160;exceptions&#160;in MS-DOS compatibility mode.&#160;The&#160;<br/>actions of these mechanisms are slightly different and&#160;more straightforward for the&#160;P6&#160;family&#160;and Pentium 4&#160;<br/>processors,&#160;as described in&#160;<a href="o_7281d5ea06a5b67a-429.html">Section&#160;D.2.2, “MS-DOS* Compatibility Sub-mode&#160;in the&#160;P6&#160;Family and Pentium®&#160;4&#160;<br/>Processors.”<br/></a>For&#160;Pentium, P6&#160;family, and Pentium 4&#160;processors, it&#160;is&#160;important to&#160;note that&#160;the special DP&#160;(Dual Processing)&#160;<br/>mode for Pentium processors and&#160;also the&#160;more general Intel&#160;MultiProcessor Specification for systems&#160;with&#160;<br/>multiple Pentium, P6 family, or Pentium 4&#160;processors support x87 FPU exception handling only in the&#160;native&#160;mode.&#160;<br/>Intel does not&#160;recommend using&#160;the MS-DOS compatibility x87&#160;FPU&#160;mode for systems&#160;using more&#160;than&#160;one&#160;<br/>processor.</p>
<p style="position:absolute;top:301px;left:69px;white-space:nowrap" class="ft03">D.2.1.1&#160;&#160;</p>
<p style="position:absolute;top:301px;left:153px;white-space:nowrap" class="ft03">Basic Rules: When FERR# Is Generated</p>
<p style="position:absolute;top:329px;left:69px;white-space:nowrap" class="ft07">When MS-DOS&#160;compatibility mode&#160;is&#160;enabled for the&#160;Intel486&#160;or Pentium processors (NE bit is&#160;set&#160;to&#160;0)&#160;and the&#160;<br/>IGNNE#&#160;input pin&#160;is de-asserted, the&#160;FERR# signal&#160;is generated as&#160;follows:<br/>1.&#160;When&#160;an x87&#160;FPU instruction causes&#160;an unmasked&#160;x87&#160;FPU exception, the&#160;processor&#160;(in most cases) uses&#160;a&#160;</p>
<p style="position:absolute;top:386px;left:95px;white-space:nowrap" class="ft05">“deferred” method&#160;of&#160;reporting the&#160;error.&#160;This means&#160;that&#160;the processor does not&#160;respond&#160;immediately,&#160;but&#160;<br/>rather&#160;freezes just before executing the&#160;next&#160;WAIT&#160;or&#160;x87&#160;FPU&#160;instruction&#160;(except for “no-wait” instructions,&#160;<br/>which the&#160;x87&#160;FPU executes regardless of an error&#160;condition).&#160;</p>
<p style="position:absolute;top:443px;left:69px;white-space:nowrap" class="ft06">2.&#160;When&#160;the&#160;processor freezes, it&#160;also&#160;asserts the&#160;FERR# output.<br/>3.&#160;The frozen processor waits for an&#160;external&#160;interrupt, which must be supplied by external hardware&#160;in&#160;response&#160;</p>
<p style="position:absolute;top:484px;left:95px;white-space:nowrap" class="ft02">to&#160;the FERR# assertion.&#160;</p>
<p style="position:absolute;top:508px;left:69px;white-space:nowrap" class="ft02">4.&#160;In&#160;MS-DOS compatibility systems,&#160;FERR#&#160;is fed to&#160;the IRQ13 input&#160;in the&#160;cascaded PIC. The&#160;PIC generates&#160;</p>
<p style="position:absolute;top:524px;left:94px;white-space:nowrap" class="ft05">interrupt&#160;75H,&#160;which&#160;then branches to interrupt 2, as&#160;described earlier in this&#160;appendix for systems using the&#160;<br/>Intel&#160;286&#160;and&#160;Intel 287&#160;or Intel386&#160;and&#160;Intel&#160;387&#160;processors.&#160;</p>
<p style="position:absolute;top:565px;left:69px;white-space:nowrap" class="ft05">The&#160;deferred method&#160;of&#160;error reporting&#160;is used for all&#160;exceptions caused by the&#160;basic&#160;arithmetic instructions&#160;<br/>(including&#160;FADD, FSUB, FMUL,&#160;FDIV, FSQRT,&#160;FCOM and FUCOM),&#160;for precision exceptions caused by all&#160;types of x87&#160;<br/>FPU&#160;instructions, and for numeric underflow and&#160;overflow&#160;exceptions&#160;caused by&#160;all types of x87&#160;FPU&#160;instructions&#160;<br/>except stores&#160;to memory.&#160;<br/>Some&#160;x87 FPU&#160;instructions&#160;with&#160;some x87&#160;FPU&#160;exceptions&#160;use an “immediate”&#160;method&#160;of reporting errors. Here,&#160;<br/>the FERR# is&#160;asserted immediately,&#160;at the&#160;time that&#160;the&#160;exception occurs.&#160;The&#160;immediate&#160;method of&#160;error&#160;<br/>reporting is&#160;used&#160;for&#160;x87&#160;FPU stack fault, invalid operation&#160;and denormal&#160;exceptions caused by all&#160;transcendental&#160;<br/>instructions, FSCALE, FXTRACT,&#160;FPREM and others, and all&#160;exceptions&#160;(except precision)&#160;when caused&#160;by&#160;x87 FPU&#160;<br/>store instructions. Like&#160;deferred error&#160;reporting, immediate error&#160;reporting&#160;will&#160;cause&#160;the processor to&#160;freeze&#160;just&#160;<br/>before executing the&#160;next WAIT&#160;or x87&#160;FPU instruction&#160;if&#160;the&#160;error condition&#160;has not been cleared&#160;by that time.<br/>Note&#160;that&#160;in&#160;general,&#160;whether&#160;deferred&#160;or&#160;immediate&#160;error reporting is used for an x87 FPU&#160;exception depends both&#160;<br/>on which exception&#160;occurred and&#160;which instruction caused that exception. A&#160;complete&#160;specification of these&#160;cases,&#160;<br/>which applies to both the Pentium and the Intel486&#160;processors, is given in Section 5.1.21 in the&#160;<i>Pentium Processor&#160;<br/>Family Developer’s Manual:&#160;Volume&#160;1</i>.&#160;<br/>If NE&#160;=&#160;0 but&#160;the IGNNE# input&#160;is active&#160;while&#160;an unmasked&#160;x87 FPU exception is&#160;in effect,&#160;the&#160;processor&#160;disre-<br/>gards&#160;the exception, does&#160;not assert&#160;FERR#, and&#160;continues.&#160;If IGNNE# is&#160;then&#160;de-asserted&#160;and&#160;the x87&#160;FPU excep-<br/>tion has not&#160;been&#160;cleared,&#160;the processor will respond&#160;as&#160;described&#160;above. (That is, an immediate exception&#160;case&#160;<br/>will assert FERR# immediately.&#160;A&#160;deferred&#160;exception case&#160;will assert FERR# and&#160;freeze&#160;just&#160;before the&#160;next x87&#160;<br/>FPU&#160;or WAIT instruction.)&#160;The assertion of&#160;IGNNE# is&#160;intended&#160;for&#160;use only&#160;inside&#160;the x87&#160;FPU exception&#160;handler,&#160;<br/>where&#160;it&#160;is needed&#160;if one&#160;wants to execute&#160;non-control&#160;x87&#160;FPU&#160;instructions&#160;for&#160;diagnosis, before&#160;clearing&#160;the&#160;<br/>exception&#160;condition.&#160;When IGNNE# is&#160;asserted&#160;inside the exception handler,&#160;a&#160;preceding&#160;x87 FPU exception has&#160;<br/>already caused FERR# to&#160;be asserted, and the external&#160;interrupt hardware has responded, but IGNNE# assertion&#160;<br/>still prevents&#160;the freeze at&#160;x87&#160;FPU instructions. Note that&#160;if IGNNE# is&#160;left&#160;active&#160;outside&#160;of the&#160;x87&#160;FPU&#160;exception&#160;<br/>handler,&#160;additional x87 FPU&#160;instructions&#160;may be executed&#160;after a&#160;given instruction has caused an&#160;x87 FPU&#160;excep-<br/>tion. In this&#160;case, if the&#160;x87&#160;FPU exception&#160;handler ever&#160;did get invoked,&#160;it could&#160;not determine which instruction&#160;<br/>caused the&#160;exception.&#160;<br/>To&#160;properly manage&#160;the&#160;interface between the&#160;processor’s FERR# output, its&#160;IGNNE#&#160;input,&#160;and the&#160;IRQ13 input&#160;<br/>of&#160;the PIC, additional external&#160;hardware is&#160;needed. A recommended configuration&#160;is described in&#160;the following&#160;<br/>section.</p>
</div>
</body>
</html>
