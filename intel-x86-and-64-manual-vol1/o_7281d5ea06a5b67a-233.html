<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 233</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:16px;font-family:Times;color:#0860a8;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page233-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a233.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:782px;white-space:nowrap" class="ft00">Vol. 1&#160;9-9</p>
<p style="position:absolute;top:47px;left:554px;white-space:nowrap" class="ft01">PROGRAMMING WITH INTEL® MMX™&#160;TECHNOLOGY</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft05"><a href="o_7281d5ea06a5b67a-233.html">Example&#160;9-1</a>&#160;illustrates how&#160;to use&#160;the CPUID instruction to detect&#160;the MMX technology. This&#160;example does not&#160;<br/>represent&#160;the entire CPUID&#160;sequence,&#160;but shows the&#160;portion used&#160;for detection of MMX technology.</p>
<p style="position:absolute;top:158px;left:69px;white-space:nowrap" class="ft01">Example&#160;9-1.&#160;&#160;Partial&#160;Routine for&#160;Detecting&#160;MMX&#160;Technology&#160;with&#160;the&#160;CPUID Instruction</p>
<p style="position:absolute;top:182px;left:69px;white-space:nowrap" class="ft02">...</p>
<p style="position:absolute;top:182px;left:251px;white-space:nowrap" class="ft02">;&#160;identify&#160;existence of&#160;CPUID instruction</p>
<p style="position:absolute;top:200px;left:69px;white-space:nowrap" class="ft02">...</p>
<p style="position:absolute;top:200px;left:251px;white-space:nowrap" class="ft02">;&#160;identify&#160;Intel processor</p>
<p style="position:absolute;top:218px;left:69px;white-space:nowrap" class="ft02">mov</p>
<p style="position:absolute;top:218px;left:116px;white-space:nowrap" class="ft02">EAX, 1</p>
<p style="position:absolute;top:218px;left:251px;white-space:nowrap" class="ft02">;&#160;request for&#160;feature&#160;flags</p>
<p style="position:absolute;top:236px;left:69px;white-space:nowrap" class="ft02">CPUID</p>
<p style="position:absolute;top:236px;left:251px;white-space:nowrap" class="ft02">;&#160;0FH,&#160;0A2H&#160;CPUID instruction</p>
<p style="position:absolute;top:254px;left:69px;white-space:nowrap" class="ft02">test</p>
<p style="position:absolute;top:254px;left:116px;white-space:nowrap" class="ft02">EDX, 00800000H</p>
<p style="position:absolute;top:254px;left:251px;white-space:nowrap" class="ft02">; Is&#160;IA MMX technology&#160;bit (Bit 23&#160;of&#160;EDX) set?</p>
<p style="position:absolute;top:272px;left:69px;white-space:nowrap" class="ft02">jnz</p>
<p style="position:absolute;top:272px;left:224px;white-space:nowrap" class="ft02">;&#160;MMX_Technology_Found</p>
<p style="position:absolute;top:323px;left:69px;white-space:nowrap" class="ft03">9.6.2&#160;</p>
<p style="position:absolute;top:323px;left:150px;white-space:nowrap" class="ft03">Transitions Between x87 FPU and MMX Code</p>
<p style="position:absolute;top:353px;left:69px;white-space:nowrap" class="ft05">Applications can&#160;contain&#160;both x87 FPU&#160;floating-point and&#160;MMX instructions. However,&#160;because&#160;the MMX registers&#160;<br/>are&#160;aliased&#160;to the&#160;x87 FPU register stack,&#160;care&#160;must&#160;be&#160;taken&#160;when&#160;making&#160;transitions between x87 FPU&#160;instruc-<br/>tions and&#160;MMX instructions to&#160;prevent incoherent&#160;or unexpected results.<br/>When an&#160;MMX instruction&#160;(other&#160;than the&#160;EMMS instruction) is&#160;executed,&#160;the processor changes the&#160;x87&#160;FPU state&#160;<br/>as follows:</p>
<p style="position:absolute;top:448px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:449px;left:95px;white-space:nowrap" class="ft02">The&#160;TOS (top&#160;of stack)&#160;value&#160;of the&#160;x87 FPU&#160;status word is&#160;set&#160;to 0.</p>
<p style="position:absolute;top:471px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:472px;left:95px;white-space:nowrap" class="ft02">The&#160;entire&#160;x87 FPU tag&#160;word&#160;is&#160;set to&#160;the valid&#160;state&#160;(00B&#160;in&#160;all tag fields).&#160;</p>
<p style="position:absolute;top:493px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:494px;left:95px;white-space:nowrap" class="ft05">When an&#160;MMX instruction writes to&#160;an&#160;MMX register,&#160;it writes&#160;ones (11B) to the&#160;exponent&#160;part of&#160;the&#160;corre-<br/>sponding&#160;floating-point&#160;register (bits 64 through 79).</p>
<p style="position:absolute;top:535px;left:69px;white-space:nowrap" class="ft05">The net&#160;result of&#160;these actions is that any&#160;x87 FPU state prior to the execution&#160;of&#160;the&#160;MMX instruction&#160;is essentially&#160;<br/>lost.<br/>When&#160;an x87&#160;FPU instruction is&#160;executed,&#160;the processor assumes&#160;that the&#160;current state&#160;of the&#160;x87 FPU&#160;register&#160;<br/>stack and&#160;control&#160;registers is&#160;valid and executes&#160;the&#160;instruction&#160;without any&#160;preparatory modifications to&#160;the x87&#160;<br/>FPU state.<br/>If&#160;the application contains&#160;both&#160;x87&#160;FPU&#160;floating-point&#160;and&#160;MMX instructions, the&#160;following guidelines&#160;are&#160;recom-<br/>mended:</p>
<p style="position:absolute;top:670px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:671px;left:95px;white-space:nowrap" class="ft05">When&#160;transitioning between x87 FPU&#160;and MMX&#160;code, save&#160;the state of any&#160;x87&#160;FPU data&#160;or control&#160;registers&#160;<br/>that need&#160;to be&#160;preserved for future use.&#160;The FSAVE&#160;and&#160;FXSAVE instructions save the&#160;entire&#160;x87 FPU state.</p>
<p style="position:absolute;top:709px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:710px;left:95px;white-space:nowrap" class="ft06">When&#160;transitioning between MMX&#160;and&#160;x87 FPU&#160;code,&#160;do&#160;the&#160;following:<br/>—&#160;Save&#160;any data&#160;in the&#160;MMX registers&#160;that&#160;needs&#160;to be&#160;preserved for future use. FSAVE and&#160;FXSAVE also save&#160;</p>
<p style="position:absolute;top:751px;left:120px;white-space:nowrap" class="ft02">the&#160;state&#160;of MMX&#160;registers.</p>
<p style="position:absolute;top:775px;left:95px;white-space:nowrap" class="ft02">—&#160;Execute the&#160;EMMS instruction to&#160;clear the&#160;MMX&#160;state from the&#160;x87&#160;data and&#160;control registers.</p>
<p style="position:absolute;top:799px;left:69px;white-space:nowrap" class="ft05">The&#160;following sections describe&#160;the use&#160;of the&#160;EMMS&#160;instruction&#160;and give&#160;additional&#160;guidelines for mixing x87&#160;FPU&#160;<br/>and MMX code.</p>
<p style="position:absolute;top:866px;left:69px;white-space:nowrap" class="ft03">9.6.3&#160;</p>
<p style="position:absolute;top:866px;left:149px;white-space:nowrap" class="ft03">Using the EMMS Instruction</p>
<p style="position:absolute;top:896px;left:69px;white-space:nowrap" class="ft06">As&#160;described&#160;<a href="o_7281d5ea06a5b67a-233.html">in Section 9.6.2, “Transitions&#160;Between x87 FPU&#160;and MMX&#160;Code,”</a>&#160;when&#160;an MMX instruction executes,&#160;<br/>the x87&#160;FPU&#160;tag word&#160;is marked&#160;valid&#160;(00B).&#160;In this&#160;state,&#160;the&#160;execution of subsequent&#160;x87 FPU&#160;instructions&#160;may&#160;<br/>produce unexpected x87 FPU&#160;floating-point&#160;exceptions and/or&#160;incorrect results&#160;because&#160;the x87&#160;FPU&#160;register&#160;stack&#160;<br/>appears&#160;to contain&#160;valid&#160;data. The EMMS instruction is&#160;provided&#160;to prevent this&#160;problem&#160;by marking&#160;the&#160;x87 FPU&#160;<br/>tag word as&#160;empty.<br/>The EMMS instruction should&#160;be&#160;used&#160;in&#160;each of the&#160;following&#160;cases:&#160;</p>
<p style="position:absolute;top:1008px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:1009px;left:95px;white-space:nowrap" class="ft05">When&#160;an application using&#160;the&#160;x87&#160;FPU instructions&#160;calls an MMX technology library/DLL&#160;(use&#160;the&#160;EMMS&#160;<br/>instruction at&#160;the&#160;end of the&#160;MMX code).</p>
</div>
</body>
</html>
