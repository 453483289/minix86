<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 320</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:18px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#0860a8;}
	.ft06{font-size:8px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft011{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
	.ft012{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page320-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a320.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">13-14&#160;Vol. 1</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">MANAGING STATE&#160;USING THE XSAVE FEATURE SET</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:100px;left:93px;white-space:nowrap" class="ft03"><b>PT state.</b>&#160;PT state is&#160;in its&#160;initial configuration&#160;if each&#160;of&#160;the 9&#160;MSRs is&#160;0.</p>
<p style="position:absolute;top:122px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:123px;left:93px;white-space:nowrap" class="ft03"><b>PKRU&#160;state.</b>&#160;PKRU state&#160;is&#160;in&#160;its initial&#160;configuration if the&#160;value of the&#160;PKRU is&#160;0.</p>
<p style="position:absolute;top:178px;left:68px;white-space:nowrap" class="ft05">13.7&#160;</p>
<p style="position:absolute;top:178px;left:147px;white-space:nowrap" class="ft05">OPERATION OF&#160;XSAVE</p>
<p style="position:absolute;top:214px;left:68px;white-space:nowrap" class="ft010">The&#160;XSAVE&#160;instruction takes&#160;a single memory operand, which&#160;is an&#160;XSAVE area.&#160;In&#160;addition,&#160;the&#160;register&#160;pair&#160;<br/>EDX:EAX&#160;is an implicit operand&#160;used&#160;as a&#160;state-componen<a href="o_7281d5ea06a5b67a-307.html">t bitmap (see Section 13.1) called the&#160;</a><b>instruction&#160;<br/>mask</b>.&#160;The&#160;logical-AND&#160;of XCR0&#160;and&#160;the instruction mask is&#160;the&#160;<b>requested-feature bitmap</b>&#160;(<b>RFBM</b>) of the&#160;user&#160;<br/>state components&#160;to be saved.<br/>The&#160;following&#160;conditions&#160;cause&#160;execution of the&#160;XSAVE instruction to&#160;generate a&#160;fault:</p>
<p style="position:absolute;top:310px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:310px;left:93px;white-space:nowrap" class="ft04">If the XSAVE feature&#160;set&#160;is not enabled (CR4.OSXSAVE&#160;=&#160;0), an invalid-opcode exception&#160;(#UD)&#160;occurs.</p>
<p style="position:absolute;top:332px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:333px;left:93px;white-space:nowrap" class="ft04">If&#160;CR0.TS[bit&#160;3] is&#160;1,&#160;a device-not-available exception (#NM)&#160;occurs.</p>
<p style="position:absolute;top:355px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:355px;left:93px;white-space:nowrap" class="ft04">If the address of&#160;the XSAVE area is&#160;not&#160;64-byte&#160;aligned,&#160;a general-protection exception&#160;(#GP)&#160;occurs.</p>
<p style="position:absolute;top:353px;left:780px;white-space:nowrap" class="ft06">1</p>
<p style="position:absolute;top:379px;left:68px;white-space:nowrap" class="ft08">If none of these conditions&#160;cause a&#160;fault, execution of&#160;XSAVE&#160;reads&#160;the XSTATE_BV field of the&#160;XSAVE header (see&#160;<br/><a href="o_7281d5ea06a5b67a-313.html">Section&#160;13.4.2) a</a>nd&#160;writes it&#160;back&#160;to&#160;memory,&#160;setting XSTATE_BV[<i>i</i>] (0&#160;≤&#160;<i>i</i>&#160;≤&#160;63)&#160;as&#160;follows:</p>
<p style="position:absolute;top:418px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:418px;left:93px;white-space:nowrap" class="ft04">If RFBM[<i>i</i>]&#160;=&#160;&#160;0,&#160;&#160;XSTATE_BV[<i>i</i>] is&#160;not changed.</p>
<p style="position:absolute;top:440px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:441px;left:93px;white-space:nowrap" class="ft010">If RFBM[<i>i</i>]&#160;=&#160;&#160;1,&#160;&#160;XSTATE_BV[<i>i</i>]&#160;is set to&#160;the value of&#160;XINUSE[<i>i</i><a href="o_7281d5ea06a5b67a-318.html">]. Section 13.6&#160;</a>defines&#160;XINUSE&#160;to describe&#160;the&#160;<br/>processor init&#160;optimization&#160;and specifies the&#160;initial&#160;configuration&#160;of each&#160;state component. The&#160;nature&#160;of&#160;that&#160;<br/>optimization implies the&#160;following:<br/>—&#160;If state component&#160;<i>i</i>&#160;is in its initial configuration,&#160;XINUSE[<i>i</i>] may be&#160;either&#160;0 or 1,&#160;and XSTATE_BV[<i>i</i>] may be&#160;</p>
<p style="position:absolute;top:514px;left:119px;white-space:nowrap" class="ft08">written&#160;with&#160;either 0 or 1.<br/>XINUSE[1] pertains only to&#160;the state of the XMM&#160;registers&#160;and not&#160;to MXCSR.&#160;Thus,&#160;XSTATE_BV[1]&#160;may&#160;be&#160;<br/>written with 0&#160;even&#160;if MXCSR&#160;does&#160;not have&#160;its RESET value of&#160;1F80H.</p>
<p style="position:absolute;top:579px;left:93px;white-space:nowrap" class="ft08">—&#160;If state component&#160;<i>i</i>&#160;is&#160;not in its&#160;initial configuration, XINUSE[<i>i</i>]&#160;=&#160;&#160;1&#160;&#160;and&#160;&#160;XSTATE_BV[<i>i</i>] is&#160;written with 1.<br/>(As explaine<a href="o_7281d5ea06a5b67a-318.html">d in Section 13.6,&#160;</a>the&#160;initial configurations&#160;of&#160;some&#160;state&#160;components may&#160;depend on whether the&#160;<br/>processor is&#160;in 64-bit mode.)</p>
<p style="position:absolute;top:642px;left:68px;white-space:nowrap" class="ft08">The XSAVE&#160;instruction does not write any&#160;part of the&#160;XSAVE&#160;header&#160;other than the XSTATE_BV&#160;field;&#160;in particular,&#160;<br/>it does&#160;<b>not</b>&#160;write to the XCOMP_BV&#160;field.<br/>Execution&#160;of XSAVE saves into the XSAVE area those state components corresponding to bits that are&#160;set in RFBM.&#160;<br/>State&#160;components&#160;0 and&#160;1&#160;are located in&#160;the legacy region&#160;of&#160;the XSAVE&#160;<a href="o_7281d5ea06a5b67a-312.html">area (see Section 13.4.1). Each&#160;</a>state&#160;<br/>component&#160;<i>i</i>, 2&#160;≤&#160;<i>i</i>&#160;≤&#160;62,&#160;is located in the extended&#160;region; the XSAVE&#160;instruction always uses the standard format&#160;</p>
<p style="position:absolute;top:732px;left:68px;white-space:nowrap" class="ft08">for the&#160;extended regi<a href="o_7281d5ea06a5b67a-314.html">on (see Section 13.4.3).<br/></a>The&#160;MXCSR register&#160;and MXCSR_MASK&#160;are part of SSE&#160;st<a href="o_7281d5ea06a5b67a-315.html">ate (see Section 13.5.2)</a>&#160;and are thus associated&#160;with&#160;<br/>RFBM[1]. However,&#160;the XSAVE&#160;instruction&#160;also saves these&#160;values when&#160;RFBM[2]&#160;=&#160;1&#160;(even if RFBM[1]&#160;=&#160;0).<br/>Se<a href="o_7281d5ea06a5b67a-314.html">e Section 13.5</a>&#160;for specifics for each state&#160;component&#160;and for details&#160;regarding mode-specific operation&#160;and&#160;<br/>operation determined&#160;by instruction prefixes.&#160;<a href="o_7281d5ea06a5b67a-327.html">See Section 13.13 for detai</a>ls&#160;regarding faults caused by memory&#160;<br/>accesses.</p>
<p style="position:absolute;top:885px;left:68px;white-space:nowrap" class="ft05">13.8&#160;</p>
<p style="position:absolute;top:885px;left:147px;white-space:nowrap" class="ft05">OPERATION OF&#160;XRSTOR</p>
<p style="position:absolute;top:921px;left:68px;white-space:nowrap" class="ft012">The&#160;XRSTOR&#160;instruction takes a&#160;single&#160;memory operand, which is&#160;an&#160;XSAVE area. In&#160;addition, the&#160;register&#160;pair&#160;<br/>EDX:EAX&#160;is an implicit operand&#160;used&#160;as a&#160;state-componen<a href="o_7281d5ea06a5b67a-307.html">t bitmap (see Section 13.1) called the&#160;</a><b>instruction&#160;<br/>mask</b>.&#160;The&#160;logical-AND&#160;of XCR0&#160;and&#160;the instruction mask is&#160;the&#160;<b>requested-feature bitmap</b>&#160;(<b>RFBM</b>) of the&#160;user&#160;<br/>state components&#160;to be restored.<br/>The&#160;following&#160;conditions&#160;cause&#160;execution of the&#160;XRSTOR instruction to&#160;generate a&#160;fault:</p>
<p style="position:absolute;top:1016px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:1017px;left:93px;white-space:nowrap" class="ft04">If the XSAVE feature&#160;set&#160;is not enabled (CR4.OSXSAVE&#160;=&#160;0), an invalid-opcode exception&#160;(#UD)&#160;occurs.</p>
<p style="position:absolute;top:1054px;left:68px;white-space:nowrap" class="ft04">1.&#160;If&#160;CR0.AM&#160;= 1, CPL&#160;=&#160;3, and EFLAGS.AC&#160;=1, an&#160;alignment-check exception (#AC) may occur instead of&#160;#GP.</p>
</div>
</body>
</html>
