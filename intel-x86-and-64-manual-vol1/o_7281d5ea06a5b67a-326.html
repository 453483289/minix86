<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 326</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:18px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#0860a8;}
	.ft06{font-size:11px;font-family:Times;color:#000000;}
	.ft07{font-size:8px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft011{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft012{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft013{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
	.ft014{font-size:11px;line-height:20px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page326-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a326.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">13-20&#160;Vol. 1</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">MANAGING STATE&#160;USING THE XSAVE FEATURE SET</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:100px;left:93px;white-space:nowrap" class="ft03"><i>w&#160;</i>= CPL;</p>
<p style="position:absolute;top:122px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:123px;left:93px;white-space:nowrap" class="ft03"><i>x&#160;</i>=&#160;1 if&#160;and only if the&#160;logical&#160;processor&#160;is in&#160;VMX non-root operation;</p>
<p style="position:absolute;top:145px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:145px;left:93px;white-space:nowrap" class="ft03"><i>y</i>&#160;is&#160;the linear&#160;address of the&#160;XSAVE area&#160;being used&#160;by XSAVEOPT;&#160;and</p>
<p style="position:absolute;top:167px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:168px;left:93px;white-space:nowrap" class="ft09"><i>z</i>[63]&#160;is 1&#160;and&#160;<i>z</i>[62:0]&#160;= RFBM[62:0].&#160;(This last&#160;item&#160;implies that&#160;XSAVES does not&#160;use the&#160;modified&#160;optimi-<br/>zation if the&#160;last&#160;execution of XRSTOR&#160;used&#160;the&#160;standard form&#160;and followed&#160;the last&#160;execution of&#160;XRSTORS.)</p>
<p style="position:absolute;top:208px;left:68px;white-space:nowrap" class="ft09">If XSAVES&#160;uses the modified&#160;optimization and&#160;XMODIFIED[<i>i</i>]&#160;=&#160;<a href="o_7281d5ea06a5b67a-318.html">0 (see Section 13.6),</a>&#160;state&#160;component&#160;<i>i</i>&#160;is&#160;not&#160;<br/>saved to&#160;the XSAVE area.</p>
<p style="position:absolute;top:280px;left:68px;white-space:nowrap" class="ft05">13.12&#160;&#160;OPERATION OF&#160;XRSTORS</p>
<p style="position:absolute;top:316px;left:68px;white-space:nowrap" class="ft012">The&#160;operation&#160;of XRSTORS is&#160;similar to&#160;that of XRSTOR.&#160;Three main differences are (1)&#160;XRSTORS can&#160;be&#160;executed&#160;<br/>only if CPL&#160;=&#160;0; (2)&#160;XRSTORS can operate on the state components whose bits&#160;are set in XCR0&#160;| IA32_XSS&#160;and can&#160;<br/>thus operate&#160;on&#160;supervisor state components;&#160;and (3)&#160;XRSTORS has only a&#160;compacted form&#160;(no standard form;&#160;<br/><a href="o_7281d5ea06a5b67a-320.html">see Section 13.8).</a>&#160;S<a href="o_7281d5ea06a5b67a-308.html">ee Section 13.2 for details of&#160;</a>how&#160;to determine whether&#160;XRSTORS is&#160;supported.<br/>The&#160;XRSTORS instruction takes a&#160;single&#160;memory&#160;operand,&#160;which is&#160;an XSAVE&#160;area.&#160;In addition,&#160;the register&#160;pair&#160;<br/>EDX:EAX&#160;is an implicit operand&#160;used&#160;as a&#160;state-componen<a href="o_7281d5ea06a5b67a-307.html">t bitmap (see Section 13.1) called the&#160;</a><b>instruction&#160;<br/>mask</b>. EDX:EAX&#160;&amp;&#160;(XCR0&#160;|&#160;IA32_XSS)&#160;(the logical AND&#160;the instruction&#160;mask with the&#160;logical&#160;OR of XCR0 and&#160;<br/>IA32_XSS) is&#160;the&#160;<b>requested-feature bitmap</b>&#160;(<b>RFBM</b>)&#160;of the&#160;state components&#160;to be restored.<br/>The&#160;following&#160;conditions&#160;cause&#160;execution of the&#160;XRSTOR instruction to&#160;generate a&#160;fault:</p>
<p style="position:absolute;top:485px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:486px;left:93px;white-space:nowrap" class="ft04">If the XSAVE feature&#160;set&#160;is not enabled (CR4.OSXSAVE&#160;=&#160;0), an invalid-opcode exception&#160;(#UD)&#160;occurs.</p>
<p style="position:absolute;top:508px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:508px;left:93px;white-space:nowrap" class="ft04">If&#160;CR0.TS[bit&#160;3] is&#160;1,&#160;a device-not-available exception (#NM)&#160;occurs.</p>
<p style="position:absolute;top:530px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:531px;left:93px;white-space:nowrap" class="ft09">If&#160;CPL&#160;&gt;&#160;0&#160;or if the&#160;address of the&#160;XSAVE area is&#160;not 64-byte aligned, a&#160;general-protection exception&#160;(#GP)&#160;<br/>occurs.</p>
<p style="position:absolute;top:545px;left:142px;white-space:nowrap" class="ft07">1</p>
<p style="position:absolute;top:571px;left:68px;white-space:nowrap" class="ft09">After checking&#160;for these&#160;faults, the&#160;XRSTORS instruction&#160;reads the&#160;first&#160;64 bytes&#160;of&#160;the XSAVE header, including the&#160;<br/>XSTATE_BV and&#160;XCOMP_BV fields<a href="o_7281d5ea06a5b67a-313.html">&#160;(see Section 13.4.2). A</a>&#160;#GP occurs if any of the following conditions hold for the&#160;<br/>values&#160;read:</p>
<p style="position:absolute;top:626px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:627px;left:93px;white-space:nowrap" class="ft04">XCOMP_BV[63]&#160;= 0.</p>
<p style="position:absolute;top:649px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:649px;left:93px;white-space:nowrap" class="ft04">XCOMP_BV&#160;sets&#160;a bit in&#160;the&#160;range&#160;62:0&#160;that is&#160;not&#160;set&#160;in XCR0&#160;| IA32_XSS.</p>
<p style="position:absolute;top:671px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:672px;left:93px;white-space:nowrap" class="ft04">XSTATE_BV&#160;sets a&#160;bit (including&#160;bit&#160;63) that&#160;is not set in XCOMP_BV.</p>
<p style="position:absolute;top:694px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:694px;left:93px;white-space:nowrap" class="ft04">Bytes&#160;63:16&#160;of the&#160;XSAVE header are&#160;not all&#160;0.</p>
<p style="position:absolute;top:718px;left:68px;white-space:nowrap" class="ft09">If none of&#160;these conditions&#160;cause&#160;a fault,&#160;the&#160;processor updates each state&#160;component&#160;<i>i</i>&#160;for which RFBM[<i>i</i>]&#160;=&#160;&#160;1.&#160;<br/>XRSTORS updates state component&#160;<i>i</i>&#160;based on the&#160;value of bit&#160;<i>i</i>&#160;in the XSTATE_BV field&#160;of the&#160;XSAVE&#160;header:</p>
<p style="position:absolute;top:757px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:757px;left:93px;white-space:nowrap" class="ft09">If XSTATE_BV[<i>i</i>]&#160;=&#160;0, the&#160;state component&#160;is set to&#160;its initial&#160;configuration.<a href="o_7281d5ea06a5b67a-318.html">&#160;Section&#160;13.6 specifies&#160;</a>the&#160;initial&#160;<br/>configuration of&#160;each state&#160;component.&#160;If XSTATE_BV[1]&#160;=&#160;0,&#160;XRSTORS&#160;initializes MXCSR to&#160;1F80H.<br/>State&#160;component&#160;<i>i</i>&#160;is&#160;set to&#160;its initial&#160;configuration as&#160;indicated above if&#160;RFBM[<i>i</i>]&#160;=&#160;1 and XSTATE_BV[<i>i</i>]&#160;=&#160;&#160;0&#160;&#160;—&#160;<br/><b>even&#160;if XCOMP_BV[<i>i</i></b><b>]&#160;=&#160;&#160;0</b>.&#160;This is&#160;true for all&#160;values&#160;of&#160;<i>i</i>,&#160;including&#160;0&#160;(x87&#160;state) and&#160;1&#160;(SSE state).</p>
<p style="position:absolute;top:835px;left:68px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:835px;left:93px;white-space:nowrap" class="ft04">If XSTATE_BV[<i>i</i>]&#160;=&#160;1,&#160;the state&#160;component is&#160;loaded with data&#160;from&#160;the XSAVE&#160;area.</p>
<p style="position:absolute;top:833px;left:661px;white-space:nowrap" class="ft07">2</p>
<p style="position:absolute;top:835px;left:668px;white-space:nowrap" class="ft04">&#160;See<a href="o_7281d5ea06a5b67a-314.html">&#160;Section 13.5&#160;</a>for&#160;</p>
<p style="position:absolute;top:852px;left:93px;white-space:nowrap" class="ft09">specifics for each state&#160;component&#160;and for&#160;details&#160;regarding mode-specific operation&#160;and operation&#160;determined&#160;<br/>by&#160;instruction&#160;prefixes;&#160;in particular<a href="o_7281d5ea06a5b67a-318.html">, see Section 13.5.6 for some&#160;</a>special treatment&#160;of&#160;PT state&#160;by XRSTORS.&#160;<br/><a href="o_7281d5ea06a5b67a-327.html">See Section 13.13 fo</a>r details&#160;regarding faults caused by memory accesses.<br/>If XRSTORS is&#160;restoring&#160;a supervisor&#160;state component, the&#160;instruction causes&#160;a general-protection exception&#160;<br/>(#GP) if&#160;it would&#160;load&#160;any element of&#160;that component with&#160;an unsupported&#160;value (e.g.,&#160;by setting a reserved&#160;bit&#160;<br/>in&#160;an&#160;MSR) or if&#160;a bit is&#160;set in&#160;any reserved portion&#160;of&#160;the state component in&#160;the XSAVE&#160;area.</p>
<p style="position:absolute;top:1017px;left:68px;white-space:nowrap" class="ft014">1.&#160;If&#160;CR0.AM&#160;= 1, CPL&#160;=&#160;3, and EFLAGS.AC&#160;=1, an&#160;alignment-check exception (#AC) may occur instead of&#160;#GP.<br/>2.&#160;Earlier fault checking&#160;ensured that,&#160;if&#160;the&#160;instruction&#160;has reached this&#160;point&#160;in&#160;execution&#160;and XSTATE_BV[<i>i</i>] is&#160;1, then&#160;XCOMP_BV[<i>i</i>] is&#160;</p>
<p style="position:absolute;top:1054px;left:89px;white-space:nowrap" class="ft04">also&#160;1.</p>
</div>
</body>
</html>
