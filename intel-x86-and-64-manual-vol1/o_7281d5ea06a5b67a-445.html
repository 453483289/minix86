<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 445</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:18px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:16px;font-family:Times;color:#0860a8;}
	.ft05{font-size:18px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page445-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a445.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:783px;white-space:nowrap" class="ft00">Vol. 1&#160;E-3</p>
<p style="position:absolute;top:47px;left:421px;white-space:nowrap" class="ft01">GUIDELINES FOR WRITING SIMD FLOATING-POINT&#160;EXCEPTION&#160;HANDLERS</p>
<p style="position:absolute;top:97px;left:69px;white-space:nowrap" class="ft02">E.3 EXCEPTION&#160;</p>
<p style="position:absolute;top:97px;left:260px;white-space:nowrap" class="ft02">SYNCHRONIZATION</p>
<p style="position:absolute;top:133px;left:69px;white-space:nowrap" class="ft06">An SSE/SSE2/SSE3&#160;instruction&#160;can&#160;execute in&#160;parallel with&#160;other similar&#160;instructions,&#160;with&#160;integer instructions,&#160;and&#160;<br/>with&#160;floating-point&#160;or&#160;MMX&#160;instructions.&#160;Unlike for x87 instructions, special precaution&#160;for exception synchroniza-<br/>tion is not&#160;necessary&#160;in&#160;this&#160;case.&#160;This is because floating-point exceptions&#160;for&#160;SSE/SSE2/SSE3 instructions&#160;occur&#160;<br/>immediately&#160;and are&#160;not delayed&#160;until&#160;a subsequent&#160;floating-point instruction&#160;is executed. However,&#160;floating-<br/>point&#160;emulation&#160;may&#160;be necessary when&#160;unmasked floating-point exceptions are generated.</p>
<p style="position:absolute;top:255px;left:69px;white-space:nowrap" class="ft02">E.4&#160;</p>
<p style="position:absolute;top:255px;left:148px;white-space:nowrap" class="ft02">SIMD FLOATING-POINT&#160;EXCEPTIONS AND THE IEEE STANDARD&#160;754</p>
<p style="position:absolute;top:291px;left:69px;white-space:nowrap" class="ft06">SSE/SSE2/SSE3 extensions are&#160;100%&#160;compatible with the IEEE Standard 754 for Binary Floating-Point Arithmetic,&#160;<br/>satisfying&#160;all of&#160;its mandatory requirements (when&#160;the&#160;flush-to-zero or&#160;denormals-are-zeros modes&#160;are&#160;not&#160;<br/>enabled).&#160;But&#160;a programming environment&#160;that includes&#160;SSE/SSE2/SSE3&#160;instructions&#160;will&#160;comply with both&#160;the&#160;<br/>obligatory&#160;and&#160;the&#160;strongly recommended&#160;requirements of&#160;the IEEE&#160;Standard 754&#160;regarding floating-point&#160;excep-<br/>tion handling, only as&#160;a combination of&#160;hardware and software&#160;(which is&#160;acceptable). The standard states&#160;that a&#160;<br/>user&#160;should&#160;be&#160;able&#160;to&#160;request&#160;a&#160;trap&#160;on&#160;any&#160;of&#160;the&#160;five&#160;floating-point exceptions (note that the denormal exception&#160;<br/>is an&#160;IA-32 addition),&#160;and&#160;it also specifies the values&#160;(operands or result) to be delivered to&#160;the exception handler.&#160;<br/>The main issue&#160;is that&#160;for&#160;SSE/SSE2/SSE3&#160;instructions&#160;that raise post-computation&#160;exceptions (traps: overflow,&#160;<br/>underflow,&#160;or inexact), unlike&#160;for x87&#160;FPU instructions,&#160;the processor&#160;does not provide the&#160;result recommended&#160;by&#160;<br/>IEEE Standard 754 to&#160;the user handler.&#160;If a&#160;user&#160;program&#160;needs&#160;the&#160;result of an&#160;instruction that generated a&#160;post-<br/>computation&#160;exception, it&#160;is the responsibility of the&#160;software&#160;to&#160;produce this result by emulating&#160;the faulting&#160;<br/>SSE/SSE2/SSE3 instruction.&#160;Another&#160;issue&#160;is that&#160;the standard does not specify&#160;explicitly how to&#160;handle multiple&#160;<br/>floating-point&#160;exceptions&#160;that occur simultaneously. For packed operations, a&#160;logical&#160;OR&#160;of the&#160;flags&#160;that would be&#160;<br/>set by each&#160;sub-operation is&#160;used&#160;to set&#160;the exception&#160;flags in&#160;the MXCSR.&#160;The following subsections present one&#160;<br/>possible&#160;way&#160;to solve these problems.</p>
<p style="position:absolute;top:580px;left:69px;white-space:nowrap" class="ft04">E.4.1 &#160;</p>
<p style="position:absolute;top:580px;left:150px;white-space:nowrap" class="ft04">Floating-Point&#160;Emulation</p>
<p style="position:absolute;top:610px;left:69px;white-space:nowrap" class="ft07">Every&#160;operating system must provide&#160;a kernel&#160;level floating-point exception handler (a&#160;template was presented in&#160;<br/><a href="o_7281d5ea06a5b67a-443.html">Section&#160;E.2,&#160;“Software Exception Handling” abo</a>ve). In&#160;the&#160;following&#160;discussion, assume that&#160;a&#160;user mode floating-<br/>point exception filter is supplied for SIMD floating-point exceptions (for example as part of a library&#160;of C functions),&#160;<br/>that a&#160;user program can&#160;invoke&#160;in order to&#160;handle&#160;unmasked exceptions. The user&#160;mode floating-point&#160;exception&#160;<br/>filter&#160;(not shown&#160;here) has&#160;to be able to&#160;emulate&#160;the&#160;subset of&#160;SSE/SSE2/SSE3&#160;instructions that can&#160;generate&#160;<br/>numeric&#160;exceptions, and&#160;has to&#160;be able&#160;to&#160;invoke&#160;a user&#160;provided&#160;floating-point&#160;exception handler&#160;for floating-point&#160;<br/>exceptions. When&#160;a floating-point&#160;exception that&#160;is not&#160;masked is&#160;raised by an&#160;SSE/SSE2/SSE3&#160;instruction, the&#160;<br/>low-level floating-point&#160;exception handler&#160;will&#160;be&#160;called.&#160;This&#160;low-level handler may&#160;in turn call&#160;the user&#160;mode&#160;<br/>floating-point exception&#160;filter. The filter&#160;function&#160;receives&#160;the&#160;original operands&#160;of the&#160;excepting instruction as&#160;no&#160;<br/>results are&#160;provided&#160;by&#160;the&#160;hardware,&#160;whether&#160;a pre-computation or a&#160;post-computation exception&#160;has occurred.&#160;<br/>The filter&#160;will unpack the&#160;operands into up to four sets of&#160;sub-operands, and&#160;will submit&#160;them&#160;one&#160;set at&#160;a time to&#160;<br/><a href="o_7281d5ea06a5b67a-459.html">an emulation function (See Example&#160;E-2 in Section E.4.</a><a href="o_7281d5ea06a5b67a-457.html">3, “Example SIMD&#160;Floating-Point Emulation&#160;Implementa-<br/>tion”). The</a>&#160;emulation function will examine&#160;the&#160;sub-operands, and&#160;will&#160;possibly&#160;redo&#160;the necessary calculation.&#160;<br/>Two cases are&#160;possible:</p>
<p style="position:absolute;top:854px;left:69px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:855px;left:95px;white-space:nowrap" class="ft06">If an unmasked (enabled) exception would&#160;occur in&#160;this process, the&#160;emulation function will&#160;return&#160;to&#160;its caller&#160;<br/>(the filter&#160;function) with the&#160;appropriate&#160;information.&#160;The filter&#160;will invoke&#160;a (previously registered) user&#160;<br/>floating-point&#160;exception handler&#160;for&#160;this set of sub-operands,&#160;and will&#160;record&#160;the result&#160;upon return&#160;from&#160;the&#160;<br/>user handler&#160;(provided the&#160;user handler allows&#160;continuation&#160;of the&#160;execution).&#160;</p>
<p style="position:absolute;top:926px;left:69px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:927px;left:95px;white-space:nowrap" class="ft06">If no&#160;unmasked&#160;(enabled)&#160;exception would occur,&#160;the emulation&#160;function will determine&#160;and will return&#160;to its&#160;<br/>caller the&#160;result of the&#160;operation for the&#160;current set&#160;of&#160;sub-operands&#160;(it has to&#160;be&#160;IEEE Standard&#160;754&#160;<br/>compliant). The&#160;filter function will record&#160;the&#160;result (plus any&#160;new&#160;flag&#160;settings).</p>
<p style="position:absolute;top:984px;left:69px;white-space:nowrap" class="ft06">The user&#160;level filter&#160;function will then&#160;call&#160;the emulation&#160;function for the&#160;next set of sub-operands&#160;(if any). When&#160;<br/>done with all the operand sets, the partial results will be&#160;packed (if the excepting instruction has a packed floating-<br/>point result, which is true&#160;for most SSE/SSE2/SSE3&#160;numeric&#160;instructions) and the filter&#160;will return to the low-level&#160;<br/>exception handler,&#160;which&#160;in turn will return&#160;from&#160;the&#160;interruption, allowing execution&#160;to continue. Note&#160;that the&#160;</p>
</div>
</body>
</html>
