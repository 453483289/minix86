<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 434</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:16px;font-family:Times;color:#0860a8;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page434-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a434.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">D-12&#160;Vol. 1</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">GUIDELINES&#160;FOR WRITING X87 FPU EXCEPTION HANDLERS</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft05">active,&#160;or&#160;it is&#160;a no-wait x87&#160;FPU&#160;instruction). Exactly&#160;when&#160;the&#160;exception&#160;handler will be invoked (in&#160;the interval&#160;<br/>between&#160;when the&#160;exception is detected&#160;and&#160;the&#160;next WAIT&#160;or&#160;x87&#160;FPU instruction) is&#160;dependent on&#160;the&#160;processor&#160;<br/>generation,&#160;the system, and&#160;which x87 FPU&#160;instruction and&#160;exception is&#160;involved.&#160;<br/>To&#160;be&#160;safe&#160;in exception&#160;synchronization, one&#160;should&#160;assume&#160;the handler will be&#160;invoked at&#160;the&#160;end of the&#160;interval.&#160;<br/>Thus&#160;the program&#160;should&#160;not change&#160;any&#160;value&#160;that&#160;might be needed by&#160;the&#160;handler&#160;(such&#160;as CO<a href="o_7281d5ea06a5b67a-433.html">UNT in&#160;Example&#160;<br/>D-1&#160;and Example D-2)&#160;</a>until&#160;<b>after&#160;</b>the&#160;<b>next</b>&#160;x87&#160;FPU instruction following an&#160;x87&#160;FPU instruction that&#160;could cause&#160;<br/>an error.&#160;If the&#160;program&#160;needs to modify such a&#160;value before the&#160;next&#160;x87&#160;FPU instruction (or&#160;if&#160;the next&#160;x87 FPU&#160;<br/>instruction&#160;could also cause an error), then a WAIT instruction should be&#160;inserted before the value is&#160;modified.&#160;This&#160;<br/>will&#160;force the handling of&#160;any exception before the&#160;value is&#160;modified. A WAIT instruction&#160;should also be placed&#160;after&#160;<br/>the last&#160;floating-point instruction&#160;in an application so that any unmasked exceptions will be&#160;serviced&#160;before the&#160;task&#160;<br/>completes.</p>
<p style="position:absolute;top:323px;left:68px;white-space:nowrap" class="ft04">D.3.4 &#160;</p>
<p style="position:absolute;top:323px;left:148px;white-space:nowrap" class="ft04">x87 FPU Exception Handling Examples</p>
<p style="position:absolute;top:354px;left:68px;white-space:nowrap" class="ft05">There are many approaches&#160;to writing exception&#160;handlers.&#160;One useful&#160;technique is&#160;to&#160;consider the&#160;exception&#160;<br/>handler&#160;procedure as consisting of “prologue,”&#160;“body,”&#160;and “epilogue”&#160;sections of&#160;code.&#160;<br/>In the&#160;transfer of control&#160;to the&#160;exception handler&#160;due&#160;to&#160;an INTR,&#160;NMI, or&#160;SMI, external&#160;interrupts&#160;have been&#160;<br/>disabled&#160;by&#160;hardware.&#160;The&#160;prologue&#160;performs&#160;all functions&#160;that must be protected from&#160;possible interruption&#160;by&#160;<br/>higher-priority sources. Typically,&#160;this involves&#160;saving registers&#160;and transferring diagnostic information&#160;from the&#160;<br/>x87&#160;FPU to memory.&#160;When the&#160;critical&#160;processing&#160;has been completed,&#160;the&#160;prologue&#160;may&#160;re-enable interrupts to&#160;<br/>allow higher-priority interrupt handlers to&#160;preempt the exception handler.&#160;The standard “prologue”&#160;not only&#160;saves&#160;<br/>the&#160;registers and&#160;transfers&#160;diagnostic&#160;information from the&#160;x87 FPU&#160;to memory but&#160;also clears the&#160;floating-point&#160;<br/>exception flags&#160;in the status&#160;word. Alternatively,&#160;when it&#160;is not necessary&#160;for&#160;the handler to be re-entrant,&#160;another&#160;<br/>technique&#160;may also be used. In&#160;this technique,&#160;the&#160;exception flags&#160;are not&#160;cleared in the&#160;“prologue”&#160;and the&#160;body&#160;<br/>of&#160;the handler&#160;must&#160;not contain any&#160;floating-point instructions&#160;that cannot complete execution when&#160;there&#160;is a&#160;<br/>pending&#160;floating-point exception. (The no-wait&#160;instructions are&#160;discussed&#160;in&#160;<a href="o_7281d5ea06a5b67a-214.html">Section&#160;8.3.12,&#160;“Waiting vs.&#160;Non-<br/>waiting Instructions.”) Note</a>&#160;that the&#160;handler must still&#160;clear the&#160;exception flag(s) before executing the&#160;IRET. If the&#160;<br/>exception handler&#160;uses neither&#160;of&#160;these techniques, the system&#160;will be caught&#160;in an endless loop&#160;of&#160;nested floating-<br/>point exceptions, and hang.<br/>The&#160;body of the&#160;exception handler examines&#160;the&#160;diagnostic&#160;information&#160;and makes a&#160;response&#160;that is&#160;necessarily&#160;<br/>application-dependent. This response&#160;may&#160;range from halting execution, to&#160;displaying a&#160;message,&#160;to attempting&#160;to&#160;<br/>repair the&#160;problem and&#160;proceed with normal execution.&#160;The&#160;epilogue&#160;essentially&#160;reverses the&#160;actions of&#160;the&#160;<br/>prologue, restoring the&#160;processor&#160;so that&#160;normal&#160;execution can be&#160;resumed. The&#160;epilogue must not&#160;load an&#160;<br/>unmasked&#160;exception flag into the&#160;x87&#160;FPU or&#160;another&#160;exception will be requested immediately.<br/>The following code&#160;examples&#160;show&#160;the&#160;ASM386/486 coding&#160;of three&#160;skeleton exception&#160;handlers,&#160;with&#160;the save&#160;<br/>spaces&#160;given&#160;as correct for 32-bit&#160;protected mode. They&#160;show&#160;how&#160;prologues&#160;and epilogues&#160;can be written for&#160;<br/>various situations, but the application-dependent exception handling body is just indicated by comments showing&#160;<br/>where&#160;it&#160;should be&#160;placed.<br/>The first two are&#160;very similar;&#160;their&#160;only&#160;substantial difference&#160;is their&#160;choice&#160;of instructions to save&#160;and&#160;restore the&#160;<br/>x87 FPU.&#160;The trade-off here is&#160;between&#160;the increased diagnostic&#160;information provided&#160;by&#160;FNSAVE&#160;and the&#160;faster&#160;<br/>execution of FNSTENV. (Also,&#160;after saving&#160;the&#160;original&#160;contents,&#160;FNSAVE re-initializes&#160;the x87&#160;FPU,&#160;while FNSTENV&#160;<br/>only masks all&#160;x87&#160;FPU exceptions.) For&#160;applications&#160;that&#160;are&#160;sensitive to interrupt latency or&#160;that do&#160;not need to&#160;<br/>examine&#160;register contents, FNSTENV&#160;reduces&#160;the duration&#160;of&#160;the “critical&#160;region,”&#160;during which&#160;the processor does&#160;<br/>not recognize&#160;another interrupt&#160;request.&#160;<a href="o_7281d5ea06a5b67a-201.html">(See the&#160;Section&#160;8.1.10,&#160;“Saving the&#160;x87 FPU’s State with&#160;<br/>FSTENV/FNSTENV&#160;and FSAVE/FNSAVE,”</a>&#160;for a&#160;complete&#160;description of the&#160;x87 FPU save&#160;image.) If&#160;the&#160;processor&#160;<br/>supports Streaming SIMD Extensions&#160;and&#160;the operating&#160;system&#160;supports it, the&#160;FXSAVE instruction should&#160;be&#160;used&#160;<br/>instead&#160;of FNSAVE. If&#160;the&#160;FXSAVE&#160;instruction&#160;is used,&#160;the&#160;save&#160;area&#160;should&#160;be increased&#160;to 512 bytes&#160;and aligned&#160;<br/>to 16&#160;bytes&#160;to save&#160;the&#160;entire&#160;state.&#160;These&#160;steps will ensure&#160;that the&#160;complete&#160;context is&#160;saved.<br/>After the exception handler body,&#160;the epilogues prepare the processor to resume&#160;execution from the point of inter-<br/>ruption (for example,&#160;the instruction following the&#160;one&#160;that generated the&#160;unmasked exception). Notice that the&#160;<br/>exception flags in the memory image that is loaded&#160;into the x87 FPU&#160;are cleared to zero&#160;prior to reloading&#160;(in&#160;fact,&#160;<br/>in these&#160;examples,&#160;the&#160;entire&#160;status word&#160;image is&#160;cleared).<br/><a href="o_7281d5ea06a5b67a-435.html">Example&#160;D-3 and&#160;Example&#160;D-4 ass</a>ume&#160;that the&#160;exception&#160;handler itself&#160;will not cause&#160;an unmasked&#160;exception.&#160;<br/>Where this&#160;is&#160;a possibility,&#160;the&#160;general approach shown&#160;<a href="o_7281d5ea06a5b67a-436.html">in Example D-5 can&#160;</a>be&#160;employed.&#160;The basic technique&#160;is to&#160;</p>
</div>
</body>
</html>
