<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 429</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:16px;font-family:Times;color:#0860a8;}
	.ft05{font-size:18px;font-family:Times;color:#0860a8;}
	.ft06{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page429-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a429.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:781px;white-space:nowrap" class="ft00">Vol. 1&#160;D-7</p>
<p style="position:absolute;top:47px;left:500px;white-space:nowrap" class="ft01">GUIDELINES&#160;FOR WRITING X87&#160;FPU EXCEPTION HANDLERS</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft06">If&#160;a no-wait&#160;instruction&#160;is used outside of the&#160;x87&#160;FPU exception handler,&#160;it&#160;may malfunction&#160;as explained&#160;above,&#160;<br/>depending&#160;on&#160;the details of the&#160;hardware&#160;interface implementation&#160;and which particular&#160;processor&#160;is involved. The&#160;<br/>actual interrupt&#160;inside&#160;the&#160;window in the no-wait&#160;instruction may be blocked&#160;by&#160;surrounding it&#160;with&#160;the instruc-<br/>tions: PUSHFD,&#160;CLI,&#160;no-wait,&#160;then&#160;POPFD.&#160;(CLI&#160;blocks&#160;interrupts,&#160;and the&#160;push and&#160;pop&#160;of flags&#160;preserves&#160;and&#160;<br/>restores the&#160;original value&#160;of the&#160;interrupt flag.) However,&#160;if FERR# was triggered by the&#160;no-wait, its latched value&#160;<br/>and the&#160;PIC response&#160;will&#160;still be in&#160;effect.&#160;Further code&#160;can be used&#160;to&#160;check&#160;for&#160;and&#160;correct such a&#160;condition,&#160;if&#160;<br/>needed.<a href="o_7281d5ea06a5b67a-437.html">&#160;Section D.3.6,&#160;“Considerations When x87 FPU Shared&#160;Between Tasks,”</a><b>&#160;</b>discusses an&#160;important example&#160;of&#160;<br/>this type&#160;of problem and gives a&#160;solution.</p>
<p style="position:absolute;top:266px;left:69px;white-space:nowrap" class="ft04">D.2.2 &#160;</p>
<p style="position:absolute;top:266px;left:149px;white-space:nowrap" class="ft04">MS-DOS* Compatibility&#160;Sub-mode in the P6 Family&#160;</p>
<p style="position:absolute;top:287px;left:149px;white-space:nowrap" class="ft04">and Pentium® 4 Processors</p>
<p style="position:absolute;top:318px;left:69px;white-space:nowrap" class="ft06">When bit NE&#160;=&#160;0 in&#160;CR0,&#160;the&#160;MS-DOS compatibility mode&#160;of&#160;the P6 family&#160;and&#160;Pentium 4 processors provides&#160;<br/>FERR#&#160;and IGNNE# functionality that is&#160;almost identical to&#160;the Intel486&#160;and Pentium processors.&#160;The&#160;same&#160;<br/>external hardware described<a href="o_7281d5ea06a5b67a-426.html">&#160;in&#160;Section&#160;D.2.1.2,&#160;“Recommended External Hardware to Support&#160;the MS-DOS*&#160;<br/>Compatibility Sub-mode,”&#160;is recommende</a>d&#160;for the P6&#160;family&#160;and Pentium 4&#160;processors&#160;as well as the two previous&#160;<br/>generations. The only&#160;change&#160;to MS-DOS compatibility x87 FPU exception&#160;handling&#160;with the P6 family and Pentium&#160;<br/>4&#160;processors&#160;is that all&#160;exceptions for all x87&#160;FPU instructions cause immediate error&#160;reporting. That&#160;is,&#160;FERR#&#160;is&#160;<br/>asserted as&#160;soon&#160;as the&#160;x87&#160;FPU detects&#160;an unmasked&#160;exception;&#160;there are no&#160;cases in&#160;which&#160;error&#160;reporting&#160;is&#160;<br/>deferred to&#160;the next&#160;x87 FPU&#160;or WAIT instruction.&#160;<br/>(As is&#160;discussed in<a href="o_7281d5ea06a5b67a-425.html">&#160;Section&#160;D.2.1.1,&#160;“Basic&#160;Rules:&#160;When&#160;FERR#&#160;Is Generated,”&#160;</a>most&#160;exception cases in the&#160;Intel486&#160;<br/>and Pentium processors are&#160;of the&#160;deferred type.)<br/>Although FERR# is&#160;asserted immediately upon&#160;detection&#160;of&#160;an unmasked&#160;x87&#160;FPU error,&#160;this certainly&#160;does&#160;not&#160;<br/>mean&#160;that&#160;the&#160;requested interrupt will always be serviced&#160;before the&#160;next instruction in&#160;the code sequence&#160;is&#160;<br/>executed. To&#160;begin with,&#160;the P6 family&#160;and Pentium 4 processors execute several&#160;instructions&#160;simultaneously.&#160;<br/>There also&#160;will&#160;be a&#160;delay,&#160;which depends on the&#160;external hardware&#160;implementation, between the&#160;FERR#&#160;assertion&#160;<br/>from the&#160;processor&#160;and the&#160;responding INTR assertion&#160;to the processor.&#160;Further,&#160;the&#160;interrupt request&#160;to the&#160;PICs&#160;<br/>(IRQ13)&#160;may&#160;be&#160;temporarily blocked by&#160;the&#160;operating system, or delayed by&#160;higher priority&#160;interrupts, and&#160;<br/>processor&#160;response&#160;to INTR itself&#160;is blocked if the&#160;operating&#160;system has cleared&#160;the IF bit&#160;in EFLAGS.&#160;Note&#160;that&#160;<br/>Streaming&#160;SIMD&#160;Extensions numeric&#160;exceptions will not cause&#160;assertion of FERR# (independent of the&#160;value of&#160;<br/>CR0.NE). In addition,&#160;they ignore&#160;the assertion/deassertion&#160;of IGNNE#).<br/>However,&#160;just as&#160;with the Intel486&#160;and&#160;Pentium processors,&#160;if the&#160;IGNNE# input is&#160;inactive,&#160;a floating-point excep-<br/>tion&#160;which occurred in the&#160;previous&#160;x87 FPU&#160;instruction&#160;and&#160;is unmasked&#160;causes&#160;the processor to&#160;freeze&#160;immedi-<br/>ately when encountering the next WAIT or x87 FPU instruction (except for no-wait instructions). This means that if&#160;<br/>the x87&#160;FPU&#160;exception handler&#160;has not already been invoked&#160;due&#160;to the&#160;earlier exception (and&#160;therefore,&#160;the&#160;<br/>handler not has&#160;cleared that exception&#160;state&#160;from the&#160;x87&#160;FPU), the&#160;processor&#160;is forced to wait for the&#160;handler to&#160;<br/>be invoked and&#160;handle&#160;the exception, before the&#160;processor&#160;can&#160;execute&#160;another WAIT or&#160;x87 FPU&#160;instruction.&#160;<br/>As explained in&#160;<a href="o_7281d5ea06a5b67a-427.html">Section D.2.1.3,&#160;“No-Wait x87&#160;FPU Instructions Can Get x87 FPU&#160;Interrupt in Window,”</a><b>&#160;</b>if a&#160;no-wait&#160;<br/>instruction&#160;is used&#160;outside&#160;of the&#160;x87 FPU exception handler,&#160;in&#160;the Intel486&#160;and Pentium processors,&#160;it may accept&#160;<br/>an unmasked&#160;exception from a previous x87&#160;FPU instruction which happens to fall&#160;within&#160;the external&#160;interrupt&#160;<br/>sampling window that&#160;is&#160;opened near the beginning of execution&#160;of all x87 FPU&#160;instructions. This will&#160;not happen&#160;in&#160;<br/>the P6 family and Pentium 4 processors, because this&#160;sampling&#160;window&#160;has been&#160;removed from&#160;the no-wait group&#160;<br/>of x87 FPU&#160;instructions.</p>
<p style="position:absolute;top:898px;left:69px;white-space:nowrap" class="ft05">D.3 RECOMMENDED&#160;</p>
<p style="position:absolute;top:898px;left:301px;white-space:nowrap" class="ft05">PROTOCOL&#160;</p>
<p style="position:absolute;top:898px;left:407px;white-space:nowrap" class="ft05">FOR&#160;</p>
<p style="position:absolute;top:898px;left:450px;white-space:nowrap" class="ft05">MS-DOS* COMPATIBILITY HANDLERS</p>
<p style="position:absolute;top:934px;left:69px;white-space:nowrap" class="ft06">The activities of numeric programs can be split&#160;into two major areas: program&#160;control and arithmetic.&#160;The program&#160;<br/>control&#160;part performs activities such as deciding what functions to perform, calculating addresses of numeric oper-<br/>ands, and&#160;loop control. The&#160;arithmetic part simply adds,&#160;subtracts, multiplies,&#160;and performs&#160;other operations on&#160;<br/>the numeric operands.&#160;The processor is designed&#160;to handle&#160;these&#160;two parts separately and efficiently.&#160;An x87 FPU&#160;<br/>exception handler,&#160;if&#160;a&#160;system chooses to implement one,&#160;is often one of&#160;the most complicated parts&#160;of the program&#160;<br/>control&#160;code.</p>
</div>
</body>
</html>
