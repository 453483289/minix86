<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 310</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:16px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#0860a8;}
	.ft06{font-size:18px;font-family:Times;color:#000000;}
	.ft07{font-size:8px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page310-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a310.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">13-4&#160;Vol. 1</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">MANAGING STATE&#160;USING THE XSAVE FEATURE SET</p>
<p style="position:absolute;top:100px;left:93px;white-space:nowrap" class="ft02">‚Äî&#160;CPUID&#160;function&#160;0DH,&#160;sub-function&#160;<i>i</i>&#160;(<i>i</i>&#160;&gt; 1).&#160;This sub-function enumerates details for&#160;state component&#160;<i>i</i>. If&#160;</p>
<p style="position:absolute;top:117px;left:119px;white-space:nowrap" class="ft08">the&#160;XSAVE feature&#160;set&#160;supports&#160;state&#160;component&#160;<i>i</i>&#160;(see&#160;note&#160;above),&#160;the following items&#160;provide&#160;specific&#160;<br/>details:</p>
<p style="position:absolute;top:159px;left:119px;white-space:nowrap" class="ft04">‚Ä¢</p>
<p style="position:absolute;top:157px;left:144px;white-space:nowrap" class="ft02">EAX enumerates&#160;the&#160;size (in&#160;bytes) required&#160;for&#160;state component&#160;<i>i</i>.</p>
<p style="position:absolute;top:183px;left:119px;white-space:nowrap" class="ft04">‚Ä¢</p>
<p style="position:absolute;top:181px;left:144px;white-space:nowrap" class="ft08">If state&#160;component&#160;<i>i</i>&#160;is a&#160;user state component,&#160;EBX&#160;enumerates&#160;the&#160;offset&#160;(in&#160;bytes,&#160;from&#160;the&#160;base&#160;of&#160;<br/>the&#160;XSAVE area) of the&#160;section used for state&#160;component&#160;<i>i</i>. (This&#160;offset&#160;applies&#160;only when the&#160;standard&#160;<br/>format for the&#160;extended&#160;region of the&#160;XSAVE area&#160;is&#160;being&#160;used;&#160;<a href="o_7281d5ea06a5b67a-314.html">see Section&#160;13.4.3.)</a></p>
<p style="position:absolute;top:240px;left:119px;white-space:nowrap" class="ft04">‚Ä¢</p>
<p style="position:absolute;top:238px;left:144px;white-space:nowrap" class="ft02">If state&#160;component&#160;<i>i</i>&#160;is a&#160;supervisor state component,&#160;EBX returns&#160;0.</p>
<p style="position:absolute;top:264px;left:119px;white-space:nowrap" class="ft04">‚Ä¢</p>
<p style="position:absolute;top:262px;left:144px;white-space:nowrap" class="ft08">If state&#160;component&#160;<i>i</i>&#160;is a&#160;user state component,&#160;ECX[0]&#160;return 0;&#160;if state&#160;component&#160;<i>i</i>&#160;is&#160;a supervisor&#160;<br/>state component, ECX[0]&#160;returns 1.</p>
<p style="position:absolute;top:304px;left:119px;white-space:nowrap" class="ft04">‚Ä¢</p>
<p style="position:absolute;top:303px;left:144px;white-space:nowrap" class="ft08">The value returned by ECX[1] indicates the alignment of state component&#160;<i>i</i>&#160;when the compacted&#160;format&#160;<br/>of the&#160;extended region&#160;of an&#160;XSAVE&#160;area is&#160;used&#160;(see&#160;<a href="o_7281d5ea06a5b67a-314.html">Section&#160;13.4.3</a>). If ECX[1]&#160;returns 0,&#160;state&#160;<br/>component&#160;<i>i</i>&#160;is located immediately following the preceding&#160;state component;&#160;if ECX[1] returns&#160;1,&#160;state&#160;<br/>component&#160;<i>i</i>&#160;is located on the&#160;next 64-byte boundary&#160;following&#160;the&#160;preceding&#160;state&#160;component.</p>
<p style="position:absolute;top:378px;left:119px;white-space:nowrap" class="ft04">‚Ä¢</p>
<p style="position:absolute;top:376px;left:144px;white-space:nowrap" class="ft02">ECX[31:2] and&#160;EDX return 0.</p>
<p style="position:absolute;top:400px;left:119px;white-space:nowrap" class="ft08">If the XSAVE feature set does not support state component&#160;<i>i</i>, sub-function&#160;<i>i</i>&#160;returns 0 in EAX, EBX,&#160;ECX,&#160;and&#160;<br/>EDX.</p>
<p style="position:absolute;top:472px;left:68px;white-space:nowrap" class="ft05">13.3&#160;</p>
<p style="position:absolute;top:472px;left:147px;white-space:nowrap" class="ft05">ENABLING THE XSAVE FEATURE SET AND XSAVE-ENABLED FEATURES</p>
<p style="position:absolute;top:508px;left:68px;white-space:nowrap" class="ft08">Software&#160;enables the&#160;XSAVE&#160;feature set by setting CR4.OSXSAVE[bit&#160;18] to&#160;1 (e.g.,&#160;with the&#160;MOV to CR4&#160;instruc-<br/>tion). If this&#160;bit&#160;is 0, execution&#160;of&#160;any&#160;of&#160;XGETBV,&#160;XRSTOR, XRSTORS,&#160;XSAVE,&#160;XSAVEC,&#160;XSAVEOPT, XSAVES, and&#160;<br/>XSETBV causes&#160;an invalid-opcode&#160;exception (#UD).<br/>When CR4.OSXSAVE&#160;=&#160;1 and&#160;CPL&#160;=&#160;0,&#160;executing the&#160;XSETBV&#160;instruction with ECX&#160;=&#160;0 writes&#160;the 64-bit&#160;value&#160;in&#160;<br/>EDX:EAX to XCR0&#160;(EAX&#160;is written&#160;to XCR0[31:0] and&#160;EDX&#160;to XCR0[63:32]). (Execution&#160;of the&#160;XSETBV instruction&#160;<br/>causes a general-protection fault ‚Äî #GP&#160;‚Äî if CPL&#160;&gt;&#160;0.)&#160;The&#160;following items provide&#160;details&#160;regarding individual bits&#160;<br/>in XCR0:</p>
<p style="position:absolute;top:637px;left:68px;white-space:nowrap" class="ft06">‚Ä¢</p>
<p style="position:absolute;top:637px;left:93px;white-space:nowrap" class="ft08">XCR0[0] is associated&#160;with x87 state<a href="o_7281d5ea06a5b67a-315.html">&#160;(see Section 13.5.1</a>).&#160;XCR0[0] is always 1.&#160;It&#160;has that value coming&#160;out of&#160;<br/>RESET.&#160;Executing the&#160;XSETBV&#160;instruction&#160;causes a&#160;general-protection&#160;fault&#160;(#GP) if ECX&#160;=&#160;0&#160;and EAX[0]&#160;is&#160;0.</p>
<p style="position:absolute;top:676px;left:68px;white-space:nowrap" class="ft06">‚Ä¢</p>
<p style="position:absolute;top:676px;left:93px;white-space:nowrap" class="ft08">XCR0[1]&#160;is associated with&#160;SSE state&#160;<a href="o_7281d5ea06a5b67a-315.html">(see Section 13.5.2). Softw</a>are&#160;can use&#160;the&#160;XSAVE feature set to manage&#160;<br/>SSE state only&#160;if XCR0[1]&#160;=&#160;1. The value&#160;of XCR0[1] in&#160;no way determines whether software can execute SSE&#160;<br/>instructions (these&#160;instructions can&#160;be&#160;executed even if XCR0[1]&#160;=&#160;0).<br/>XCR0[1]&#160;is 0&#160;coming&#160;out of RESET.<a href="o_7281d5ea06a5b67a-308.html">&#160;As noted in Section 13.2</a>, every processor that&#160;supports&#160;the&#160;XSAVE feature&#160;<br/>set&#160;allows&#160;software to&#160;set XCR0[1].</p>
<p style="position:absolute;top:770px;left:68px;white-space:nowrap" class="ft06">‚Ä¢</p>
<p style="position:absolute;top:771px;left:93px;white-space:nowrap" class="ft08">XCR0[2] is associated with&#160;AVX state (see<a href="o_7281d5ea06a5b67a-316.html">&#160;Section 13.5.3).</a>&#160;Software can use the XSAVE feature set to manage&#160;<br/>AVX state only if XCR0[2]&#160;=&#160;1. In&#160;addition,&#160;software&#160;can&#160;execute&#160;AVX instructions only if CR4.OSXSAVE&#160;=&#160;<br/>XCR0[2]&#160;=&#160;1.&#160;Otherwise,&#160;any&#160;execution of an&#160;AVX instruction causes&#160;an invalid-opcode&#160;exception (#UD).<br/>XCR0[2]&#160;is 0&#160;coming&#160;out of RESET.&#160;As note<a href="o_7281d5ea06a5b67a-308.html">d in Section&#160;13.2</a>, a&#160;processor&#160;allows&#160;software&#160;to set&#160;XCR0[2] if and&#160;<br/>only if&#160;CPUID.(EAX=0DH,ECX=0):EAX[2]&#160;=&#160;1.&#160;In&#160;addition,&#160;executing&#160;the XSETBV&#160;instruction causes&#160;a&#160;general-<br/>protection fault (#GP)&#160;if&#160;ECX&#160;=&#160;0 and&#160;EAX[2:1]&#160;has&#160;the value&#160;10b; that is,&#160;software&#160;cannot enable&#160;the&#160;XSAVE&#160;<br/>feature&#160;set&#160;for&#160;AVX state&#160;but&#160;not&#160;for SSE state.<br/><a href="o_7281d5ea06a5b67a-307.html">As noted in Section 13.1,&#160;</a>the processor will preserve&#160;AVX state unmodified&#160;if&#160;software clears XCR0[2].&#160;<br/>However,&#160;clearing XCR0[2]&#160;while&#160;AVX state&#160;is not in its&#160;initial configuration may&#160;cause SSE&#160;instructions to&#160;incur&#160;<br/>a power and performance penalty.&#160;S<a href="˛ˇ">ee Section&#160;13.5.3,&#160;‚ÄúEnable the&#160;Use Of XSAVE Feature Set&#160;And XSAVE State&#160;<br/>Components‚Äù</a>&#160;of&#160;<a href="˛ˇ"><i>Intel¬Æ&#160;64&#160;and IA-32 Architectures&#160;Software&#160;Developer‚Äôs Manual, Volume&#160;3A</i>, for how system&#160;<br/></a>software can&#160;avoid this&#160;penalty.</p>
<p style="position:absolute;top:986px;left:68px;white-space:nowrap" class="ft06">‚Ä¢</p>
<p style="position:absolute;top:987px;left:93px;white-space:nowrap" class="ft08">XCR0[4:3] are&#160;associated with&#160;MPX&#160;state (see<a href="o_7281d5ea06a5b67a-316.html">&#160;Section 13.5.4).&#160;</a>Software can&#160;use the&#160;XSAVE feature&#160;set&#160;to&#160;<br/>manage MPX state&#160;only&#160;if XCR0[4:3]&#160;=&#160;11b.&#160;In&#160;addition,&#160;software can&#160;execute&#160;MPX instructions only if&#160;<br/>CR4.OSXSAVE&#160;=&#160;1 and&#160;XCR0[4:3]&#160;=&#160;11b.&#160;Otherwise,&#160;any&#160;execution of an&#160;MPX instruction causes&#160;an invalid-<br/>opcode exception&#160;(#UD).</p>
<p style="position:absolute;top:1034px;left:263px;white-space:nowrap" class="ft07">1</p>
</div>
</body>
</html>
