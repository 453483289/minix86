<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 325</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:18px;font-family:Times;color:#0860a8;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#000000;}
	.ft06{font-size:8px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;font-family:Times;color:#000000;}
	.ft08{font-size:14px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft011{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft012{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft013{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page325-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a325.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:768px;white-space:nowrap" class="ft00">Vol. 1&#160;13-19</p>
<p style="position:absolute;top:47px;left:544px;white-space:nowrap" class="ft01">MANAGING&#160;STATE&#160;USING&#160;THE XSAVE&#160;FEATURE SET</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft09">XMM&#160;registers)&#160;even if&#160;XINUSE[1]&#160;= 0.&#160;Unlike the&#160;XSAVE instruction,&#160;RFBM[2]&#160;does&#160;not&#160;determine whether&#160;<br/>XSAVEC&#160;saves MXCSR&#160;and MXCSR_MASK.</p>
<p style="position:absolute;top:172px;left:69px;white-space:nowrap" class="ft03">13.11&#160;&#160;OPERATION OF&#160;XSAVES</p>
<p style="position:absolute;top:208px;left:69px;white-space:nowrap" class="ft012">The operation of&#160;XSAVES&#160;is similar to&#160;that of XSAVEC.&#160;The main differences are (1)&#160;XSAVES can&#160;be&#160;executed only&#160;<br/>if&#160;CPL&#160;=&#160;0; (2)&#160;XSAVES can operate on the&#160;state components whose bits are&#160;set in&#160;XCR0&#160;| IA32_XSS&#160;and can thus&#160;<br/>operate on supervisor state components; and (3)&#160;XSAVES uses the modified&#160;optimization (see<a href="o_7281d5ea06a5b67a-318.html">&#160;Section&#160;13.6</a>). See&#160;<br/><a href="o_7281d5ea06a5b67a-308.html">Section 13.2 for details of&#160;</a>how to&#160;determine whether&#160;XSAVES&#160;is&#160;supported.<br/>The XSAVES&#160;instruction&#160;takes&#160;a single memory operand, which is&#160;an XSAVE area.&#160;In addition,&#160;the&#160;register&#160;pair&#160;<br/>EDX:EAX&#160;is an&#160;implicit operand&#160;used&#160;as a&#160;stat<a href="o_7281d5ea06a5b67a-307.html">e-component bitmap (see Section 13.1) called the&#160;</a><b>instruction&#160;<br/>mask</b>. EDX:EAX&#160;&amp;&#160;(XCR0&#160;|&#160;IA32_XSS)&#160;(the logical AND&#160;the instruction mask with the&#160;logical&#160;OR of&#160;XCR0 and&#160;<br/>IA32_XSS) is&#160;the&#160;<b>requested-feature bitmap</b>&#160;(<b>RFBM</b>) of the state&#160;components to&#160;be&#160;saved.<br/>The following&#160;conditions&#160;cause execution&#160;of&#160;the XSAVES instruction to&#160;generate a&#160;fault:</p>
<p style="position:absolute;top:377px;left:69px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:378px;left:95px;white-space:nowrap" class="ft02">If the&#160;XSAVE feature&#160;set&#160;is not enabled&#160;(CR4.OSXSAVE&#160;=&#160;0), an invalid-opcode exception&#160;(#UD)&#160;occurs.</p>
<p style="position:absolute;top:400px;left:69px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:400px;left:95px;white-space:nowrap" class="ft02">If&#160;CR0.TS[bit&#160;3] is&#160;1,&#160;a device-not-available exception (#NM)&#160;occurs.</p>
<p style="position:absolute;top:422px;left:69px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:423px;left:95px;white-space:nowrap" class="ft09">If CPL&#160;&gt;&#160;0&#160;or if&#160;the address&#160;of&#160;the XSAVE&#160;area is&#160;not 64-byte&#160;aligned, a&#160;general-protection exception&#160;(#GP)&#160;<br/>occurs.</p>
<p style="position:absolute;top:437px;left:143px;white-space:nowrap" class="ft06">1</p>
<p style="position:absolute;top:463px;left:69px;white-space:nowrap" class="ft09">If none of these conditions&#160;cause a&#160;fault,&#160;execution of&#160;XSAVES&#160;writes&#160;the XSTATE_BV field of the XSAVE header&#160;<br/><a href="o_7281d5ea06a5b67a-313.html">(see Section 13.4.2),</a>&#160;setting&#160;XSTATE_BV[<i>i</i>] (0&#160;≤&#160;<i>i</i>&#160;≤&#160;63) as&#160;follows:</p>
<p style="position:absolute;top:502px;left:69px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:502px;left:95px;white-space:nowrap" class="ft02">If RFBM[<i>i</i>]&#160;=&#160;&#160;0,&#160;&#160;XSTATE_BV[<i>i</i>]&#160;is written as&#160;0.</p>
<p style="position:absolute;top:524px;left:69px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:525px;left:95px;white-space:nowrap" class="ft09">If RFBM[<i>i</i>]&#160;=&#160;&#160;1,&#160;&#160;XSTATE_BV[<i>i</i>]&#160;is set to&#160;the value of&#160;XINUSE[<i>i</i>] (see below&#160;for&#160;an exception made for&#160;<br/>XSTATE_BV[1]).&#160;<a href="o_7281d5ea06a5b67a-318.html">Section&#160;13.6 defines XIN</a>USE to&#160;describe the&#160;processor&#160;init optimization and specifies the&#160;<br/>initial configuration of&#160;each state component. The nature&#160;of&#160;that&#160;optimization implies the&#160;following:<br/>—&#160;If state component&#160;<i>i</i>&#160;is&#160;in its&#160;initial configuration, XSTATE_BV[<i>i</i>] may be&#160;written with either&#160;0&#160;or&#160;1.<br/>—&#160;If state component&#160;<i>i</i>&#160;is&#160;not in&#160;its initial&#160;configuration, XSTATE_BV[<i>i</i>] is&#160;written with 1.<br/>XINUSE[1] pertains only to&#160;the state of the&#160;XMM registers&#160;and not&#160;to MXCSR. However,&#160;if RFBM[1]&#160;=&#160;1&#160;and&#160;<br/>MXCSR does not&#160;have&#160;the&#160;value 1F80H,&#160;XSAVES writes&#160;XSTATE_BV[1] as&#160;1 even&#160;if&#160;XINUSE[1]&#160;=&#160;0.<br/>(As explained&#160;<a href="o_7281d5ea06a5b67a-318.html">in Section 13.6,&#160;</a>the&#160;initial configurations&#160;of&#160;some&#160;state&#160;components may&#160;depend on&#160;whether the&#160;<br/>processor is&#160;in 64-bit mode.)</p>
<p style="position:absolute;top:708px;left:69px;white-space:nowrap" class="ft09">The&#160;XSAVES instructions sets bit&#160;63 of the&#160;XCOMP_BV&#160;field of the&#160;XSAVE header while&#160;writing&#160;RFBM[62:0] to&#160;<br/>XCOMP_BV[62:0].&#160;The XSAVES&#160;instruction does&#160;not&#160;write&#160;any part&#160;of&#160;the XSAVE header other than the XSTATE_BV&#160;<br/>and XCOMP_BV&#160;fields.<br/>Execution of XSAVES saves into the XSAVE area those state components corresponding to bits that are set in RFBM&#160;<br/>(subject to&#160;the optimizations described&#160;below).&#160;State&#160;components 0&#160;and&#160;1 are located in the legacy&#160;region&#160;of&#160;the&#160;<br/>XSAVE&#160;<a href="o_7281d5ea06a5b67a-312.html">area (see Section 13.4.1). Ea</a>ch state component&#160;<i>i</i>, 2&#160;≤&#160;<i>i</i>&#160;≤&#160;62, is&#160;located in the&#160;extended region; the&#160;XSAVES&#160;</p>
<p style="position:absolute;top:814px;left:69px;white-space:nowrap" class="ft09">instruction&#160;always uses the&#160;compacted&#160;format&#160;for the&#160;extended&#160;region (see<a href="o_7281d5ea06a5b67a-314.html">&#160;Section 13.4.3).<br/></a>Se<a href="o_7281d5ea06a5b67a-314.html">e Section 13.5&#160;for specifics for e</a>ach&#160;state&#160;component&#160;and for details&#160;regarding mode-specific operation&#160;and&#160;<br/>operation determined&#160;by instruction prefixes; in particular,&#160;see<a href="o_7281d5ea06a5b67a-318.html">&#160;Section 13.5.6&#160;</a>for&#160;some&#160;special treatment of PT&#160;<br/>state&#160;by&#160;XSAVES.&#160;See<a href="o_7281d5ea06a5b67a-327.html">&#160;Section 13.13</a>&#160;for details regarding faults caused by memory accesses.<br/>Execution of XSAVES performs&#160;the init&#160;optimization&#160;to&#160;reduce&#160;the amount of data&#160;written to&#160;memory.&#160;If&#160;<br/>XINUSE[<i>i</i>]&#160;=&#160;0, state&#160;component&#160;<i>i</i>&#160;is&#160;not&#160;saved to the XSAVE area (even if RFBM[<i>i</i>]&#160;=&#160;1). However,&#160;if RFBM[1] = 1&#160;<br/>and&#160;MXCSR&#160;does&#160;not have&#160;the&#160;value 1F80H,&#160;XSAVES&#160;writes&#160;saves&#160;all&#160;of state component 1 (SSE&#160;—&#160;including&#160;the&#160;<br/>XMM registers)&#160;even&#160;if XINUSE[1] = 0.<br/>Like&#160;XSAVEOPT,&#160;XSAVES may perform&#160;the modified optimization.&#160;Each&#160;execution of XRSTOR&#160;and XRSTORS&#160;estab-<br/>lishes XRSTOR_INFO as a&#160;4-tuple&#160;</p>
<p style="position:absolute;top:982px;left:297px;white-space:nowrap" class="ft08"></p>
<p style="position:absolute;top:985px;left:303px;white-space:nowrap" class="ft07"><i>w</i>,<i>x</i>,<i>y</i>,<i>z</i></p>
<p style="position:absolute;top:982px;left:350px;white-space:nowrap" class="ft08"></p>
<p style="position:absolute;top:985px;left:355px;white-space:nowrap" class="ft02"><a href="o_7281d5ea06a5b67a-322.html">&#160;(see Section&#160;13.8.3&#160;</a>and&#160;<a href="o_7281d5ea06a5b67a-326.html">Section&#160;13.12). Ex</a>ecution of XSAVES&#160;uses the&#160;</p>
<p style="position:absolute;top:1002px;left:69px;white-space:nowrap" class="ft02">modified optimization&#160;only&#160;if the&#160;following&#160;all hold:</p>
<p style="position:absolute;top:1054px;left:69px;white-space:nowrap" class="ft02">1.&#160;If&#160;CR0.AM&#160;= 1, CPL&#160;=&#160;3,&#160;and&#160;EFLAGS.AC&#160;=1, an&#160;alignment-check exception&#160;(#AC) may occur instead&#160;of&#160;#GP.</p>
</div>
</body>
</html>
