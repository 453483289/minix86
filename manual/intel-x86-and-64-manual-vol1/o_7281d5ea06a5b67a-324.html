<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 324</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:18px;font-family:Times;color:#0860a8;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#000000;}
	.ft06{font-size:8px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft011{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft012{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
	.ft013{font-size:11px;line-height:20px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page324-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a324.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">13-18&#160;Vol. 1</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">MANAGING STATE&#160;USING THE XSAVE FEATURE SET</p>
<p style="position:absolute;top:100px;left:93px;white-space:nowrap" class="ft08">Depending&#160;on details of the&#160;operating&#160;system, an&#160;execution of XSAVEOPT&#160;by a&#160;user application might&#160;use the&#160;<br/>modified&#160;optimization when&#160;the&#160;most&#160;recent&#160;execution&#160;of XRSTOR&#160;was by a&#160;different application.&#160;Because&#160;of&#160;<br/>this, Intel&#160;recommends the&#160;application software not use&#160;the&#160;XSAVEOPT instruction.</p>
<p style="position:absolute;top:157px;left:68px;white-space:nowrap" class="ft08">The&#160;MXCSR register&#160;and MXCSR_MASK&#160;are part of SSE&#160;st<a href="o_7281d5ea06a5b67a-315.html">ate (see Section 13.5.2</a>)&#160;and are thus associated&#160;with&#160;<br/>bit&#160;1&#160;of&#160;RFBM. However,&#160;the&#160;XSAVEOPT instruction also&#160;saves these values when RFBM[2]&#160;=&#160;1&#160;(even if&#160;RFBM[1]&#160;=&#160;<br/>0).&#160;The init&#160;and modified optimizations do not apply to&#160;the MXCSR&#160;register and&#160;MXCSR_MASK.</p>
<p style="position:absolute;top:246px;left:68px;white-space:nowrap" class="ft03">13.10&#160;&#160;OPERATION OF&#160;XSAVEC</p>
<p style="position:absolute;top:282px;left:68px;white-space:nowrap" class="ft09">The operation of XSAVEC is&#160;similar to&#160;that&#160;of&#160;XSAVE.&#160;Two main differences are (1)&#160;XSAVEC&#160;uses&#160;the compacted&#160;<br/>format for the&#160;extended region of the&#160;XSAVE area;&#160;and&#160;(2)&#160;XSAVEC&#160;uses the&#160;init optimization (s<a href="o_7281d5ea06a5b67a-318.html">ee&#160;Section&#160;13.6).&#160;<br/></a>Unlike XSAVEOPT,&#160;XSAVEC does&#160;not use&#160;the&#160;modified&#160;optimization.&#160;S<a href="o_7281d5ea06a5b67a-308.html">ee Section 13.2&#160;</a>for&#160;details of how&#160;to determine&#160;<br/>whether XSAVEC&#160;is supported.<br/>The XSAVEC instruction takes a&#160;single&#160;memory operand, which is&#160;an&#160;XSAVE&#160;area. In&#160;addition, the&#160;register pair&#160;<br/>EDX:EAX&#160;is an implicit operand&#160;used&#160;as a&#160;state-componen<a href="o_7281d5ea06a5b67a-307.html">t bitmap (see Section 13.1) called the&#160;</a><b>instruction&#160;<br/>mask</b>.&#160;The logical (bitwise) AND&#160;of&#160;XCR0&#160;and the instruction mask is the&#160;<b>requested-feature bitmap</b>&#160;(<b>RFBM</b>) of&#160;<br/>the user&#160;state&#160;components to&#160;be&#160;saved.<br/>The following conditions&#160;cause execution&#160;of&#160;the XSAVEC&#160;instruction&#160;to&#160;generate a&#160;fault:</p>
<p style="position:absolute;top:451px;left:68px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:451px;left:93px;white-space:nowrap" class="ft02">If the XSAVE feature&#160;set&#160;is not enabled (CR4.OSXSAVE&#160;=&#160;0), an invalid-opcode exception&#160;(#UD)&#160;occurs.</p>
<p style="position:absolute;top:473px;left:68px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:474px;left:93px;white-space:nowrap" class="ft02">If&#160;CR0.TS[bit&#160;3] is&#160;1,&#160;a device-not-available exception (#NM)&#160;occurs.</p>
<p style="position:absolute;top:496px;left:68px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:496px;left:93px;white-space:nowrap" class="ft02">If the address of&#160;the XSAVE area is&#160;not&#160;64-byte&#160;aligned,&#160;a general-protection exception&#160;(#GP)&#160;occurs.</p>
<p style="position:absolute;top:494px;left:780px;white-space:nowrap" class="ft06">1</p>
<p style="position:absolute;top:520px;left:68px;white-space:nowrap" class="ft08">If none of&#160;these conditions&#160;cause&#160;a fault,&#160;execution of&#160;XSAVEC writes&#160;the&#160;XSTATE_BV&#160;field&#160;of the&#160;XSAVE&#160;header&#160;<br/><a href="o_7281d5ea06a5b67a-313.html">(see&#160;Section 13.4.2),</a>&#160;setting&#160;XSTATE_BV[<i>i</i>] (0&#160;≤&#160;<i>i</i>&#160;≤&#160;63) as&#160;follows:</p>
<p style="position:absolute;top:534px;left:514px;white-space:nowrap" class="ft06">2</p>
<p style="position:absolute;top:559px;left:68px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:559px;left:93px;white-space:nowrap" class="ft02">If RFBM[<i>i</i>]&#160;=&#160;&#160;0,&#160;&#160;XSTATE_BV[<i>i</i>] is&#160;written as&#160;0.</p>
<p style="position:absolute;top:581px;left:68px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:582px;left:93px;white-space:nowrap" class="ft08">If RFBM[<i>i</i>]&#160;=&#160;&#160;1,&#160;&#160;XSTATE_BV[<i>i</i>]&#160;is set to&#160;the value of&#160;XINUSE[<i>i</i>] (see below&#160;for&#160;an exception&#160;made for&#160;<br/>XSTATE_B<a href="o_7281d5ea06a5b67a-318.html">V[1]). Section 13.6&#160;</a>defines&#160;XINUSE to&#160;describe&#160;the processor init optimization and specifies the&#160;<br/>initial&#160;configuration of each&#160;state&#160;component. The nature&#160;of&#160;that optimization implies the&#160;following:<br/>—&#160;If state component&#160;<i>i</i>&#160;is&#160;in its&#160;initial configuration, XSTATE_BV[<i>i</i>] may be written with either&#160;0&#160;or 1.<br/>—&#160;If state component&#160;<i>i</i>&#160;is&#160;not in&#160;its initial&#160;configuration,&#160;XSTATE_BV[<i>i</i>]&#160;is written with 1.<br/>XINUSE[1] pertains only to&#160;the state of the&#160;XMM registers&#160;and&#160;not&#160;to MXCSR. However,&#160;if RFBM[1]&#160;=&#160;1&#160;and&#160;<br/>MXCSR does not&#160;have&#160;the&#160;value 1F80H,&#160;XSAVEC&#160;writes XSTATE_BV[1]&#160;as 1&#160;even if XINUSE[1]&#160;=&#160;0.<br/>(As explaine<a href="o_7281d5ea06a5b67a-318.html">d in Section 13.6,&#160;</a>the&#160;initial configurations&#160;of&#160;some&#160;state&#160;components may&#160;depend on whether the&#160;<br/>processor is&#160;in 64-bit mode.)</p>
<p style="position:absolute;top:765px;left:68px;white-space:nowrap" class="ft08">The XSAVEC instructions sets&#160;bit&#160;63 of&#160;the&#160;XCOMP_BV&#160;field&#160;of the&#160;XSAVE&#160;header&#160;while writing RFBM[62:0]&#160;to&#160;<br/>XCOMP_BV[62:0].&#160;The XSAVEC instruction&#160;does not&#160;write any part of the XSAVE&#160;header other than&#160;the&#160;XSTATE_BV&#160;<br/>and XCOMP_BV&#160;fields.<br/>Execution&#160;of XSAVEC saves into&#160;the XSAVE area those&#160;state&#160;components&#160;corresponding to&#160;bits that&#160;are set in&#160;RFBM&#160;<br/>(subject to&#160;the&#160;init optimization described below).&#160;State&#160;components 0&#160;and&#160;1 are located in&#160;the legacy region of&#160;the&#160;<br/>XSAV<a href="o_7281d5ea06a5b67a-312.html">E area (see Section 13.4.1).</a>&#160;Each state component&#160;<i>i</i>, 2&#160;≤&#160;<i>i</i>&#160;≤&#160;62,&#160;is located in the extended region;&#160;the&#160;XSAVEC&#160;</p>
<p style="position:absolute;top:871px;left:68px;white-space:nowrap" class="ft08">instruction&#160;always&#160;uses&#160;the&#160;compacted format&#160;for the&#160;extended&#160;region (see<a href="o_7281d5ea06a5b67a-314.html">&#160;Section 13.4.3)</a>.<br/>Se<a href="o_7281d5ea06a5b67a-314.html">e Section 13.5</a>&#160;for specifics for each state&#160;component&#160;and for details&#160;regarding mode-specific operation&#160;and&#160;<br/>operation determined&#160;by instruction prefixes.&#160;<a href="o_7281d5ea06a5b67a-327.html">See Section 13.13 for detai</a>ls&#160;regarding faults caused by memory&#160;<br/>accesses.<br/>Execution&#160;of XSAVEC performs&#160;the init&#160;optimization&#160;to&#160;reduce&#160;the amount of data written to&#160;memory. If&#160;<br/>XINUSE[<i>i</i>]&#160;=&#160;0, state&#160;component&#160;<i>i</i>&#160;is&#160;not&#160;saved to&#160;the XSAVE area (even if&#160;RFBM[<i>i</i>]&#160;=&#160;1). However,&#160;if RFBM[1] = 1&#160;<br/>and&#160;MXCSR&#160;does&#160;not have&#160;the&#160;value 1F80H,&#160;XSAVEC&#160;writes&#160;saves all&#160;of&#160;state&#160;component 1&#160;(SSE —&#160;including the&#160;</p>
<p style="position:absolute;top:1033px;left:68px;white-space:nowrap" class="ft013">1.&#160;If&#160;CR0.AM&#160;= 1, CPL&#160;=&#160;3, and EFLAGS.AC&#160;=1, an&#160;alignment-check exception (#AC) may occur instead of&#160;#GP.<br/>2.&#160;Unlike&#160;the&#160;XSAVE and&#160;XSAVEOPT instructions, the XSAVEC instruction does&#160;not&#160;read&#160;the&#160;XSTATE_BV&#160;field&#160;of&#160;the&#160;XSAVE&#160;header.</p>
</div>
</body>
</html>
