<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 432</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#000000;}
	.ft06{font-size:16px;font-family:Times;color:#0860a8;}
	.ft07{font-size:14px;font-family:Times;color:#0860a8;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft011{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page432-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a432.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">D-10&#160;Vol. 1</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">GUIDELINES&#160;FOR WRITING X87 FPU EXCEPTION HANDLERS</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft08">The references above to the ERROR# output&#160;from&#160;the x87 FPU apply to the Intel 387 and Intel 287 math&#160;coproces-<br/>sors&#160;(NPX chips).&#160;If&#160;one of these coprocessors encounters an unmasked exception&#160;condition,&#160;it signals&#160;the excep-<br/>tion to&#160;the&#160;Intel&#160;286&#160;or Intel386&#160;processor&#160;using the ERROR# status&#160;line between the&#160;processor&#160;and&#160;the&#160;<br/>coprocessor.&#160;Se<a href="o_7281d5ea06a5b67a-423.html">e&#160;Section&#160;D.1, ‚ÄúMS-DOS Compatibility&#160;Sub-mode&#160;for Handling x87&#160;FPU&#160;Exceptions,‚Äù</a><b>&#160;</b>in this&#160;<br/>appendix, and&#160;<a href="˛ˇ">Chapter 22,&#160;‚ÄúIA-32 Architecture&#160;Compatibility,‚Äù in the&#160;</a><i>Intel¬Æ 64&#160;and&#160;IA-32&#160;Architectures Software&#160;<br/>Developer‚Äôs Manual, Volume&#160;3B,</i>&#160;for differences in&#160;x87 FPU&#160;exception handling.<br/>The&#160;exception-handling&#160;routine is&#160;normally a part of the systems&#160;software. The&#160;routine must clear (or disable) the&#160;<br/>active&#160;exception&#160;flags&#160;in&#160;the x87 FPU&#160;status word before executing any&#160;floating-point instructions that&#160;cannot&#160;<br/>complete&#160;execution when there&#160;is a&#160;pending floating-point&#160;exception. Otherwise, the floating-point&#160;instruction&#160;will&#160;<br/>trigger the&#160;x87 FPU interrupt&#160;again, and&#160;the&#160;system will&#160;be&#160;caught&#160;in&#160;an endless&#160;loop of nested&#160;floating-point&#160;<br/>exceptions, and&#160;hang.&#160;In any&#160;event, the routine must clear&#160;(or disable)&#160;the&#160;active exception&#160;flags in&#160;the x87&#160;FPU&#160;<br/>status word after&#160;handling&#160;them, and before&#160;IRET(D).&#160;Typical&#160;exception responses may include:</p>
<p style="position:absolute;top:311px;left:68px;white-space:nowrap" class="ft05">‚Ä¢</p>
<p style="position:absolute;top:312px;left:93px;white-space:nowrap" class="ft02">Incrementing an&#160;exception counter for&#160;later display&#160;or printing.</p>
<p style="position:absolute;top:334px;left:68px;white-space:nowrap" class="ft05">‚Ä¢</p>
<p style="position:absolute;top:334px;left:93px;white-space:nowrap" class="ft02">Printing or displaying diagnostic information&#160;(e.g.,&#160;the&#160;x87 FPU&#160;environment and&#160;registers).</p>
<p style="position:absolute;top:356px;left:68px;white-space:nowrap" class="ft05">‚Ä¢</p>
<p style="position:absolute;top:357px;left:93px;white-space:nowrap" class="ft08">Aborting further execution, or&#160;using the&#160;exception&#160;pointers to&#160;build&#160;an instruction that will&#160;run&#160;without&#160;<br/>exception&#160;and executing it.</p>
<p style="position:absolute;top:397px;left:68px;white-space:nowrap" class="ft08">Applications programmers should&#160;consult their&#160;operating&#160;system's reference manuals for&#160;the appropriate&#160;system&#160;<br/>response&#160;to&#160;numerical exceptions. For systems programmers,&#160;some details on writing software&#160;exception handlers&#160;<br/>are prov<a href="˛ˇ">ided in&#160;Chapter 6, ‚ÄúInterrupt&#160;and&#160;Exception Handling,‚Äù in&#160;</a>the&#160;<i>Intel¬Æ 64&#160;and&#160;IA-32 Architectures Software&#160;<br/>Developer‚Äôs Manual, Volume&#160;3A,</i>&#160;as well&#160;<a href="o_7281d5ea06a5b67a-434.html">as in Section D.3.4,&#160;‚Äúx87 FPU Exception Handling&#160;Examples,‚Äù&#160;</a>in this&#160;<br/>appendix.<br/>As discussed&#160;<a href="o_7281d5ea06a5b67a-426.html">in Section D.2.1.2, ‚ÄúRecommended&#160;External&#160;Hardware&#160;to Support&#160;the MS-DOS* Compatibility Sub-<br/>mode,‚Äù</a>&#160;some early&#160;FERR#&#160;to INTR hardware interface&#160;implementations&#160;are&#160;less robust than the&#160;recommended&#160;<br/>circuit. This is&#160;because they&#160;depended&#160;on&#160;the exception&#160;handler to&#160;clear&#160;the x87 FPU&#160;exception interrupt request to&#160;<br/>the PIC&#160;(by accessing&#160;port&#160;0F0H)&#160;<b>before</b>&#160;the&#160;handler causes&#160;FERR# to&#160;be&#160;de-asserted by clearing the&#160;exception&#160;<br/>from&#160;the x87 FPU itself.&#160;To&#160;eliminate&#160;the&#160;chance of a&#160;problem with this early&#160;hardware, Intel recommends that x87&#160;<br/>FPU&#160;exception&#160;handlers always access port&#160;0F0H before&#160;clearing&#160;the error condition from the&#160;x87&#160;FPU.</p>
<p style="position:absolute;top:620px;left:68px;white-space:nowrap" class="ft06">D.3.3 &#160;</p>
<p style="position:absolute;top:620px;left:148px;white-space:nowrap" class="ft06">Synchronization Required for Use of&#160;x87 FPU Exception Handlers</p>
<p style="position:absolute;top:651px;left:68px;white-space:nowrap" class="ft08">Concurrency or&#160;synchronization&#160;management requires a&#160;check for exceptions&#160;before&#160;letting&#160;the&#160;processor change&#160;<br/>a&#160;value&#160;just&#160;used&#160;by&#160;the&#160;x87&#160;FPU.&#160;It&#160;is&#160;important&#160;to&#160;remember that&#160;almost any numeric&#160;instruction can, under the&#160;<br/>wrong circumstances, produce a&#160;numeric exception.&#160;</p>
<p style="position:absolute;top:728px;left:68px;white-space:nowrap" class="ft07">D.3.3.1 &#160;</p>
<p style="position:absolute;top:728px;left:152px;white-space:nowrap" class="ft07">Exception Synchronization: What, Why,&#160;and When</p>
<p style="position:absolute;top:757px;left:68px;white-space:nowrap" class="ft08">Exception&#160;synchronization&#160;means that the exception handler inspects and&#160;deals&#160;with&#160;the exception&#160;in the&#160;context&#160;<br/>in which&#160;it occurred. If concurrent&#160;execution is allowed,&#160;the&#160;state&#160;of&#160;the processor when&#160;it recognizes&#160;the&#160;exception&#160;<br/>is often&#160;<b>not</b>&#160;in the context in which it occurred. The processor&#160;may have changed&#160;many&#160;of its internal registers and&#160;<br/>be&#160;executing&#160;a totally&#160;different program by the time&#160;the exception occurs. If&#160;the exception handler cannot recap-<br/>ture the original&#160;context, it&#160;cannot reliably&#160;determine the&#160;cause of the&#160;exception or&#160;recover&#160;successfully from&#160;the&#160;<br/>exception. To&#160;handle this situation, the&#160;x87 FPU has special registers updated at the&#160;start of each numeric&#160;instruc-<br/>tion to&#160;describe the&#160;state&#160;of&#160;the numeric&#160;program&#160;when the failed instruction was&#160;attempted.&#160;<br/>This provides tools to help the&#160;exception handler&#160;recapture&#160;the original context, but the application code must also&#160;<br/>be&#160;written with&#160;synchronization in mind. Overall, exception&#160;synchronization must ensure&#160;that the&#160;x87 FPU and&#160;<br/>other&#160;relevant parts of the&#160;context are&#160;in a&#160;well defined state when the&#160;handler is&#160;invoked&#160;after an&#160;unmasked&#160;<br/>numeric exception occurs.&#160;<br/>When the x87 FPU signals an unmasked exception condition, it is requesting help. The fact that the exception was&#160;<br/>unmasked&#160;indicates&#160;that further numeric&#160;program execution&#160;under the&#160;arithmetic&#160;and programming rules&#160;of&#160;the&#160;<br/>x87&#160;FPU will probably yield invalid results.&#160;Thus the&#160;exception must be handled, and with&#160;proper&#160;synchronization,&#160;<br/>or&#160;the program will not&#160;operate reliably.<br/>For programmers using&#160;higher-level languages,&#160;all required synchronization is&#160;automatically&#160;provided by the&#160;<br/>appropriate compiler.&#160;However,&#160;for&#160;assembly language&#160;programmers exception synchronization&#160;remains&#160;the&#160;<br/>responsibility of the&#160;programmer.&#160;It is not uncommon&#160;for&#160;a programmer to expect&#160;that their numeric program will&#160;</p>
</div>
</body>
</html>
