<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 322</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;font-family:Times;color:#000000;}
	.ft06{font-size:18px;font-family:Times;color:#000000;}
	.ft07{font-size:8px;font-family:Times;color:#000000;}
	.ft08{font-size:16px;font-family:Times;color:#0860a8;}
	.ft09{font-size:14px;font-family:Times;color:#000000;}
	.ft010{font-size:18px;font-family:Times;color:#0860a8;}
	.ft011{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft012{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
	.ft013{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft014{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft015{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page322-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_7281d5ea06a5b67a322.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">13-16&#160;Vol. 1</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">MANAGING STATE&#160;USING THE XSAVE FEATURE SET</p>
<p style="position:absolute;top:100px;left:93px;white-space:nowrap" class="ft011">If&#160;XSTATE_BV[1]&#160;=&#160;0,&#160;the compacted form XRSTOR&#160;initializes&#160;MXCSR to 1F80H. (This differs from the standard&#160;<br/>from of XRSTOR, which&#160;loads&#160;MXCSR from the&#160;XSAVE&#160;area&#160;whenever either RFBM[1] or&#160;RFBM[2]&#160;is set.)<br/>State&#160;component&#160;<i>i</i>&#160;is&#160;set to&#160;its initial&#160;configuration as&#160;indicated above if&#160;RFBM[<i>i</i>]&#160;=&#160;1 and XSTATE_BV[<i>i</i>]&#160;=&#160;&#160;0&#160;&#160;—&#160;<br/><b>even&#160;if XCOMP_BV[<i>i</i></b><b>]&#160;=&#160;&#160;0</b>.&#160;This is&#160;true for all&#160;values&#160;of&#160;<i>i</i>,&#160;including&#160;0&#160;(x87&#160;state) and&#160;1&#160;(SSE state).</p>
<p style="position:absolute;top:178px;left:68px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:178px;left:93px;white-space:nowrap" class="ft02">If XSTATE_BV[<i>i</i>]&#160;=&#160;1,&#160;the state&#160;component is&#160;loaded with data&#160;from&#160;the XSAVE&#160;area.</p>
<p style="position:absolute;top:176px;left:661px;white-space:nowrap" class="ft07">1</p>
<p style="position:absolute;top:178px;left:668px;white-space:nowrap" class="ft02">&#160;See<a href="o_7281d5ea06a5b67a-314.html">&#160;Section 13.5&#160;</a>for&#160;</p>
<p style="position:absolute;top:195px;left:93px;white-space:nowrap" class="ft011">specifics for each state&#160;component&#160;and for&#160;details&#160;regarding mode-specific operation&#160;and operation&#160;determined&#160;<br/>by instruction prefixes.&#160;Se<a href="o_7281d5ea06a5b67a-327.html">e Section 13.13 for&#160;</a>details&#160;regarding faults caused&#160;by&#160;memory accesses.<br/>State components 0 and&#160;1 are located in the legacy region of&#160;the&#160;XSAVE area (see<a href="o_7281d5ea06a5b67a-312.html">&#160;Section 13.4.1). Each state&#160;<br/></a>component&#160;<i>i</i>, 2&#160;≤&#160;<i>i</i>&#160;≤&#160;62,&#160;is located in&#160;the extended region; the&#160;compacted&#160;form&#160;of&#160;the XRSTOR instruction uses&#160;</p>
<p style="position:absolute;top:267px;left:93px;white-space:nowrap" class="ft02">the compacted&#160;format for the&#160;extended regi<a href="o_7281d5ea06a5b67a-314.html">on (see Section 13.4.3).</a></p>
<p style="position:absolute;top:291px;left:68px;white-space:nowrap" class="ft011">The&#160;MXCSR register&#160;is part of SSE&#160;state (see&#160;<a href="o_7281d5ea06a5b67a-315.html">Section&#160;13.5.2)&#160;</a>and is&#160;thus&#160;loaded from&#160;memory if RFBM[1]&#160;=&#160;<br/>XSTATE_BV[<i>i</i>]&#160;=&#160;1.&#160;The compacted form of XRSTOR&#160;does&#160;not&#160;consider RFBM[2] (AVX) when&#160;determining whether&#160;<br/>to&#160;update&#160;MXCSR.&#160;(This&#160;is&#160;a&#160;difference&#160;from&#160;the&#160;standard&#160;form&#160;of&#160;XRSTOR.)&#160;The&#160;compacted&#160;form&#160;of&#160;XRSTOR&#160;causes&#160;<br/>a general-protection exception&#160;(#GP) if it&#160;would load MXCSR&#160;with&#160;an illegal value.</p>
<p style="position:absolute;top:391px;left:68px;white-space:nowrap" class="ft08">13.8.3&#160;</p>
<p style="position:absolute;top:391px;left:148px;white-space:nowrap" class="ft08">XRSTOR and the Init and Modified Optimizations</p>
<p style="position:absolute;top:421px;left:68px;white-space:nowrap" class="ft011">Execution&#160;of the&#160;XRSTOR instruction&#160;causes the&#160;processor&#160;to&#160;update&#160;is tracking for the&#160;init&#160;and&#160;modified optimiza-<br/>tions (see<a href="o_7281d5ea06a5b67a-318.html">&#160;Section 13.6</a>).&#160;The following items&#160;provide&#160;details:</p>
<p style="position:absolute;top:460px;left:68px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:460px;left:93px;white-space:nowrap" class="ft014">The&#160;processor&#160;updates&#160;its tracking for the&#160;init optimization as&#160;follows:<br/>—&#160;If&#160;&#160;RFBM[<i>i</i>]&#160;=&#160;&#160;0,&#160;&#160;XINUSE[<i>i</i>]&#160;is not changed.<br/>—&#160;If&#160;&#160;RFBM[<i>i</i>]&#160;=&#160;&#160;1&#160;&#160;and&#160;&#160;XSTATE_BV[<i>i</i>]&#160;=&#160;0, state component&#160;<i>i</i>&#160;may be tracked&#160;as init;&#160;XINUSE[<i>i</i>] may be set&#160;to&#160;</p>
<p style="position:absolute;top:525px;left:119px;white-space:nowrap" class="ft011">0 or 1.&#160;(As noted in<a href="o_7281d5ea06a5b67a-318.html">&#160;Section 13.6,&#160;</a>a&#160;processor need not implement the init optimization for state&#160;component&#160;<br/><i>i</i>;&#160;a processor&#160;that does not&#160;do so&#160;implicitly maintains XINUSE[<i>i</i>]&#160;=&#160;1&#160;at all&#160;times.)</p>
<p style="position:absolute;top:565px;left:93px;white-space:nowrap" class="ft02">—&#160;If&#160;&#160;RFBM[<i>i</i>]&#160;=&#160;&#160;1&#160;&#160;and&#160;&#160;XSTATE_BV[<i>i</i>]&#160;=&#160;1, state component&#160;<i>i</i>&#160;is&#160;tracked&#160;as not init;&#160;XINUSE[<i>i</i>]&#160;is set to&#160;1.</p>
<p style="position:absolute;top:587px;left:68px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:588px;left:93px;white-space:nowrap" class="ft013">The&#160;processor updates its&#160;tracking&#160;for&#160;the&#160;modified optimization&#160;and records information&#160;about the&#160;XRSTOR&#160;<br/>execution for future interaction with the&#160;XSAVEOPT and&#160;XSAVES instructions (see<a href="o_7281d5ea06a5b67a-322.html">&#160;Section 13.9 and&#160;</a><a href="o_7281d5ea06a5b67a-325.html">Section&#160;<br/>13.11) as&#160;</a>follows:<br/>—&#160;If&#160;&#160;RFBM[<i>i</i>]&#160;=&#160;0,&#160;state component&#160;<i>i</i>&#160;is tracked&#160;as modified; XMODIFIED[<i>i</i>] is&#160;set to&#160;1.<br/>—&#160;If&#160;&#160;RFBM[<i>i</i>]&#160;=&#160;1,&#160;state component&#160;<i>i</i>&#160;may be tracked&#160;as unmodified;&#160;XMODIFIED[<i>i</i>] may be set to 0 or 1.&#160;(As&#160;</p>
<p style="position:absolute;top:685px;left:119px;white-space:nowrap" class="ft011">note<a href="o_7281d5ea06a5b67a-318.html">d in Section 13.6,</a>&#160;a processor need&#160;not&#160;implement the&#160;modified optimization for&#160;state component&#160;<i>i</i>; a&#160;<br/>processor&#160;that does not&#160;do so&#160;implicitly maintains XMODIFIED[<i>i</i>]&#160;=&#160;1&#160;at all times.)</p>
<p style="position:absolute;top:726px;left:93px;white-space:nowrap" class="ft02">—&#160;XRSTOR_INFO is&#160;set&#160;to the 4-tuple&#160;</p>
<p style="position:absolute;top:723px;left:355px;white-space:nowrap" class="ft09"></p>
<p style="position:absolute;top:726px;left:360px;white-space:nowrap" class="ft03"><i>w</i>,<i>x</i>,<i>y</i>,<i>z</i></p>
<p style="position:absolute;top:723px;left:407px;white-space:nowrap" class="ft09"></p>
<p style="position:absolute;top:726px;left:413px;white-space:nowrap" class="ft02">, where w is&#160;the CPL (0); x is 1 if&#160;the logical processor is&#160;in VMX&#160;</p>
<p style="position:absolute;top:742px;left:119px;white-space:nowrap" class="ft011">non-root operation and 0&#160;otherwise;&#160;<i>y</i>&#160;is&#160;the&#160;linear&#160;address&#160;of&#160;the XSAVE area;&#160;and&#160;<i>z</i>&#160;is&#160;XCOMP_BV. In&#160;<br/>particular, the standard form&#160;of&#160;XRSTOR always sets&#160;<i>z</i>&#160;to&#160;all zeroes, while the&#160;compacted form of XRSTORS&#160;<br/>never&#160;does&#160;so (because it&#160;sets&#160;at least bit&#160;63 to&#160;1).</p>
<p style="position:absolute;top:831px;left:68px;white-space:nowrap" class="ft010">13.9&#160;</p>
<p style="position:absolute;top:831px;left:147px;white-space:nowrap" class="ft010">OPERATION OF&#160;XSAVEOPT</p>
<p style="position:absolute;top:867px;left:68px;white-space:nowrap" class="ft011">The operation of XSAVEOPT is&#160;similar to&#160;that&#160;of&#160;XSAVE.&#160;Unlike XSAVE, XSAVEOPT&#160;uses the&#160;init optimization (by&#160;<br/>which&#160;it may&#160;omit&#160;saving state&#160;components that are&#160;in their&#160;initial&#160;configuration) and&#160;the modified optimization&#160;(by&#160;<br/>which&#160;it may&#160;omit saving state components&#160;that have&#160;not been&#160;modified&#160;since&#160;the&#160;last&#160;execution of XRSTOR);&#160;see&#160;<br/><a href="o_7281d5ea06a5b67a-318.html">Section 13.6.</a>&#160;S<a href="o_7281d5ea06a5b67a-308.html">ee Section 13.2 for details of ho</a>w&#160;to determine whether XSAVEOPT is&#160;supported.<br/>The&#160;XSAVEOPT instruction takes a&#160;single&#160;memory&#160;operand,&#160;which is&#160;an XSAVE&#160;area.&#160;In addition,&#160;the register&#160;pair&#160;<br/>EDX:EAX&#160;is an implicit operand&#160;used&#160;as a&#160;state-componen<a href="o_7281d5ea06a5b67a-307.html">t bitmap (see Section 13.1) called the&#160;</a><b>instruction&#160;<br/>mask</b>.&#160;The logical (bitwise) AND&#160;of&#160;XCR0&#160;and the instruction mask is the&#160;<b>requested-feature bitmap</b>&#160;(<b>RFBM</b>) of&#160;<br/>the user&#160;state&#160;components to&#160;be&#160;saved.</p>
<p style="position:absolute;top:1038px;left:68px;white-space:nowrap" class="ft02">1.&#160;Earlier fault checking&#160;ensured that,&#160;if&#160;the&#160;instruction&#160;has reached this&#160;point&#160;in&#160;execution&#160;and XSTATE_BV[<i>i</i>]&#160;is 1, then&#160;XCOMP_BV[<i>i</i>] is&#160;</p>
<p style="position:absolute;top:1054px;left:89px;white-space:nowrap" class="ft02">also&#160;1.</p>
</div>
</body>
</html>
