<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1222</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:16px;font-family:Times;color:#0860a8;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#0860a8;}
	.ft06{font-size:12px;font-family:Times;color:#0860a8;}
	.ft07{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1222-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1222.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">31-12&#160;Vol. 3C</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">VIRTUAL-MACHINE MONITOR PROGRAMMING CONSIDERATIONS</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft07">processor's current VMCS should&#160;be modified by any logical processor or DMA. Before updating one&#160;of&#160;these struc-<br/>tures, the VMM must ensure that no&#160;logical processor whose&#160;current&#160;VMCS references&#160;the&#160;structure is in VMX&#160;non-<br/>root operation.&#160;<br/>If a&#160;VMM uses&#160;multiple VMCS&#160;with&#160;each VMCS using&#160;separate&#160;external structures, and&#160;these&#160;structures&#160;must be&#160;<br/>kept&#160;synchronized, the&#160;VMM must apply the&#160;same care&#160;to&#160;updating&#160;these structures.</p>
<p style="position:absolute;top:224px;left:68px;white-space:nowrap" class="ft03">31.8.5 CPUID&#160;</p>
<p style="position:absolute;top:224px;left:202px;white-space:nowrap" class="ft03">Emulation</p>
<p style="position:absolute;top:255px;left:68px;white-space:nowrap" class="ft07">CPUID reports information&#160;that&#160;is used&#160;by OS&#160;and applications to detect&#160;hardware features. It&#160;also provides&#160;multi-<br/>threading/multi-core&#160;configuration information. For example, MP-aware&#160;OSs rely&#160;on data&#160;reported by&#160;CPUID to&#160;<br/>discover the&#160;topology of&#160;logical processors in&#160;a platform&#160;(see&#160;<a href="o_fe12b1e2a880e0ce-289.html">Section&#160;8.9,&#160;‚ÄúProgramming Considerations&#160;for Hard-<br/>ware Multi-Threading&#160;Capable Processors,‚Äù</a><a href="˛ˇ">&#160;in the&#160;<i>Intel¬Æ 64&#160;and IA-32&#160;Architectures&#160;Software Developer‚Äôs&#160;Manual,&#160;<br/>Volume 3A</i></a>).&#160;<br/>If a&#160;VMM is&#160;to support&#160;asymmetric&#160;allocation of logical&#160;processor resources to&#160;guest OSs that&#160;are MP aware, then&#160;<br/>the VMM must emulate CPUID&#160;for its&#160;guests.&#160;The emulation&#160;of CPUID by the VMM&#160;must ensure&#160;the guest‚Äôs view of&#160;<br/>CPUID leaves&#160;are consistent&#160;with&#160;the logical processor allocation&#160;committed by the&#160;VMM to&#160;each guest OS.</p>
<p style="position:absolute;top:433px;left:68px;white-space:nowrap" class="ft05">31.9&#160;</p>
<p style="position:absolute;top:433px;left:147px;white-space:nowrap" class="ft05">32-BIT AND 64-BIT GUEST ENVIRONMENTS</p>
<p style="position:absolute;top:469px;left:68px;white-space:nowrap" class="ft07">For the most part, extensions&#160;provided by&#160;VMX&#160;to support&#160;virtualization are orthogonal&#160;to the extensions&#160;provided&#160;<br/>by&#160;Intel 64 architecture.&#160;There&#160;are considerations that&#160;impact&#160;VMM designs. These are&#160;described in the&#160;following&#160;<br/>subsections.</p>
<p style="position:absolute;top:553px;left:68px;white-space:nowrap" class="ft03">31.9.1&#160;</p>
<p style="position:absolute;top:553px;left:148px;white-space:nowrap" class="ft03">Operating Modes of&#160;Guest Environments</p>
<p style="position:absolute;top:583px;left:68px;white-space:nowrap" class="ft07">For&#160;Intel 64&#160;processors,&#160;VMX operation supports host and&#160;guest&#160;environments&#160;that run in IA-32e mode or without&#160;<br/>IA-32e&#160;mode.&#160;VMX operation also&#160;supports&#160;host&#160;and&#160;guest environments&#160;on IA-32&#160;processors.&#160;<br/>A&#160;VMM&#160;entering&#160;VMX operation while IA-32e&#160;mode&#160;is&#160;active&#160;is&#160;considered&#160;to be&#160;an&#160;IA-32e&#160;mode&#160;host.&#160;A VMM&#160;<br/>entering VMX operation while&#160;IA-32e&#160;mode&#160;is not activated or&#160;not&#160;available&#160;is referred&#160;to&#160;as a&#160;32-bit VMM. The type&#160;<br/>of guest operations&#160;such&#160;VMMs support are&#160;summarize<a href="o_fe12b1e2a880e0ce-1222.html">d in Table 31-1</a>.</p>
<p style="position:absolute;top:819px;left:68px;white-space:nowrap" class="ft07">A&#160;VM&#160;exit may occur to&#160;an IA-32e&#160;mode&#160;guest in either&#160;64-bit sub-mode or&#160;compatibility sub-mode of IA-32e&#160;<br/>mode.&#160;VMMs may&#160;resume guests&#160;in either mode. The sub-mode in which an&#160;IA-32e mode guest resumes VMX non-<br/>root operation is determined&#160;by&#160;the attributes of the code&#160;segment which&#160;experienced&#160;the VM&#160;exit. If CS.L&#160;=&#160;1,&#160;the&#160;<br/>guest&#160;is executing in&#160;64-bit mode;&#160;if CS.L&#160;=&#160;0,&#160;the guest&#160;is executing in&#160;compatibility&#160;<a href="o_fe12b1e2a880e0ce-1224.html">mode (see Section 31.9.5).<br/></a>Not&#160;all&#160;of&#160;an&#160;IA-32e&#160;mode&#160;VMM&#160;must&#160;run&#160;in&#160;64-bit&#160;mode.&#160;While&#160;some&#160;parts&#160;of&#160;an&#160;IA-32e&#160;mode&#160;VMM&#160;must&#160;run&#160;in&#160;64-<br/>bit mode, there are&#160;only&#160;a few restrictions preventing&#160;a&#160;VMM from executing in compatibility mode.&#160;The most&#160;<br/>notable&#160;restriction is&#160;that most VMX instructions cause&#160;exceptions when executed&#160;in compatibility mode.&#160;</p>
<p style="position:absolute;top:976px;left:68px;white-space:nowrap" class="ft03">31.9.2&#160;</p>
<p style="position:absolute;top:976px;left:148px;white-space:nowrap" class="ft03">Handling Widths of&#160;VMCS Fields</p>
<p style="position:absolute;top:1006px;left:68px;white-space:nowrap" class="ft07">Individual VMCS&#160;control fields must be&#160;accessed using VMREAD&#160;or VMWRITE instructions.&#160;Outside of&#160;64-Bit&#160;mode,&#160;<br/>VMREAD&#160;and&#160;VMWRITE operate&#160;on 32 bits of data.&#160;The widths of VMCS&#160;control&#160;fields&#160;may vary depending&#160;on&#160;<br/>whether a processor supports Intel 64&#160;architecture.</p>
<p style="position:absolute;top:698px;left:240px;white-space:nowrap" class="ft06">Table 31-1.&#160;&#160;Operating Modes&#160;for&#160;Host&#160;and&#160;Guest Environments</p>
<p style="position:absolute;top:720px;left:72px;white-space:nowrap" class="ft02">Capability</p>
<p style="position:absolute;top:720px;left:265px;white-space:nowrap" class="ft02">Guest Operation&#160;</p>
<p style="position:absolute;top:735px;left:265px;white-space:nowrap" class="ft02">in IA-32e mode</p>
<p style="position:absolute;top:720px;left:529px;white-space:nowrap" class="ft02">Guest Operation&#160;</p>
<p style="position:absolute;top:735px;left:529px;white-space:nowrap" class="ft02">Not&#160;Requiring IA-32e Mode</p>
<p style="position:absolute;top:757px;left:72px;white-space:nowrap" class="ft02">IA-32e&#160;mode VMM</p>
<p style="position:absolute;top:757px;left:265px;white-space:nowrap" class="ft02">Yes</p>
<p style="position:absolute;top:757px;left:529px;white-space:nowrap" class="ft02">Yes</p>
<p style="position:absolute;top:780px;left:72px;white-space:nowrap" class="ft02">32-bit VMM</p>
<p style="position:absolute;top:780px;left:265px;white-space:nowrap" class="ft02">Not&#160;supported</p>
<p style="position:absolute;top:780px;left:529px;white-space:nowrap" class="ft02">Yes</p>
</div>
</body>
</html>
