<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1921</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:18px;font-family:Times;color:#0860a8;}
	.ft04{font-size:16px;font-family:Times;color:#0860a8;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1921-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1921.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:767px;white-space:nowrap" class="ft00">Vol. 3D&#160;42-3</p>
<p style="position:absolute;top:47px;left:438px;white-space:nowrap" class="ft01">INTEL® SGX INTERACTIONS WITH IA32&#160;AND INTEL® 64&#160;ARCHITECTURE</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft05">segmentation, enclaves&#160;abide&#160;by&#160;all the paging policies set&#160;up&#160;by the&#160;OS, but they can be more restrictive than the&#160;<br/>OS.<br/>All the&#160;memory operands passed&#160;into&#160;Intel SGX instructions&#160;are interpreted as offsets within the DS segment, and&#160;<br/>the linear addresses&#160;generated&#160;by combining&#160;these offsets&#160;with DS&#160;segment register&#160;are&#160;subject to&#160;paging-based&#160;<br/>access&#160;control&#160;if&#160;paging is&#160;enabled&#160;at the&#160;time&#160;of the&#160;execution of&#160;the leaf&#160;function.<br/>Since the ENCLU[EENTER] and&#160;ENCLU[ERESUME] can&#160;only&#160;be&#160;executed when paging is&#160;enabled,&#160;and&#160;since paging&#160;<br/>cannot&#160;be disabled&#160;by software running&#160;inside&#160;an&#160;enclave&#160;(recall&#160;that enclaves always run with CPL&#160;=&#160;3),&#160;enclave&#160;<br/>execution is&#160;always subject&#160;to&#160;paging-based access control.&#160;The&#160;Intel SGX access&#160;control itself&#160;is implemented&#160;as&#160;<br/>an extension to&#160;the existing paging modes.&#160;Se<a href="o_fe12b1e2a880e0ce-1772.html">e Section 38.5&#160;for de</a>tails.<br/>Execution of Intel SGX&#160;instructions&#160;may set accessed&#160;and dirty flags&#160;on&#160;accesses to&#160;EPC&#160;pages that do not fault&#160;<br/>even&#160;if&#160;the instruction later causes&#160;a fault for&#160;some&#160;other reason.&#160;</p>
<p style="position:absolute;top:339px;left:69px;white-space:nowrap" class="ft03">42.5 INTERACTIONS&#160;</p>
<p style="position:absolute;top:339px;left:293px;white-space:nowrap" class="ft03">WITH&#160;</p>
<p style="position:absolute;top:339px;left:348px;white-space:nowrap" class="ft03">VMX</p>
<p style="position:absolute;top:373px;left:69px;white-space:nowrap" class="ft05">Intel SGX functionality&#160;(including&#160;SGX1 and SGX2) can be&#160;made available&#160;to software&#160;running&#160;in either&#160;VMX&#160;root&#160;<br/>operation&#160;or VMX non-root&#160;operation,&#160;as long&#160;as the&#160;processor&#160;is using&#160;a legal mode&#160;of operation (see<a href="o_fe12b1e2a880e0ce-1919.html">&#160;Section&#160;<br/>42.1).</a>&#160;<br/>A VMM has&#160;the flexibility to configure&#160;a&#160;VMCS to&#160;permit a&#160;guest&#160;to&#160;use any subset of&#160;the&#160;ENCLS leaf functions. Avail-<br/>ability of the&#160;ENCLU&#160;leaf functions&#160;in VMX non-root&#160;operation&#160;has&#160;the same&#160;requirement as&#160;ENCLU leaf&#160;functions&#160;<br/>outside of a&#160;virtualized environment.<br/>Details of the&#160;VMCS control&#160;to allow VMM to&#160;configure&#160;support of Intel SGX&#160;in&#160;VMX&#160;non-root operation&#160;is described&#160;<br/><a href="o_fe12b1e2a880e0ce-1921.html">in Section 42.5.1</a></p>
<p style="position:absolute;top:551px;left:69px;white-space:nowrap" class="ft04">42.5.1&#160;</p>
<p style="position:absolute;top:551px;left:149px;white-space:nowrap" class="ft04">VMM Controls to&#160;Configure Guest Support of&#160;Intel® SGX</p>
<p style="position:absolute;top:580px;left:69px;white-space:nowrap" class="ft05">Intel SGX capabilities are primarily exposed to&#160;the software via&#160;the CPUID instruction. VMMs&#160;can virtualize&#160;CPUID&#160;<br/>instruction&#160;to expose/hide&#160;this capability to/from guests.<br/>Some of Intel&#160;SGX&#160;resources are exposed/controlled&#160;via model-specific&#160;registers (see<a href="o_fe12b1e2a880e0ce-1768.html">&#160;Section 37.7</a>).&#160;VMMs can&#160;<br/>virtualize these MSRs&#160;for&#160;the guests using&#160;the MSR&#160;bitmaps&#160;referenced by pointers in the VMCS.<br/>The VMM&#160;can&#160;partition&#160;the Enclave&#160;Page Cache,&#160;and&#160;assign&#160;various&#160;partitions to&#160;(a subset of)&#160;its guests via the&#160;<br/>usual&#160;memory-virtualization techniques such&#160;as paging or&#160;the extended&#160;page table mechanism (EPT).<br/>The VMM can set the “enable ENCLS&#160;exiting” VM-execution controls&#160;to cause&#160;a VM&#160;exit&#160;when the ENCLS instruction&#160;<br/>is executed in&#160;VMX non-root operation.&#160;If&#160;the “enable ENCLS&#160;exiting” control is&#160;0,&#160;all of the&#160;ENCLS leaf&#160;functions are&#160;<br/>permitted&#160;in&#160;VMX&#160;non-root operation. If&#160;the&#160;“enable&#160;ENCLS exiting”&#160;control is&#160;1,&#160;execution of&#160;ENCLS&#160;leaf functions&#160;<br/>in VMX&#160;non-root&#160;operation&#160;is governed by consulting the&#160;bits in&#160;a new 64-bit&#160;VM-execution&#160;control field&#160;called the&#160;<br/>ENCLS-exiting bitmap&#160;(Each bit in the bitmap corresponds to&#160;an&#160;ENCLS leaf&#160;function with an EAX value that is iden-<br/>tical to the bit’s position). When bits in the “ENCLS-exiting bitmap” are set, attempts to execute the corresponding&#160;<br/>ENCLS&#160;leaf&#160;functions in&#160;VMX&#160;non-root operation causes&#160;VM&#160;exits.&#160;The&#160;checking for these&#160;VM&#160;exits occurs immedi-<br/>ately&#160;after checking&#160;that CPL&#160;=&#160;0.</p>
<p style="position:absolute;top:863px;left:69px;white-space:nowrap" class="ft04">42.5.2&#160;</p>
<p style="position:absolute;top:863px;left:150px;white-space:nowrap" class="ft04">Interactions with the Extended Page Table Mechanism (EPT)</p>
<p style="position:absolute;top:892px;left:69px;white-space:nowrap" class="ft05">Intel SGX&#160;instructions&#160;are fully compatible with&#160;the&#160;extended page-table mechanism&#160;(EPT;&#160;see&#160;<a href="o_fe12b1e2a880e0ce-1149.html">Section&#160;28.2).<br/></a>All the&#160;memory operands passed&#160;into&#160;Intel SGX instructions&#160;are interpreted as offsets within the DS segment, and&#160;<br/>the linear&#160;addresses&#160;generated by combining these offsets&#160;with&#160;DS segment register are&#160;subject&#160;to paging&#160;and EPT.&#160;<br/>As with paging,&#160;enclaves abide&#160;by&#160;all the&#160;policies set&#160;up by&#160;the VMM.<br/>The Intel SGX access control itself is implemented&#160;as an extension to paging&#160;and EPT,&#160;and&#160;may be&#160;more restrictive.&#160;<br/>Se<a href="o_fe12b1e2a880e0ce-1920.html">e Section 42.4&#160;for de</a>tails of&#160;this&#160;extension.<br/>An execution&#160;of&#160;an Intel&#160;SGX instruction&#160;may set&#160;accessed and dirty&#160;flags for&#160;EPT (when enabled;&#160;see&#160;<a href="o_fe12b1e2a880e0ce-1159.html">Section&#160;<br/>28.2.4) on</a>&#160;accesses&#160;to&#160;EPC&#160;pages that do&#160;not fault&#160;or cause VM&#160;exits even&#160;if the&#160;instruction later causes a&#160;fault or&#160;<br/>VM&#160;exit for some&#160;other reason.&#160;</p>
</div>
</body>
</html>
