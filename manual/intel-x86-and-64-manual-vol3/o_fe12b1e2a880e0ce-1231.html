<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1231</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:16px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1231-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1231.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:769px;white-space:nowrap" class="ft00">Vol. 3C&#160;32-3</p>
<p style="position:absolute;top:47px;left:598px;white-space:nowrap" class="ft01">VIRTUALIZATION OF&#160;SYSTEM&#160;RESOURCES</p>
<p style="position:absolute;top:98px;left:69px;white-space:nowrap" class="ft02">32.3.3&#160;</p>
<p style="position:absolute;top:98px;left:150px;white-space:nowrap" class="ft02">Virtualizing Virtual Memory by&#160;Brute Force</p>
<p style="position:absolute;top:129px;left:69px;white-space:nowrap" class="ft04">VMX provides the&#160;hardware&#160;features required to&#160;fully virtualize guest virtual memory accesses. VMX&#160;allows&#160;the&#160;<br/>VMM to trap guest accesses&#160;to&#160;the&#160;PAT (Page Attribute Table) MSR and the MTRR (Memory Type Range Registers).&#160;<br/>This control&#160;allows&#160;the VMM&#160;to virtualize the&#160;specific&#160;memory&#160;type of&#160;a&#160;guest&#160;memory. The&#160;VMM may control&#160;<br/>caching by&#160;controlling the&#160;guest CR0.CRD&#160;and CR0.NW bits,&#160;as well&#160;as by trapping&#160;guest&#160;execution of&#160;the&#160;INVD&#160;<br/>instruction.&#160;The&#160;VMM&#160;can trap guest CR3 loads and&#160;stores,&#160;and&#160;it may trap&#160;guest execution&#160;of&#160;INVLPG.<br/>Because a&#160;VMM must&#160;retain control of physical memory,&#160;it must also retain&#160;control&#160;over&#160;the processor’s&#160;address-<br/>translation mechanisms. Specifically, this&#160;means that&#160;only&#160;the&#160;VMM can access CR3&#160;(which&#160;contains&#160;the base&#160;of the&#160;<br/>page&#160;directory) and can execute INVLPG (the&#160;only&#160;other instruction that&#160;directly&#160;manipulates the&#160;TLB).&#160;<br/>At&#160;the&#160;same time&#160;that the&#160;VMM controls&#160;address translation, a&#160;guest operating system&#160;will&#160;also expect to&#160;perform&#160;<br/>normal&#160;memory&#160;management functions. It&#160;will access&#160;CR3,&#160;execute&#160;INVLPG,&#160;and&#160;modify (what it&#160;believes&#160;to be)&#160;<br/>page&#160;directories&#160;and page&#160;tables.&#160;Virtualization of address&#160;translation&#160;must tolerate&#160;and support guest attempts to&#160;<br/>control&#160;address translation.&#160;<br/>A simple-minded&#160;way to&#160;do this would be&#160;to ensure&#160;that&#160;all guest&#160;attempts to&#160;access address-translation&#160;hardware&#160;<br/>trap to&#160;the&#160;VMM where such operations can be properly&#160;emulated.&#160;It must ensure that&#160;accesses&#160;to page directories&#160;<br/>and&#160;page tables&#160;also get trapped.&#160;This may&#160;be&#160;done&#160;by protecting these in-memory&#160;structures with conventional&#160;<br/>page-based protection.&#160;The VMM&#160;can do&#160;this because&#160;it can locate&#160;the&#160;page&#160;directory&#160;because&#160;its&#160;base&#160;address is&#160;<br/>in CR3 and the&#160;VMM receives&#160;control on any&#160;change&#160;to&#160;CR3; it&#160;can locate&#160;the&#160;page&#160;tables&#160;because their base&#160;<br/>addresses are&#160;in the&#160;page directory.<br/>Such&#160;a straightforward approach is&#160;not necessarily&#160;desirable. Protection of the&#160;in-memory&#160;translation structures&#160;<br/>may be cumbersome. The VMM&#160;may&#160;maintain these structures&#160;with different&#160;values&#160;(e.g.,&#160;different&#160;page&#160;base&#160;<br/>addresses) than guest software. This&#160;means that&#160;there must&#160;be traps on guest attempt to&#160;read&#160;these&#160;structures&#160;<br/>and that&#160;the VMM&#160;must&#160;maintain, in&#160;auxiliary data structures, the&#160;values&#160;to return&#160;to these&#160;reads.&#160;There&#160;must&#160;also&#160;<br/>be&#160;traps&#160;on modifications to&#160;these&#160;structures even if&#160;the&#160;translations they effect&#160;are&#160;never&#160;used. All this&#160;implies&#160;<br/>considerable overhead&#160;that&#160;should be avoided.</p>
<p style="position:absolute;top:589px;left:69px;white-space:nowrap" class="ft02">32.3.4&#160;</p>
<p style="position:absolute;top:589px;left:149px;white-space:nowrap" class="ft02">Alternate Approach to&#160;Memory Virtualization</p>
<p style="position:absolute;top:619px;left:69px;white-space:nowrap" class="ft04">Guest software is&#160;allowed to&#160;freely modify the&#160;guest&#160;page-table hierarchy without&#160;causing&#160;traps to the VMM.&#160;<br/>Because of&#160;this,&#160;the active page-table hierarchy might&#160;not&#160;always be consistent&#160;with&#160;the guest hierarchy.&#160;Any&#160;<br/>potential problems arising from&#160;inconsistencies&#160;can be solved&#160;using techniques analogous&#160;to those&#160;used&#160;by&#160;the&#160;<br/>processor and&#160;its TLB.<br/>This section describes&#160;an alternative approach that&#160;allows&#160;guest&#160;software&#160;to&#160;freely access&#160;page directories&#160;and&#160;<br/>page&#160;tables. Traps occur on&#160;CR3&#160;accesses and&#160;executions&#160;of INVLPG. They also&#160;occur&#160;when&#160;necessary to&#160;ensure&#160;<br/>that guest&#160;modifications&#160;to the&#160;translation structures actually take effect. The&#160;software&#160;mechanisms to support this&#160;<br/>approach are collectively called&#160;virtual TLB. This&#160;is&#160;because they&#160;emulate the&#160;functionality of&#160;the&#160;processor’s&#160;phys-<br/>ical&#160;translation&#160;look-aside buffer&#160;(TLB).<br/>The basic idea behind the&#160;virtual&#160;TLB&#160;is similar&#160;to that&#160;behind&#160;the processor TLB. While&#160;the page-table&#160;hierarchy&#160;<br/>defines&#160;the relationship between physical&#160;to linear&#160;address,&#160;it does not directly control&#160;the address&#160;translation of&#160;<br/>each memory access. Instead,&#160;translation is controlled by the&#160;TLB, which is occasionally filled by the&#160;processor&#160;with&#160;<br/>translations derived from the&#160;page-table&#160;hierarchy.&#160;With&#160;a virtual TLB,&#160;the&#160;page-table&#160;hierarchy&#160;established&#160;by&#160;<br/>guest&#160;software&#160;(specifically,&#160;the&#160;guest operating&#160;system)&#160;does&#160;not control translation,&#160;either directly or indirectly.&#160;<br/>Instead, translation&#160;is controlled by the&#160;processor&#160;(through its&#160;TLB)&#160;and&#160;by the&#160;VMM (through&#160;a page-table&#160;hier-<br/>archy that&#160;it maintains).<br/>Specifically, the&#160;VMM maintains an&#160;alternative page-table hierarchy that&#160;effectively&#160;caches translations&#160;derived&#160;<br/>from the&#160;hierarchy&#160;maintained by guest software. The remainder&#160;of&#160;this&#160;document refers to&#160;the former as&#160;the&#160;<br/>active&#160;page-table&#160;hierarchy (because it is&#160;referenced by&#160;CR3 and may be used by&#160;the processor to load its&#160;TLB)&#160;and&#160;<br/>the latter as the guest page-table hierarchy (because it is&#160;maintained by guest software). The entries in&#160;the active&#160;<br/>hierarchy&#160;may resemble&#160;the corresponding&#160;entries&#160;in&#160;the guest hierarchy in&#160;some&#160;ways and&#160;may differ&#160;in others.<br/>Guest software is&#160;allowed to&#160;freely modify the&#160;guest&#160;page-table hierarchy without&#160;causing VM&#160;exits to&#160;the VMM.&#160;<br/>Because of&#160;this,&#160;the active page-table hierarchy might&#160;not&#160;always be consistent&#160;with&#160;the guest hierarchy.&#160;Any&#160;<br/>potential problems arising from&#160;any inconsistencies can be&#160;solved using techniques&#160;analogous&#160;to&#160;those used&#160;by the&#160;<br/>processor and&#160;its TLB.&#160;Note the&#160;following:</p>
</div>
</body>
</html>
