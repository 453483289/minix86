<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1803</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:21px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#0860a8;}
	.ft06{font-size:18px;font-family:Times;color:#000000;}
	.ft07{font-size:12px;font-family:Times;color:#0860a8;}
	.ft08{font-size:12px;font-family:Times;color:#000000;}
	.ft09{font-size:16px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft011{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1803-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1803.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:767px;white-space:nowrap" class="ft00">Vol. 3D&#160;40-1</p>
<p style="position:absolute;top:47px;left:685px;white-space:nowrap" class="ft01">ENCLAVE EXITING EVENTS</p>
<p style="position:absolute;top:96px;left:699px;white-space:nowrap" class="ft02">CHAPTER 40</p>
<p style="position:absolute;top:120px;left:553px;white-space:nowrap" class="ft02">ENCLAVE EXITING EVENTS</p>
<p style="position:absolute;top:190px;left:69px;white-space:nowrap" class="ft010">Certain&#160;events, such&#160;as&#160;exceptions&#160;and&#160;interrupts, incident to&#160;(but asynchronous&#160;with) enclave&#160;execution may&#160;<br/>cause&#160;control to&#160;transition outside&#160;of enclave mode. (Most of these also&#160;cause a&#160;change&#160;of&#160;privilege level.) To&#160;<br/>protect the&#160;integrity&#160;and security&#160;of&#160;the&#160;enclave, the&#160;processor will exit&#160;the&#160;enclave&#160;(and enclave mode) before&#160;<br/>invoking&#160;the handler for such&#160;an event.&#160;For&#160;that reason,&#160;such&#160;events&#160;are&#160;called&#160;an&#160;<b>enclave-exiting events</b>&#160;(EEE);&#160;<br/>EEEs include&#160;external&#160;interrupts, non-maskable&#160;interrupts, system-management&#160;interrupts, exceptions, and&#160;VM&#160;<br/>exits.<br/>The process of leaving an&#160;enclave in response&#160;to an EEE is called an&#160;<b>asynchronous enclave exit</b>&#160;(AEX). To&#160;protect&#160;<br/>the&#160;secrecy&#160;of the&#160;enclave, an&#160;AEX saves the&#160;state of certain registers within enclave&#160;memory&#160;and then loads those&#160;<br/>registers with fixed&#160;values&#160;called&#160;<b>synthetic state</b>.</p>
<p style="position:absolute;top:384px;left:69px;white-space:nowrap" class="ft05">40.1&#160;</p>
<p style="position:absolute;top:384px;left:148px;white-space:nowrap" class="ft05">COMPATIBLE SWITCH TO&#160;THE&#160;EXITING&#160;STACK OF&#160;AEX</p>
<p style="position:absolute;top:418px;left:69px;white-space:nowrap" class="ft011">AEXs&#160;load registers&#160;with&#160;a pre-determined synthetic state.&#160;These&#160;register may be later&#160;pushed&#160;onto the&#160;appro-<br/>priate&#160;stack in a&#160;form&#160;as defined&#160;by&#160;the enclave-exiting&#160;event.&#160;To&#160;allow enclave&#160;execution&#160;to resume&#160;after the&#160;<br/>invoking handler&#160;has process the&#160;enclave exiting&#160;event, the&#160;asynchronous&#160;enclave&#160;exit loads the&#160;address of tram-<br/>poline code&#160;outside of the enclave into RIP.&#160;This&#160;trampoline code&#160;eventually returns to the enclave by means of an&#160;<br/>ENCLU(ERESUME) leaf function. Prior to exiting the enclave the RSP and&#160;RBP&#160;registers are restored&#160;to their values&#160;<br/>prior&#160;to enclave entry.<br/>The&#160;stack&#160;to be&#160;used&#160;is&#160;chosen using&#160;the same&#160;rules as&#160;for non-SGX&#160;mode:</p>
<p style="position:absolute;top:545px;left:69px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:546px;left:95px;white-space:nowrap" class="ft03">If there&#160;is&#160;a privilege&#160;level change, the&#160;stack&#160;will be the&#160;one associated&#160;with&#160;the&#160;new ring.&#160;</p>
<p style="position:absolute;top:568px;left:69px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:568px;left:95px;white-space:nowrap" class="ft03">If there&#160;is&#160;no&#160;privilege level&#160;change, the&#160;current application stack is&#160;used.&#160;</p>
<p style="position:absolute;top:590px;left:69px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:591px;left:95px;white-space:nowrap" class="ft03">If the&#160;IA-32e&#160;IST mechanism is&#160;used,&#160;the&#160;exit stack is&#160;chosen using&#160;that method.</p>
<p style="position:absolute;top:1011px;left:247px;white-space:nowrap" class="ft07">Figure&#160;40-1. &#160;Exit Stack Just&#160;After&#160;Interrupt with Stack Switch</p>
<p style="position:absolute;top:789px;left:679px;white-space:nowrap" class="ft03">ENCLU[ERESUME]</p>
<p style="position:absolute;top:853px;left:272px;white-space:nowrap" class="ft08">RAX</p>
<p style="position:absolute;top:726px;left:142px;white-space:nowrap" class="ft09">Current SSA Frame</p>
<p style="position:absolute;top:738px;left:670px;white-space:nowrap" class="ft09">Per-Thread</p>
<p style="position:absolute;top:759px;left:672px;white-space:nowrap" class="ft09">Trampoline&#160;in&#160;uRTS</p>
<p style="position:absolute;top:942px;left:657px;white-space:nowrap" class="ft09">RSP after pushes</p>
<p style="position:absolute;top:696px;left:482px;white-space:nowrap" class="ft03">CSSA</p>
<p style="position:absolute;top:728px;left:483px;white-space:nowrap" class="ft03">AEP</p>
<p style="position:absolute;top:665px;left:511px;white-space:nowrap" class="ft09">TCS</p>
<p style="position:absolute;top:771px;left:487px;white-space:nowrap" class="ft09">Exit Stack</p>
<p style="position:absolute;top:822px;left:524px;white-space:nowrap" class="ft03">SS</p>
<p style="position:absolute;top:846px;left:520px;white-space:nowrap" class="ft03">RSP</p>
<p style="position:absolute;top:870px;left:508px;white-space:nowrap" class="ft03">RFLAGS</p>
<p style="position:absolute;top:894px;left:524px;white-space:nowrap" class="ft03">CS</p>
<p style="position:absolute;top:918px;left:522px;white-space:nowrap" class="ft03">RIP</p>
<p style="position:absolute;top:941px;left:472px;white-space:nowrap" class="ft03">Error Code (optional)</p>
<p style="position:absolute;top:789px;left:200px;white-space:nowrap" class="ft03">uRSP</p>
<p style="position:absolute;top:898px;left:181px;white-space:nowrap" class="ft03">AEP</p>
<p style="position:absolute;top:974px;left:242px;white-space:nowrap" class="ft03">RSP</p>
<p style="position:absolute;top:875px;left:181px;white-space:nowrap" class="ft03">TCS LA</p>
<p style="position:absolute;top:854px;left:148px;white-space:nowrap" class="ft03">ENCLU[ERESUME]</p>
<p style="position:absolute;top:899px;left:272px;white-space:nowrap" class="ft08">RCX</p>
<p style="position:absolute;top:875px;left:272px;white-space:nowrap" class="ft08">RBX</p>
<p style="position:absolute;top:669px;left:255px;white-space:nowrap" class="ft09">Next SSA Frame</p>
<p style="position:absolute;top:732px;left:313px;white-space:nowrap" class="ft03">uRSP</p>
</div>
</body>
</html>
