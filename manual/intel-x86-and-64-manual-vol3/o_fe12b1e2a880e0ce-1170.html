<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1170</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:16px;font-family:Times;color:#0860a8;}
	.ft04{font-size:8px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:17px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1170-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1170.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">29-4&#160;Vol. 3C</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">APIC VIRTUALIZATION&#160;AND&#160;VIRTUAL INTERRUPTS</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft05"><a href="o_fe12b1e2a880e0ce-1169.html">29.1.4,&#160;Section 29.1.5,</a><a href="o_fe12b1e2a880e0ce-1179.html">&#160;and&#160;Section&#160;29.6 for d</a>etails&#160;of&#160;when&#160;evaluation of pending&#160;virtual&#160;interrupts is&#160;performed.&#160;<br/>No other&#160;operations&#160;cause&#160;the evaluation of pending&#160;virtual&#160;interrupts, even if they&#160;modify&#160;RVI&#160;or VPPR.<br/>Evaluation of&#160;pending&#160;virtual&#160;interrupts&#160;uses the&#160;guest&#160;interrupt status&#160;(specifically<a href="o_fe12b1e2a880e0ce-1051.html">, RVI; see Section 24.4.2). The&#160;<br/></a>following pseudocode&#160;details the&#160;evaluation&#160;of pending virtual interrupts:</p>
<p style="position:absolute;top:178px;left:95px;white-space:nowrap" class="ft07">IF&#160;“interrupt-window exiting” is&#160;0 AND<br/>RVI[7:4] &gt; VPPR[7:4] (see&#160;<a href="o_fe12b1e2a880e0ce-1167.html">Section&#160;29.1.1</a>&#160;for definition of&#160;VPPR)</p>
<p style="position:absolute;top:214px;left:142px;white-space:nowrap" class="ft02">THEN&#160;recognize a&#160;pending virtual interrupt;</p>
<p style="position:absolute;top:232px;left:115px;white-space:nowrap" class="ft02">ELSE</p>
<p style="position:absolute;top:250px;left:142px;white-space:nowrap" class="ft02">do&#160;not recognize a&#160;pending virtual interrupt;</p>
<p style="position:absolute;top:268px;left:95px;white-space:nowrap" class="ft02">FI;</p>
<p style="position:absolute;top:292px;left:68px;white-space:nowrap" class="ft05">Once recognized, a&#160;virtual&#160;interrupt may be&#160;delivered&#160;in&#160;VMX&#160;non-root operation; s<a href="o_fe12b1e2a880e0ce-1170.html">ee&#160;Section&#160;29.2.2</a>.<br/>Evaluation of pending&#160;virtual&#160;interrupts&#160;is caused only by&#160;VM&#160;entry,&#160;TPR virtualization, EOI virtualization,&#160;self-IPI&#160;<br/>virtualization,&#160;and&#160;posted-interrupt processing. No other&#160;operations do&#160;so,&#160;even&#160;if&#160;they modify RVI or&#160;VPPR.&#160;The&#160;<br/>logical processor ceases recognition of&#160;a&#160;pending virtual&#160;interrupt following the&#160;delivery of a&#160;virtual&#160;interrupt.</p>
<p style="position:absolute;top:400px;left:68px;white-space:nowrap" class="ft03">29.2.2 Virtual-Interrupt&#160;</p>
<p style="position:absolute;top:400px;left:285px;white-space:nowrap" class="ft03">Delivery</p>
<p style="position:absolute;top:430px;left:68px;white-space:nowrap" class="ft05">If a virtual&#160;interrupt has been recognized<a href="o_fe12b1e2a880e0ce-1169.html">&#160;(see Section 29.2.1), it is deliv</a>ered&#160;at an instruction boundary when&#160;the&#160;<br/>following&#160;conditions all&#160;hold: (1) RFLAGS.IF&#160;=&#160;1; (2) there&#160;is&#160;no&#160;blocking&#160;by&#160;STI;&#160;(3)&#160;there&#160;is&#160;no&#160;blocking&#160;by&#160;MOV&#160;<br/>SS&#160;or&#160;by POP&#160;SS;&#160;and (4)&#160;the&#160;“interrupt-window&#160;exiting” VM-execution control&#160;is 0.<br/>Virtual-interrupt&#160;delivery has&#160;the same&#160;priority&#160;as&#160;that of VM&#160;exits due to&#160;the 1-setting&#160;of&#160;the “interrupt-window&#160;<br/>exiting” VM-execution control.</p>
<p style="position:absolute;top:501px;left:270px;white-space:nowrap" class="ft04">2</p>
<p style="position:absolute;top:504px;left:277px;white-space:nowrap" class="ft02">&#160;Thus, non-maskable&#160;interrupts (NMIs) and higher priority&#160;events&#160;take priority over&#160;</p>
<p style="position:absolute;top:520px;left:68px;white-space:nowrap" class="ft05">delivery of a&#160;virtual interrupt; delivery of a&#160;virtual&#160;interrupt&#160;takes priority&#160;over&#160;external interrupts&#160;and lower priority&#160;<br/>events.<br/>Virtual-interrupt delivery&#160;wakes&#160;a logical processor from the&#160;same inactive&#160;activity&#160;states as&#160;would an&#160;external&#160;<br/>interrupt.&#160;Specifically, it&#160;wakes&#160;a logical processor from the&#160;states&#160;entered using&#160;the HLT and&#160;MWAIT instructions.&#160;<br/>It does not&#160;wake&#160;a logical processor in the&#160;shutdown&#160;state or&#160;in the&#160;wait-for-SIPI&#160;state.<br/>Virtual-interrupt&#160;delivery updates the&#160;guest interrupt status&#160;(both&#160;RVI&#160;and&#160;SVI; se<a href="o_fe12b1e2a880e0ce-1051.html">e Section 24.4.2)&#160;</a>and&#160;delivers&#160;an&#160;<br/>event&#160;within VMX non-root&#160;operation without&#160;a VM&#160;exit.&#160;The&#160;following pseudocode details the&#160;behavior of virtual-<br/>interrupt&#160;delivery&#160;(see<a href="o_fe12b1e2a880e0ce-1167.html">&#160;Section 29.1.1&#160;</a>for&#160;definition of VISR,&#160;VIRR,&#160;and&#160;VPPR):</p>
<p style="position:absolute;top:672px;left:95px;white-space:nowrap" class="ft02">Vector&#160;←&#160;RVI;</p>
<p style="position:absolute;top:690px;left:95px;white-space:nowrap" class="ft02">VISR[Vector]&#160;←&#160;1;</p>
<p style="position:absolute;top:708px;left:95px;white-space:nowrap" class="ft02">SVI&#160;←&#160;Vector;</p>
<p style="position:absolute;top:726px;left:95px;white-space:nowrap" class="ft02">VPPR&#160;←&#160;Vector &amp; F0H;</p>
<p style="position:absolute;top:744px;left:95px;white-space:nowrap" class="ft02">VIRR[Vector]&#160;←&#160;0;</p>
<p style="position:absolute;top:762px;left:95px;white-space:nowrap" class="ft02">IF any bits&#160;set in VIRR</p>
<p style="position:absolute;top:780px;left:115px;white-space:nowrap" class="ft02">THEN&#160;RVI&#160;←&#160;highest index of bit set in VIRR</p>
<p style="position:absolute;top:798px;left:115px;white-space:nowrap" class="ft02">ELSE RVI&#160;←&#160;0;</p>
<p style="position:absolute;top:816px;left:95px;white-space:nowrap" class="ft07">FI;<br/>deliver&#160;interrupt with&#160;Vector&#160;through IDT;<br/>cease recognition of any pending virtual&#160;interrupt;</p>
<p style="position:absolute;top:876px;left:68px;white-space:nowrap" class="ft05">If a&#160;logical processor is&#160;in enclave mode,&#160;an Asynchronous&#160;Enclave Exit (AEX) occurs&#160;before&#160;delivery of a&#160;virtual&#160;<br/><a href="o_fe12b1e2a880e0ce-1803.html">interrupt (see Chapter&#160;40, “Enclave&#160;Exiting Events”).</a></p>
<p style="position:absolute;top:1038px;left:68px;white-space:nowrap" class="ft02">2.&#160;A logical processor never&#160;recognizes&#160;or&#160;delivers&#160;a&#160;virtual interrupt if&#160;the “interrupt-window&#160;exiting”&#160;VM-execution&#160;control is 1.&#160;</p>
<p style="position:absolute;top:1054px;left:89px;white-space:nowrap" class="ft02">Because of&#160;this, the relative&#160;priority of&#160;virtual-interrupt delivery&#160;and VM&#160;exits due&#160;to&#160;the 1-setting of&#160;that&#160;control is not defined.</p>
</div>
</body>
</html>
