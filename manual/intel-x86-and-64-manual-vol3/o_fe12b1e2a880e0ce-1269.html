<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1269</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:8px;font-family:Times;color:#000000;}
	.ft04{font-size:18px;font-family:Times;color:#0860a8;}
	.ft05{font-size:11px;font-family:Times;color:#000000;}
	.ft06{font-size:16px;font-family:Times;color:#0860a8;}
	.ft07{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1269-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1269.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:761px;white-space:nowrap" class="ft00">Vol. 3C&#160;34-19</p>
<p style="position:absolute;top:47px;left:666px;white-space:nowrap" class="ft01">SYSTEM&#160;MANAGEMENT&#160;MODE</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft02">IA32_SMM_MONITOR_CTL[bit&#160;2]&#160;is 1 (see<a href="o_fe12b1e2a880e0ce-1274.html">&#160;Section 34.15.5 for d</a>etails regarding this&#160;MSR).</p>
<p style="position:absolute;top:98px;left:680px;white-space:nowrap" class="ft03">1</p>
<p style="position:absolute;top:100px;left:687px;white-space:nowrap" class="ft02"><a href="o_fe12b1e2a880e0ce-1279.html">&#160;Section 34.15.7&#160;iden-</a></p>
<p style="position:absolute;top:117px;left:69px;white-space:nowrap" class="ft08">tifies&#160;a case in&#160;which SMIs&#160;may be blocked&#160;when&#160;VMXOFF is&#160;executed.<br/>Not all&#160;processors&#160;allow&#160;this bit to be&#160;set to&#160;1. Software&#160;should&#160;consult the&#160;VMX&#160;capability MSR IA32_VMX_MISC&#160;<br/><a href="o_fe12b1e2a880e0ce-1947.html">(see Appendix A.6)&#160;</a>to determine&#160;whether this is&#160;allowed.</p>
<p style="position:absolute;top:213px;left:69px;white-space:nowrap" class="ft04">34.15&#160;&#160;DUAL-MONITOR TREATMENT OF&#160;SMIs AND SMM</p>
<p style="position:absolute;top:249px;left:69px;white-space:nowrap" class="ft08">Dual-monitor treatment&#160;is activated through the&#160;cooperation of the&#160;<b>executive monitor</b>&#160;(the VMM that&#160;operates&#160;<br/>outside of SMM&#160;to provide basic virtualization)&#160;and the&#160;<b>SMM-transfer monitor</b>&#160;(<b>STM</b>; the&#160;VMM that&#160;operates&#160;<br/>inside SMM—while in VMX operation—to support system-management functions). Control is transferred to the STM&#160;<br/>through&#160;VM&#160;exits; VM&#160;entries&#160;are&#160;used to&#160;return from SMM.<br/>The&#160;dual-monitor&#160;treatment may not be supported&#160;by all&#160;processors. Software&#160;should consult&#160;the&#160;VMX capability&#160;<br/>MSR IA32_VMX_BASIC (see<a href="o_fe12b1e2a880e0ce-1943.html">&#160;Appendix&#160;A.1)&#160;</a>to&#160;determine&#160;whether it&#160;is supported.</p>
<p style="position:absolute;top:389px;left:69px;white-space:nowrap" class="ft06">34.15.1&#160;&#160;Dual-Monitor Treatment Overview</p>
<p style="position:absolute;top:420px;left:69px;white-space:nowrap" class="ft08">The dual-monitor treatment&#160;uses&#160;an&#160;executive monitor and an&#160;SMM-transfer monitor (STM). Transitions from the&#160;<br/>executive monitor or its guests to the STM are called&#160;<b>SMM VM&#160;exits</b>&#160;and&#160;are discussed&#160;<a href="o_fe12b1e2a880e0ce-1269.html">in Section 34.15.2.</a>&#160;SMM&#160;<br/>VM&#160;exits&#160;are&#160;caused&#160;by&#160;SMIs&#160;as&#160;well&#160;as&#160;executions&#160;of VMCALL in VMX root operation. The&#160;latter allow the executive&#160;<br/>monitor to&#160;call the&#160;STM for service.<br/>The&#160;STM runs in&#160;VMX root&#160;operation&#160;and uses&#160;VMX&#160;instructions&#160;to establish a&#160;VMCS and&#160;perform VM&#160;entries to&#160;its&#160;<br/>own&#160;guests. This&#160;is done&#160;all&#160;inside&#160;SMM (see<a href="o_fe12b1e2a880e0ce-1271.html">&#160;Section 34.15.3)</a>.&#160;The STM&#160;returns from SMM,&#160;not by using&#160;the&#160;RSM&#160;<br/>instruction,&#160;but&#160;by using&#160;a VM&#160;entry&#160;that returns from&#160;SMM. Such&#160;VM&#160;entries are&#160;described<a href="o_fe12b1e2a880e0ce-1272.html">&#160;in Section 34.15.4.<br/></a>Initially, there is no STM and the defaul<a href="o_fe12b1e2a880e0ce-1266.html">t treatment (Section&#160;34.14) is used. Th</a>e dual-monitor&#160;treatment is not used&#160;<br/>until&#160;it is&#160;enabled and&#160;activated. The steps to&#160;do this are&#160;described<a href="o_fe12b1e2a880e0ce-1274.html">&#160;in Section 34.15.5</a>&#160;and&#160;<a href="o_fe12b1e2a880e0ce-1276.html">Section&#160;34.15.6.<br/></a>It is&#160;not possible to&#160;leave&#160;VMX&#160;operation&#160;under the&#160;dual-monitor treatment;&#160;VMXOFF&#160;will&#160;fail if executed. The&#160;dual-<br/>monitor&#160;treatment must be deactivated first.&#160;The&#160;STM deactivates dual-monitor treatment using&#160;a VM&#160;entry&#160;that&#160;<br/>returns from SMM with the&#160;“deactivate&#160;dual-monitor treatment”&#160;VM-entry&#160;control set&#160;to 1&#160;(see<a href="o_fe12b1e2a880e0ce-1279.html">&#160;Section 34.15.7</a>).<br/>The&#160;executive&#160;monitor configures&#160;any VMCS&#160;that&#160;it&#160;uses&#160;for VM&#160;exits to&#160;the&#160;executive&#160;monitor.&#160;SMM&#160;VM&#160;exits,&#160;which&#160;<br/>transfer&#160;control to&#160;the STM, use&#160;a different&#160;VMCS. Under&#160;the dual-monitor treatment, each logical&#160;processor&#160;uses&#160;<br/>a separate&#160;VMCS called the&#160;<b>SMM-transfer VMCS</b>. When&#160;the dual-monitor treatment&#160;is&#160;active, the&#160;logical&#160;<br/>processor&#160;maintains&#160;another VMCS pointer called the&#160;<b>SMM-transfer VMCS pointer</b>.&#160;The SMM-transfer&#160;VMCS&#160;<br/>pointer&#160;is established&#160;when&#160;the dual-monitor treatment is&#160;activated.</p>
<p style="position:absolute;top:764px;left:69px;white-space:nowrap" class="ft06">34.15.2 SMM&#160;</p>
<p style="position:absolute;top:764px;left:192px;white-space:nowrap" class="ft06">VM&#160;Exits</p>
<p style="position:absolute;top:795px;left:69px;white-space:nowrap" class="ft08">An&#160;SMM&#160;VM&#160;exit&#160;is a&#160;VM&#160;exit&#160;that begins outside&#160;SMM and that ends in&#160;SMM.<br/>Unlike other&#160;VM&#160;exits, SMM&#160;VM&#160;exits&#160;can begin in&#160;VMX root&#160;operation. SMM&#160;VM&#160;exits&#160;result from the&#160;arrival of an&#160;<br/>SMI outside SMM or&#160;from&#160;execution of VMCALL in&#160;VMX root operation&#160;outside SMM. Execution of VMCALL in&#160;VMX&#160;<br/>root operation causes&#160;an SMM VM&#160;exit only if the&#160;valid&#160;bit is&#160;set&#160;in&#160;the IA32_SMM_MONITO<a href="o_fe12b1e2a880e0ce-1274.html">R_CTL MSR (see Section&#160;<br/>34.15.5).<br/></a>Execution&#160;of&#160;VMCALL&#160;in VMX root operation causes an SMM&#160;VM&#160;exit&#160;even&#160;under&#160;the default treatment.&#160;This&#160;SMM&#160;<br/>VM&#160;exit activates&#160;the dual-monitor&#160;<a href="o_fe12b1e2a880e0ce-1276.html">treatment (see Section 34.15.6).<br/></a>Differences&#160;between&#160;SMM VM&#160;exits and&#160;other VM&#160;exits are&#160;detailed&#160;in Se<a href="o_fe12b1e2a880e0ce-1270.html">ctions 34.15.2.1&#160;through 34</a><a href="o_fe12b1e2a880e0ce-1271.html">.15.2.5.</a>&#160;<br/>Differences between&#160;SMM VM&#160;exits that&#160;activate&#160;the dual-monitor&#160;treatment and other&#160;SMM VM&#160;exits&#160;are described&#160;<br/><a href="o_fe12b1e2a880e0ce-1276.html">in Section 34.15.6.</a></p>
<p style="position:absolute;top:1038px;left:69px;white-space:nowrap" class="ft02">1.&#160;Setting&#160;IA32_SMM_MONITOR_CTL[bit 2]&#160;to&#160;1&#160;prevents VMXOFF&#160;from&#160;unblocking&#160;SMIs regardless&#160;of&#160;the value of&#160;the register’s valid&#160;</p>
<p style="position:absolute;top:1054px;left:91px;white-space:nowrap" class="ft02">bit (bit&#160;0).</p>
</div>
</body>
</html>
