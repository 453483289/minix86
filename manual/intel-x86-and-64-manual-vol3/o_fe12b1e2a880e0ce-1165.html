<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1165</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:18px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;font-family:Times;color:#ff0000;}
	.ft06{font-size:14px;font-family:Times;color:#0860a8;}
	.ft07{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1165-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1165.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:761px;white-space:nowrap" class="ft00">Vol. 3C&#160;28-17</p>
<p style="position:absolute;top:47px;left:581px;white-space:nowrap" class="ft01">VMX SUPPORT&#160;FOR ADDRESS TRANSLATION</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft07">to&#160;use the&#160;INVVPID instruction to&#160;ensure that&#160;the logical&#160;processor‚Äôs TLBs and&#160;the paging-structure&#160;caches are&#160;<br/>appropriately invalidated.<br/>Requirements of when software&#160;should&#160;use&#160;the INVVPID&#160;instruction depend on the&#160;specific&#160;algorithm being&#160;used&#160;<br/>for page-table&#160;virtualization.&#160;The following items provide guidelines&#160;for&#160;software developers:</p>
<p style="position:absolute;top:179px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:180px;left:95px;white-space:nowrap" class="ft09">Emulation&#160;of&#160;the INVLPG instruction may require&#160;execution of the&#160;INVVPID instruction as&#160;follows:<br/>‚Äî&#160;The INVVPID&#160;type&#160;is individual-address (0).<br/>‚Äî&#160;The VPID&#160;in the&#160;INVVPID&#160;descriptor&#160;is the&#160;one assigned&#160;to the&#160;virtual&#160;processor&#160;whose&#160;execution is&#160;being&#160;</p>
<p style="position:absolute;top:244px;left:120px;white-space:nowrap" class="ft02">emulated.</p>
<p style="position:absolute;top:268px;left:95px;white-space:nowrap" class="ft02">‚Äî&#160;The linear&#160;address in&#160;the INVVPID&#160;descriptor is&#160;that&#160;of&#160;the operand&#160;of&#160;the INVLPG instruction being&#160;</p>
<p style="position:absolute;top:285px;left:120px;white-space:nowrap" class="ft02">emulated.</p>
<p style="position:absolute;top:307px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:307px;left:95px;white-space:nowrap" class="ft010">Some&#160;instructions&#160;invalidate&#160;all&#160;entries in&#160;the&#160;TLBs and&#160;paging-structure&#160;caches‚Äîexcept for global translations.&#160;<br/>An&#160;example is&#160;the&#160;MOV&#160;to CR3 instruction.&#160;(See<a href="o_fe12b1e2a880e0ce-139.html">&#160;Section&#160;4.10, ‚ÄúCaching Translation Information‚Äù&#160;</a>in&#160;th<a href="˛ˇ">e&#160;<i>Intel¬Æ&#160;<br/>64&#160;and IA-32 Architectures Software&#160;Developer‚Äôs&#160;Manual, Volume 3A</i></a></p>
<p style="position:absolute;top:340px;left:556px;white-space:nowrap" class="ft05"><a href="˛ˇ"><i>&#160;</i></a></p>
<p style="position:absolute;top:340px;left:559px;white-space:nowrap" class="ft02">for details&#160;regarding global&#160;translations.)&#160;</p>
<p style="position:absolute;top:357px;left:95px;white-space:nowrap" class="ft09">Emulation&#160;of&#160;such an instruction may require&#160;execution of the&#160;INVVPID instruction as&#160;follows:<br/>‚Äî&#160;The INVVPID&#160;type&#160;is single-context-retaining-globals (3).<br/>‚Äî&#160;The VPID&#160;in the&#160;INVVPID&#160;descriptor&#160;is the&#160;one assigned&#160;to the&#160;virtual&#160;processor&#160;whose&#160;execution is&#160;being&#160;</p>
<p style="position:absolute;top:421px;left:120px;white-space:nowrap" class="ft02">emulated.</p>
<p style="position:absolute;top:443px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:444px;left:95px;white-space:nowrap" class="ft08">Some&#160;instructions invalidate all&#160;entries&#160;in the&#160;TLBs&#160;and paging-structure&#160;caches‚Äîincluding for global&#160;transla-<br/>tions.&#160;An example is&#160;the MOV to&#160;CR4 instruction if the value&#160;of&#160;value&#160;of bit&#160;4&#160;(page global&#160;enable‚ÄîPGE)&#160;is&#160;<br/>changing. Emulation&#160;of such an&#160;instruction&#160;may require execution of the&#160;INVVPID instruction as&#160;follows:<br/>‚Äî&#160;The INVVPID&#160;type&#160;is single-context (1).<br/>‚Äî&#160;The VPID&#160;in the&#160;INVVPID&#160;descriptor&#160;is the&#160;one assigned&#160;to the&#160;virtual&#160;processor&#160;whose&#160;execution is&#160;being&#160;</p>
<p style="position:absolute;top:541px;left:120px;white-space:nowrap" class="ft02">emulated.</p>
<p style="position:absolute;top:565px;left:69px;white-space:nowrap" class="ft09">If EPT&#160;is not&#160;in&#160;use, the&#160;logical processor associates all mappings&#160;it creates with the&#160;current VPID,&#160;and it&#160;will use&#160;<br/>such mappings to translate linear addresses. For that&#160;reason,&#160;a VMM&#160;should not use&#160;the same&#160;VPID&#160;for&#160;different&#160;<br/>non-EPT guests&#160;that use different&#160;page tables. Doing so may result in one guest&#160;using translations that pertain to&#160;<br/>the other.<br/>If&#160;EPT is in&#160;use,&#160;the&#160;instructions enumerated&#160;above might not&#160;be&#160;configured&#160;to cause VM&#160;exits and the&#160;VMM&#160;might&#160;<br/>not be emulating&#160;them.&#160;In&#160;that case,&#160;executions of the&#160;instructions&#160;by guest software&#160;properly invalidate&#160;the&#160;<br/>required&#160;entries&#160;in the TLBs and&#160;paging-structure&#160;caches&#160;(see<a href="o_fe12b1e2a880e0ce-1163.html">&#160;Section 28.3.3.1); ex</a>ecution of the&#160;INVVPID&#160;instruc-<br/>tion&#160;is not required.<br/>If EPT&#160;is in use, the&#160;logical processor associates&#160;all mappings it&#160;creates&#160;with&#160;the&#160;value of bits 51:12 of current&#160;EPTP.&#160;<br/>If a&#160;VMM&#160;uses&#160;different EPTP&#160;values&#160;for&#160;different guests, it&#160;may&#160;use the&#160;same VPID for those&#160;guests. Doing so&#160;<br/>cannot result in&#160;one&#160;guest&#160;using translations&#160;that pertain to&#160;the other.<br/>The following&#160;guidelines apply more&#160;generally&#160;and&#160;are appropriate&#160;even if EPT is&#160;in&#160;use:</p>
<p style="position:absolute;top:791px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:792px;left:95px;white-space:nowrap" class="ft07">As&#160;de<a href="o_fe12b1e2a880e0ce-1176.html">tailed in&#160;Section&#160;29.4.5,&#160;</a>an access to&#160;the APIC-access page&#160;might not cause an&#160;APIC-access&#160;VM&#160;exit&#160;if&#160;<br/>software does not properly invalidate&#160;information that&#160;may be cached from the&#160;paging&#160;structures.&#160;If, at&#160;one&#160;<br/>time,&#160;the&#160;current VPID&#160;on&#160;a logical processor was a&#160;non-zero&#160;value X, it&#160;is&#160;recommended&#160;that software use&#160;the&#160;<br/>INVVPID instruction with the&#160;‚Äúsingle-context‚Äù&#160;INVVPID&#160;type and with VPID X in&#160;the&#160;INVVPID descriptor before&#160;<br/>a VM&#160;entry on&#160;the same&#160;logical&#160;processor that establishes VPID&#160;X and either (a)&#160;the ‚Äúvirtualize APIC accesses‚Äù&#160;<br/>VM-execution control&#160;was changed from 0&#160;to 1;&#160;or&#160;(b)&#160;the&#160;value of the&#160;APIC-access address&#160;was changed.</p>
<p style="position:absolute;top:896px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:897px;left:95px;white-space:nowrap" class="ft07">Software&#160;can&#160;use&#160;the INVVPID instruction with the&#160;‚Äúall-context‚Äù&#160;INVVPID&#160;type&#160;immediately&#160;after execution&#160;of&#160;<br/>the VMXON instruction or immediately prior to execution&#160;of the VMXOFF instruction. Either prevents potentially&#160;<br/>undesired retention of information&#160;cached&#160;from&#160;paging&#160;structures&#160;between&#160;separate&#160;uses of VMX operation.</p>
<p style="position:absolute;top:974px;left:69px;white-space:nowrap" class="ft06">28.3.3.4 &#160;&#160;Guidelines for&#160;Use of&#160;the INVEPT&#160;Instruction</p>
<p style="position:absolute;top:1003px;left:69px;white-space:nowrap" class="ft07">The following items provide guidelines&#160;for use of the INVEPT&#160;instruction&#160;to&#160;invalidate information cached from the&#160;<br/>EPT paging structures.</p>
</div>
</body>
</html>
