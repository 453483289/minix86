<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1111</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:18px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:8px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1111-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1111.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:761px;white-space:nowrap" class="ft00">Vol. 3C&#160;26-19</p>
<p style="position:absolute;top:47px;left:766px;white-space:nowrap" class="ft01">VM&#160;ENTRIES</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:100px;left:95px;white-space:nowrap" class="ft07">The value&#160;pushed&#160;on&#160;the stack for RFLAGS&#160;is&#160;generally&#160;that&#160;which was loaded&#160;from the&#160;guest-state area. The&#160;<br/>value pushed&#160;for&#160;the&#160;RF&#160;flag is&#160;not modified&#160;based&#160;on&#160;the type of event&#160;being&#160;delivered.&#160;However,&#160;the&#160;pushed&#160;<br/>value of&#160;RFLAGS&#160;may be modified&#160;if&#160;a software&#160;interrupt&#160;is being&#160;injected into&#160;a guest that will&#160;be&#160;in&#160;virtual-<br/>8086 mode (see below).&#160;After&#160;RFLAGS&#160;is&#160;pushed&#160;on the stack,&#160;the&#160;value in&#160;the RFLAGS&#160;register is modified&#160;as&#160;<br/>is&#160;done normally when delivering an event through&#160;the&#160;IDT.</p>
<p style="position:absolute;top:188px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:189px;left:95px;white-space:nowrap" class="ft07">The&#160;instruction pointer&#160;that is&#160;pushed&#160;on the&#160;stack depends on the&#160;type&#160;of event and&#160;whether nested&#160;<br/>exceptions occur during its&#160;delivery.&#160;The term&#160;<b>current guest&#160;RIP</b>&#160;refers to&#160;the value to&#160;be&#160;loaded from&#160;the&#160;<br/>guest-state&#160;area. The value pushed&#160;is determined&#160;as follows:</p>
<p style="position:absolute;top:219px;left:506px;white-space:nowrap" class="ft05">1</p>
<p style="position:absolute;top:246px;left:95px;white-space:nowrap" class="ft03">—&#160;If VM&#160;entry&#160;successfully&#160;injects (with no&#160;nested&#160;exception)&#160;an event with&#160;interruption&#160;type&#160;external&#160;</p>
<p style="position:absolute;top:262px;left:120px;white-space:nowrap" class="ft03">interrupt,&#160;NMI, or hardware exception, the&#160;current guest RIP is&#160;pushed&#160;on&#160;the stack.</p>
<p style="position:absolute;top:286px;left:95px;white-space:nowrap" class="ft03">—&#160;If VM&#160;entry&#160;successfully&#160;injects (with no&#160;nested&#160;exception)&#160;an event with&#160;interruption&#160;type&#160;software&#160;</p>
<p style="position:absolute;top:303px;left:120px;white-space:nowrap" class="ft07">interrupt, privileged&#160;software exception, or&#160;software&#160;exception,&#160;the&#160;current guest RIP is&#160;incremented&#160;by&#160;the&#160;<br/>VM-entry instruction length before&#160;being pushed&#160;on&#160;the stack.</p>
<p style="position:absolute;top:343px;left:95px;white-space:nowrap" class="ft03">—&#160;If VM&#160;entry encounters an&#160;exception while injecting&#160;an&#160;event&#160;and&#160;that exception does not cause a&#160;VM&#160;exit,&#160;</p>
<p style="position:absolute;top:360px;left:120px;white-space:nowrap" class="ft07">the&#160;current guest RIP is pushed&#160;on the stack regardless&#160;of event type&#160;or VM-entry instruction length. If the&#160;<br/>encountered exception&#160;does cause a&#160;VM&#160;exit&#160;that&#160;saves&#160;RIP,&#160;the saved RIP is&#160;current guest RIP.</p>
<p style="position:absolute;top:398px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:399px;left:95px;white-space:nowrap" class="ft07">If the&#160;deliver-error-code bit (bit&#160;11) is&#160;set&#160;in the&#160;VM-entry interruption-information&#160;field, the&#160;contents of&#160;the&#160;<br/>VM-entry&#160;exception&#160;error-code field is pushed on the&#160;stack as an error code would be pushed&#160;during delivery of&#160;<br/>an exception.</p>
<p style="position:absolute;top:454px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:454px;left:95px;white-space:nowrap" class="ft07">DR6,&#160;DR7,&#160;and the&#160;IA32_DEBUGCTL&#160;MSR are&#160;not modified&#160;by&#160;event&#160;injection, even&#160;if&#160;the event has&#160;vector&#160;1&#160;<br/>(normal deliveries of debug&#160;exceptions,&#160;which&#160;have&#160;vector&#160;1, do&#160;update these registers).</p>
<p style="position:absolute;top:493px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:493px;left:95px;white-space:nowrap" class="ft07">If VM&#160;entry is&#160;injecting a software&#160;interrupt&#160;and the&#160;guest&#160;will&#160;be&#160;in virtual-8086 mode&#160;(RFLAGS.VM&#160;=&#160;1),&#160;no&#160;<br/>general-protection exception can&#160;occur due&#160;to RFLAGS.IOPL&#160;&lt;&#160;3.&#160;A VM&#160;monitor should&#160;check RFLAGS.IOPL&#160;<br/>before&#160;injecting such&#160;an&#160;event and,&#160;if&#160;desired,&#160;inject&#160;a&#160;general-protection&#160;exception instead of a&#160;software&#160;<br/>interrupt.</p>
<p style="position:absolute;top:565px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:565px;left:95px;white-space:nowrap" class="ft08">If VM&#160;entry is injecting&#160;a software interrupt and the guest&#160;will be in virtual-8086&#160;mode&#160;with virtual-8086 mode&#160;<br/>extensions (RFLAGS.VM&#160;= CR4.VME&#160;=&#160;1), event delivery&#160;is&#160;subject to&#160;VME-based interrupt redirection based&#160;<br/>on the&#160;software interrupt redirection bitmap&#160;in&#160;the task-state segment (TSS) as&#160;follows:<br/>—&#160;If&#160;&#160;bit&#160;<i>n</i>&#160;in the bitmap is clear (where&#160;<i>n</i>&#160;is the&#160;number of&#160;the software interrupt), the interrupt is directed to&#160;</p>
<p style="position:absolute;top:639px;left:120px;white-space:nowrap" class="ft07">an&#160;8086 program interrupt handler:&#160;the processor uses&#160;a 16-bit&#160;interrupt-vector table (IVT)&#160;located&#160;at&#160;<br/>linear&#160;address&#160;zero.&#160;If&#160;the value of&#160;RFLAGS.IOPL&#160;is&#160;less than 3,&#160;the&#160;following&#160;modifications&#160;are&#160;made&#160;to the&#160;<br/>value&#160;of&#160;RFLAGS&#160;that is&#160;pushed&#160;on the&#160;stack: IOPL&#160;is&#160;set&#160;to 3, and&#160;IF is&#160;set&#160;to the&#160;value of VIF.</p>
<p style="position:absolute;top:696px;left:95px;white-space:nowrap" class="ft03">—&#160;If&#160;&#160;bit&#160;<i>n</i>&#160;in the bitmap is set (where&#160;<i>n</i>&#160;is the&#160;number&#160;of&#160;the software interrupt), the interrupt is directed to a&#160;</p>
<p style="position:absolute;top:712px;left:120px;white-space:nowrap" class="ft07">protected-mode interrupt handler.&#160;(In other&#160;words,&#160;the&#160;injection&#160;is treated&#160;as described in&#160;the next item.)&#160;<br/>In&#160;this case,&#160;the&#160;software&#160;interrupt does not&#160;invoke&#160;such&#160;a handler if RFLAGS.IOPL &lt; 3&#160;(a general-<br/>protection exception&#160;occurs&#160;instead).&#160;However,&#160;as&#160;noted above, RFLAGS.IOPL cannot cause&#160;an injected&#160;<br/>software interrupt to&#160;cause such&#160;a&#160;exception.&#160;Thus,&#160;in this case,&#160;the injection&#160;invokes&#160;a protected-mode&#160;<br/>interrupt&#160;handler independent of&#160;the&#160;value of&#160;RFLAGS.IOPL.</p>
<p style="position:absolute;top:801px;left:95px;white-space:nowrap" class="ft03">Injection&#160;of events&#160;of other&#160;types are not&#160;subject to this&#160;redirection.</p>
<p style="position:absolute;top:823px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:823px;left:95px;white-space:nowrap" class="ft07">If VM&#160;entry&#160;is&#160;injecting a software&#160;interrupt (not redirected&#160;as&#160;described&#160;above)&#160;or software&#160;exception, privilege&#160;<br/>checking is&#160;performed on the&#160;IDT descriptor being accessed as&#160;would&#160;be the&#160;case for executions of INT&#160;<i>n</i>, INT3,&#160;<br/>or&#160;INTO&#160;(the&#160;descriptor’s&#160;DPL&#160;cannot&#160;be&#160;less&#160;than&#160;CPL).&#160;There&#160;is&#160;no&#160;checking&#160;of&#160;RFLAGS.IOPL,&#160;even&#160;if&#160;the&#160;guest&#160;<br/>will be&#160;in&#160;virtual-8086&#160;mode. Failure of&#160;this&#160;check may lead&#160;to&#160;a nested&#160;exception. Injection of an&#160;event&#160;with&#160;<br/>interruption type external interrupt,&#160;NMI, hardware exception,&#160;and privileged software exception, or with inter-<br/>ruption type software&#160;interrupt and&#160;being redirected&#160;as described&#160;above,&#160;do&#160;not&#160;perform these&#160;checks.</p>
<p style="position:absolute;top:928px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:928px;left:95px;white-space:nowrap" class="ft07">If VM&#160;entry is&#160;injecting a non-maskable&#160;interrupt (NMI) and&#160;the “virtual&#160;NMIs”&#160;VM-execution control is&#160;1,&#160;<br/>virtual-NMI blocking&#160;is in&#160;effect after&#160;VM&#160;entry.</p>
<p style="position:absolute;top:967px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:967px;left:95px;white-space:nowrap" class="ft07">The&#160;transition causes a last-branch record&#160;to&#160;be&#160;logged&#160;if&#160;the LBR&#160;bit is&#160;set in the IA32_DEBUGCTL MSR.&#160;This&#160;is&#160;<br/>true even&#160;for events&#160;such&#160;as debug&#160;exceptions,&#160;which&#160;normally clear the&#160;LBR bit before delivery.</p>
<p style="position:absolute;top:1054px;left:69px;white-space:nowrap" class="ft03">1.&#160;While these&#160;items refer to&#160;RIP,&#160;the width&#160;of&#160;the&#160;value pushed&#160;(16 bits, 32&#160;bits, or 64 bits) is determined normally.</p>
</div>
</body>
</html>
