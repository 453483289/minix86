<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1687</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:14px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;font-family:Times;color:#000000;}
	.ft06{font-size:12px;font-family:Times;color:#0860a8;}
	.ft07{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
	.ft011{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
	.ft012{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1687-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1687.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:769px;white-space:nowrap" class="ft00">Vol. 3C&#160;36-3</p>
<p style="position:absolute;top:47px;left:685px;white-space:nowrap" class="ft01">INTEL®&#160;PROCESSOR TRACE</p>
<p style="position:absolute;top:281px;left:69px;white-space:nowrap" class="ft02">36.2.1.1 &#160;&#160;Direct Transfer COFI</p>
<p style="position:absolute;top:308px;left:69px;white-space:nowrap" class="ft07">Direct Transfer COFI are&#160;relative&#160;branches.&#160;This means that&#160;their target is&#160;an&#160;IP&#160;whose offset&#160;from the&#160;current IP&#160;is&#160;<br/>embedded in the&#160;instruction bytes. It&#160;is not necessary to&#160;indicate&#160;target of&#160;these instructions in&#160;the trace output&#160;<br/>since it&#160;can be obtained&#160;through&#160;the source&#160;disassembly.&#160;Conditional&#160;branches&#160;need&#160;to indicate&#160;only whether the&#160;<br/>branch&#160;is taken&#160;or not. Unconditional branches&#160;do not need&#160;any recording&#160;in&#160;the trace output. There are&#160;two&#160;sub-<br/>categories:</p>
<p style="position:absolute;top:396px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:397px;left:95px;white-space:nowrap" class="ft07"><b>Conditional&#160;Branch (Jcc,&#160;J*CXZ) and LOOP<br/></b>To&#160;track&#160;this type of instruction,&#160;the processor encodes&#160;a single&#160;bit (taken or not&#160;taken —&#160;TNT)&#160;to indicate the&#160;<br/>program flow&#160;after the&#160;instruction.&#160;<br/>Jcc, J*CXZ,&#160;and LOOP can&#160;be traced with TNT bits. To&#160;improve the trace packet&#160;output efficiency,&#160;the processor&#160;<br/>will&#160;compact several TNT bits into a&#160;single&#160;packet.</p>
<p style="position:absolute;top:499px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:500px;left:95px;white-space:nowrap" class="ft07"><b>Unconditional Direct&#160;Jumps<br/></b>There&#160;is no&#160;trace&#160;output&#160;required for&#160;direct&#160;unconditional&#160;jumps (like&#160;JMP near&#160;relative or&#160;CALL&#160;near&#160;relative)&#160;<br/>since they can&#160;be directly inferred from&#160;the&#160;application&#160;assembly. Direct&#160;unconditional jumps&#160;do&#160;not generate&#160;a&#160;<br/>TNT&#160;bit or a&#160;Target&#160;IP&#160;packet,&#160;though&#160;TIP.PGD&#160;and&#160;TIP.PGE packets&#160;can&#160;be generated by unconditional direct&#160;<br/>jumps&#160;that&#160;toggle Intel&#160;PT<a href="o_fe12b1e2a880e0ce-1690.html">&#160;enables (see Section 36.2.5).</a></p>
<p style="position:absolute;top:618px;left:69px;white-space:nowrap" class="ft02">36.2.1.2 &#160;&#160;Indirect Transfer&#160;COFI</p>
<p style="position:absolute;top:645px;left:69px;white-space:nowrap" class="ft07">Indirect&#160;transfer instructions involve&#160;updating the&#160;IP&#160;from a&#160;register&#160;or memory&#160;location.&#160;Since the&#160;register or&#160;<br/>memory contents can vary at any time&#160;during&#160;execution, there is no&#160;way&#160;to know the target of&#160;the indirect&#160;transfer&#160;<br/>until&#160;the register or memory contents are read. As a result, the disassembled&#160;code is not sufficient to determine the&#160;<br/>target&#160;of this type of COFI. Therefore, tracing hardware must send out the&#160;destination&#160;IP&#160;in&#160;the trace&#160;packet&#160;for&#160;<br/>debug software&#160;to determine&#160;the target address&#160;of the&#160;COFI. Note&#160;that&#160;this&#160;IP&#160;may&#160;be&#160;a linear or effective&#160;address&#160;<br/><a href="o_fe12b1e2a880e0ce-1713.html">(see Section 36.3.1.1).<br/></a>An&#160;indirect&#160;transfer&#160;instruction generates&#160;a Target&#160;IP Packet&#160;(TIP)&#160;that contains&#160;the target address&#160;of&#160;the branch.&#160;<br/>There are two sub-categories:</p>
<p style="position:absolute;top:788px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:789px;left:95px;white-space:nowrap" class="ft07"><b>Near&#160;JMP&#160;Indirect&#160;and Near Call&#160;Indirect<br/></b>As&#160;previously&#160;mentioned,&#160;the&#160;target&#160;of&#160;an&#160;indirect&#160;COFI&#160;resides&#160;in&#160;the&#160;contents&#160;of&#160;either&#160;a&#160;register&#160;or&#160;memory<br/>location. Therefore, the&#160;processor must generate&#160;a packet that includes this&#160;target&#160;address to&#160;allow&#160;the<br/>decoder to determine the program&#160;flow.</p>
<p style="position:absolute;top:866px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:867px;left:95px;white-space:nowrap" class="ft012"><b>Near&#160;RET<br/></b>When a CALL instruction executes, it pushes&#160;onto the stack the address of the next instruction following the<br/>CALL.&#160;Upon completion&#160;of the call&#160;procedure, the&#160;RET instruction&#160;is often used to&#160;pop the&#160;return address off of<br/>the call stack&#160;and&#160;redirect code&#160;flow back to the instruction following the CALL.<br/>A RET instruction&#160;simply transfers program flow to&#160;the address it popped off the&#160;stack. Because a called<br/>procedure may&#160;change the return address on the stack before&#160;executing the&#160;RET instruction,&#160;debug software<br/>can be misled if&#160;it assumes&#160;that code flow will return&#160;to&#160;the instruction following the last&#160;CALL.&#160;Therefore,<br/>even for near RET,&#160;a Target IP Packet may be sent.<br/><b>—&#160;RET&#160;&#160;Compression</b></p>
<p style="position:absolute;top:1042px;left:120px;white-space:nowrap" class="ft07">A&#160;special case is applied if&#160;the&#160;target of the RET is consistent with&#160;what&#160;would&#160;be expected from tracking&#160;the&#160;<br/>CALL stack. If it is&#160;assured&#160;that&#160;the&#160;decoder has&#160;seen&#160;the corresponding CALL&#160;(with&#160;“corresponding”&#160;defined&#160;</p>
<p style="position:absolute;top:148px;left:75px;white-space:nowrap" class="ft03">Unconditional Direct Branch</p>
<p style="position:absolute;top:148px;left:251px;white-space:nowrap" class="ft03">JMP&#160;(E9 xx, EB xx), CALL&#160;(E8 xx)</p>
<p style="position:absolute;top:172px;left:75px;white-space:nowrap" class="ft03">Indirect Branch</p>
<p style="position:absolute;top:172px;left:251px;white-space:nowrap" class="ft03">JMP (FF /4), CALL (FF /2)</p>
<p style="position:absolute;top:196px;left:75px;white-space:nowrap" class="ft03">Near Ret</p>
<p style="position:absolute;top:196px;left:251px;white-space:nowrap" class="ft03">RET (C3, C2&#160;xx)</p>
<p style="position:absolute;top:220px;left:75px;white-space:nowrap" class="ft03">Far Transfers</p>
<p style="position:absolute;top:220px;left:251px;white-space:nowrap" class="ft03">INT3, INTn, INTO, IRET, IRETD, IRETQ,&#160;JMP (EA&#160;xx, FF /5), CALL&#160;(9A xx, FF&#160;/3), RET (CB, CA xx), SYS-</p>
<p style="position:absolute;top:236px;left:251px;white-space:nowrap" class="ft03">CALL,&#160;SYSRET,&#160;SYSENTER,&#160;SYSEXIT,&#160;VMLAUNCH,&#160;VMRESUME</p>
<p style="position:absolute;top:100px;left:289px;white-space:nowrap" class="ft06">Table&#160;36-1.&#160;COFI&#160;Type for Branch Instructions&#160;</p>
<p style="position:absolute;top:124px;left:127px;white-space:nowrap" class="ft03">COFI Type</p>
<p style="position:absolute;top:124px;left:493px;white-space:nowrap" class="ft03">Instructions</p>
</div>
</body>
</html>
