<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 996</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:18px;font-family:Times;color:#0860a8;}
	.ft04{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page996-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce996.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">20-20&#160;Vol. 3B</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">8086&#160;EMULATION</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft04">Method 6 differs from method 5 in that with&#160;the&#160;IOPL value set to less than 3, the VIF and VIP flags in the EFLAGS&#160;<br/>register are&#160;enabled,&#160;providing&#160;virtual interrupt support for handling&#160;class&#160;2&#160;maskable hardware&#160;interrupts&#160;(see&#160;<br/><a href="o_fe12b1e2a880e0ce-991.html">Section 20.3.2,&#160;“Class 2—Maskable&#160;Hardware Interrupt&#160;Handling&#160;in Virtual-8086&#160;Mode&#160;Using&#160;the Virtual Interrupt&#160;<br/>Mechanism”). These flags provid</a>e the&#160;virtual-8086&#160;monitor&#160;with an efficient&#160;means of&#160;handling maskable&#160;hardware&#160;<br/>interrupts that occur during a virtual-8086&#160;mode&#160;task. Also,&#160;because the IOPL&#160;value is&#160;less than 3 and the VIF flag&#160;<br/>is&#160;enabled,&#160;the&#160;information pushed on the&#160;stack by the&#160;processor when invoking the&#160;interrupt&#160;handler is&#160;slightly&#160;<br/>different between methods 5&#160;and 6&#160;(see<a href="o_fe12b1e2a880e0ce-981.html">&#160;Table&#160;20-2).</a></p>
<p style="position:absolute;top:255px;left:68px;white-space:nowrap" class="ft03">20.4 PROTECTED-MODE&#160;</p>
<p style="position:absolute;top:255px;left:326px;white-space:nowrap" class="ft03">VIRTUAL&#160;</p>
<p style="position:absolute;top:255px;left:414px;white-space:nowrap" class="ft03">INTERRUPTS</p>
<p style="position:absolute;top:291px;left:68px;white-space:nowrap" class="ft04">The IA-32 processors (beginning with the&#160;Pentium&#160;processor) also&#160;support&#160;the&#160;VIF and&#160;VIP flags&#160;in the&#160;EFLAGS&#160;<br/>register in&#160;protected&#160;mode&#160;by setting&#160;the&#160;PVI&#160;(protected-mode virtual interrupt) flag&#160;in the&#160;CR4 register.&#160;Setting&#160;<br/>the PVI&#160;flag allows applications running&#160;at privilege level 3 to&#160;execute the&#160;CLI and STI instructions without causing&#160;<br/>a general-protection exception&#160;(#GP)&#160;or&#160;affecting hardware interrupts.&#160;<br/>When the&#160;PVI flag&#160;is set to&#160;1,&#160;the CPL&#160;is&#160;3,&#160;and&#160;the&#160;IOPL&#160;is&#160;less&#160;than&#160;3, the&#160;STI&#160;and&#160;CLI instructions set and&#160;clear&#160;<br/>the VIF&#160;flag in the EFLAGS&#160;register, leaving&#160;IF unaffected.&#160;In&#160;this mode of operation,&#160;an application running&#160;in&#160;<br/>protected mode&#160;and&#160;at a&#160;CPL of&#160;3 can&#160;inhibit interrupts&#160;in&#160;the same&#160;manner&#160;as is&#160;described&#160;<a href="o_fe12b1e2a880e0ce-991.html">in Section 20.3.2, “Class&#160;<br/>2—Maskable Hardware&#160;Interrupt Handling&#160;in Virtual-8086&#160;Mode Using&#160;the Virtual&#160;Interrupt&#160;Mechanism”,&#160;</a>for&#160;a&#160;<br/>virtual-8086&#160;mode&#160;task.&#160;When the application executes&#160;the&#160;CLI instruction, the&#160;processor clears the VIF flag.&#160;If&#160;the&#160;<br/>processor receives a&#160;maskable hardware interrupt, the&#160;processor invokes&#160;the protected-mode interrupt handler.&#160;<br/>This handler&#160;checks&#160;the state&#160;of the&#160;VIF flag&#160;in the EFLAGS register. If the VIF flag is clear (indicating&#160;that&#160;the active&#160;<br/>task does not want&#160;to have&#160;interrupts handled now), the handler sets the VIP flag in the EFLAGS image&#160;on the stack&#160;<br/>and returns&#160;to the&#160;privilege-level 3 application,&#160;which&#160;continues program execution. When the&#160;application executes&#160;<br/>a STI instruction&#160;to set the VIF flag,&#160;the processor&#160;automatically&#160;invokes the general-protection exception handler,&#160;<br/>which can&#160;then&#160;handle the pending&#160;interrupt. After handing&#160;the pending&#160;interrupt, the handler typically sets the&#160;VIF&#160;<br/>flag and clears the VIP&#160;flag in the EFLAGS&#160;image on the&#160;stack and executes&#160;a return to&#160;the&#160;application program.&#160;The&#160;<br/>next time&#160;the&#160;processor receives&#160;a maskable hardware&#160;interrupt, the&#160;processor&#160;will&#160;handle&#160;it in the&#160;normal&#160;manner&#160;<br/>for interrupts received while the&#160;processor&#160;is operating&#160;at a&#160;CPL&#160;of&#160;3.<br/>As&#160;with&#160;the virtual mode&#160;extension (enabled&#160;with&#160;the VME flag&#160;in the&#160;CR4&#160;register),&#160;the&#160;protected-mode&#160;virtual&#160;<br/>interrupt extension only affects&#160;maskable hardware interrupts (interrupt vectors 32 through 255). NMI interrupts&#160;<br/>and&#160;exceptions are handled in&#160;the normal manner.<br/>When protected-mode&#160;virtual interrupts are disabled&#160;(that is,&#160;when the&#160;PVI&#160;flag in&#160;control&#160;register&#160;CR4&#160;is&#160;set&#160;to 0,&#160;<br/>the CPL&#160;is&#160;less&#160;than&#160;3,&#160;or the&#160;IOPL&#160;value is&#160;3),&#160;then&#160;the&#160;CLI and&#160;STI instructions execute in&#160;a manner compatible&#160;<br/>with the&#160;Intel486 processor.&#160;That is, if the&#160;CPL&#160;is greater (less&#160;privileged)&#160;than&#160;the I/O&#160;privilege&#160;level&#160;(IOPL),&#160;a&#160;<br/>general-protection&#160;exception&#160;occurs. If&#160;the IOPL value&#160;is 3,&#160;CLI and&#160;STI&#160;clear&#160;or set&#160;the IF flag, respectively.<br/>PUSHF,&#160;POPF,&#160;IRET and&#160;INT&#160;are&#160;executed&#160;like&#160;in the&#160;Intel486&#160;processor,&#160;regardless of whether&#160;protected-mode&#160;<br/>virtual interrupts are&#160;enabled.<br/>It is only possible to enter virtual-8086 mode through a task&#160;switch or the execution of&#160;an IRET instruction, and it&#160;<br/>is only possible to&#160;leave virtual-8086&#160;mode&#160;by faulting&#160;to&#160;a protected-mode interrupt handler (typically the general-<br/>protection&#160;exception handler,&#160;which&#160;in turn calls&#160;the&#160;virtual 8086-mode monitor).&#160;In both&#160;cases,&#160;the&#160;EFLAGS&#160;<br/>register&#160;is saved&#160;and restored.&#160;This&#160;is not true, however,&#160;in protected&#160;mode&#160;when the&#160;PVI flag&#160;is set and&#160;the&#160;<br/>processor&#160;is not in virtual-8086 mode. Here, it is&#160;possible&#160;to call&#160;a procedure at a&#160;different privilege level, in which&#160;<br/>case&#160;the EFLAGS register&#160;is not&#160;saved or&#160;modified. However,&#160;the&#160;states&#160;of VIF and VIP flags are never examined by&#160;<br/>the processor when the&#160;CPL&#160;is not 3.</p>
</div>
</body>
</html>
