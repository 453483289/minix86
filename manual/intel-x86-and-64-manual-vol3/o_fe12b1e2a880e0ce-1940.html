<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1940</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:16px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1940-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1940.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">43-8&#160;Vol. 3D</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">ENCLAVE CODE&#160;DEBUG&#160;AND PROFILING</p>
<p style="position:absolute;top:98px;left:68px;white-space:nowrap" class="ft02">43.6.3&#160;</p>
<p style="position:absolute;top:98px;left:148px;white-space:nowrap" class="ft02">Performance Monitoring with Opt-out Entry</p>
<p style="position:absolute;top:127px;left:68px;white-space:nowrap" class="ft04">In general, performance monitoring activities are suppressed&#160;when entering&#160;an&#160;opt-out&#160;enclave.&#160;This applies to all&#160;<br/>thread-specific,&#160;configured&#160;performance&#160;monitoring,&#160;except for the&#160;cycle-counting fixed&#160;counter,&#160;<br/>IA32_FIXED_CTR1&#160;and&#160;IA32_FIXED_CTR2.&#160;Upon entering an opt-out enclave, IA32_FIXED_CTR0,&#160;IA32_PMCx will&#160;<br/>stop accumulating counts. Additionally,&#160;if PEBS&#160;is configured&#160;to&#160;capture PEBS&#160;record&#160;for this thread,&#160;PEBS&#160;record&#160;<br/>generation will also&#160;be&#160;suppressed. Consequently, bit 60 of IA32_PERF_GLOBAL_STATUS MSR&#160;is set.<br/>Performance monitoring on&#160;the sibling thread may&#160;also&#160;be affected.&#160;Any&#160;one of IA32_FIXED_CTRx or IA32_PMCx&#160;<br/>on&#160;the sibling thread configured&#160;to monitor thread-specific eventing logic with AnyThread&#160;=1 is&#160;demoted&#160;to count&#160;<br/>only MyThread while&#160;an&#160;opt-out enclave is&#160;executing&#160;on the&#160;other thread.</p>
<p style="position:absolute;top:299px;left:68px;white-space:nowrap" class="ft02">43.6.4&#160;</p>
<p style="position:absolute;top:299px;left:148px;white-space:nowrap" class="ft02">Enclave Exit and Performance Monitoring</p>
<p style="position:absolute;top:328px;left:68px;white-space:nowrap" class="ft04">When&#160;a logical processor&#160;exits an&#160;enclave,&#160;either&#160;via ENCLU[EEXIT] or&#160;via&#160;AEX, all&#160;performance monitoring activity&#160;<br/>(including PEBS)&#160;on&#160;that logical processor that&#160;was suppressed is&#160;unsuppressed.&#160;<br/>Any&#160;counters that were demoted from AnyThread&#160;to MyThread&#160;on the&#160;sibling&#160;thread&#160;are&#160;promoted&#160;back to&#160;<br/>AnyThread.</p>
<p style="position:absolute;top:434px;left:68px;white-space:nowrap" class="ft02">43.6.5&#160;</p>
<p style="position:absolute;top:434px;left:148px;white-space:nowrap" class="ft02">PEBS Record&#160;Generation on Intel® SGX Instructions</p>
<p style="position:absolute;top:463px;left:68px;white-space:nowrap" class="ft04">All&#160;leaf functions of the&#160;ENCLS&#160;instruction&#160;report&#160;“Eventing&#160;RIP” of the&#160;ENCLS instruction&#160;if&#160;a PEBS record is&#160;gener-<br/>ated at&#160;the&#160;end of&#160;the instruction execution. Additionally, the&#160;EGETKEY and&#160;EREPORT leaf&#160;functions of&#160;the ENCLU&#160;<br/>instruction&#160;report&#160;“Eventing RIP” of the&#160;ENCLU instruction if&#160;a PEBS&#160;record&#160;is generated at&#160;the&#160;end of the&#160;instruction&#160;<br/>execution.<br/>If the&#160;EENTER&#160;and ERESUME leaf&#160;functions are performing&#160;an&#160;opt-in entry report “Eventing&#160;RIP”&#160;of&#160;the ENCLU&#160;<br/>instruction&#160;if a&#160;PEBS record is&#160;generated at&#160;the end of the&#160;instruction&#160;execution. On&#160;the&#160;other hand, if&#160;these leaf&#160;<br/>functions are performing&#160;an opt-out&#160;entry,&#160;then these leaf&#160;functions result&#160;in PEBS&#160;being suppressed,&#160;and&#160;no&#160;PEBS&#160;<br/>record&#160;is generated at&#160;the end of these instructions.<br/>A&#160;PEBS record is&#160;generated&#160;if there&#160;is&#160;a PEBS&#160;event&#160;pending at&#160;the end of EEXIT&#160;(due&#160;to a&#160;counter overflowing&#160;<br/>during&#160;enclave&#160;execution or&#160;during EEXIT&#160;execution).&#160;This&#160;PEBS&#160;record contains&#160;the architectural state&#160;of the&#160;<br/>logical processor at&#160;the end of EEXIT.&#160;If&#160;the enclave was&#160;entered via an&#160;opt-in&#160;entry,&#160;then this record reports the&#160;<br/>“Eventing RIP” as&#160;the&#160;linear&#160;address of the&#160;ENCLU[EEXIT]&#160;instruction. If the&#160;enclave was&#160;entered via an&#160;opt-out&#160;<br/>entry,&#160;then&#160;the record reports the&#160;“Eventing RIP”&#160;as&#160;the linear address&#160;of&#160;the ENCLU[EENTER/ERESUME] instruc-<br/>tion that performed the last&#160;enclave&#160;entry.&#160;<br/>A PEBS record is&#160;generated&#160;after the AEX if&#160;there&#160;is a&#160;PEBS&#160;event pending&#160;at the&#160;end&#160;of AEX (due to&#160;a counter&#160;over-<br/>flowing during&#160;enclave execution&#160;or&#160;during&#160;AEX&#160;execution). This&#160;PEBS record contains&#160;the synthetic state of&#160;the&#160;<br/>logical&#160;processor&#160;that is&#160;established at&#160;the end of AEX. For opt-in&#160;entry,&#160;this&#160;record&#160;has the&#160;EVENTING_RIP set to&#160;<br/>the&#160;RIP&#160;saved in&#160;the SSA. For opt-out&#160;entry,&#160;the record has&#160;the EVENTING_RIP&#160;set&#160;to&#160;the&#160;linear address&#160;of&#160;<br/>EENTER/ERESUME used&#160;for the&#160;last enclave&#160;entry.<br/>If the enclave&#160;was entered via an opt-in entry,&#160;then this&#160;record reports the “Eventing&#160;RIP” as the linear address in&#160;<br/>the&#160;SSA&#160;of&#160;the enclave (a.k.a.,&#160;the&#160;“Eventing LIP”&#160;inside&#160;the enclave).&#160;If the&#160;enclave&#160;was&#160;entered&#160;via an opt-out&#160;<br/>entry,&#160;then&#160;the record reports the&#160;“Eventing RIP”&#160;as&#160;the linear address&#160;of&#160;the ENCLU[EENTER/ERESUME] instruc-<br/>tion that performed the last&#160;enclave&#160;entry.<br/>A&#160;second&#160;PEBS&#160;event may be&#160;pended&#160;during&#160;the&#160;Enclave&#160;Exiting Event (EEE). If the&#160;PEBS&#160;event is&#160;taken&#160;at the end&#160;<br/>of delivery&#160;of the&#160;EEE then&#160;the&#160;“Eventing RIP”&#160;in this second PEBS record&#160;is the&#160;linear&#160;address of the&#160;AEP.</p>
<p style="position:absolute;top:940px;left:68px;white-space:nowrap" class="ft02">43.6.6&#160;</p>
<p style="position:absolute;top:940px;left:148px;white-space:nowrap" class="ft02">Exception-Handling on PEBS/BTS Loads/Stores after AEX</p>
<p style="position:absolute;top:969px;left:68px;white-space:nowrap" class="ft04">The operating&#160;system&#160;should allocate sections&#160;of the&#160;DS save&#160;area&#160;from&#160;a non-paged pool,&#160;and mark them&#160;as&#160;<br/>accessed and dirty.&#160;If the loads/stores to any&#160;section&#160;of the&#160;DS&#160;save&#160;area incur faults&#160;then&#160;such faults are reported&#160;<br/>to the OS/VMM immediately,&#160;and generation of&#160;the PEBS/BTS&#160;record is skipped and may leave the buffers in a state&#160;<br/>where they have&#160;a&#160;partial&#160;PEBS&#160;or&#160;BTS records.&#160;<br/>However,&#160;any&#160;events that are detected during PEBS/BTS record&#160;generation at the&#160;end&#160;of&#160;AEX&#160;and&#160;before&#160;delivering&#160;<br/>the Enclave Exiting Event (EEE) cannot be reported immediately to the OS/VMM, as an event window is not open at&#160;</p>
</div>
</body>
</html>
