<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 228</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:12px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:17px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page228-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce228.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">6-42&#160;Vol. 3A</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">INTERRUPT&#160;AND EXCEPTION&#160;HANDLING</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft02">Saved Instruction&#160;Pointer</p>
<p style="position:absolute;top:126px;left:68px;white-space:nowrap" class="ft05">The saved contents&#160;of&#160;CS and EIP&#160;registers generally point&#160;to&#160;the instruction that&#160;generated&#160;the exception. If the&#160;<br/>page-fault exception occurred&#160;during&#160;a task switch, the CS&#160;and EIP registers may point to the first instruction of the&#160;<br/>new task&#160;(as described in&#160;the following “Program&#160;State Change” section).</p>
<p style="position:absolute;top:196px;left:68px;white-space:nowrap" class="ft02">Program State&#160;Change</p>
<p style="position:absolute;top:222px;left:68px;white-space:nowrap" class="ft05">A program-state&#160;change does&#160;not normally accompany&#160;a page-fault&#160;exception, because the&#160;instruction that causes&#160;<br/>the exception&#160;to be generated is&#160;not executed. After&#160;the&#160;page-fault exception handler has&#160;corrected&#160;the violation&#160;<br/>(for&#160;example,&#160;loaded&#160;the missing&#160;page&#160;into memory),&#160;execution of the program or task&#160;can be resumed.<br/>When a&#160;page-fault exception&#160;is generated&#160;during&#160;a task&#160;switch, the&#160;program-state&#160;may change,&#160;as follows. During&#160;<br/>a&#160;task switch,&#160;a page-fault exception&#160;can&#160;occur during&#160;any of following operations:</p>
<p style="position:absolute;top:317px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:318px;left:93px;white-space:nowrap" class="ft03">While writing the&#160;state&#160;of&#160;the original&#160;task into the TSS of that&#160;task.</p>
<p style="position:absolute;top:340px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:340px;left:93px;white-space:nowrap" class="ft03">While&#160;reading&#160;the GDT to&#160;locate the TSS descriptor&#160;of&#160;the new&#160;task.</p>
<p style="position:absolute;top:362px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:363px;left:93px;white-space:nowrap" class="ft03">While&#160;reading&#160;the TSS of&#160;the new task.</p>
<p style="position:absolute;top:385px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:385px;left:93px;white-space:nowrap" class="ft03">While&#160;reading&#160;segment&#160;descriptors associated with segment selectors from the&#160;new&#160;task.</p>
<p style="position:absolute;top:407px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:408px;left:93px;white-space:nowrap" class="ft03">While&#160;reading the&#160;LDT&#160;of the&#160;new&#160;task to&#160;verify&#160;the segment registers stored&#160;in&#160;the new TSS.</p>
<p style="position:absolute;top:432px;left:68px;white-space:nowrap" class="ft05">In the&#160;last&#160;two cases the exception occurs&#160;in the context of the new&#160;task. The instruction&#160;pointer&#160;refers&#160;to the first&#160;<br/>instruction&#160;of the&#160;new&#160;task, not&#160;to the&#160;instruction&#160;which caused&#160;the&#160;task switch (or the&#160;last&#160;instruction&#160;to be&#160;<br/>executed,&#160;in the&#160;case of&#160;an&#160;interrupt).&#160;If the&#160;design of&#160;the operating&#160;system&#160;permits page&#160;faults&#160;to occur during&#160;<br/>task-switches,&#160;the page-fault handler&#160;should be called&#160;through&#160;a task&#160;gate.<br/>If a&#160;page&#160;fault occurs during&#160;a&#160;task&#160;switch, the&#160;processor will&#160;load all&#160;the state information&#160;from&#160;the new TSS&#160;<br/>(without performing any additional&#160;limit, present, or type&#160;checks) before&#160;it generates the&#160;exception. The page-fault&#160;<br/>handler&#160;should thus not rely&#160;on being able to&#160;use the&#160;segment&#160;selectors found in the&#160;CS,&#160;SS, DS,&#160;ES, FS, and GS&#160;<br/>registers without causing&#160;another&#160;exception.&#160;(See the&#160;Program State Chan<a href="o_fe12b1e2a880e0ce-217.html">ge description for “Interrupt 10—Invalid&#160;<br/>TSS Exception (#TS)”&#160;</a>in this&#160;chapter&#160;for&#160;additional&#160;information on how to&#160;handle this&#160;situation.)&#160;</p>
<p style="position:absolute;top:608px;left:68px;white-space:nowrap" class="ft02">Additional&#160;Exception-Handling&#160;Information</p>
<p style="position:absolute;top:634px;left:68px;white-space:nowrap" class="ft05">Special care&#160;should be&#160;taken to ensure&#160;that&#160;an exception that occurs during an explicit stack switch does not cause&#160;<br/>the&#160;processor&#160;to use&#160;an invalid stack pointer (SS:ESP).&#160;Software&#160;written for 16-bit&#160;IA-32 processors often&#160;use a&#160;<br/>pair of instructions&#160;to&#160;change&#160;to&#160;a new&#160;stack, for example:</p>
<p style="position:absolute;top:688px;left:88px;white-space:nowrap" class="ft07">MOV SS,&#160;AX<br/>MOV SP,&#160;StackTop</p>
<p style="position:absolute;top:730px;left:68px;white-space:nowrap" class="ft05">When&#160;executing&#160;this code on one&#160;of the&#160;32-bit IA-32&#160;processors,&#160;it is&#160;possible&#160;to&#160;get a page&#160;fault,&#160;general-protec-<br/>tion fault (#GP), or&#160;alignment check fault&#160;(#AC)&#160;after the&#160;segment selector has been&#160;loaded&#160;into the&#160;SS&#160;register&#160;<br/>but before the&#160;ESP&#160;register has&#160;been&#160;loaded.&#160;At&#160;this&#160;point,&#160;the two parts&#160;of the&#160;stack&#160;pointer&#160;(SS and ESP) are&#160;<br/>inconsistent. The new stack segment is&#160;being used with&#160;the&#160;old stack&#160;pointer.<br/>The processor does not&#160;use&#160;the inconsistent&#160;stack pointer&#160;if the exception&#160;handler switches&#160;to a well defined&#160;stack&#160;<br/>(that&#160;is,&#160;the handler is&#160;a task or&#160;a more&#160;privileged procedure).&#160;However,&#160;if the&#160;exception handler is&#160;called&#160;at the&#160;<br/>same&#160;privilege level&#160;and from the&#160;same task, the&#160;processor will attempt to&#160;use&#160;the&#160;inconsistent stack pointer.<br/>In systems that handle page-fault, general-protection, or&#160;alignment check&#160;exceptions within&#160;the faulting task (with&#160;<br/>trap or interrupt&#160;gates),&#160;software executing at the&#160;same privilege level&#160;as the exception handler should&#160;initialize&#160;a&#160;<br/>new stack&#160;by&#160;using the&#160;LSS instruction rather&#160;than a&#160;pair&#160;of MOV instructions,&#160;as described&#160;earlier in&#160;this note.&#160;<br/>When the&#160;exception handler is&#160;running at&#160;privilege&#160;level&#160;0&#160;(the&#160;normal&#160;case), the&#160;problem is&#160;limited&#160;to procedures&#160;<br/>or tasks that&#160;run&#160;at privilege&#160;level 0,&#160;typically&#160;the kernel of the&#160;operating system.</p>
</div>
</body>
</html>
