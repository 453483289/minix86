<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 754</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:16px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#0860a8;}
	.ft06{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page754-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce754.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">18-118&#160;Vol. 3B</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">PERFORMANCE MONITORING</p>
<p style="position:absolute;top:98px;left:68px;white-space:nowrap" class="ft02">18.22.4&#160;&#160;Event and Time-Stamp Monitoring Software</p>
<p style="position:absolute;top:129px;left:68px;white-space:nowrap" class="ft06">To&#160;use the&#160;performance-monitoring&#160;counters and&#160;time-stamp counter,&#160;the operating&#160;system needs to&#160;provide&#160;an&#160;<br/>event-monitoring&#160;device&#160;driver. This&#160;driver should&#160;include&#160;procedures&#160;for handling&#160;the following&#160;operations:</p>
<p style="position:absolute;top:167px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:168px;left:93px;white-space:nowrap" class="ft03">Feature checking</p>
<p style="position:absolute;top:190px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:190px;left:93px;white-space:nowrap" class="ft03">Initialize and&#160;start counters</p>
<p style="position:absolute;top:212px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:213px;left:93px;white-space:nowrap" class="ft03">Stop counters</p>
<p style="position:absolute;top:235px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:235px;left:93px;white-space:nowrap" class="ft03">Read the&#160;event counters</p>
<p style="position:absolute;top:257px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:258px;left:93px;white-space:nowrap" class="ft03">Read&#160;the time-stamp&#160;counter</p>
<p style="position:absolute;top:282px;left:68px;white-space:nowrap" class="ft06">The event monitor&#160;feature&#160;determination procedure&#160;must&#160;check whether the&#160;current processor&#160;supports&#160;the&#160;perfor-<br/>mance-monitoring counters&#160;and time-stamp counter.&#160;This procedure&#160;compares&#160;the family&#160;and model of&#160;the&#160;<br/>processor returned by the&#160;CPUID&#160;instruction&#160;with&#160;those&#160;of processors known&#160;to&#160;support&#160;performance monitoring.&#160;<br/>(The&#160;Pentium&#160;and&#160;P6&#160;family processors support&#160;performance counters.) The&#160;procedure&#160;also checks the&#160;MSR and&#160;<br/>TSC flags&#160;returned to register EDX by the CPUID instruction to determine if the MSRs and the RDTSC instruction&#160;are&#160;<br/>supported.<br/>The&#160;initialize and&#160;start counters&#160;procedure&#160;sets&#160;the&#160;PerfEvtSel0&#160;and/or&#160;PerfEvtSel1 MSRs&#160;for&#160;the events to&#160;be&#160;<br/>counted and&#160;the method&#160;used&#160;to count them&#160;and initializes&#160;the&#160;counter MSRs&#160;(PerfCtr0&#160;and PerfCtr1) to&#160;starting&#160;<br/>counts.&#160;The&#160;stop counters&#160;procedure stops the performance&#160;counters (see<a href="o_fe12b1e2a880e0ce-753.html">&#160;Section&#160;18.22.3,&#160;“Starting&#160;and&#160;Stopping&#160;<br/>the Performance-Monitoring&#160;Counters”).<br/></a>The&#160;read&#160;counters procedure reads&#160;the&#160;values in&#160;the PerfCtr0 and PerfCtr1&#160;MSRs,&#160;and a&#160;read time-stamp&#160;counter&#160;<br/>procedure&#160;reads the&#160;time-stamp&#160;counter.&#160;These procedures&#160;would be provided&#160;in lieu of enabling&#160;the RDTSC&#160;and&#160;<br/>RDPMC instructions that allow&#160;application&#160;code&#160;to read the&#160;counters.&#160;</p>
<p style="position:absolute;top:545px;left:68px;white-space:nowrap" class="ft02">18.22.5&#160;&#160;Monitoring Counter Overflow</p>
<p style="position:absolute;top:576px;left:68px;white-space:nowrap" class="ft06">The&#160;P6&#160;family processors provide the option&#160;of&#160;generating&#160;a&#160;local APIC interrupt&#160;when&#160;a performance-monitoring&#160;<br/>counter&#160;overflows. This mechanism is&#160;enabled by setting the interrupt enable flag&#160;in either the&#160;PerfEvtSel0 or&#160;the&#160;<br/>PerfEvtSel1 MSR. The primary use&#160;of this option is&#160;for statistical&#160;performance sampling.&#160;<br/>To&#160;use this&#160;option,&#160;the operating&#160;system&#160;should&#160;do the&#160;following&#160;things on&#160;the processor for which&#160;performance&#160;<br/>events&#160;are required&#160;to be monitored:</p>
<p style="position:absolute;top:671px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:672px;left:93px;white-space:nowrap" class="ft03">Provide&#160;an interrupt vector for handling&#160;the counter-overflow interrupt.</p>
<p style="position:absolute;top:694px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:694px;left:93px;white-space:nowrap" class="ft03">Initialize&#160;the APIC PERF&#160;local&#160;vector&#160;entry to&#160;enable&#160;handling of&#160;performance-monitor counter&#160;overflow events.</p>
<p style="position:absolute;top:716px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:717px;left:93px;white-space:nowrap" class="ft06">Provide an entry&#160;in the&#160;IDT that&#160;points to&#160;a stub&#160;exception handler&#160;that returns&#160;without executing any&#160;instruc-<br/>tions.</p>
<p style="position:absolute;top:755px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:756px;left:93px;white-space:nowrap" class="ft06">Provide an&#160;event&#160;monitor driver&#160;that&#160;provides the&#160;actual&#160;interrupt&#160;handler&#160;and modifies the reserved IDT&#160;entry&#160;<br/>to point&#160;to its&#160;interrupt routine.</p>
<p style="position:absolute;top:796px;left:68px;white-space:nowrap" class="ft03">When&#160;interrupted by a&#160;counter overflow,&#160;the interrupt handler&#160;needs&#160;to perform&#160;the following actions:</p>
<p style="position:absolute;top:818px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:819px;left:93px;white-space:nowrap" class="ft06">Save&#160;the&#160;instruction pointer (EIP register), code-segment&#160;selector, TSS segment selector,&#160;counter values and&#160;<br/>other&#160;relevant information&#160;at the&#160;time of the interrupt.</p>
<p style="position:absolute;top:857px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:858px;left:93px;white-space:nowrap" class="ft03">Reset the&#160;counter to&#160;its initial&#160;setting&#160;and return&#160;from&#160;the interrupt.</p>
<p style="position:absolute;top:882px;left:68px;white-space:nowrap" class="ft06">An event monitor application&#160;utility or another application&#160;program can&#160;read the&#160;information collected&#160;for analysis&#160;<br/>of the performance&#160;of&#160;the profiled application.</p>
<p style="position:absolute;top:954px;left:68px;white-space:nowrap" class="ft05">18.23&#160;&#160;PERFORMANCE MONITORING (PENTIUM PROCESSORS)</p>
<p style="position:absolute;top:990px;left:68px;white-space:nowrap" class="ft06">The Pentium processor provides two&#160;40-bit performance&#160;counters, which can be used to&#160;count&#160;events or measure&#160;<br/>duration. The&#160;counters are supported by&#160;three MSRs:&#160;the&#160;control and&#160;event&#160;select MSR (CESR)&#160;and the&#160;perfor-<br/>mance&#160;counter MSRs (CTR0 and&#160;CTR1).&#160;These can be&#160;read from&#160;and written&#160;to using&#160;the RDMSR&#160;and&#160;WRMSR&#160;<br/>instructions,&#160;respectively. They&#160;can be accessed&#160;using these&#160;instructions only&#160;when operating&#160;at privilege&#160;level&#160;0.&#160;</p>
</div>
</body>
</html>
