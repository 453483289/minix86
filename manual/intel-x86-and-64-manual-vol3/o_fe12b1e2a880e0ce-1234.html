<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1234</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:14px;font-family:Times;color:#0860a8;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1234-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1234.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">32-6&#160;Vol. 3C</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">VIRTUALIZATION&#160;OF&#160;SYSTEM&#160;RESOURCES</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft06">nisms can be derived by&#160;VMM developers according to&#160;the&#160;paging behavior defined&#160;<a href="þÿ">in&#160;Chapter 3 of the&#160;<i>IntelÂ®&#160;64&#160;<br/>and IA-32&#160;Architectures&#160;Software Developerâ€™s&#160;Manual,&#160;Volume&#160;3A</i></a>):<br/>1.&#160;First&#160;consult the&#160;active&#160;PDE, which can be located&#160;using&#160;the upper 10 bits of the&#160;faulting address&#160;and the&#160;</p>
<p style="position:absolute;top:157px;left:93px;white-space:nowrap" class="ft07">current value of&#160;CR3. The active&#160;PDE is&#160;the&#160;source of the&#160;fault&#160;if it&#160;is marked not present&#160;or&#160;if its&#160;R/W bit and&#160;<br/>U/S bits are&#160;inconsistent with the&#160;attempted guest access (the&#160;guest&#160;privilege level&#160;and the&#160;values of&#160;CR0.WP&#160;<br/>and&#160;CR4.SMEP should&#160;also be taken into&#160;account).</p>
<p style="position:absolute;top:214px;left:68px;white-space:nowrap" class="ft02">2.&#160;If the active&#160;PDE is&#160;the&#160;source of the fault, consult the corresponding guest PDE&#160;using the same 10&#160;bits from the&#160;</p>
<p style="position:absolute;top:231px;left:93px;white-space:nowrap" class="ft08">faulting address&#160;and the&#160;physical&#160;address that corresponds&#160;to the guest&#160;address in the&#160;guest&#160;CR3. If&#160;the guest&#160;<br/>PDE would&#160;cause&#160;a page&#160;fault&#160;(for example:&#160;it is&#160;marked&#160;not present),&#160;then raise a&#160;page&#160;fault to&#160;the guest&#160;<br/>operating system.&#160;<br/>The following&#160;steps assume that&#160;the guest PDE would not&#160;have&#160;caused a&#160;page fault.</p>
<p style="position:absolute;top:310px;left:68px;white-space:nowrap" class="ft02">3.&#160;If the active&#160;PDE is&#160;the source&#160;of&#160;the fault&#160;and the&#160;guest PDE contains,&#160;as page-table&#160;base&#160;address (if PS&#160;=&#160;0)&#160;</p>
<p style="position:absolute;top:327px;left:93px;white-space:nowrap" class="ft08">or page base address (PS&#160;=&#160;1), a guest address that&#160;the VMM has chosen&#160;not to support; then&#160;raise a machine&#160;<br/>check (or some&#160;other abort) to the&#160;guest&#160;operating system.&#160;<br/>The&#160;following&#160;steps assume that&#160;the guest address&#160;in&#160;the guest PDE is&#160;supported for the&#160;virtual&#160;machine.</p>
<p style="position:absolute;top:390px;left:68px;white-space:nowrap" class="ft02">4.&#160;If the&#160;active&#160;PDE is&#160;marked&#160;not-present,&#160;then&#160;set&#160;the&#160;active&#160;PDE to correspond&#160;to guest&#160;PDE&#160;as follows:</p>
<p style="position:absolute;top:414px;left:93px;white-space:nowrap" class="ft02">a.&#160;If the&#160;active PDE contains a&#160;page-table&#160;base&#160;address&#160;(if PS&#160;=&#160;0), then&#160;allocate an&#160;aligned 4-KByte active&#160;</p>
<p style="position:absolute;top:430px;left:119px;white-space:nowrap" class="ft07">page&#160;table&#160;marked&#160;completely&#160;invalid&#160;and set the&#160;page-table base address&#160;in&#160;the active&#160;PDE&#160;to be the&#160;<br/>physical&#160;address&#160;of the&#160;newly allocated&#160;page&#160;table.</p>
<p style="position:absolute;top:471px;left:93px;white-space:nowrap" class="ft02">b.&#160;If the&#160;active&#160;PDE contains a page&#160;base&#160;address&#160;(if PS&#160;=&#160;1),&#160;then set the&#160;page&#160;base address in the active&#160;PDE&#160;</p>
<p style="position:absolute;top:487px;left:119px;white-space:nowrap" class="ft02">to be&#160;the physical page&#160;base&#160;address that corresponds to the guest&#160;address in&#160;the guest PDE.</p>
<p style="position:absolute;top:511px;left:93px;white-space:nowrap" class="ft06">c.&#160;Set&#160;the P,&#160;U/S,&#160;and PS bits in the active&#160;PDE to&#160;be&#160;identical&#160;to those&#160;in the&#160;guest&#160;PDE.<br/>d.&#160;Set the&#160;PWT,&#160;PCD,&#160;and&#160;G bits according to&#160;the policy&#160;of&#160;the VMM.<br/>e.&#160;Set A&#160;=&#160;1 in&#160;the guest PDE.<br/>f.</p>
<p style="position:absolute;top:583px;left:119px;white-space:nowrap" class="ft07">If&#160;D&#160;=&#160;1 in&#160;the guest PDE or&#160;PS&#160;=&#160;0&#160;(meaning&#160;that this&#160;PDE&#160;refers to&#160;a page&#160;table),&#160;then set the&#160;R/W bit in&#160;<br/>the active PDE as&#160;in the&#160;guest&#160;PDE.</p>
<p style="position:absolute;top:624px;left:93px;white-space:nowrap" class="ft02">g.&#160;If D&#160;=&#160;0&#160;in&#160;the guest PDE,&#160;PS&#160;=&#160;1&#160;(this&#160;is a&#160;4-MByte&#160;page), and the&#160;attempted access is&#160;a write; then&#160;set&#160;</p>
<p style="position:absolute;top:640px;left:119px;white-space:nowrap" class="ft02">R/W in&#160;the active PDE as&#160;in the&#160;guest&#160;PDE&#160;and set D&#160;=&#160;1 in&#160;the guest PDE.</p>
<p style="position:absolute;top:664px;left:93px;white-space:nowrap" class="ft02">h.&#160;If D&#160;=&#160;0 in the guest PDE, PS&#160;=&#160;1, and&#160;the&#160;attempted access is not a write; then set R/W&#160;=&#160;0&#160;in the active&#160;</p>
<p style="position:absolute;top:681px;left:119px;white-space:nowrap" class="ft02">PDE.</p>
<p style="position:absolute;top:705px;left:93px;white-space:nowrap" class="ft02">i.</p>
<p style="position:absolute;top:705px;left:119px;white-space:nowrap" class="ft02">After modifying&#160;the active&#160;PDE, re-execute the&#160;faulting&#160;instruction.&#160;</p>
<p style="position:absolute;top:727px;left:93px;white-space:nowrap" class="ft02">The remaining&#160;steps&#160;assume&#160;that the active PDE is&#160;already&#160;marked&#160;present.</p>
<p style="position:absolute;top:751px;left:68px;white-space:nowrap" class="ft02">5.&#160;If the active&#160;PDE is&#160;the source&#160;of&#160;the fault, the&#160;active&#160;PDE refers to&#160;a&#160;4-MByte&#160;page (PS&#160;=&#160;1), the&#160;attempted&#160;</p>
<p style="position:absolute;top:768px;left:93px;white-space:nowrap" class="ft07">access is&#160;a write; D&#160;=&#160;0 in&#160;the guest PDE,&#160;and the&#160;active&#160;PDE&#160;has caused a fault solely&#160;because&#160;it&#160;has&#160;R/W&#160;=&#160;0;&#160;<br/>then&#160;set R/W&#160;in the active&#160;PDE as&#160;in the&#160;guest&#160;PDE;&#160;set D&#160;=&#160;1 in&#160;the guest PDE,&#160;and re-execute&#160;the faulting&#160;<br/>instruction.</p>
<p style="position:absolute;top:825px;left:68px;white-space:nowrap" class="ft02">6.&#160;If the active&#160;PDE is&#160;the source&#160;of&#160;the fault&#160;and none&#160;of&#160;the above cases apply,&#160;then raise a&#160;page fault of the&#160;</p>
<p style="position:absolute;top:841px;left:93px;white-space:nowrap" class="ft08">guest operating&#160;system.&#160;<br/>The remaining&#160;steps&#160;assume&#160;that the source&#160;of&#160;the original&#160;page fault is&#160;not the&#160;active&#160;PDE.</p>
<p style="position:absolute;top:898px;left:432px;white-space:nowrap" class="ft04">NOTE</p>
<p style="position:absolute;top:924px;left:120px;white-space:nowrap" class="ft07">It&#160;is possible&#160;that the&#160;active&#160;PDE&#160;might be causing&#160;a fault even&#160;though&#160;the guest PDE would not.&#160;<br/>However,&#160;this can happen only if the guest operating system increased access in the guest PDE and&#160;<br/>did&#160;not take&#160;action&#160;to&#160;ensure that&#160;older&#160;translations&#160;were&#160;flushed from&#160;the&#160;TLB.&#160;Such&#160;translations&#160;<br/>might&#160;have caused&#160;a&#160;page&#160;fault if&#160;the&#160;guest software&#160;were running on bare hardware.</p>
<p style="position:absolute;top:1014px;left:68px;white-space:nowrap" class="ft02">7.&#160;If the&#160;active&#160;PDE refers&#160;to a&#160;4-MByte&#160;page&#160;(PS&#160;=&#160;1) but&#160;is not the&#160;source of&#160;the fault,&#160;then the&#160;fault&#160;resulted&#160;</p>
<p style="position:absolute;top:1030px;left:93px;white-space:nowrap" class="ft02">from&#160;an&#160;inconsistency between the&#160;active&#160;page-table hierarchy and the&#160;processorâ€™s TLB.&#160;Since&#160;the transition&#160;to&#160;</p>
</div>
</body>
</html>
