<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 991</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:16px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:14px;font-family:Times;color:#0860a8;}
	.ft06{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page991-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce991.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:761px;white-space:nowrap" class="ft00">Vol. 3B&#160;20-15</p>
<p style="position:absolute;top:47px;left:734px;white-space:nowrap" class="ft01">8086 EMULATION</p>
<p style="position:absolute;top:98px;left:69px;white-space:nowrap" class="ft02">20.3.2&#160;</p>
<p style="position:absolute;top:98px;left:149px;white-space:nowrap" class="ft02">Class 2—Maskable Hardware&#160;Interrupt&#160;Handling in Virtual-8086 Mode Using the&#160;</p>
<p style="position:absolute;top:119px;left:149px;white-space:nowrap" class="ft02">Virtual Interrupt Mechanism</p>
<p style="position:absolute;top:150px;left:69px;white-space:nowrap" class="ft06">Maskable hardware interrupts are&#160;those interrupts that&#160;are&#160;delivered&#160;through the&#160;INTR# pin&#160;or through an&#160;inter-<br/>rupt request to&#160;the&#160;local AP<a href="o_fe12b1e2a880e0ce-189.html">IC (see Section&#160;6.3.2,&#160;“Maskable Hardware&#160;Interrupts”). Th</a>ese&#160;interrupts can&#160;be inhib-<br/>ited&#160;(masked) from&#160;interrupting&#160;an executing program or&#160;task by clearing the&#160;IF&#160;flag in the&#160;EFLAGS&#160;register.<br/>When&#160;the VME flag&#160;in control register&#160;CR4 is&#160;set and the&#160;IOPL&#160;field&#160;in&#160;the&#160;EFLAGS&#160;register&#160;is less than 3,&#160;two&#160;addi-<br/>tional flags&#160;are activated in&#160;the EFLAGS register:</p>
<p style="position:absolute;top:245px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:246px;left:95px;white-space:nowrap" class="ft03">VIF (virtual interrupt) flag, bit&#160;19&#160;of the&#160;EFLAGS&#160;register.</p>
<p style="position:absolute;top:268px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:268px;left:95px;white-space:nowrap" class="ft03">VIP&#160;(virtual&#160;interrupt&#160;pending) flag, bit 20 of&#160;the&#160;EFLAGS register.</p>
<p style="position:absolute;top:292px;left:69px;white-space:nowrap" class="ft06">These&#160;flags&#160;provide&#160;the&#160;virtual-8086&#160;monitor with more efficient control&#160;over&#160;handling maskable&#160;hardware&#160;inter-<br/>rupts&#160;that&#160;occur during virtual-8086 mode&#160;tasks. They&#160;also reduce&#160;interrupt-handling&#160;overhead, by eliminating the&#160;<br/>need&#160;for all&#160;IF related&#160;operations&#160;(such as PUSHF,&#160;POPF,&#160;CLI,&#160;and&#160;STI instructions) to&#160;trap&#160;to the&#160;virtual-8086&#160;<br/>monitor.&#160;The purpose and use&#160;of&#160;these&#160;flags are&#160;as&#160;follows.</p>
<p style="position:absolute;top:376px;left:433px;white-space:nowrap" class="ft05">NOTE</p>
<p style="position:absolute;top:402px;left:122px;white-space:nowrap" class="ft06">The VIF&#160;and&#160;VIP flags&#160;are only available in IA-32 processors that&#160;support&#160;the virtual mode&#160;<br/>extensions. These extensions&#160;were introduced&#160;in the IA-32 architecture&#160;with&#160;the Pentium&#160;<br/>processor.&#160;When&#160;this mechanism is&#160;either&#160;not&#160;available&#160;or not enabled, maskable&#160;hardware&#160;<br/>interrupts are handled as class&#160;1&#160;interrupts.&#160;Here,&#160;if VIF&#160;and VIP&#160;flags are needed, the virtual-8086&#160;<br/>monitor can implement them in&#160;software.</p>
<p style="position:absolute;top:513px;left:69px;white-space:nowrap" class="ft07">Existing&#160;8086&#160;programs commonly set&#160;and&#160;clear&#160;the&#160;IF flag&#160;in the EFLAGS&#160;register&#160;to enable and&#160;disable&#160;maskable&#160;<br/>hardware interrupts, respectively; for example,&#160;to&#160;disable&#160;interrupts while handling another interrupt or&#160;an&#160;excep-<br/>tion.&#160;This practice&#160;works well&#160;in single&#160;task environments, but&#160;can cause&#160;problems&#160;in multitasking and multiple-<br/>processor&#160;environments,&#160;where&#160;it&#160;is often desirable to&#160;prevent&#160;an application program from having direct control&#160;<br/>over the&#160;handling of&#160;hardware interrupts.&#160;When using&#160;earlier IA-32 processors,&#160;this problem was&#160;often solved&#160;by&#160;<br/>creating a&#160;virtual&#160;IF flag in software. The IA-32 processors&#160;(beginning&#160;with&#160;the Pentium processor) provide hard-<br/>ware support&#160;for&#160;this virtual IF flag&#160;through&#160;the VIF&#160;and VIP flags.<br/>The VIF&#160;flag&#160;is a virtualized&#160;version of&#160;the&#160;IF&#160;flag, which an&#160;application program&#160;running from within a virtual-8086&#160;<br/>task can used to&#160;control&#160;the handling&#160;of maskable&#160;hardware&#160;interrupts. When&#160;the VIF flag&#160;is enabled, the&#160;CLI&#160;and&#160;<br/>STI&#160;instructions operate on&#160;the&#160;VIF flag instead of the&#160;IF&#160;flag. When an 8086&#160;program executes&#160;the&#160;CLI instruction,&#160;<br/>the processor clears the&#160;VIF&#160;flag to&#160;request that the&#160;virtual-8086&#160;monitor inhibit&#160;maskable&#160;hardware&#160;interrupts&#160;<br/>from interrupting program execution;&#160;when&#160;it executes&#160;the&#160;STI instruction, the&#160;processor&#160;sets the&#160;VIF flag&#160;<br/>requesting&#160;that the&#160;virtual-8086 monitor enable maskable&#160;hardware interrupts for the&#160;8086&#160;program. But actually&#160;<br/>the&#160;IF flag, managed by the&#160;operating system,&#160;always&#160;controls whether maskable&#160;hardware&#160;interrupts are&#160;enabled.&#160;<br/>Also, if under&#160;these&#160;circumstances an 8086&#160;program tries&#160;to&#160;read&#160;or&#160;change&#160;the IF&#160;flag using&#160;the&#160;PUSHF&#160;or POPF&#160;<br/>instructions,&#160;the processor&#160;will&#160;change the&#160;VIF flag&#160;instead, leaving&#160;IF unchanged.<br/>The VIP flag provides&#160;software&#160;a&#160;means of recording&#160;the&#160;existence of a&#160;deferred (or&#160;pending) maskable&#160;hardware&#160;<br/>interrupt. This flag is read by&#160;the&#160;processor but never explicitly written by the&#160;processor;&#160;it can only be&#160;written by&#160;<br/>software.&#160;<br/>If the&#160;IF flag&#160;is set and&#160;the VIF and VIP flags are&#160;enabled,&#160;and the processor receives&#160;a maskable&#160;hardware&#160;inter-<br/>rupt (interrupt vector 0&#160;through 255),&#160;the processor performs&#160;and the interrupt&#160;handler software&#160;should&#160;perform&#160;<br/>the following operations:<br/>1.&#160;The&#160;processor&#160;invokes&#160;the&#160;protected-mode&#160;interrupt&#160;handler&#160;for the&#160;interrupt received,&#160;as described in&#160;the&#160;</p>
<p style="position:absolute;top:922px;left:94px;white-space:nowrap" class="ft08">following&#160;steps.&#160;These&#160;steps&#160;are&#160;almost&#160;identical to&#160;those&#160;described&#160;for method&#160;1 interrupt&#160;and&#160;exception&#160;<br/><a href="o_fe12b1e2a880e0ce-988.html">handling in Section 20.3.1.1,&#160;“Handling an&#160;Interrupt&#160;or&#160;Exception Through a Protected-Mode&#160;Trap&#160;or Interrupt&#160;<br/>Gate”:<br/></a>a.&#160;Switches&#160;to 32-bit protected&#160;mode&#160;and privilege&#160;level 0.<br/>b.&#160;Saves&#160;the state&#160;of the processor on the&#160;privilege-level&#160;0&#160;stack.&#160;The&#160;states&#160;of&#160;the EIP,&#160;CS,&#160;EFLAGS,&#160;ESP,&#160;SS,&#160;</p>
<p style="position:absolute;top:1020px;left:120px;white-space:nowrap" class="ft03">ES,&#160;DS,&#160;FS,&#160;and&#160;GS&#160;registers&#160;are saved&#160;<a href="o_fe12b1e2a880e0ce-989.html">(see Figure&#160;20-4).</a></p>
<p style="position:absolute;top:1044px;left:94px;white-space:nowrap" class="ft03">c.&#160;Clears&#160;the segment registers.</p>
</div>
</body>
</html>
