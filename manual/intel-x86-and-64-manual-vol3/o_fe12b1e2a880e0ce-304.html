<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 304</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:18px;font-family:Times;color:#000000;}
	.ft04{font-size:16px;font-family:Times;color:#0860a8;}
	.ft05{font-size:11px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page304-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce304.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">8-48&#160;Vol. 3A</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">MULTIPLE-PROCESSOR&#160;MANAGEMENT</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft06">Software should not allow&#160;for voluntary context&#160;switches&#160;in&#160;between MONITOR/MWAIT in&#160;the&#160;instruction flow. Note&#160;<br/>that execution&#160;of&#160;MWAIT does&#160;not re-arm the&#160;monitor&#160;hardware. This&#160;means that MONITOR/MWAIT need&#160;to be&#160;<br/>executed in a loop. Also&#160;note that exits from the MWAIT state could be due to a condition&#160;other than a write to the&#160;<br/>triggering address;&#160;software should explicitly check the&#160;triggering data&#160;location to determine if the write occurred.&#160;<br/>Software should&#160;also check&#160;the value of&#160;the triggering&#160;address&#160;following the execution&#160;of&#160;the monitor instruction&#160;<br/>(and prior to&#160;the execution of the MWAIT&#160;instruction). This&#160;check&#160;is to identify any&#160;writes to the&#160;triggering address&#160;<br/>that occurred during&#160;the course&#160;of MONITOR execution.&#160;<br/>The&#160;address range provided&#160;to the&#160;MONITOR&#160;instruction must be&#160;of write-back&#160;caching type.&#160;Only&#160;write-back&#160;<br/>memory type stores&#160;to&#160;the monitored address range will trigger the monitor hardware. If the&#160;address&#160;range&#160;is not&#160;<br/>in memory&#160;of&#160;write-back type, the&#160;address monitor&#160;hardware may not be set up properly&#160;or the monitor hardware&#160;<br/>may not be armed.&#160;Software&#160;is also&#160;responsible for ensuring&#160;that</p>
<p style="position:absolute;top:295px;left:68px;white-space:nowrap" class="ft03">•</p>
<p style="position:absolute;top:295px;left:93px;white-space:nowrap" class="ft06">Writes&#160;that&#160;are not intended to cause the exit of a&#160;busy&#160;loop do&#160;not&#160;write&#160;to a location within&#160;the address region&#160;<br/>being&#160;monitored by&#160;the monitor hardware,</p>
<p style="position:absolute;top:334px;left:68px;white-space:nowrap" class="ft03">•</p>
<p style="position:absolute;top:334px;left:93px;white-space:nowrap" class="ft02">Writes&#160;intended&#160;to&#160;cause the&#160;exit of a&#160;busy loop&#160;are&#160;written&#160;to locations within the&#160;monitored address&#160;region.</p>
<p style="position:absolute;top:358px;left:68px;white-space:nowrap" class="ft06">Not&#160;doing so&#160;will&#160;lead to&#160;more false&#160;wakeups (an&#160;exit from&#160;the MWAIT state not&#160;due&#160;to a write to the&#160;intended data&#160;<br/>location). These have negative&#160;performance implications.&#160;It might&#160;be&#160;necessary for&#160;software&#160;to use&#160;padding&#160;to&#160;<br/>prevent false wakeups.&#160;CPUID&#160;provides&#160;a mechanism for determining the size data locations for monitoring&#160;as well&#160;<br/>as a&#160;mechanism&#160;for determining the&#160;size&#160;of a&#160;the pad.</p>
<p style="position:absolute;top:458px;left:68px;white-space:nowrap" class="ft04">8.10.5&#160;</p>
<p style="position:absolute;top:458px;left:148px;white-space:nowrap" class="ft04">Monitor/Mwait Address Range Determination</p>
<p style="position:absolute;top:489px;left:68px;white-space:nowrap" class="ft06">To&#160;use the&#160;MONITOR/MWAIT&#160;instructions, software&#160;should know&#160;the length of the&#160;region monitored by the&#160;<br/>MONITOR/MWAIT instructions&#160;and the&#160;size of the&#160;coherence line&#160;size&#160;for&#160;cache-snoop traffic&#160;in a multiprocessor&#160;<br/>system.&#160;This information&#160;can be&#160;queried&#160;using the&#160;CPUID&#160;monitor leaf&#160;function (EAX&#160;= 05H). You will need the&#160;<br/>smallest&#160;and largest monitor line&#160;size:</p>
<p style="position:absolute;top:560px;left:68px;white-space:nowrap" class="ft03">•</p>
<p style="position:absolute;top:561px;left:93px;white-space:nowrap" class="ft06">To&#160;avoid missed wake-ups: make&#160;sure&#160;that&#160;the&#160;data structure&#160;used&#160;to monitor writes fits&#160;within&#160;the&#160;smallest&#160;<br/>monitor line-size.&#160;Otherwise,&#160;the&#160;processor&#160;may not&#160;wake&#160;up after&#160;a write&#160;intended&#160;to trigger&#160;an exit from&#160;<br/>MWAIT.&#160;</p>
<p style="position:absolute;top:616px;left:68px;white-space:nowrap" class="ft03">•</p>
<p style="position:absolute;top:616px;left:93px;white-space:nowrap" class="ft06">To&#160;avoid&#160;false wake-ups; use the&#160;largest&#160;monitor&#160;line size&#160;to pad the data&#160;structure used to&#160;monitor&#160;writes.&#160;<br/>Software&#160;must make&#160;sure that&#160;beyond&#160;the&#160;data&#160;structure,&#160;no&#160;unrelated data variable exists&#160;in&#160;the&#160;triggering&#160;<br/>area&#160;for MWAIT.&#160;A pad may be needed&#160;to avoid this&#160;situation.</p>
<p style="position:absolute;top:673px;left:68px;white-space:nowrap" class="ft09">These&#160;above&#160;two&#160;values bear no relationship to&#160;cache line&#160;size in&#160;the system&#160;and software&#160;should not make&#160;any&#160;<br/>assumptions&#160;to that effect. Within&#160;a single-cluster&#160;system, the two parameters&#160;should&#160;default&#160;to be the same&#160;(the&#160;<br/>size of&#160;the&#160;monitor triggering&#160;area is&#160;the same&#160;as&#160;the&#160;system coherence line&#160;size).<br/>Based on&#160;the monitor&#160;line&#160;sizes returned by the&#160;CPUID,&#160;the&#160;OS&#160;should dynamically allocate&#160;structures with&#160;appro-<br/>priate&#160;padding.&#160;If static&#160;data&#160;structures must be&#160;used&#160;by an&#160;OS, attempt to&#160;adapt&#160;the data structure&#160;and use&#160;a&#160;<br/>dynamically&#160;allocated data&#160;buffer&#160;for thread synchronization. When&#160;the latter technique is&#160;not&#160;possible,&#160;consider&#160;<br/>not&#160;using MONITOR/MWAIT when using&#160;static data structures.<br/>To&#160;set up&#160;the data structure&#160;correctly for MONITOR/MWAIT on multi-clustered systems:&#160;interaction&#160;between&#160;<br/>processors,&#160;chipsets, and the&#160;BIOS is&#160;required (system coherence&#160;line size&#160;may&#160;depend on&#160;the chipset used in the&#160;<br/>system; the size could be different from the processor’s monitor triggering area). The BIOS is responsible to set&#160;the&#160;<br/>correct&#160;value for system&#160;coherence line&#160;size using&#160;the&#160;IA32_MONITOR_FILTER_LINE_SIZE MSR.&#160;Depending on the&#160;<br/>relative magnitude of the&#160;size of&#160;the monitor triggering&#160;area versus the&#160;value written into&#160;the&#160;<br/>IA32_MONITOR_FILTER_LINE_SIZE MSR,&#160;the&#160;smaller&#160;of the&#160;parameters will be&#160;reported&#160;as&#160;the&#160;<i>Smallest Monitor&#160;<br/>Line Size</i>. The&#160;larger&#160;of the&#160;parameters will be reported as&#160;the&#160;<i>Largest Monitor&#160;Line&#160;Size</i>.</p>
<p style="position:absolute;top:953px;left:68px;white-space:nowrap" class="ft04">8.10.6&#160;</p>
<p style="position:absolute;top:953px;left:148px;white-space:nowrap" class="ft04">Required Operating System Support</p>
<p style="position:absolute;top:984px;left:68px;white-space:nowrap" class="ft06">This section describes&#160;changes&#160;that must be&#160;made&#160;to an&#160;operating system&#160;to&#160;run on processors supporting&#160;Intel&#160;<br/>Hyper-Threading Technology. It&#160;also describes optimizations&#160;that&#160;can&#160;help an&#160;operating system make&#160;more&#160;efficient&#160;<br/>use of&#160;the&#160;logical processors sharing&#160;execution resources. The required&#160;changes&#160;and suggested optimizations are&#160;<br/>representative&#160;of the types&#160;of&#160;modifications that&#160;appear&#160;in Windows* XP&#160;and Linux* kernel 2.4.0 operating&#160;systems&#160;<br/>for Intel processors supporting Intel&#160;Hyper-Threading&#160;Technology.&#160;Additional optimizations for processors&#160;</p>
</div>
</body>
</html>
