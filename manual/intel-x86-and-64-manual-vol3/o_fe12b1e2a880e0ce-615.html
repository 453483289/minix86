<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 615</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:14px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:16px;font-family:Times;color:#0860a8;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page615-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce615.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:761px;white-space:nowrap" class="ft00">Vol. 3B&#160;17-41</p>
<p style="position:absolute;top:47px;left:425px;white-space:nowrap" class="ft01">DEBUG, BRANCH&#160;PROFILE, TSC, AND RESOURCE MONITORING FEATURES</p>
<p style="position:absolute;top:99px;left:433px;white-space:nowrap" class="ft02">NOTE</p>
<p style="position:absolute;top:124px;left:122px;white-space:nowrap" class="ft05">To&#160;determine&#160;average processor clock frequency,&#160;Intel recommends&#160;the use&#160;of performance&#160;<br/>monitoring&#160;logic to count&#160;processor&#160;core&#160;clocks over the&#160;period&#160;of time&#160;for which&#160;the average is&#160;<br/>required.&#160;S<a href="o_fe12b1e2a880e0ce-739.html">ee Section 18.17,&#160;“Counting Clocks,”&#160;and&#160;</a><a href="o_fe12b1e2a880e0ce-757.html">Chapter&#160;19,&#160;“Performance-Monitoring&#160;Events,”&#160;<br/></a>for more&#160;information.</p>
<p style="position:absolute;top:214px;left:69px;white-space:nowrap" class="ft05">The&#160;RDTSC instruction reads&#160;the&#160;time-stamp&#160;counter and&#160;is guaranteed to return&#160;a monotonically&#160;increasing&#160;<br/>unique value&#160;whenever executed,&#160;except&#160;for a 64-bit&#160;counter wraparound. Intel&#160;guarantees that&#160;the time-stamp&#160;<br/>counter will not wraparound&#160;within 10&#160;years after&#160;being&#160;reset. The&#160;period for counter&#160;wrap is longer for Pentium 4,&#160;<br/>Intel&#160;Xeon, P6 family,&#160;and Pentium processors.<br/>Normally,&#160;the RDTSC instruction&#160;can be executed&#160;by&#160;programs and&#160;procedures&#160;running at any&#160;privilege&#160;level and in&#160;<br/>virtual-8086&#160;mode. The&#160;TSD flag&#160;allows&#160;use&#160;of this instruction to be restricted to&#160;programs&#160;and procedures running&#160;<br/>at privilege&#160;level 0. A secure&#160;operating&#160;system&#160;would set&#160;the&#160;TSD&#160;flag during system&#160;initialization to&#160;disable user&#160;<br/>access to the&#160;time-stamp&#160;counter. An&#160;operating system&#160;that&#160;disables user&#160;access to&#160;the time-stamp counter should&#160;<br/>emulate the instruction through a&#160;user-accessible programming interface.<br/>The&#160;RDTSC instruction is&#160;not serializing or ordered&#160;with&#160;other instructions.&#160;It does not&#160;necessarily wait&#160;until all&#160;<br/>previous instructions have&#160;been&#160;executed before&#160;reading&#160;the&#160;counter. Similarly,&#160;subsequent&#160;instructions may&#160;begin&#160;<br/>execution&#160;before&#160;the RDTSC instruction operation is&#160;performed.<br/>The RDMSR and&#160;WRMSR instructions read and&#160;write the&#160;time-stamp&#160;counter, treating the&#160;time-stamp counter&#160;as&#160;<br/>an ordinary MSR&#160;(address 10H).&#160;In the&#160;Pentium&#160;4,&#160;Intel&#160;Xeon,&#160;and P6 family processors,&#160;all 64-bits&#160;of&#160;the time-<br/>stamp counter&#160;are read&#160;using&#160;RDMSR (just&#160;as with&#160;RDTSC). When&#160;WRMSR is&#160;used to write the time-stamp counter&#160;<br/>on processors before&#160;family&#160;[0FH],&#160;models [03H, 04H]:&#160;only&#160;the low-order 32-bits&#160;of&#160;the time-stamp counter&#160;can&#160;<br/>be written (the&#160;high-order&#160;32&#160;bits are cleared to&#160;0).&#160;For&#160;family [0FH], models&#160;[03H,&#160;04H,&#160;06H]; for family&#160;[06H]],&#160;<br/>model&#160;[0EH, 0FH]; for family [06H]], DisplayModel&#160;[17H,&#160;1AH,&#160;1CH, 1DH]:&#160;all 64 bits are&#160;writable.</p>
<p style="position:absolute;top:568px;left:69px;white-space:nowrap" class="ft04">17.15.1 Invariant&#160;</p>
<p style="position:absolute;top:568px;left:225px;white-space:nowrap" class="ft04">TSC</p>
<p style="position:absolute;top:598px;left:69px;white-space:nowrap" class="ft05">The time&#160;stamp counter&#160;in&#160;newer processors may&#160;support&#160;an enhancement, referred to&#160;as invariant&#160;TSC.&#160;<br/>Processor’s support for invariant&#160;TSC is&#160;indicated by&#160;CPUID.80000007H:EDX[8].&#160;<br/>The&#160;invariant TSC&#160;will&#160;run at&#160;a constant rate in&#160;all ACPI P-, C-. and&#160;T-states.&#160;This is&#160;the architectural behavior&#160;<br/>moving forward. On&#160;processors with invariant&#160;TSC&#160;support, the OS&#160;may use the&#160;TSC&#160;for&#160;wall clock timer&#160;services&#160;<br/>(instead of ACPI&#160;or HPET timers). TSC&#160;reads&#160;are&#160;much&#160;more&#160;efficient and do&#160;not&#160;incur&#160;the overhead associated with&#160;<br/>a&#160;ring transition&#160;or access to&#160;a platform resource.</p>
<p style="position:absolute;top:739px;left:69px;white-space:nowrap" class="ft04">17.15.2&#160;&#160;IA32_TSC_AUX Register and RDTSCP Support</p>
<p style="position:absolute;top:769px;left:69px;white-space:nowrap" class="ft05">Processors based on Intel&#160;microarchitecture&#160;code name&#160;Nehalem provide an auxiliary TSC register, IA32_TSC_AUX&#160;<br/>that is&#160;designed&#160;to be&#160;used&#160;in conjunction&#160;with&#160;IA32_TSC.&#160;IA32_TSC_AUX provides a&#160;32-bit&#160;field&#160;that is&#160;initialized&#160;<br/>by privileged software&#160;with&#160;a signature&#160;value (for example,&#160;a logical&#160;processor&#160;ID).&#160;<br/>The primary usage of IA32_TSC_AUX&#160;in&#160;conjunction&#160;with&#160;IA32_TSC&#160;is to&#160;allow software&#160;to read the&#160;64-bit time&#160;<br/>stamp&#160;in IA32_TSC&#160;and signature&#160;value&#160;in IA32_TSC_AUX with the&#160;instruction&#160;RDTSCP&#160;in&#160;an atomic operation.&#160;<br/>RDTSCP&#160;returns the 64-bit time&#160;stamp in&#160;EDX:EAX and the 32-bit&#160;TSC_AUX signature value in ECX.&#160;The atomicity&#160;<br/>of RDTSCP&#160;ensures that&#160;no&#160;context switch can&#160;occur between the&#160;reads&#160;of&#160;the TSC and TSC_AUX values.<br/>Support for RDTSCP is&#160;indicated&#160;by CPUID.80000001H:EDX[27]. As with RDTSC&#160;instruction, non-ring&#160;0 access is&#160;<br/>controlled by CR4.TSD&#160;(Time Stamp Disable flag).<br/>User&#160;mode&#160;software&#160;can use RDTSCP to&#160;detect&#160;if CPU&#160;migration has occurred between&#160;successive&#160;reads&#160;of&#160;the TSC.&#160;<br/>It can&#160;also be&#160;used to&#160;adjust&#160;for&#160;per-CPU&#160;differences&#160;in TSC values in&#160;a NUMA system.</p>
<p style="position:absolute;top:1007px;left:69px;white-space:nowrap" class="ft04">17.15.3&#160;&#160;Time-Stamp Counter Adjustment</p>
<p style="position:absolute;top:1038px;left:69px;white-space:nowrap" class="ft05">Software can modify the&#160;value of&#160;the time-stamp counter&#160;(TSC) of a logical&#160;processor by using the&#160;WRMSR instruc-<br/>tion to write&#160;to the&#160;IA32_TIME_STAMP_COUNTER MSR (address&#160;10H).&#160;Because&#160;such a&#160;write&#160;applies&#160;only to&#160;that&#160;</p>
</div>
</body>
</html>
