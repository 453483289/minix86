<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 998</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:18px;font-family:Times;color:#0860a8;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page998-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce998.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">21-2&#160;Vol. 3B</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">MIXING&#160;16-BIT&#160;AND 32-BIT&#160;CODE</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft07">The B flag in&#160;the stack-segment descriptor specifies&#160;the&#160;size&#160;of stack&#160;pointer (the&#160;32-bit&#160;ESP&#160;register&#160;or the 16-bit&#160;<br/>SP register) used by&#160;the processor for implicit&#160;stack references. The B&#160;flag&#160;for all&#160;data&#160;descriptors&#160;also&#160;controls&#160;<br/>upper&#160;address&#160;range for expand down segments.<br/>When transferring&#160;program control to&#160;another code&#160;segment through a&#160;call gate, interrupt&#160;gate, or&#160;trap&#160;gate, the&#160;<br/>operand&#160;size used during&#160;the transfer is&#160;determined by the type&#160;of gate used&#160;(16-bit or 32-bit), (not by the D-flag&#160;<br/>or prefix&#160;of&#160;the transfer&#160;instruction).&#160;The gate type determines&#160;how return&#160;information is&#160;saved on the&#160;stack (or&#160;<br/>stacks).<br/>For&#160;most&#160;efficient and&#160;trouble-free&#160;operation of the&#160;processor,&#160;32-bit&#160;programs or&#160;tasks&#160;should have&#160;the D flag&#160;in&#160;<br/>the code-segment&#160;descriptor and the&#160;B&#160;flag in&#160;the stack-segment&#160;descriptor set, and 16-bit programs&#160;or&#160;tasks&#160;<br/>should&#160;have these flags clear.&#160;Program&#160;control transfers from 16-bit segments to 32-bit&#160;segments (and vice&#160;versa)&#160;<br/>are handled most efficiently&#160;through call, interrupt,&#160;or&#160;trap gates.<br/>Instruction&#160;prefixes&#160;can be&#160;used&#160;to&#160;override&#160;the&#160;default&#160;operand&#160;size and address size&#160;of a&#160;code&#160;segment. These&#160;<br/>prefixes can be&#160;used&#160;in&#160;real-address mode as well as in&#160;protected&#160;mode&#160;and virtual-8086 mode. An operand-size or&#160;<br/>address-size&#160;prefix only changes the&#160;size for the&#160;duration&#160;of&#160;the instruction.</p>
<p style="position:absolute;top:393px;left:68px;white-space:nowrap" class="ft03">21.2&#160;</p>
<p style="position:absolute;top:393px;left:147px;white-space:nowrap" class="ft03">MIXING 16-BIT AND&#160;32-BIT OPERATIONS WITHIN A CODE SEGMENT</p>
<p style="position:absolute;top:429px;left:68px;white-space:nowrap" class="ft02">The&#160;following&#160;two instruction prefixes allow&#160;mixing&#160;of&#160;32-bit and&#160;16-bit operations within one&#160;segment:</p>
<p style="position:absolute;top:451px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:451px;left:93px;white-space:nowrap" class="ft02">The operand-size&#160;prefix&#160;(66H)</p>
<p style="position:absolute;top:473px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:474px;left:93px;white-space:nowrap" class="ft02">The&#160;address-size&#160;prefix (67H)</p>
<p style="position:absolute;top:498px;left:68px;white-space:nowrap" class="ft07">These&#160;prefixes&#160;reverse&#160;the&#160;default&#160;size selected&#160;by the&#160;D flag&#160;in the&#160;code-segment descriptor.&#160;For&#160;example, the&#160;<br/>processor&#160;can interpret the&#160;(MOV&#160;<i>mem</i>,&#160;<i>reg</i>) instruction in&#160;any&#160;of four&#160;ways:</p>
<p style="position:absolute;top:536px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:537px;left:93px;white-space:nowrap" class="ft09">In&#160;a 32-bit code segment:<br/>—&#160;Moves 32 bits from a&#160;32-bit&#160;register to&#160;memory&#160;using&#160;a 32-bit&#160;effective address.<br/>—&#160;If&#160;preceded&#160;by an&#160;operand-size&#160;prefix,&#160;moves&#160;16&#160;bits&#160;from a&#160;16-bit register&#160;to memory&#160;using a&#160;32-bit&#160;</p>
<p style="position:absolute;top:601px;left:119px;white-space:nowrap" class="ft02">effective address.</p>
<p style="position:absolute;top:625px;left:93px;white-space:nowrap" class="ft02">—&#160;If&#160;preceded&#160;by an&#160;address-size&#160;prefix,&#160;moves&#160;32&#160;bits&#160;from&#160;a 32-bit register&#160;to memory using a&#160;16-bit&#160;</p>
<p style="position:absolute;top:642px;left:119px;white-space:nowrap" class="ft02">effective address.</p>
<p style="position:absolute;top:666px;left:93px;white-space:nowrap" class="ft02">—&#160;If&#160;preceded&#160;by both an address-size prefix and&#160;an operand-size prefix,&#160;moves 16&#160;bits&#160;from a&#160;16-bit&#160;register&#160;</p>
<p style="position:absolute;top:682px;left:119px;white-space:nowrap" class="ft02">to&#160;memory&#160;using&#160;a 16-bit effective address.</p>
<p style="position:absolute;top:704px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:705px;left:93px;white-space:nowrap" class="ft08">In&#160;a 16-bit code segment:<br/>—&#160;Moves 16 bits from a&#160;16-bit&#160;register to&#160;memory&#160;using&#160;a 16-bit&#160;effective address.<br/>—&#160;If&#160;preceded&#160;by an&#160;operand-size&#160;prefix,&#160;moves&#160;32&#160;bits&#160;from a&#160;32-bit register&#160;to memory&#160;using a&#160;16-bit&#160;</p>
<p style="position:absolute;top:769px;left:119px;white-space:nowrap" class="ft02">effective address.</p>
<p style="position:absolute;top:793px;left:93px;white-space:nowrap" class="ft02">—&#160;If&#160;preceded&#160;by an&#160;address-size&#160;prefix,&#160;moves&#160;16&#160;bits&#160;from&#160;a 16-bit register&#160;to memory using a&#160;32-bit&#160;</p>
<p style="position:absolute;top:810px;left:119px;white-space:nowrap" class="ft02">effective address.</p>
<p style="position:absolute;top:834px;left:93px;white-space:nowrap" class="ft02">—&#160;If&#160;preceded&#160;by both an address-size prefix and&#160;an operand-size prefix,&#160;moves 32&#160;bits&#160;from a&#160;32-bit&#160;register&#160;</p>
<p style="position:absolute;top:850px;left:119px;white-space:nowrap" class="ft02">to&#160;memory&#160;using&#160;a 32-bit effective address.</p>
<p style="position:absolute;top:874px;left:68px;white-space:nowrap" class="ft07">The previous&#160;examples&#160;show that&#160;any instruction can&#160;generate any&#160;combination of&#160;operand&#160;size and&#160;address size&#160;<br/>regardless of&#160;whether the&#160;instruction&#160;is in&#160;a 16- or&#160;32-bit&#160;segment. The choice&#160;of&#160;the 16- or&#160;32-bit default&#160;for&#160;a code&#160;<br/>segment&#160;is normally based&#160;on&#160;the following criteria:</p>
<p style="position:absolute;top:929px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:930px;left:93px;white-space:nowrap" class="ft07"><b>Performance&#160;</b>—&#160;Always use&#160;32-bit code&#160;segments when possible.&#160;They run much faster&#160;than&#160;16-bit code&#160;<br/>segments on P6&#160;family processors,&#160;and somewhat faster&#160;on&#160;earlier IA-32&#160;processors.</p>
<p style="position:absolute;top:968px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:969px;left:93px;white-space:nowrap" class="ft07"><b>The&#160;operating system&#160;the code&#160;segment&#160;will&#160;be running on&#160;</b>—&#160;If&#160;the&#160;operating&#160;system&#160;is&#160;a 16-bit&#160;<br/>operating system,&#160;it&#160;may not support 32-bit&#160;program&#160;modules.</p>
<p style="position:absolute;top:1007px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:1008px;left:93px;white-space:nowrap" class="ft07"><b>Mode of operation&#160;</b>—&#160;If the&#160;code&#160;segment is being&#160;designed&#160;to run in&#160;real-address mode,&#160;virtual-8086&#160;mode,&#160;<br/>or&#160;SMM,&#160;it must be&#160;a&#160;16-bit code&#160;segment.</p>
</div>
</body>
</html>
