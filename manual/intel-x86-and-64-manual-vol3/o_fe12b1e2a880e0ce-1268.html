<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1268</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:8px;font-family:Times;color:#000000;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:16px;font-family:Times;color:#0860a8;}
	.ft06{font-size:11px;line-height:17px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1268-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1268.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">34-18&#160;Vol. 3C</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">SYSTEM&#160;MANAGEMENT&#160;MODE</p>
<p style="position:absolute;top:100px;left:115px;white-space:nowrap" class="ft06">IF internal storage indicates that the logical processor<br/>had been&#160;in&#160;VMX operation (root or non-root)</p>
<p style="position:absolute;top:136px;left:142px;white-space:nowrap" class="ft02">THEN</p>
<p style="position:absolute;top:154px;left:169px;white-space:nowrap" class="ft06">enter VMX operation&#160;(root or&#160;non-root);<br/>restore&#160;VMX-critical state as&#160;defined&#160;in<a href="o_fe12b1e2a880e0ce-1266.html">&#160;Section 34.14.1</a>;<br/>set to their fixed values&#160;any bits&#160;in&#160;CR0 and CR4&#160;whose&#160;values&#160;must be&#160;fixed in&#160;VMX operation (see<a href="o_fe12b1e2a880e0ce-1045.html">&#160;Section 23.8);</a></p>
<p style="position:absolute;top:187px;left:819px;white-space:nowrap" class="ft03">1</p>
<p style="position:absolute;top:208px;left:169px;white-space:nowrap" class="ft02">IF RFLAGS.VM&#160;=&#160;0 AND (in VMX&#160;root operation&#160;OR&#160;the&#160;“unrestricted guest”&#160;VM-execution control is 0)</p>
<p style="position:absolute;top:205px;left:747px;white-space:nowrap" class="ft03">2</p>
<p style="position:absolute;top:226px;left:196px;white-space:nowrap" class="ft02">THEN</p>
<p style="position:absolute;top:244px;left:223px;white-space:nowrap" class="ft02">CS.RPL&#160;←&#160;SS.DPL;</p>
<p style="position:absolute;top:262px;left:223px;white-space:nowrap" class="ft02">SS.RPL&#160;←&#160;SS.DPL;</p>
<p style="position:absolute;top:280px;left:169px;white-space:nowrap" class="ft06">FI;<br/>restore current&#160;VMCS pointer;</p>
<p style="position:absolute;top:316px;left:115px;white-space:nowrap" class="ft06">FI;<br/>leave&#160;SMM;<br/>IF logical processor&#160;will be&#160;in&#160;VMX&#160;operation&#160;or&#160;in&#160;SMX&#160;operation after&#160;RSM</p>
<p style="position:absolute;top:370px;left:142px;white-space:nowrap" class="ft02">THEN&#160;block&#160;A20M&#160;and leave A20M&#160;mode;</p>
<p style="position:absolute;top:388px;left:115px;white-space:nowrap" class="ft02">FI;</p>
<p style="position:absolute;top:406px;left:68px;white-space:nowrap" class="ft07">FI;<br/>RSM unblocks SMIs. It&#160;restores&#160;the&#160;state&#160;of blocking&#160;by&#160;<a href="o_fe12b1e2a880e0ce-1052.html">NMI (see Table&#160;24-3&#160;</a><a href="o_fe12b1e2a880e0ce-1051.html">in Section 24.4.2)&#160;</a>as follows:</p>
<p style="position:absolute;top:452px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:453px;left:93px;white-space:nowrap" class="ft08">If the RSM is&#160;not&#160;to VMX non-root operation&#160;or&#160;if&#160;the&#160;“virtual NMIs” VM-execution control&#160;will be 0, the state of&#160;<br/>NMI blocking&#160;is restored&#160;normally.</p>
<p style="position:absolute;top:491px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:492px;left:93px;white-space:nowrap" class="ft08">If the&#160;RSM is&#160;to VMX non-root&#160;operation and&#160;the&#160;“virtual NMIs”&#160;VM-execution control will be 1,&#160;NMIs&#160;are not&#160;<br/>blocked&#160;after RSM. The&#160;state&#160;of&#160;virtual-NMI blocking is&#160;restored&#160;as part of VMX-critical state.</p>
<p style="position:absolute;top:532px;left:68px;white-space:nowrap" class="ft08">INIT signals are&#160;blocked after&#160;RSM if and&#160;only&#160;if&#160;the&#160;logical processor will be in&#160;VMX root&#160;operation.<br/>If RSM returns&#160;a logical processor to&#160;VMX non-root operation,&#160;it re-establishes the&#160;controls&#160;associated with&#160;the&#160;<br/>current&#160;VMCS. If&#160;the “interrupt-window exiting”&#160;VM-execution control is 1,&#160;a VM&#160;exit&#160;occurs immediately after&#160;RSM&#160;<br/>if&#160;the enabling conditions&#160;apply.&#160;The&#160;same&#160;is&#160;true&#160;for the&#160;“NMI-window&#160;exiting” VM-execution&#160;control. Such&#160;<br/>VM&#160;exits occur&#160;with&#160;their normal priority<a href="o_fe12b1e2a880e0ce-1079.html">. See&#160;Section&#160;25.2.<br/></a>If an MTF&#160;VM&#160;exit was pending at&#160;the&#160;time&#160;of&#160;the&#160;previous&#160;SMI,&#160;an&#160;MTF&#160;VM&#160;exit is&#160;pending on&#160;the&#160;instruction&#160;<br/>boundary following execution&#160;of&#160;RSM.&#160;The following items&#160;detail&#160;the&#160;treatment of MTF VM&#160;exits that&#160;may&#160;be&#160;<br/>pending following RSM:</p>
<p style="position:absolute;top:685px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:685px;left:93px;white-space:nowrap" class="ft08">System-management&#160;interrupts (SMIs), INIT&#160;signals,&#160;and higher priority events take&#160;priority over these MTF&#160;<br/>VM&#160;exits. These MTF&#160;VM&#160;exits&#160;take&#160;priority over debug-trap exceptions&#160;and lower priority events.&#160;</p>
<p style="position:absolute;top:724px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:724px;left:93px;white-space:nowrap" class="ft08">These MTF VM&#160;exits wake&#160;the&#160;logical&#160;processor&#160;if RSM caused&#160;the&#160;logical processor to&#160;enter&#160;the HLT state (see&#160;<br/><a href="o_fe12b1e2a880e0ce-1263.html">Section 34.10).&#160;</a>They do not occur&#160;if&#160;the logical processor just entered the&#160;shutdown&#160;state.</p>
<p style="position:absolute;top:791px;left:68px;white-space:nowrap" class="ft05">34.14.3&#160;&#160;Protection of&#160;CR4.VMXE&#160;in SMM</p>
<p style="position:absolute;top:822px;left:68px;white-space:nowrap" class="ft08">Under&#160;the default treatment, CR4.VMXE is&#160;treated as&#160;a&#160;reserved&#160;bit&#160;while a&#160;logical&#160;processor&#160;is&#160;in&#160;SMM. Any&#160;<br/>attempt by&#160;software&#160;running&#160;in SMM&#160;to set&#160;this bit causes&#160;a general-protection&#160;exception. In&#160;addition,&#160;software&#160;<br/>cannot&#160;use&#160;VMX instructions or&#160;enter&#160;VMX operation while&#160;in SMM.</p>
<p style="position:absolute;top:905px;left:68px;white-space:nowrap" class="ft05">34.14.4&#160;&#160;VMXOFF and SMI Unblocking</p>
<p style="position:absolute;top:936px;left:68px;white-space:nowrap" class="ft08">The VMXOFF instruction&#160;can&#160;be&#160;executed only with&#160;the&#160;default treatment&#160;(see<a href="o_fe12b1e2a880e0ce-1269.html">&#160;Section 34.15.1)</a>&#160;and&#160;only outside&#160;<br/>SMM.&#160;If SMIs are&#160;blocked&#160;when&#160;VMXOFF&#160;is executed, VMXOFF unblocks&#160;them unless&#160;</p>
<p style="position:absolute;top:984px;left:68px;white-space:nowrap" class="ft02">1.&#160;If the RSM is to&#160;VMX non-root&#160;operation and both the “unrestricted guest”&#160;VM-execution control and&#160;bit&#160;31 of&#160;the primary proces-</p>
<p style="position:absolute;top:1000px;left:89px;white-space:nowrap" class="ft02">sor-based&#160;VM-execution&#160;controls&#160;will&#160;be&#160;1,&#160;CR0.PE&#160;and&#160;CR0.PG&#160;retain&#160;the&#160;values&#160;that&#160;were&#160;loaded&#160;from&#160;SMRAM&#160;regardless&#160;of&#160;what&#160;is&#160;</p>
<p style="position:absolute;top:1017px;left:89px;white-space:nowrap" class="ft02">reported&#160;in&#160;the capability&#160;MSR IA32_VMX_CR0_FIXED0.</p>
<p style="position:absolute;top:1038px;left:68px;white-space:nowrap" class="ft02">2.&#160;“Unrestricted guest” is a secondary processor-based VM-execution&#160;control.&#160;If bit&#160;31&#160;of&#160;the primary processor-based&#160;VM-execution&#160;</p>
<p style="position:absolute;top:1054px;left:89px;white-space:nowrap" class="ft02">controls&#160;is 0, VM&#160;entry functions as&#160;if the “unrestricted guest” VM-execution&#160;control were&#160;0.&#160;See&#160;<a href="o_fe12b1e2a880e0ce-1055.html">Section&#160;24.6.2</a>.</p>
</div>
</body>
</html>
