<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1938</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:14px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:12px;font-family:Times;color:#0860a8;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1938-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1938.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">43-6&#160;Vol. 3D</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">ENCLAVE CODE&#160;DEBUG&#160;AND PROFILING</p>
<p style="position:absolute;top:577px;left:68px;white-space:nowrap" class="ft02">43.5.2.2 &#160;&#160;LBR&#160;Stack on&#160;Opt-out Entry</p>
<p style="position:absolute;top:604px;left:68px;white-space:nowrap" class="ft05">An opt-out entry into an enclave suppresses last branch&#160;recording facilities, and enclave exit after an opt-out entry&#160;<br/>un-suppresses last&#160;branch recording&#160;facilities.<br/>Opt-out entry&#160;into&#160;an enclave does not push&#160;any record on&#160;LBR stack.<br/>If last&#160;branch recording&#160;facilities were&#160;enabled at&#160;the time&#160;of enclave entry,&#160;then EEXIT following such an&#160;enclave&#160;<br/>entry pushes&#160;one&#160;record&#160;on LBR stack. The&#160;MSR_LASTBRANCH_n_FROM_IP of&#160;such record holds the&#160;linear&#160;address&#160;<br/>of&#160;the instruction&#160;(EENTER&#160;or&#160;ERESUME) that&#160;was&#160;used&#160;to enter&#160;the enclave,&#160;while&#160;the&#160;<br/>MSR_LASTBRANCH_n_TO_IP&#160;of such&#160;record&#160;holds&#160;linear&#160;address of the&#160;destination&#160;of&#160;EEXIT.&#160;<br/>Additionally, if&#160;last branch recording&#160;facilities&#160;were enabled at the&#160;time of&#160;enclave entry,&#160;then&#160;an AEX&#160;after such&#160;an&#160;<br/>entry pushes&#160;one record on LBR stack, before&#160;pushing&#160;record&#160;for&#160;the event causing the AEX if&#160;the event pushes a&#160;<br/>record&#160;on LBR&#160;stack.&#160;The MSR_LASTBRANCH_n_FROM_IP&#160;of&#160;the&#160;new&#160;record holds&#160;linear address of the instruction&#160;<br/>(EENTER&#160;or ERESUME) that was&#160;used&#160;to enter the&#160;enclave,&#160;while MSR_LASTBRANCH_n_TO_IP&#160;of the&#160;new&#160;record&#160;<br/>holds&#160;linear&#160;address of the&#160;AEP.&#160;If&#160;the event causing&#160;AEX pushes&#160;a record on&#160;LBR stack, then&#160;the&#160;<br/>MSR_LASTBRANCH_n_FROM_IP&#160;for that&#160;record&#160;holds linear&#160;address of the&#160;AEP.<br/><a href="o_fe12b1e2a880e0ce-1939.html">Figure&#160;43-4 shows an&#160;</a>example of LBR stack&#160;manipulation&#160;after an opt-out&#160;entry.&#160;Every arrow in this&#160;picture&#160;indi-<br/>cates&#160;a branch record&#160;pushed on the&#160;LBR&#160;stack. The&#160;“From&#160;IP”&#160;of&#160;the branch record&#160;contains the&#160;linear&#160;address&#160;of&#160;<br/>the instruction located&#160;at the&#160;start of the&#160;arrow,&#160;while the&#160;“To IP”&#160;of the&#160;branch record contains the&#160;linear&#160;address&#160;<br/>of the instruction at&#160;the end of the&#160;arrow.</p>
<p style="position:absolute;top:525px;left:275px;white-space:nowrap" class="ft04">Figure&#160;43-3. &#160;LBR&#160;Stack&#160;Interaction with Opt-in Entry</p>
<p style="position:absolute;top:155px;left:486px;white-space:nowrap" class="ft03">Inst1</p>
<p style="position:absolute;top:196px;left:250px;white-space:nowrap" class="ft03">BR2</p>
<p style="position:absolute;top:196px;left:486px;white-space:nowrap" class="ft03">Inst3</p>
<p style="position:absolute;top:482px;left:250px;white-space:nowrap" class="ft03">EEXIT</p>
<p style="position:absolute;top:237px;left:250px;white-space:nowrap" class="ft03">Inst4</p>
<p style="position:absolute;top:279px;left:484px;white-space:nowrap" class="ft03">AEP</p>
<p style="position:absolute;top:158px;left:240px;white-space:nowrap" class="ft03">EENTER</p>
<p style="position:absolute;top:278px;left:250px;white-space:nowrap" class="ft03">Inst4</p>
<p style="position:absolute;top:359px;left:250px;white-space:nowrap" class="ft03">IRET</p>
<p style="position:absolute;top:319px;left:484px;white-space:nowrap" class="ft03">OS</p>
<p style="position:absolute;top:400px;left:484px;white-space:nowrap" class="ft03">Inst4</p>
<p style="position:absolute;top:360px;left:484px;white-space:nowrap" class="ft03">AEP</p>
<p style="position:absolute;top:319px;left:250px;white-space:nowrap" class="ft03">AEP</p>
<p style="position:absolute;top:403px;left:240px;white-space:nowrap" class="ft03">ERESUME</p>
<p style="position:absolute;top:441px;left:250px;white-space:nowrap" class="ft03">BR5</p>
<p style="position:absolute;top:441px;left:484px;white-space:nowrap" class="ft03">Inst6</p>
<p style="position:absolute;top:481px;left:484px;white-space:nowrap" class="ft03">Inst7</p>
<p style="position:absolute;top:237px;left:363px;white-space:nowrap" class="ft03">Fault</p>
</div>
</body>
</html>
