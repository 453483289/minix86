<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 999</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:18px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#0860a8;}
	.ft06{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page999-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce999.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:768px;white-space:nowrap" class="ft00">Vol. 3B&#160;21-3</p>
<p style="position:absolute;top:47px;left:648px;white-space:nowrap" class="ft01">MIXING&#160;16-BIT AND 32-BIT CODE</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:100px;left:95px;white-space:nowrap" class="ft06"><b>Backward compatibility to&#160;earlier IA-32 processors&#160;</b>—&#160;If&#160;a&#160;code&#160;segment must be able to&#160;run&#160;on&#160;an&#160;Intel&#160;<br/>8086 or&#160;Intel 286&#160;processor,&#160;it must be a&#160;16-bit code segment.</p>
<p style="position:absolute;top:172px;left:69px;white-space:nowrap" class="ft05">21.3&#160;</p>
<p style="position:absolute;top:172px;left:148px;white-space:nowrap" class="ft05">SHARING DATA AMONG MIXED-SIZE&#160;CODE SEGMENTS</p>
<p style="position:absolute;top:208px;left:69px;white-space:nowrap" class="ft06">Data segments can&#160;be&#160;accessed from both&#160;16-bit and&#160;32-bit code segments.&#160;When a&#160;data&#160;segment that&#160;is larger&#160;<br/>than&#160;64&#160;KBytes&#160;is to&#160;be shared among 16-&#160;and 32-bit&#160;code&#160;segments, the&#160;data&#160;that is&#160;to be accessed from&#160;the&#160;16-<br/>bit code segments must be located within the&#160;first 64 KBytes of&#160;the&#160;data&#160;segment. The&#160;reason&#160;for&#160;this&#160;is that&#160;16-<br/>bit pointers by definition&#160;can only&#160;point to the first 64 KBytes of a&#160;segment.&#160;<br/>A&#160;stack that spans less&#160;than 64&#160;KBytes&#160;can be shared&#160;by&#160;both 16- and&#160;32-bit code&#160;segments.&#160;This class&#160;of stacks&#160;<br/>includes:</p>
<p style="position:absolute;top:320px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:321px;left:95px;white-space:nowrap" class="ft04">Stacks in&#160;expand-up segments with&#160;the G&#160;(granularity)&#160;and B (big) flags&#160;in&#160;the stack-segment descriptor&#160;clear.</p>
<p style="position:absolute;top:343px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:343px;left:95px;white-space:nowrap" class="ft04">Stacks in&#160;expand-down segments with the&#160;G and&#160;B flags&#160;clear.</p>
<p style="position:absolute;top:365px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:366px;left:95px;white-space:nowrap" class="ft06">Stacks&#160;in expand-up segments with the&#160;G flag&#160;set&#160;and the&#160;B flag&#160;clear and where the stack is&#160;contained&#160;<br/>completely within the lower 64 KBytes. (Offsets greater than FFFFH can be used for data, other than the stack,&#160;<br/>which&#160;is&#160;not shared.)</p>
<p style="position:absolute;top:423px;left:69px;white-space:nowrap" class="ft06">Se<a href="o_fe12b1e2a880e0ce-97.html">e Section 3.4.5, “Segment Descriptors,”</a>&#160;for&#160;a description&#160;of&#160;the G&#160;and B&#160;flags and&#160;the expand-down stack type.<br/>The B flag cannot,&#160;in general, be used to&#160;change&#160;the size&#160;of&#160;stack used by a 16-bit code&#160;segment. This&#160;flag controls&#160;<br/>the size&#160;of the stack pointer&#160;only for implicit stack&#160;references such&#160;as those caused by interrupts, exceptions,&#160;and&#160;<br/>the PUSH, POP,&#160;CALL,&#160;and RET&#160;instructions.&#160;It does&#160;not control&#160;explicit stack&#160;references, such&#160;as accesses to&#160;<br/>parameters or local&#160;variables. A&#160;16-bit code&#160;segment&#160;can use&#160;a&#160;32-bit stack only if the code is&#160;modified&#160;so&#160;that&#160;all&#160;<br/>explicit references to the&#160;stack&#160;are preceded&#160;by the 32-bit address-size prefix,&#160;causing those references to use&#160;32-<br/>bit addressing&#160;and explicit writes&#160;to the&#160;stack&#160;pointer are&#160;preceded&#160;by a&#160;32-bit operand-size&#160;prefix.<br/>In&#160;32-bit,&#160;expand-down segments,&#160;all offsets may be greater than 64 KBytes; therefore, 16-bit&#160;code&#160;cannot&#160;use&#160;<br/>this kind of&#160;stack&#160;segment&#160;unless the&#160;code&#160;segment&#160;is modified&#160;to&#160;use 32-bit&#160;addressing.</p>
<p style="position:absolute;top:625px;left:69px;white-space:nowrap" class="ft05">21.4&#160;</p>
<p style="position:absolute;top:625px;left:148px;white-space:nowrap" class="ft05">TRANSFERRING CONTROL AMONG MIXED-SIZE&#160;CODE SEGMENTS</p>
<p style="position:absolute;top:661px;left:69px;white-space:nowrap" class="ft04">There are three&#160;ways&#160;for a&#160;procedure&#160;in a&#160;16-bit code segment&#160;to safely make&#160;a call&#160;to a&#160;32-bit code segment:</p>
<p style="position:absolute;top:683px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:684px;left:95px;white-space:nowrap" class="ft04">Make&#160;the call through a&#160;32-bit call&#160;gate.</p>
<p style="position:absolute;top:706px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:706px;left:95px;white-space:nowrap" class="ft06">Make&#160;a 16-bit&#160;call to&#160;a 32-bit&#160;interface procedure.&#160;The&#160;interface&#160;procedure then&#160;makes a&#160;32-bit call&#160;to the&#160;<br/>intended&#160;destination.</p>
<p style="position:absolute;top:745px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:745px;left:95px;white-space:nowrap" class="ft04">Modify the&#160;16-bit procedure,&#160;inserting&#160;an&#160;operand-size&#160;prefix before the&#160;call,&#160;to&#160;change it&#160;to a&#160;32-bit&#160;call.</p>
<p style="position:absolute;top:769px;left:69px;white-space:nowrap" class="ft06">Likewise,&#160;there&#160;are three ways&#160;for procedure&#160;in&#160;a 32-bit&#160;code&#160;segment&#160;to safely&#160;make&#160;a call&#160;to&#160;a 16-bit&#160;code&#160;<br/>segment:</p>
<p style="position:absolute;top:808px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:808px;left:95px;white-space:nowrap" class="ft04">Make&#160;the call through a&#160;16-bit call&#160;gate. Here, the&#160;EIP value&#160;at the&#160;CALL instruction cannot exceed FFFFH.</p>
<p style="position:absolute;top:830px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:831px;left:95px;white-space:nowrap" class="ft06">Make&#160;a 32-bit&#160;call to&#160;a 16-bit&#160;interface procedure.&#160;The&#160;interface&#160;procedure then&#160;makes a&#160;16-bit call&#160;to the&#160;<br/>intended&#160;destination.</p>
<p style="position:absolute;top:869px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:870px;left:95px;white-space:nowrap" class="ft06">Modify the&#160;32-bit procedure,&#160;inserting&#160;an&#160;operand-size&#160;prefix&#160;before&#160;the call, changing it&#160;to a&#160;16-bit&#160;call. Be&#160;<br/>certain&#160;that the&#160;return offset does not exceed FFFFH.</p>
<p style="position:absolute;top:910px;left:69px;white-space:nowrap" class="ft06">These methods of transferring&#160;program&#160;control overcome&#160;the&#160;following architectural&#160;limitations imposed on calls&#160;<br/>between&#160;16-bit and&#160;32-bit code&#160;segments:</p>
<p style="position:absolute;top:949px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:949px;left:95px;white-space:nowrap" class="ft06">Pointers&#160;from&#160;16-bit code segments (which&#160;by default&#160;can only be 16 bits)&#160;cannot be used to&#160;address&#160;data&#160;or&#160;<br/>code&#160;located beyond&#160;FFFFH in&#160;a 32-bit segment.</p>
<p style="position:absolute;top:988px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:988px;left:95px;white-space:nowrap" class="ft06">The operand-size attributes&#160;for&#160;a CALL and its&#160;companion&#160;RETURN&#160;instruction must be the&#160;same to&#160;maintain&#160;<br/>stack coherency.&#160;This is also true for implicit calls to&#160;interrupt and exception handlers&#160;and their companion IRET&#160;<br/>instructions.</p>
<p style="position:absolute;top:1043px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:1044px;left:95px;white-space:nowrap" class="ft06">A 32-bit parameters&#160;(particularly a&#160;pointer&#160;parameter)&#160;greater than&#160;FFFFH cannot be&#160;squeezed&#160;into a 16-bit&#160;<br/>parameter location&#160;on&#160;a stack.</p>
</div>
</body>
</html>
