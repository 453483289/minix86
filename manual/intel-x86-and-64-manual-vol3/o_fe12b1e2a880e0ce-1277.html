<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1277</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:18px;font-family:Times;color:#000000;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:14px;font-family:Times;color:#0860a8;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1277-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1277.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:761px;white-space:nowrap" class="ft00">Vol. 3C&#160;34-27</p>
<p style="position:absolute;top:47px;left:666px;white-space:nowrap" class="ft01">SYSTEM&#160;MANAGEMENT&#160;MODE</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:100px;left:95px;white-space:nowrap" class="ft05">The&#160;32&#160;bits at the&#160;MSEG&#160;base address&#160;(used as&#160;a physical&#160;address) must contain the processor’s MSEG revision&#160;<br/>identifier.</p>
<p style="position:absolute;top:139px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:139px;left:95px;white-space:nowrap" class="ft05">Bits&#160;31:1&#160;of&#160;the SMM-transfer&#160;monitor features&#160;field&#160;in&#160;the MSEG header&#160;(see&#160;<a href="o_fe12b1e2a880e0ce-1275.html">Table&#160;34-10</a>) must be&#160;0.&#160;Bit&#160;0&#160;of&#160;<br/>the&#160;field&#160;(the&#160;IA-32e&#160;mode&#160;SMM&#160;feature&#160;bit) must be&#160;0&#160;if&#160;the processor does not support Intel&#160;64&#160;architecture.</p>
<p style="position:absolute;top:180px;left:69px;white-space:nowrap" class="ft03">If&#160;either of&#160;these checks&#160;fail,&#160;execution of VMCALL fails.</p>
<p style="position:absolute;top:224px;left:69px;white-space:nowrap" class="ft04">34.15.6.3 &#160;&#160;Updating the&#160;Current-VMCS and Executive-VMCS Pointers</p>
<p style="position:absolute;top:253px;left:69px;white-space:nowrap" class="ft05">Before&#160;performing the&#160;steps&#160;<a href="o_fe12b1e2a880e0ce-1270.html">in Section&#160;34.15.2.2,&#160;</a>SMM&#160;VM&#160;exits that activate the dual-monitor&#160;treatment begin by&#160;<br/>loading&#160;the SMM-transfer&#160;VMCS pointer with&#160;the&#160;value of the&#160;current-VMCS&#160;pointer.</p>
<p style="position:absolute;top:313px;left:69px;white-space:nowrap" class="ft04">34.15.6.4&#160;&#160;&#160;Saving Guest State</p>
<p style="position:absolute;top:342px;left:69px;white-space:nowrap" class="ft05">As noted in&#160;<a href="o_fe12b1e2a880e0ce-1271.html">Section 34.15.2.4, SM</a>M VM&#160;exits save&#160;the contents&#160;of the SMBASE&#160;register&#160;into&#160;the corresponding&#160;field&#160;<br/>in the&#160;guest-state area. While this is&#160;true&#160;also for SMM&#160;VM&#160;exits&#160;that&#160;activate&#160;the dual-monitor treatment, the&#160;<br/>VMCS&#160;used&#160;for those&#160;VM&#160;exits&#160;exists outside&#160;SMRAM.<br/>The&#160;SMM-transfer monitor (STM)&#160;can also discover&#160;the current value&#160;of&#160;the SMBASE register&#160;by&#160;using the&#160;RDMSR&#160;<br/>instruction&#160;to read&#160;the&#160;IA32_SMBASE MSR (MSR&#160;address 9EH). The following items&#160;detail&#160;use&#160;of&#160;this&#160;MSR:</p>
<p style="position:absolute;top:437px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:438px;left:95px;white-space:nowrap" class="ft03">The&#160;MSR is&#160;supported&#160;only if IA32_VMX_MISC[15]&#160;= 1&#160;(see&#160;<a href="o_fe12b1e2a880e0ce-1947.html">Appendix&#160;A.6).</a></p>
<p style="position:absolute;top:460px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:460px;left:95px;white-space:nowrap" class="ft05">A&#160;write&#160;to the IA32_SMBASE MSR using WRMSR&#160;generates a&#160;general-protection fault (#GP(0)). An attempt to&#160;<br/>write to&#160;the IA32_SMBASE&#160;MSR&#160;fails if made&#160;as&#160;part&#160;of&#160;a VM&#160;exit or part of a&#160;VM&#160;entry.</p>
<p style="position:absolute;top:499px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:499px;left:95px;white-space:nowrap" class="ft05">A&#160;read&#160;from&#160;the IA32_SMBASE&#160;MSR&#160;using RDMSR generates a&#160;general-protection fault&#160;(#GP(0)) if&#160;executed&#160;<br/>outside of SMM. An&#160;attempt&#160;to read from&#160;the IA32_SMBASE&#160;MSR&#160;fails if made as&#160;part&#160;of&#160;a VM exit&#160;that does&#160;not&#160;<br/>end&#160;in SMM.</p>
<p style="position:absolute;top:577px;left:69px;white-space:nowrap" class="ft04">34.15.6.5&#160;&#160;&#160;Saving MSRs</p>
<p style="position:absolute;top:605px;left:69px;white-space:nowrap" class="ft05">The&#160;VM-exit MSR-store&#160;area&#160;is&#160;not used&#160;by&#160;SMM&#160;VM&#160;exits&#160;that activate&#160;the dual-monitor treatment.&#160;No MSRs are&#160;<br/>saved into that&#160;area.</p>
<p style="position:absolute;top:666px;left:69px;white-space:nowrap" class="ft04">34.15.6.6&#160;&#160;&#160;Loading&#160;Host State</p>
<p style="position:absolute;top:694px;left:69px;white-space:nowrap" class="ft05">The&#160;VMCS&#160;that&#160;is&#160;current&#160;during&#160;an&#160;SMM&#160;VM&#160;exit&#160;that&#160;activates the dual-monitor treatment was established by the&#160;<br/>executive monitor.&#160;It&#160;does&#160;not contain the&#160;VM-exit controls&#160;and host state&#160;required&#160;to&#160;initialize&#160;the&#160;STM. For this&#160;<br/>reason,&#160;such SMM VM&#160;exits do not load processor state&#160;as&#160;described&#160;in&#160;<a href="o_fe12b1e2a880e0ce-1143.html">Section 27.5. Inste</a>ad,&#160;state&#160;is set to fixed&#160;<br/>values&#160;or loaded&#160;based on&#160;the&#160;content of&#160;the&#160;MSEG header (see<a href="o_fe12b1e2a880e0ce-1275.html">&#160;Table&#160;34-10</a>):</p>
<p style="position:absolute;top:766px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:766px;left:95px;white-space:nowrap" class="ft06">CR0 is&#160;set to&#160;as follows:<br/>—&#160;PG, NE, ET,&#160;MP, and PE&#160;are all&#160;set&#160;to 1.<br/>—&#160;CD and&#160;NW are left&#160;unchanged.<br/>—&#160;All&#160;other bits are cleared&#160;to&#160;0.</p>
<p style="position:absolute;top:860px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:861px;left:95px;white-space:nowrap" class="ft07">CR3 is&#160;set as&#160;follows:<br/>—&#160;Bits&#160;63:32&#160;are cleared&#160;on processors&#160;that support IA-32e mode.<br/>—&#160;Bits&#160;31:12&#160;are set to&#160;bits&#160;31:12 of&#160;the sum of&#160;the MSEG&#160;base address&#160;and&#160;the&#160;CR3-offset field&#160;in&#160;the&#160;MSEG&#160;</p>
<p style="position:absolute;top:925px;left:120px;white-space:nowrap" class="ft03">header.</p>
<p style="position:absolute;top:949px;left:95px;white-space:nowrap" class="ft03">—&#160;Bits&#160;11:5 and&#160;bits&#160;2:0&#160;are&#160;cleared&#160;(the&#160;corresponding&#160;bits&#160;in&#160;the CR3-offset&#160;field in&#160;the MSEG header are&#160;</p>
<p style="position:absolute;top:966px;left:120px;white-space:nowrap" class="ft03">ignored).</p>
<p style="position:absolute;top:990px;left:95px;white-space:nowrap" class="ft03">—&#160;Bits&#160;4:3&#160;are&#160;set&#160;to bits&#160;4:3&#160;of the&#160;CR3-offset&#160;field&#160;in the&#160;MSEG&#160;header.</p>
<p style="position:absolute;top:1012px;left:69px;white-space:nowrap" class="ft02">•</p>
<p style="position:absolute;top:1012px;left:95px;white-space:nowrap" class="ft06">CR4 is&#160;set as&#160;follows:<br/>—&#160;MCE and PGE&#160;are cleared.<br/>—&#160;PAE&#160;is set to&#160;the value of&#160;the IA-32e mode SMM&#160;feature bit.</p>
</div>
</body>
</html>
