<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1083</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:16px;font-family:Times;color:#000000;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;font-family:Times;color:#000000;}
	.ft06{font-size:8px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1083-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1083.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:769px;white-space:nowrap" class="ft00">Vol. 3C&#160;25-9</p>
<p style="position:absolute;top:47px;left:673px;white-space:nowrap" class="ft01">VMX&#160;NON-ROOT&#160;OPERATION</p>
<p style="position:absolute;top:100px;left:95px;white-space:nowrap" class="ft07">—&#160;If&#160;both controls&#160;are 0,&#160;RDTSC operates&#160;normally.<br/>—&#160;If the&#160;“RDTSC&#160;exiting” VM-execution&#160;control&#160;is 0 and the&#160;“use TSC offsetting” VM-execution&#160;control is&#160;1, the&#160;</p>
<p style="position:absolute;top:141px;left:120px;white-space:nowrap" class="ft02">value returned is&#160;determined by the setting of&#160;the&#160;“use&#160;TSC scaling” VM-execution control:</p>
<p style="position:absolute;top:166px;left:120px;white-space:nowrap" class="ft03">•</p>
<p style="position:absolute;top:165px;left:146px;white-space:nowrap" class="ft02">If the&#160;control&#160;is 0,&#160;RDTSC loads EAX:EDX with the sum of&#160;the value of the&#160;IA32_TIME_STAMP_COUNTER&#160;</p>
<p style="position:absolute;top:181px;left:145px;white-space:nowrap" class="ft02">MSR and&#160;the value&#160;of&#160;the TSC offset.</p>
<p style="position:absolute;top:207px;left:120px;white-space:nowrap" class="ft03">•</p>
<p style="position:absolute;top:205px;left:146px;white-space:nowrap" class="ft02">If&#160;the control is 1, RDTSC&#160;first computes the product of&#160;the value of&#160;the IA32_TIME_STAMP_COUNTER&#160;</p>
<p style="position:absolute;top:222px;left:145px;white-space:nowrap" class="ft08">MSR and&#160;the value&#160;of&#160;the TSC multiplier.&#160;It&#160;then shifts the value of the product&#160;right&#160;48&#160;bits and loads&#160;<br/>EAX:EDX&#160;with&#160;the sum&#160;of that&#160;shifted value&#160;and the&#160;value of the&#160;TSC&#160;offset.</p>
<p style="position:absolute;top:262px;left:94px;white-space:nowrap" class="ft02">—&#160;If the&#160;“RDTSC exiting”&#160;VM-execution control is&#160;1,&#160;RDTSC causes&#160;a VM&#160;exit.</p>
<p style="position:absolute;top:284px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:285px;left:95px;white-space:nowrap" class="ft09"><b>RDTSCP.</b>&#160;Behavior of the&#160;RDTSCP instruction is&#160;determined first by&#160;the setting of the&#160;“enable&#160;RDTSCP”&#160;<br/>VM-execution control:<br/>—&#160;If the&#160;“enable RDTSCP”&#160;VM-execution&#160;control is&#160;0,&#160;RDTSCP causes an&#160;invalid-opcode exception (#UD). This&#160;</p>
<p style="position:absolute;top:342px;left:120px;white-space:nowrap" class="ft02">exception takes priority&#160;over&#160;any other&#160;exception the&#160;instruction&#160;may&#160;incur.</p>
<p style="position:absolute;top:366px;left:95px;white-space:nowrap" class="ft02">—&#160;If the “enable RDTSCP” VM-execution control is 1, treatment is based&#160;on the&#160;settings of the “RDTSC exiting”&#160;</p>
<p style="position:absolute;top:382px;left:120px;white-space:nowrap" class="ft02">and “use TSC offsetting” VM-execution&#160;controls:</p>
<p style="position:absolute;top:408px;left:120px;white-space:nowrap" class="ft03">•</p>
<p style="position:absolute;top:406px;left:146px;white-space:nowrap" class="ft02">If&#160;both controls are 0, RDTSCP&#160;operates normally.</p>
<p style="position:absolute;top:432px;left:120px;white-space:nowrap" class="ft03">•</p>
<p style="position:absolute;top:430px;left:146px;white-space:nowrap" class="ft02">If the&#160;“RDTSC exiting”&#160;VM-execution control&#160;is 0&#160;and&#160;the&#160;“use TSC offsetting” VM-execution&#160;control&#160;is 1,&#160;</p>
<p style="position:absolute;top:447px;left:145px;white-space:nowrap" class="ft02">the value returned is&#160;determined by&#160;the setting&#160;of&#160;the “use&#160;TSC scaling” VM-execution control:</p>
<p style="position:absolute;top:471px;left:146px;white-space:nowrap" class="ft02">—</p>
<p style="position:absolute;top:471px;left:176px;white-space:nowrap" class="ft02">If&#160;the control is&#160;0, RDTSCP loads EAX:EDX with the&#160;sum&#160;of the&#160;value&#160;of the&#160;</p>
<p style="position:absolute;top:487px;left:175px;white-space:nowrap" class="ft02">IA32_TIME_STAMP_COUNTER MSR&#160;and&#160;the&#160;value&#160;of the&#160;TSC&#160;offset.</p>
<p style="position:absolute;top:511px;left:146px;white-space:nowrap" class="ft02">—</p>
<p style="position:absolute;top:511px;left:176px;white-space:nowrap" class="ft02">If the&#160;control&#160;is 1,&#160;RDTSCP&#160;first computes&#160;the product of the&#160;value of the&#160;</p>
<p style="position:absolute;top:528px;left:175px;white-space:nowrap" class="ft08">IA32_TIME_STAMP_COUNTER MSR&#160;and&#160;the&#160;value&#160;of the&#160;TSC multiplier.&#160;It&#160;then shifts the&#160;value of&#160;<br/>the product&#160;right 48 bits&#160;and loads EAX:EDX with the sum&#160;of&#160;that shifted&#160;value and&#160;the value of the&#160;<br/>TSC offset.</p>
<p style="position:absolute;top:585px;left:146px;white-space:nowrap" class="ft02">In either&#160;case, RDTSCP&#160;also loads&#160;ECX with the value of&#160;bits 31:0&#160;of&#160;the IA32_TSC_AUX&#160;MSR.</p>
<p style="position:absolute;top:610px;left:120px;white-space:nowrap" class="ft03">•</p>
<p style="position:absolute;top:609px;left:146px;white-space:nowrap" class="ft02">If the&#160;“RDTSC exiting”&#160;VM-execution control is&#160;1,&#160;RDTSCP&#160;causes&#160;a VM&#160;exit.</p>
<p style="position:absolute;top:631px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:631px;left:95px;white-space:nowrap" class="ft08"><b>SMSW.</b>&#160;The behavior of SMSW&#160;is determined by the CR0&#160;guest/host mask and the CR0 read&#160;shadow.&#160;For each&#160;<br/>position&#160;corresponding&#160;to&#160;a bit clear in&#160;the&#160;CR0 guest/host mask,&#160;the destination&#160;operand is&#160;loaded with the&#160;<br/>value of&#160;the&#160;corresponding bit in&#160;CR0. For each position&#160;corresponding to a bit set in the CR0 guest/host mask,&#160;<br/>the destination operand&#160;is loaded&#160;with&#160;the&#160;value of the corresponding&#160;bit in&#160;the&#160;CR0 read shadow. Thus, if&#160;every&#160;<br/>bit&#160;is cleared in the CR0&#160;guest/host&#160;mask, MOV&#160;from&#160;CR0 reads normally from CR0;&#160;if every&#160;bit&#160;is set in&#160;the&#160;CR0&#160;<br/>guest/host&#160;mask, MOV from CR0&#160;returns the&#160;value&#160;of the&#160;CR0 read shadow.<br/>Note the&#160;following:&#160;(1)&#160;for&#160;any memory destination&#160;or for a&#160;16-bit&#160;register&#160;destination,&#160;only the&#160;low 16&#160;bits&#160;of&#160;<br/>the&#160;CR0 guest/host&#160;mask&#160;and the CR0 read shadow&#160;are&#160;used&#160;(bits&#160;63:16 of&#160;a register destination are&#160;left&#160;<br/>unchanged); (2)&#160;for a&#160;32-bit register destination,&#160;only&#160;the low 32 bits&#160;of the CR0&#160;guest/host&#160;mask and the&#160;CR0&#160;<br/>read shadow are used&#160;(bits&#160;63:32&#160;of&#160;the destination are&#160;cleared); and&#160;(3)&#160;depending&#160;on the&#160;contents of the&#160;<br/>CR0&#160;guest/host mask and&#160;the CR0&#160;read&#160;shadow,&#160;bits may be set&#160;in the&#160;destination&#160;that&#160;would never be set&#160;<br/>when reading directly from&#160;CR0.</p>
<p style="position:absolute;top:841px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:841px;left:95px;white-space:nowrap" class="ft09"><b>WRMSR.</b><a href="o_fe12b1e2a880e0ce-1076.html">&#160;Section 25.1.3&#160;</a>identifies&#160;when&#160;executions&#160;of&#160;the&#160;WRMSR&#160;instruction&#160;cause VM&#160;exits. If such an&#160;<br/>execution&#160;neither a&#160;fault&#160;due&#160;to CPL&#160;&gt;&#160;0 nor a&#160;VM&#160;exit, the&#160;instruction’s&#160;behavior may be modified&#160;for certain&#160;<br/>values&#160;of&#160;ECX:<br/>—&#160;If ECX contains 79H (indicating IA32_BIOS_UPDT_TRIG&#160;MSR), no microcode update is loaded, and control&#160;</p>
<p style="position:absolute;top:915px;left:120px;white-space:nowrap" class="ft08">passes&#160;to the&#160;next&#160;instruction.&#160;This implies that&#160;microcode&#160;updates cannot&#160;be&#160;loaded in VMX non-root&#160;<br/>operation.</p>
<p style="position:absolute;top:955px;left:95px;white-space:nowrap" class="ft02">—&#160;On processors that&#160;support Intel&#160;PT but which&#160;do&#160;not&#160;allow it&#160;to be&#160;used in VMX operation,&#160;if ECX contains&#160;</p>
<p style="position:absolute;top:972px;left:120px;white-space:nowrap" class="ft08">570H (indicating&#160;the&#160;IA32_RTIT_CTL MSR),&#160;the&#160;instruction&#160;causes&#160;a general-protection exception if&#160;it&#160;<br/>attempts IA32_RTIT_CTL.TraceEn.</p>
<p style="position:absolute;top:986px;left:353px;white-space:nowrap" class="ft06">1</p>
<p style="position:absolute;top:1038px;left:69px;white-space:nowrap" class="ft02">1.&#160;Software&#160;should&#160;read&#160;the&#160;VMX&#160;capability&#160;MSR&#160;IA32_VMX_MISC&#160;to&#160;determine&#160;whether the processor allows&#160;Intel&#160;PT to&#160;be used in&#160;</p>
<p style="position:absolute;top:1054px;left:91px;white-space:nowrap" class="ft02">VMX operation&#160;(see<a href="o_fe12b1e2a880e0ce-1947.html">&#160;Appendix&#160;A.6).</a></p>
</div>
</body>
</html>
