<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1248</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:14px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1248-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1248.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">33-10&#160;Vol. 3C</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">HANDLING&#160;BOUNDARY&#160;CONDITIONS&#160;IN A VIRTUAL MACHINE MONITOR</p>
<p style="position:absolute;top:99px;left:68px;white-space:nowrap" class="ft02">33.4.3.1 &#160;&#160;VMM Error Handling Strategies</p>
<p style="position:absolute;top:127px;left:68px;white-space:nowrap" class="ft03">Broadly speaking,&#160;there&#160;are two strategies&#160;that VMMs&#160;may take for error handling:&#160;</p>
<p style="position:absolute;top:149px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:150px;left:93px;white-space:nowrap" class="ft05">Basic&#160;error handling:&#160;in this&#160;approach the&#160;guest&#160;VM is&#160;treated&#160;as any&#160;other thread&#160;of execution. If the&#160;error&#160;<br/>recovery action does not&#160;support&#160;restarting the thread&#160;after handling&#160;the&#160;error,&#160;the guest VM should&#160;be&#160;<br/>terminated.</p>
<p style="position:absolute;top:205px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:205px;left:93px;white-space:nowrap" class="ft05">MCA&#160;virtualization: in&#160;this approach, the&#160;VMM virtualizes the&#160;MCA events&#160;and hardware.&#160;This enables the&#160;VMM&#160;<br/>to intercept MCA events and inject an MCA into the guest VM. The guest VM then has the opportunity to attempt&#160;<br/>error recovery&#160;actions,&#160;rather&#160;than&#160;being terminated by the&#160;VMM.</p>
<p style="position:absolute;top:262px;left:68px;white-space:nowrap" class="ft03">Details of these approaches and implementation&#160;considerations for hosted and&#160;native&#160;VMMs are discussed&#160;below.</p>
<p style="position:absolute;top:307px;left:68px;white-space:nowrap" class="ft02">33.4.3.2 &#160;&#160;Basic VMM MCA error recovery handling</p>
<p style="position:absolute;top:335px;left:68px;white-space:nowrap" class="ft03">The simplest approach is&#160;for&#160;the VMM&#160;to treat&#160;the guest&#160;VM as&#160;any other&#160;thread of&#160;execution:</p>
<p style="position:absolute;top:357px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:358px;left:93px;white-space:nowrap" class="ft05">MCE's that&#160;occur outside&#160;the&#160;stream of execution&#160;of&#160;a&#160;virtual&#160;machine guest will cause&#160;an MCE abort&#160;and&#160;may&#160;<br/>be handled by the MCA&#160;error handler following the&#160;recovery actions&#160;and guidelines&#160;desc<a href="o_fe12b1e2a880e0ce-526.html">ribed in Section 15.9,&#160;<br/></a>and&#160;<a href="o_fe12b1e2a880e0ce-532.html">Section 15.10</a>.&#160;This includes logging the error and taking appropriate recovery actions when necessary. The&#160;<br/>VMM&#160;must&#160;not&#160;resume&#160;the interrupted thread of execution&#160;or&#160;another VM until&#160;it has taken the&#160;appropriate&#160;<br/>recovery action or, in the&#160;case&#160;of&#160;fatal MCAs, reset&#160;the&#160;system.</p>
<p style="position:absolute;top:445px;left:68px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:446px;left:93px;white-space:nowrap" class="ft05">MCE's that&#160;occur while executing in&#160;the&#160;context of a&#160;virtual machine will be intercepted by the&#160;VMM. The&#160;MCA&#160;<br/>intercept handler may&#160;follow&#160;the&#160;error&#160;handling guidelines&#160;<a href="o_fe12b1e2a880e0ce-526.html">listed in Section 15.9</a>&#160;and&#160;<a href="o_fe12b1e2a880e0ce-532.html">Section&#160;15.10</a>&#160;for SRAO&#160;<br/>and&#160;SRAR errors.&#160;For SRAR errors, terminating&#160;the thread&#160;of execution&#160;will&#160;involve&#160;terminating the&#160;affected&#160;<br/>guest VM.&#160;For&#160;fatal errors&#160;the MCA handler&#160;should log&#160;the error and&#160;reset&#160;the system&#160;-- the&#160;VMM should not&#160;<br/>resume&#160;execution of the interrupted VM.</p>
<p style="position:absolute;top:556px;left:68px;white-space:nowrap" class="ft02">33.4.3.3 &#160;&#160;Implementation Considerations for the&#160;Basic&#160;Model</p>
<p style="position:absolute;top:585px;left:68px;white-space:nowrap" class="ft05">For&#160;hosted&#160;VMMs,&#160;the&#160;host OS MCA error&#160;handling code will perform&#160;error analysis and&#160;initiate the appropriate&#160;<br/>recovery actions. For the basic model this&#160;flow&#160;does&#160;not&#160;change when terminating&#160;a guest&#160;VM&#160;although the specific&#160;<br/>actions needed to terminate a&#160;guest&#160;VM&#160;may be different than terminating&#160;an application or&#160;user process.<br/>For native, hypervisor-based VMMs,&#160;MCA&#160;errors will&#160;either&#160;be delivered directly to the&#160;VMM MCA handler (when the&#160;<br/>error is&#160;signaled while in&#160;the VMM&#160;context)&#160;or cause&#160;a VM&#160;exit&#160;from&#160;a&#160;guest&#160;VM&#160;or be delivered to&#160;the MCA intercept&#160;<br/>handler.&#160;There are two general&#160;approaches&#160;the hypervisor&#160;can use&#160;to&#160;handle the&#160;MCA&#160;error: either&#160;by forwarding&#160;<br/>the error to the&#160;control OS&#160;or within the&#160;hypervisor itself. These approaches&#160;are described in&#160;the following para-<br/>graphs.<br/>The hypervisor&#160;may forward the error to the control OS for handling&#160;errors. This approach simplifies the&#160;hypervisor&#160;<br/>error handling since it relies on the control OS to implement the basic error handling model. &#160;The control OS error&#160;<br/>handling code will&#160;be&#160;similar&#160;to the&#160;error handling code&#160;in&#160;the hosted VMM. Errors&#160;can be forwarded to&#160;the control&#160;<br/>OS via an OS callback or by injecting&#160;an MCE event into the control OS. Injecting an MCE will cause&#160;the&#160;control OS&#160;<br/>MCA&#160;error handler&#160;to be invoked. The control OS is&#160;responsible&#160;for terminating&#160;the&#160;affected guest&#160;VM, if&#160;necessary,&#160;<br/>which&#160;may require cooperation from the&#160;hypervisor.<br/>Alternatively,&#160;the&#160;error&#160;may be handled completely in&#160;the&#160;hypervisor. The&#160;hypervisor&#160;error handler&#160;is enhanced to&#160;<br/>implement&#160;the&#160;basic error&#160;handling model and&#160;the hypervisor error&#160;handler has the&#160;capability to&#160;fully analyze the&#160;<br/>error&#160;information and&#160;take&#160;recovery actions&#160;based on&#160;the guidelines. In this case error&#160;handling&#160;steps in the hyper-<br/>visor are&#160;similar to&#160;those&#160;for the&#160;hosted&#160;VMM described&#160;above (where&#160;the hypervisor replaces&#160;the host OS actions).&#160;<br/>The&#160;hypervisor is&#160;responsible for&#160;terminating the&#160;affected&#160;guest VM, if necessary.<br/>In all&#160;cases, if a&#160;fatal error&#160;is detected the&#160;VMM error&#160;handler should&#160;log the&#160;error&#160;and reset the&#160;system.&#160;The VMM&#160;<br/>error handler must ensure&#160;that guest VMs are not resumed&#160;after a&#160;fatal error&#160;is detected to&#160;ensure error&#160;contain-<br/>ment is&#160;maintained.</p>
<p style="position:absolute;top:1006px;left:68px;white-space:nowrap" class="ft02">33.4.3.4 &#160;&#160;MCA Virtualization</p>
<p style="position:absolute;top:1034px;left:68px;white-space:nowrap" class="ft05">A more&#160;sophisticated approach for handling&#160;errors is&#160;to virtualize&#160;the MCA. This involves virtualizing the&#160;MCA&#160;hard-<br/>ware&#160;and intercepting&#160;the MCA event in&#160;the VMM&#160;when a&#160;guest VM&#160;is interrupted by&#160;an&#160;MCA. After analyzing&#160;the&#160;</p>
</div>
</body>
</html>
