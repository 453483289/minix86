<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 647</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:18px;font-family:Times;color:#000000;}
	.ft04{font-size:16px;font-family:Times;color:#0860a8;}
	.ft05{font-size:14px;font-family:Times;color:#0860a8;}
	.ft06{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page647-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce647.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:761px;white-space:nowrap" class="ft00">Vol. 3B&#160;18-11</p>
<p style="position:absolute;top:47px;left:672px;white-space:nowrap" class="ft01">PERFORMANCE MONITORING</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft07">One&#160;example&#160;is&#160;the&#160;proliferation&#160;of software&#160;environments&#160;that support multiple&#160;virtual&#160;machines&#160;(VM)&#160;under&#160;VMX&#160;<br/><a href="˛ˇ">(see Chapter&#160;23, ‚ÄúIntroduction&#160;to&#160;Virtual-Machine&#160;Extensions‚Äù)</a>&#160;where each&#160;VM&#160;represents&#160;a domain separated&#160;<br/>from one&#160;another.<br/>A Virtual Machine&#160;Monitor (VMM)&#160;that manages&#160;the VMs&#160;may&#160;allow&#160;individual VM&#160;to employ performance&#160;moni-<br/>toring facilities to&#160;profiles the&#160;performance characteristics&#160;of&#160;a workload.&#160;The use&#160;of the&#160;Anythread interface&#160;in&#160;<br/>IA32_PERFEVTSELx and&#160;IA32_FIXED_CTR_CTRL is&#160;discouraged&#160;with software&#160;environments supporting virtualiza-<br/>tion or requiring domain&#160;separation.&#160;<br/>Specifically, Intel&#160;recommends VMM:</p>
<p style="position:absolute;top:253px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:253px;left:95px;white-space:nowrap" class="ft06">configure the MSR bitmap&#160;to cause VM-exits for WRMSR&#160;to IA32_PERFEVTSELx and IA32_FIXED_CTR_CTRL in&#160;<br/>VMX non-Root&#160;operation&#160;<a href="˛ˇ">(see CHAPTER 24 for</a>&#160;additional&#160;information),&#160;</p>
<p style="position:absolute;top:292px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:292px;left:95px;white-space:nowrap" class="ft06">clear&#160;the&#160;AnyThread&#160;bit&#160;of IA32_PERFEVTSELx&#160;and IA32_FIXED_CTR_CTRL&#160;in the&#160;MSR-load&#160;lists&#160;for VM&#160;exits&#160;<br/><a href="˛ˇ">and VM entries (see CHAPTER&#160;24, CHAPTER&#160;26, and&#160;CHAPTER 27).</a></p>
<p style="position:absolute;top:333px;left:69px;white-space:nowrap" class="ft06">Even when operating&#160;in simpler legacy&#160;software environments&#160;which might&#160;not emphasize&#160;the pre-requisites of a&#160;<br/>virtualized&#160;software environment, the&#160;use&#160;of&#160;the AnyThread&#160;interface&#160;should&#160;be&#160;moderated&#160;and follow any&#160;event-<br/>specific guidance where&#160;explicitly noted (see relevant&#160;se<a href="˛ˇ">ctions of Chapter&#160;19, ‚ÄúPerformance&#160;Monitoring Events‚Äù</a>).</p>
<p style="position:absolute;top:416px;left:69px;white-space:nowrap" class="ft04">18.2.4&#160;</p>
<p style="position:absolute;top:416px;left:149px;white-space:nowrap" class="ft04">Architectural Performance Monitoring Version 4&#160;</p>
<p style="position:absolute;top:447px;left:69px;white-space:nowrap" class="ft06">Processors supporting&#160;architectural&#160;performance monitoring&#160;version&#160;4&#160;also supports version&#160;1, 2, and 3,&#160;as well as&#160;<br/>capability enumerated&#160;by&#160;CPUID leaf&#160;0AH.&#160;Version 4&#160;introduced&#160;a streamlined PMI overhead&#160;mitigation&#160;interface&#160;<br/>that replaces&#160;the legacy semantic&#160;behavior&#160;but retains the&#160;same&#160;control interface in&#160;<br/>IA32_DEBUGCTL.Freeze_LBRs_On_PMI and&#160;Freeze_PerfMon_On_PMI. Specifically version 4&#160;provides&#160;the following&#160;<br/>enhancement:</p>
<p style="position:absolute;top:535px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:535px;left:95px;white-space:nowrap" class="ft02">New indicators (LBR_FRZ,&#160;CTR_FRZ) in IA32_PERF_GLOBAL_STATUS,&#160;<a href="o_fe12b1e2a880e0ce-647.html">see&#160;Section&#160;18.2.4.1</a>.</p>
<p style="position:absolute;top:557px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:558px;left:95px;white-space:nowrap" class="ft06">Streamlined Freeze/PMI Overhead&#160;management&#160;interfaces&#160;to use IA32_DEBUGCTL.Freeze_LBRs_On_PMI&#160;and&#160;<br/>IA32_DEBUGCTL.Freeze_PerfMon_On_PMI:&#160;see<a href="o_fe12b1e2a880e0ce-647.html">&#160;Section 18.2.4.1</a>.&#160;Legacy semantics&#160;of&#160;Freeze_LBRs_On_PMI&#160;<br/>and Freeze_PerfMon_On_PMI (applicable to&#160;version&#160;2 and 3) are&#160;not supported&#160;with version 4 or higher.</p>
<p style="position:absolute;top:613px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:613px;left:95px;white-space:nowrap" class="ft06">Fine-grain&#160;separation of control interface to&#160;manage overflow/status of IA32_PERF_GLOBAL_STATUS and&#160;<br/>read-only performance&#160;counter enabling interface&#160;in IA32_PERF_GLOBAL_STA<a href="o_fe12b1e2a880e0ce-648.html">TUS: see Section 18.2.4.2.</a></p>
<p style="position:absolute;top:652px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:652px;left:95px;white-space:nowrap" class="ft06">Performance&#160;monitoring resource&#160;in-use MSR&#160;to facilitate cooperative sharing&#160;protocol&#160;between perfmon-<br/>managing privilege&#160;agents.</p>
<p style="position:absolute;top:713px;left:69px;white-space:nowrap" class="ft05">18.2.4.1 &#160;&#160;Enhancement in&#160;IA32_PERF_GLOBAL_STATUS&#160;</p>
<p style="position:absolute;top:742px;left:69px;white-space:nowrap" class="ft06">The IA32_PERF_GLOBAL_STATUS MSR&#160;provides&#160;the following&#160;indicators with architectural&#160;performance&#160;monitoring&#160;<br/>version&#160;4:</p>
<p style="position:absolute;top:780px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:781px;left:95px;white-space:nowrap" class="ft07">IA32_PERF_GLOBAL_STATUS.LBR_FRZ[bit 58]: This&#160;bit is&#160;set due to&#160;the following conditions:<br/>‚Äî&#160;IA32_DEBUGCTL.FREEZE_LBR_ON_PMI has&#160;been&#160;set by the&#160;profiling&#160;agent,&#160;and<br/>‚Äî&#160;A&#160;performance counter,&#160;configured to&#160;generate&#160;PMI,&#160;has overflowed&#160;to signal a PMI.&#160;Consequently&#160;the LBR&#160;</p>
<p style="position:absolute;top:845px;left:120px;white-space:nowrap" class="ft02">stack&#160;is&#160;frozen.</p>
<p style="position:absolute;top:868px;left:94px;white-space:nowrap" class="ft08">Effectively,&#160;the&#160;IA32_PERF_GLOBAL_STATUS.LBR_FRZ bit&#160;also serve&#160;as an&#160;read-only control to&#160;enable&#160;<br/>capturing data&#160;in the&#160;LBR stack. To&#160;enable&#160;capturing&#160;LBR records,&#160;the following expression must hold&#160;with&#160;<br/>architectural perfmon version 4&#160;or higher:<br/>‚Äî&#160;(IA32_DEBUGCTL.LBR&#160;&amp; (!IA32_PERF_GLOBAL_STATUS.LBR_FRZ)&#160;) =1</p>
<p style="position:absolute;top:946px;left:69px;white-space:nowrap" class="ft03">‚Ä¢</p>
<p style="position:absolute;top:947px;left:95px;white-space:nowrap" class="ft07">IA32_PERF_GLOBAL_STATUS.CTR_FRZ[bit 59]: This&#160;bit&#160;is set due&#160;to the&#160;following&#160;conditions:<br/>‚Äî&#160;IA32_DEBUGCTL.FREEZE_PERFMON_ON_PMI has&#160;been&#160;set by the profiling&#160;agent, and<br/>‚Äî&#160;A&#160;performance&#160;counter,&#160;configured to&#160;generate PMI, has overflowed&#160;to&#160;signal a&#160;PMI.&#160;Consequently,&#160;all&#160;the&#160;</p>
<p style="position:absolute;top:1012px;left:120px;white-space:nowrap" class="ft02">performance counters&#160;are frozen.</p>
</div>
</body>
</html>
