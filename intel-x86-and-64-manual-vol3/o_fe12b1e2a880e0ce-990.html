<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 990</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:14px;font-family:Times;color:#0860a8;}
	.ft04{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page990-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce990.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">20-14&#160;Vol. 3B</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">8086&#160;EMULATION</p>
<p style="position:absolute;top:100px;left:68px;white-space:nowrap" class="ft04">The virtual-8086 monitor runs at&#160;privilege level&#160;0,&#160;like&#160;the&#160;protected-mode interrupt and&#160;exception handlers.&#160;It is&#160;<br/>commonly&#160;closely tied to&#160;the protected-mode general-protection&#160;exception (#GP,&#160;vector 13) handler.&#160;If the&#160;<br/>protected-mode&#160;interrupt&#160;or exception handler calls the&#160;virtual-8086&#160;monitor to&#160;handle the interrupt&#160;or exception,&#160;<br/>the return&#160;from&#160;the virtual-8086 monitor to&#160;the interrupted&#160;virtual-8086&#160;mode&#160;program requires&#160;two&#160;return&#160;<br/>instructions: a&#160;RET instruction&#160;to&#160;return to&#160;the protected-mode handler&#160;and an&#160;IRET instruction&#160;to&#160;return to&#160;the&#160;<br/>interrupted&#160;program.<br/>The virtual-8086 monitor has&#160;the option&#160;of&#160;directing the&#160;interrupt and exception back&#160;to an&#160;interrupt or&#160;exception&#160;<br/>handler&#160;that&#160;is part of the&#160;interrupted&#160;8086&#160;program,&#160;as&#160;described<a href="o_fe12b1e2a880e0ce-990.html">&#160;in Section 20.3.1.2,&#160;“Handling an&#160;Interrupt or&#160;<br/>Exception&#160;With an 8086&#160;Program Interrupt&#160;or Exception&#160;Handler”</a>.</p>
<p style="position:absolute;top:284px;left:68px;white-space:nowrap" class="ft03">20.3.1.2&#160;&#160;&#160;Handling an&#160;Interrupt or Exception With an 8086&#160;Program Interrupt&#160;or&#160;Exception Handler</p>
<p style="position:absolute;top:313px;left:68px;white-space:nowrap" class="ft05">Because&#160;it was&#160;designed&#160;to&#160;run on an 8086&#160;processor,&#160;an&#160;8086&#160;program running&#160;in&#160;a virtual-8086-mode task&#160;<br/>contains an 8086-style interrupt&#160;vector&#160;table,&#160;which&#160;starts&#160;at linear&#160;address 0.&#160;If the virtual-8086&#160;monitor&#160;correctly&#160;<br/>directs an&#160;interrupt&#160;or exception vector back to the&#160;virtual-8086-mode&#160;task it came from,&#160;the handlers&#160;in the&#160;8086&#160;<br/>program&#160;can&#160;handle&#160;the interrupt or&#160;exception. The virtual-8086&#160;monitor&#160;must carry out&#160;the&#160;following steps to&#160;send&#160;<br/>an interrupt&#160;or exception&#160;back to&#160;the&#160;8086&#160;program:<br/>1.&#160;Use the&#160;8086&#160;interrupt vector&#160;to locate the&#160;appropriate&#160;handler&#160;procedure in&#160;the 8086 program interrupt table.<br/>2.&#160;Store&#160;the EFLAGS (low-order 16 bits&#160;only), CS&#160;and EIP values&#160;of&#160;the&#160;8086&#160;program on the&#160;privilege-level 3&#160;</p>
<p style="position:absolute;top:443px;left:93px;white-space:nowrap" class="ft04">stack.&#160;This&#160;is the&#160;stack that the&#160;virtual-8086-mode task&#160;is using.&#160;(The&#160;8086&#160;handler may use&#160;or&#160;modify this&#160;<br/>information.)</p>
<p style="position:absolute;top:484px;left:68px;white-space:nowrap" class="ft05">3.&#160;Change the return link on&#160;the privilege-level&#160;0 stack to&#160;point to&#160;the privilege-level&#160;3 handler&#160;procedure.<br/>4.&#160;Execute an IRET instruction to pass&#160;control to the&#160;8086&#160;program&#160;handler.<br/>5.&#160;When the IRET&#160;instruction from the&#160;privilege-level&#160;3 handler triggers a general-protection exception (#GP) and&#160;</p>
<p style="position:absolute;top:548px;left:93px;white-space:nowrap" class="ft04">thus effectively again calls&#160;the virtual-8086 monitor,&#160;restore the&#160;return link on&#160;the&#160;privilege-level&#160;0 stack&#160;to&#160;<br/>point to&#160;the original, interrupted, privilege-level&#160;3 procedure.</p>
<p style="position:absolute;top:589px;left:68px;white-space:nowrap" class="ft02">6.&#160;Copy&#160;the low order 16&#160;bits of the&#160;EFLAGS&#160;image from&#160;the&#160;privilege-level&#160;3&#160;stack to&#160;the&#160;privilege-level&#160;0 stack&#160;</p>
<p style="position:absolute;top:605px;left:93px;white-space:nowrap" class="ft02">(because some 8086&#160;handlers modify these&#160;flags to&#160;return&#160;information to the code that caused the interrupt).&#160;</p>
<p style="position:absolute;top:629px;left:68px;white-space:nowrap" class="ft04">7.&#160;Execute an&#160;IRET instruction to&#160;pass control&#160;back to&#160;the interrupted 8086&#160;program.<br/>Note&#160;that&#160;if an operating&#160;system intends to support all&#160;8086 MS-DOS-based&#160;programs,&#160;it&#160;is necessary&#160;to use&#160;the&#160;<br/>actual 8086 interrupt and&#160;exception handlers supplied with the&#160;program.&#160;The&#160;reason&#160;for&#160;this&#160;is&#160;that&#160;some&#160;programs&#160;<br/>modify their&#160;own interrupt vector table to&#160;substitute (or&#160;hook&#160;in series) their&#160;own specialized interrupt&#160;and excep-<br/>tion handlers.</p>
<p style="position:absolute;top:747px;left:68px;white-space:nowrap" class="ft03">20.3.1.3 &#160;&#160;Handling an&#160;Interrupt&#160;or Exception Through a Task Gate</p>
<p style="position:absolute;top:775px;left:68px;white-space:nowrap" class="ft05">When an&#160;interrupt or exception&#160;vector points&#160;to a task&#160;gate&#160;in&#160;the IDT,&#160;the processor&#160;performs a task switch&#160;to the&#160;<br/>selected&#160;interrupt- or&#160;exception-handling task. The&#160;following&#160;actions&#160;are carried out&#160;as part&#160;of this task&#160;switch:<br/>1.&#160;The EFLAGS&#160;register with the&#160;VM&#160;flag set is&#160;saved&#160;in the&#160;current TSS.<br/>2.&#160;The&#160;link&#160;field in&#160;the TSS of&#160;the called task&#160;is loaded&#160;with&#160;the segment selector of&#160;the TSS for the&#160;interrupted&#160;</p>
<p style="position:absolute;top:856px;left:93px;white-space:nowrap" class="ft02">virtual-8086-mode task.</p>
<p style="position:absolute;top:880px;left:68px;white-space:nowrap" class="ft02">3.&#160;The&#160;EFLAGS&#160;register&#160;is&#160;loaded&#160;from&#160;the image in&#160;the new TSS,&#160;which clears&#160;the&#160;VM&#160;flag and causes&#160;the&#160;</p>
<p style="position:absolute;top:897px;left:93px;white-space:nowrap" class="ft02">processor&#160;to switch to&#160;protected mode.</p>
<p style="position:absolute;top:921px;left:68px;white-space:nowrap" class="ft04">4.&#160;The&#160;NT&#160;flag in&#160;the EFLAGS&#160;register is&#160;set.<br/>5.&#160;The processor begins&#160;executing the&#160;selected interrupt-&#160;or exception-handler&#160;task.<br/>When an IRET instruction&#160;is executed&#160;in&#160;the&#160;handler task and&#160;the NT&#160;flag in&#160;the EFLAGS&#160;register is&#160;set,&#160;the proces-<br/>sors switches&#160;from&#160;a protected-mode&#160;interrupt- or&#160;exception-handler&#160;task back&#160;to a&#160;virtual-8086-mode task. Here,&#160;<br/>the EFLAGS and segment&#160;registers are loaded from&#160;images&#160;saved&#160;in the TSS&#160;for the virtual-8086-mode task. If the&#160;<br/>VM&#160;flag is&#160;set in&#160;the&#160;EFLAGS&#160;image,&#160;the processor switches back&#160;to virtual-8086&#160;mode&#160;on&#160;the&#160;task switch. The CPL&#160;<br/>at&#160;the time&#160;the&#160;IRET instruction is&#160;executed must be 0,&#160;otherwise the&#160;processor&#160;does&#160;not change&#160;the state of the&#160;<br/>VM&#160;flag.&#160;</p>
</div>
</body>
</html>
