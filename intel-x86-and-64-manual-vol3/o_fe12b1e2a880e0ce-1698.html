<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1698</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:12px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1698-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1698.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">36-14&#160;Vol. 3C</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">INTEL® PROCESSOR TRACE</p>
<p style="position:absolute;top:559px;left:68px;white-space:nowrap" class="ft02">ToPA&#160;Errors</p>
<p style="position:absolute;top:583px;left:68px;white-space:nowrap" class="ft06">When a&#160;malformed ToPA&#160;entry is&#160;found, an&#160;<b>operation&#160;error</b>&#160;results (see<a href="o_fe12b1e2a880e0ce-1719.html">&#160;Section 36.3.9</a>). A malformed&#160;entry&#160;can&#160;<br/>be&#160;any of the&#160;following:<br/>1.&#160;<b>ToPA entry reserved bit&#160;violation</b>.</p>
<p style="position:absolute;top:640px;left:93px;white-space:nowrap" class="ft03">This describes cases where a&#160;bit&#160;marked&#160;as reserved in<a href="o_fe12b1e2a880e0ce-1693.html">&#160;Section&#160;36.2.6.2&#160;</a>above is&#160;set&#160;to&#160;1.</p>
<p style="position:absolute;top:664px;left:68px;white-space:nowrap" class="ft03">2.&#160;<b>ToPA alignment violation</b>.</p>
<p style="position:absolute;top:681px;left:93px;white-space:nowrap" class="ft06">This includes cases where illegal&#160;ToPA&#160;entry&#160;base&#160;address bits are&#160;set&#160;to 1:<br/>a.&#160;ToPA&#160;table base address&#160;is not 4KB-aligned. The table base can&#160;be&#160;from&#160;a WRMSR&#160;to&#160;</p>
<p style="position:absolute;top:721px;left:119px;white-space:nowrap" class="ft03">IA32_RTIT_OUTPUT_BASE,&#160;or&#160;from&#160;a ToPA&#160;entry with END=1.</p>
<p style="position:absolute;top:745px;left:93px;white-space:nowrap" class="ft03">b.&#160;ToPA&#160;entry base&#160;address is not aligned to the ToPA&#160;entry size (e.g.,&#160;a 2MB region with base&#160;address[20:12]&#160;</p>
<p style="position:absolute;top:762px;left:119px;white-space:nowrap" class="ft03">not equal to&#160;0).</p>
<p style="position:absolute;top:786px;left:93px;white-space:nowrap" class="ft03">c.&#160;ToPA&#160;entry&#160;base&#160;address sets&#160;upper physical&#160;address&#160;bits not&#160;supported&#160;by the&#160;processor.</p>
<p style="position:absolute;top:810px;left:68px;white-space:nowrap" class="ft03">3.&#160;<b>Illegal ToPA Output Offset&#160;</b>(if IA32_RTIT_STATUS.Stopped=0).</p>
<p style="position:absolute;top:826px;left:93px;white-space:nowrap" class="ft05">IA32_RTIT_OUTPUT_MASK_PTRS.OutputOffset is&#160;greater than&#160;or&#160;equal&#160;to the&#160;size&#160;of the&#160;current ToPA&#160;output&#160;<br/>region size.</p>
<p style="position:absolute;top:867px;left:68px;white-space:nowrap" class="ft03">4.&#160;<b>ToPA rules violations</b>.</p>
<p style="position:absolute;top:883px;left:93px;white-space:nowrap" class="ft07">These&#160;are&#160;similar&#160;to ToPA&#160;entry reserved bit violations;&#160;they are cases when&#160;a ToPA&#160;entry&#160;is encountered with&#160;<br/>illegal field combinations. They&#160;include the&#160;following:<br/>a.&#160;Setting the STOP&#160;or INT bit&#160;on an&#160;entry&#160;with&#160;END=1.<br/>b.&#160;Setting&#160;the&#160;END bit in entry&#160;0 of a&#160;ToPA&#160;table.<br/>c.&#160;On&#160;processors that&#160;support only a&#160;single&#160;ToPA&#160;entry (see&#160;above), two additional illegal&#160;settings&#160;apply:</p>
<p style="position:absolute;top:996px;left:119px;white-space:nowrap" class="ft06">i)&#160;ToPA&#160;table&#160;entry 1&#160;with END=0.<br/>ii)&#160;ToPA&#160;table entry&#160;1 with base address&#160;not&#160;matching the&#160;table base.</p>
<p style="position:absolute;top:116px;left:205px;white-space:nowrap" class="ft02">Table 36-4. Algorithm to&#160;Manage&#160;Intel&#160;PT&#160;ToPA&#160;PMI and&#160;XSAVES/XRSTORS&#160;</p>
<p style="position:absolute;top:141px;left:398px;white-space:nowrap" class="ft03">Pseudo&#160;Code Flow</p>
<p style="position:absolute;top:170px;left:74px;white-space:nowrap" class="ft03">IF&#160;(IA32_PERF_GLOBAL_STATUS.ToPA)</p>
<p style="position:absolute;top:188px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160;Save IA32_RTIT_CTL value;</p>
<p style="position:absolute;top:206px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160;IF ( IA32_RTIT_CTL.TraceEN )</p>
<p style="position:absolute;top:224px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160;Disable Intel PT&#160;by clearing TraceEn;&#160;</p>
<p style="position:absolute;top:242px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160;FI;</p>
<p style="position:absolute;top:260px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160;IF ( there is space&#160;available to grow the current ToPA table )</p>
<p style="position:absolute;top:278px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160;Add one or more&#160;ToPA entries after the&#160;last entry in the ToPA&#160;table;&#160;</p>
<p style="position:absolute;top:296px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160;Point new ToPA entry address field(s) to&#160;new output region base(s);</p>
<p style="position:absolute;top:314px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160;ELSE&#160;</p>
<p style="position:absolute;top:332px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160;Modify an upcoming ToPA entry in the current table to have END=1;</p>
<p style="position:absolute;top:350px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160;IF (output should transition to a new ToPA table )</p>
<p style="position:absolute;top:368px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160; &#160; &#160;Point the address of the “END=1” entry of the current table to the new table base;&#160;</p>
<p style="position:absolute;top:386px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160;ELSE&#160;</p>
<p style="position:absolute;top:404px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160; &#160; &#160;/* Continue&#160;to use the current ToPA&#160;table, make a circular. */&#160;</p>
<p style="position:absolute;top:422px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160; &#160; &#160;Point the address of the “END=1”l entry to the base of the current table;&#160;</p>
<p style="position:absolute;top:440px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160; &#160; &#160;Modify the ToPA entry address fields for filled output regions to point to new,&#160;unused output regions;</p>
<p style="position:absolute;top:458px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160; &#160; &#160;/* Filled regions are those with index in the range of 0&#160;to (IA32_RTIT_MASK_PTRS.MaskOrTableOffset -1).&#160;*/&#160;</p>
<p style="position:absolute;top:476px;left:74px;white-space:nowrap" class="ft03">&#160;&#160; &#160; &#160; &#160;FI;</p>
<p style="position:absolute;top:494px;left:112px;white-space:nowrap" class="ft03">FI;</p>
<p style="position:absolute;top:511px;left:112px;white-space:nowrap" class="ft03">Restore saved IA32_RTIT_CTL.value;</p>
<p style="position:absolute;top:527px;left:74px;white-space:nowrap" class="ft03">FI;</p>
</div>
</body>
</html>
