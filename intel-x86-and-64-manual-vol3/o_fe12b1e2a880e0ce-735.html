<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 735</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:14px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:16px;font-family:Times;color:#0860a8;}
	.ft05{font-size:18px;font-family:Times;color:#0860a8;}
	.ft06{font-size:18px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page735-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce735.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:761px;white-space:nowrap" class="ft00">Vol. 3B&#160;18-99</p>
<p style="position:absolute;top:47px;left:672px;white-space:nowrap" class="ft01">PERFORMANCE MONITORING</p>
<p style="position:absolute;top:99px;left:69px;white-space:nowrap" class="ft02">18.15.7.5 &#160;&#160;Other DS&#160;Mechanism Implications</p>
<p style="position:absolute;top:127px;left:69px;white-space:nowrap" class="ft09">The DS&#160;mechanism&#160;is not available in the&#160;SMM.&#160;It&#160;is disabled&#160;on transition&#160;to the&#160;SMM mode. Similarly&#160;the DS&#160;<br/>mechanism&#160;is disabled on the generation of a&#160;machine&#160;check exception&#160;and is&#160;cleared on&#160;processor&#160;RESET and&#160;<br/>INIT.&#160;<br/>The&#160;DS mechanism is&#160;available in&#160;real address&#160;mode.</p>
<p style="position:absolute;top:235px;left:69px;white-space:nowrap" class="ft04">18.15.8 Operating&#160;</p>
<p style="position:absolute;top:235px;left:234px;white-space:nowrap" class="ft04">System&#160;</p>
<p style="position:absolute;top:235px;left:299px;white-space:nowrap" class="ft04">Implications</p>
<p style="position:absolute;top:265px;left:69px;white-space:nowrap" class="ft08">The&#160;DS mechanism can be used&#160;by&#160;the&#160;operating&#160;system&#160;as&#160;a debugging extension&#160;to facilitate&#160;failure analysis.&#160;<br/>When using this facility,&#160;a 25&#160;to 30&#160;times slowdown can be&#160;expected due to the effects of the trace store occurring&#160;<br/>on every taken&#160;branch.&#160;<br/>Depending upon&#160;intended usage,&#160;the instruction pointers that are part&#160;of the&#160;branch&#160;records or&#160;the PEBS records&#160;<br/>need&#160;to have&#160;an association&#160;with&#160;the corresponding process.&#160;One solution requires the ability for the&#160;DS specific&#160;<br/>operating system&#160;module&#160;to&#160;be&#160;chained to&#160;the context&#160;switch. A separate&#160;buffer&#160;can then&#160;be&#160;maintained&#160;for&#160;each&#160;<br/>process of interest&#160;and the MSR pointing to the configuration area saved and setup appropriately on&#160;each&#160;context&#160;<br/>switch.&#160;<br/>If&#160;the&#160;BTS facility&#160;has been enabled, then it must&#160;be disabled and state&#160;stored&#160;on transition&#160;of the system to&#160;a&#160;sleep&#160;<br/>state in&#160;which processor context is&#160;lost.&#160;The&#160;state&#160;must&#160;be&#160;restored&#160;on&#160;return&#160;from the&#160;sleep state.<br/>It&#160;is&#160;required&#160;that&#160;an&#160;interrupt&#160;gate&#160;be&#160;used&#160;for&#160;the&#160;DS&#160;interrupt as opposed to a trap gate to prevent the generation&#160;<br/>of&#160;an endless interrupt loop.<br/>Pages that&#160;contain&#160;buffers must have mappings to&#160;the same&#160;physical&#160;address for&#160;all processes/logical processors,&#160;<br/>such that any&#160;change&#160;to CR3 will not&#160;change DS&#160;addresses. If this&#160;requirement&#160;cannot&#160;be&#160;satisfied (that is, the&#160;<br/>feature is&#160;enabled on&#160;a per thread/process&#160;basis), then&#160;the&#160;operating system&#160;must&#160;ensure that&#160;the feature&#160;is&#160;<br/>enabled/disabled&#160;appropriately in the&#160;context switch code.</p>
<p style="position:absolute;top:598px;left:69px;white-space:nowrap" class="ft05">18.16&#160;&#160;PERFORMANCE MONITORING AND INTEL HYPER-THREADING&#160;</p>
<p style="position:absolute;top:624px;left:147px;white-space:nowrap" class="ft05">TECHNOLOGY IN PROCESSORS BASED ON INTEL NETBURST</p>
<p style="position:absolute;top:626px;left:699px;white-space:nowrap" class="ft01">®</p>
<p style="position:absolute;top:624px;left:712px;white-space:nowrap" class="ft05">&#160;</p>
<p style="position:absolute;top:649px;left:147px;white-space:nowrap" class="ft05">MICROARCHITECTURE</p>
<p style="position:absolute;top:685px;left:69px;white-space:nowrap" class="ft08">The performance&#160;monitoring&#160;capability of&#160;processors based on Intel NetBurst microarchitecture&#160;and&#160;supporting&#160;<br/>Intel Hyper-Threading Technology is similar to&#160;that described<a href="o_fe12b1e2a880e0ce-718.html">&#160;in&#160;Section 18.15.</a>&#160;However,&#160;the capability&#160;is&#160;extended&#160;<br/>so that:</p>
<p style="position:absolute;top:740px;left:69px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:741px;left:95px;white-space:nowrap" class="ft03">Performance&#160;counters can&#160;be&#160;programmed to&#160;select&#160;events qualified by logical processor IDs.&#160;</p>
<p style="position:absolute;top:763px;left:69px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:763px;left:95px;white-space:nowrap" class="ft03">Performance monitoring interrupts&#160;can&#160;be directed to a specific logical processor within the physical&#160;processor.&#160;</p>
<p style="position:absolute;top:787px;left:69px;white-space:nowrap" class="ft08">The sections below&#160;describe&#160;performance counters,&#160;event qualification by&#160;logical&#160;processor ID, and&#160;special purpose&#160;<br/>bits in&#160;ESCRs/CCCRs. They&#160;also describe&#160;MSR_PEBS_ENABLE, MSR_PEBS_MATRIX_VERT,&#160;and&#160;<br/>MSR_TC_PRECISE_EVENT.&#160;</p>
<p style="position:absolute;top:871px;left:69px;white-space:nowrap" class="ft04">18.16.1 ESCR&#160;</p>
<p style="position:absolute;top:871px;left:195px;white-space:nowrap" class="ft04">MSRs&#160;</p>
<p style="position:absolute;top:901px;left:69px;white-space:nowrap" class="ft09"><a href="o_fe12b1e2a880e0ce-736.html">Figure&#160;18-47&#160;</a>shows the&#160;layout of&#160;an&#160;ESCR MSR in&#160;processors supporting Intel Hyper-Threading&#160;Technology.&#160;<br/>The&#160;functions of the flags&#160;and fields are&#160;as follows:</p>
<p style="position:absolute;top:947px;left:69px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:948px;left:95px;white-space:nowrap" class="ft08"><b>T1_USR&#160;flag, bit 0 —&#160;</b>When&#160;set, events are counted&#160;when&#160;thread&#160;1 (logical processor 1)&#160;is&#160;executing at&#160;a&#160;<br/>current privilege&#160;level (CPL) of 1,&#160;2,&#160;or 3. These&#160;privilege&#160;levels are&#160;generally used&#160;by application&#160;code&#160;and&#160;<br/>unprotected&#160;operating&#160;system code.</p>
</div>
</body>
</html>
