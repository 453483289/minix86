<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1225</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:18px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:16px;font-family:Times;color:#0860a8;}
	.ft06{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1225-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1225.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:761px;white-space:nowrap" class="ft00">Vol. 3C&#160;31-15</p>
<p style="position:absolute;top:47px;left:475px;white-space:nowrap" class="ft01">VIRTUAL-MACHINE&#160;MONITOR PROGRAMMING CONSIDERATIONS</p>
<p style="position:absolute;top:100px;left:95px;white-space:nowrap" class="ft06">MSR-bitmap-address in the&#160;guest&#160;VMCS&#160;can&#160;be&#160;programmed&#160;by VMM&#160;to point&#160;to a bitmap region which&#160;<br/>specifies&#160;VM-exit behavior&#160;when&#160;reading&#160;and writing individual MSRs.&#160;<br/>MSR bitmaps form a 4-KByte&#160;region in&#160;physical&#160;memory&#160;and&#160;are required&#160;to be&#160;aligned to&#160;a 4-KByte boundary.&#160;<br/>The&#160;first 1-KByte region manages read&#160;control of&#160;MSRs in&#160;the range 00000000H-00001FFFH;&#160;the second 1-<br/>KByte&#160;region covers read control&#160;of MSR addresses&#160;in the&#160;range&#160;C0000000H-C0001FFFH.&#160;The bitmaps for write&#160;<br/>control of these MSRs are located&#160;in the 2-KByte&#160;region&#160;immediately following&#160;the&#160;read control&#160;bitmaps. While&#160;<br/>the MSR&#160;bitmap address&#160;is part of VMCS,&#160;the MSR&#160;bitmaps&#160;themselves are&#160;not.&#160;This implies MSR&#160;bitmaps&#160;are&#160;<br/>not accessible&#160;through VMREAD and&#160;VMWRITE instructions but&#160;rather&#160;by&#160;using ordinary&#160;memory writes. Also,&#160;<br/>they are&#160;not specially cached&#160;by the&#160;processor and&#160;may&#160;be placed&#160;in normal cache-coherent memory&#160;by the&#160;<br/>VMM.&#160;<br/>When&#160;MSR&#160;bitmap&#160;addresses&#160;are&#160;properly&#160;programmed&#160;and the&#160;use-MSR-bitmap&#160;control&#160;(see<a href="o_fe12b1e2a880e0ce-1055.html">&#160;Section&#160;24.6.2)</a>&#160;<br/>is set, the&#160;processor&#160;consults the&#160;associated bit in the&#160;appropriate bitmap on guest&#160;MSR&#160;accesses&#160;to the corre-<br/>sponding&#160;MSR&#160;and&#160;causes&#160;a VM&#160;exit&#160;if the&#160;bit&#160;in the&#160;bitmap is&#160;set. Otherwise, the&#160;access&#160;is permitted&#160;to&#160;<br/>proceed. This&#160;level&#160;of&#160;protection may be&#160;utilized&#160;by VMMs&#160;to selectively allow guest access&#160;to some MSRs while&#160;<br/>virtualizing others.&#160;</p>
<p style="position:absolute;top:365px;left:69px;white-space:nowrap" class="ft03">â€¢</p>
<p style="position:absolute;top:366px;left:95px;white-space:nowrap" class="ft06"><b>Default MSR&#160;protection</b>: If the use-MSR-bitmap&#160;control is not set, an attempt by a guest to access any MSR&#160;<br/>causes a VM&#160;exit. This also occurs for any&#160;attempt to&#160;access an MSR outside the ranges&#160;identified above (even&#160;<br/>if&#160;the use-MSR-bitmap control is&#160;set).</p>
<p style="position:absolute;top:423px;left:69px;white-space:nowrap" class="ft06">VM&#160;exits&#160;due to&#160;guest&#160;MSR&#160;accesses may be&#160;identified&#160;by the&#160;VMM through&#160;VM-exit&#160;reason codes.&#160;The MSR-read&#160;<br/>exit reason implies guest&#160;software&#160;attempted to read an&#160;MSR protected either&#160;by default or through MSR bitmaps.&#160;<br/>The MSR-write exit&#160;reason implies guest software&#160;attempting&#160;to write&#160;a MSR protected through the&#160;VM-execution&#160;<br/>controls.&#160;Upon&#160;VM&#160;exits caused&#160;by MSR&#160;accesses,&#160;the&#160;VMM may virtualize the&#160;guest&#160;MSR access&#160;through emulation&#160;<br/>of RDMSR/WRMSR.</p>
<p style="position:absolute;top:539px;left:69px;white-space:nowrap" class="ft05">31.10.2&#160;&#160;Using VM-Exit Controls for MSRs</p>
<p style="position:absolute;top:570px;left:69px;white-space:nowrap" class="ft06">If a VMM&#160;allows&#160;its guest&#160;to access&#160;MSRs directly, the&#160;VMM may&#160;need&#160;to store&#160;guest MSR&#160;values&#160;and load&#160;host MSR&#160;<br/>values&#160;for these&#160;MSRs on&#160;VM&#160;exits.&#160;This&#160;is especially true if&#160;the VMM&#160;uses the&#160;same MSRs&#160;while&#160;in&#160;VMX root oper-<br/>ation.&#160;<br/>A VMM&#160;can use&#160;the VM-exit MSR-store-address and&#160;the VM-exit&#160;MSR-store-count exit&#160;control fiel<a href="o_fe12b1e2a880e0ce-1064.html">ds (see Section&#160;<br/>24.7.2) to&#160;</a>manage&#160;how MSRs&#160;are stored&#160;on VM&#160;exits.&#160;The VM-exit&#160;MSR-store-address field contains the&#160;physical&#160;<br/>address (16-byte aligned)&#160;of&#160;the VM-exit MSR-store&#160;area (a&#160;table of entries with 16 bytes per entry). Each table&#160;<br/>entry&#160;specifies&#160;an MSR whose value&#160;needs&#160;to be stored&#160;on VM exits. The&#160;VM-exit MSR-store-count contains the&#160;<br/>number of entries in&#160;the table.<br/>Similarly the&#160;VM-exit MSR-load-address and&#160;VM-exit MSR-load-count fields point&#160;to the location&#160;and size of&#160;the&#160;VM-<br/>exit MSR&#160;load area.&#160;The entries in&#160;the VM-exit MSR-load&#160;area contain the&#160;host expected&#160;values of specific MSRs&#160;<br/>when&#160;a VM exit&#160;occurs.&#160;<br/>Upon VM-exit,&#160;bits&#160;127:64&#160;of&#160;each entry in&#160;the VM-exit&#160;MSR-store&#160;area is&#160;updated&#160;with the&#160;contents of&#160;the&#160;MSR&#160;<br/>indexed&#160;by bits 31:0.&#160;Also,&#160;bits 127:64&#160;of each&#160;entry&#160;in&#160;the&#160;VM-exit MSR-load area&#160;is&#160;updated by loading with&#160;<br/>values&#160;from bits&#160;127:64&#160;the contents&#160;of&#160;the MSR&#160;indexed&#160;by bits 31:0.&#160;</p>
<p style="position:absolute;top:857px;left:69px;white-space:nowrap" class="ft05">31.10.3&#160;&#160;Using VM-Entry Controls for MSRs</p>
<p style="position:absolute;top:888px;left:69px;white-space:nowrap" class="ft06">A&#160;VMM may&#160;require&#160;specific&#160;MSRs to&#160;be&#160;loaded explicitly&#160;on VM entries while launching&#160;or&#160;resuming guest execu-<br/>tion. The VM-entry MSR-load-address&#160;and VM-entry&#160;MSR-load-count entry control fields determine how MSRs are&#160;<br/>loaded on VM-entries.&#160;The VM-entry MSR-load-address and&#160;count&#160;fields are similar&#160;in&#160;structure and function&#160;to the&#160;<br/>VM-exit MSR-load&#160;address&#160;and count fields,&#160;except&#160;the&#160;MSR loading is&#160;done&#160;on&#160;VM-entries.</p>
<p style="position:absolute;top:988px;left:69px;white-space:nowrap" class="ft05">31.10.4 Handling&#160;</p>
<p style="position:absolute;top:988px;left:226px;white-space:nowrap" class="ft05">Special-Case&#160;MSRs&#160;and Instructions</p>
<p style="position:absolute;top:1018px;left:69px;white-space:nowrap" class="ft06">A&#160;number of instructions make&#160;use&#160;of&#160;designated&#160;MSRs&#160;in&#160;their operation. The&#160;VMM may need to&#160;consider&#160;saving&#160;<br/>the states&#160;of those&#160;MSRs.&#160;Instructions&#160;that merit such&#160;consideration&#160;include SYSENTER/SYSEXIT,&#160;<br/>SYSCALL/SYSRET, SWAPGS.&#160;</p>
</div>
</body>
</html>
