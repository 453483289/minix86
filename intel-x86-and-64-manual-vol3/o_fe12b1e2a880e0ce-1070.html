<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1070</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:18px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:18px;font-family:Times;color:#000000;}
	.ft06{font-size:16px;font-family:Times;color:#0860a8;}
	.ft07{font-size:8px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1070-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1070.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">24-24&#160;Vol. 3C</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">VIRTUAL MACHINE CONTROL STRUCTURES</p>
<p style="position:absolute;top:97px;left:68px;white-space:nowrap" class="ft02">24.10&#160;&#160;VMCS TYPES: ORDINARY AND SHADOW</p>
<p style="position:absolute;top:133px;left:68px;white-space:nowrap" class="ft09">Every VMCS is&#160;either an&#160;<b>ordinary VMCS</b>&#160;or a&#160;<b>shadow VMCS</b>.&#160;A&#160;VMCS’s&#160;type&#160;is&#160;determined&#160;by&#160;the&#160;shadow-VMCS&#160;<br/>indicator in&#160;the&#160;VMCS region&#160;(this is&#160;the&#160;value of bit&#160;31&#160;of the&#160;first&#160;4 bytes&#160;of&#160;the VMCS&#160;region; see<a href="o_fe12b1e2a880e0ce-1048.html">&#160;Table&#160;24-1): 0&#160;<br/></a>indicates an&#160;ordinary&#160;VMCS, while 1 indicates a&#160;shadow&#160;VMCS.&#160;Shadow VMCSs are supported&#160;only on&#160;processors&#160;<br/>that support the&#160;1-setting&#160;of the “VMCS shadowing” VM-execution&#160;control (see<a href="o_fe12b1e2a880e0ce-1055.html">&#160;Section 24.6.2).<br/></a>A shadow VMCS&#160;differs from&#160;an&#160;ordinary VMCS in&#160;two ways:</p>
<p style="position:absolute;top:229px;left:68px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:229px;left:93px;white-space:nowrap" class="ft08">An&#160;ordinary&#160;VMCS&#160;can be used for VM&#160;entry&#160;but&#160;a shadow VMCS cannot. Attempts&#160;to perform&#160;VM&#160;entry when&#160;<br/>the&#160;current VMCS&#160;is&#160;a shadow&#160;VMCS&#160;fail (see<a href="o_fe12b1e2a880e0ce-1094.html">&#160;Section 26.1</a>).</p>
<p style="position:absolute;top:268px;left:68px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:268px;left:93px;white-space:nowrap" class="ft010">The&#160;VMREAD and VMWRITE&#160;instructions can&#160;be&#160;used in&#160;VMX non-root&#160;operation to&#160;access&#160;a shadow&#160;VMCS but&#160;<br/>not&#160;an ordinary VMCS.&#160;This fact&#160;results from the&#160;following:<br/>—&#160;If the&#160;“VMCS&#160;shadowing” VM-execution&#160;control&#160;is 0,&#160;execution&#160;of&#160;the&#160;VMREAD and&#160;VMWRITE instructions in&#160;</p>
<p style="position:absolute;top:325px;left:119px;white-space:nowrap" class="ft03">VMX non-root operation always cause VM&#160;<a href="o_fe12b1e2a880e0ce-1076.html">exits (see Section 25.1.3).</a></p>
<p style="position:absolute;top:349px;left:93px;white-space:nowrap" class="ft03">—&#160;If the&#160;“VMCS&#160;shadowing” VM-execution&#160;control&#160;is 1,&#160;execution&#160;of&#160;the&#160;VMREAD and&#160;VMWRITE instructions in&#160;</p>
<p style="position:absolute;top:366px;left:119px;white-space:nowrap" class="ft03">VMX non-root operation can&#160;access&#160;the VMCS&#160;refere<a href="o_fe12b1e2a880e0ce-1182.html">nced by the VMCS link pointer (see Section 30.3).</a></p>
<p style="position:absolute;top:390px;left:93px;white-space:nowrap" class="ft03">—&#160;If&#160;the “VMCS shadowing” VM-execution&#160;control&#160;is 1,&#160;VM&#160;entry ensures that any&#160;VMCS&#160;referenced by the&#160;</p>
<p style="position:absolute;top:406px;left:119px;white-space:nowrap" class="ft03">VMCS link pointer is&#160;a shadow VMCS&#160;(see<a href="o_fe12b1e2a880e0ce-1104.html">&#160;Section&#160;26.3.1.5).</a></p>
<p style="position:absolute;top:430px;left:68px;white-space:nowrap" class="ft08">In VMX root operation,&#160;both types of&#160;VMCSs&#160;can be&#160;accessed&#160;with&#160;the VMREAD and&#160;VMWRITE instructions.<br/>Software should not&#160;modify the shadow-VMCS indicator in the&#160;VMCS&#160;region&#160;of&#160;a&#160;VMCS&#160;that&#160;is&#160;active.&#160;Doing&#160;so&#160;may&#160;<br/>cause the&#160;VMCS&#160;to become corru<a href="o_fe12b1e2a880e0ce-1070.html">pted (see Section&#160;24.11.1).&#160;</a>Before modifying&#160;the shadow-VMCS indicator,&#160;soft-<br/>ware&#160;should execute VMCLEAR&#160;for&#160;the VMCS to&#160;ensure that&#160;it is&#160;not active.</p>
<p style="position:absolute;top:543px;left:68px;white-space:nowrap" class="ft02">24.11&#160;&#160;SOFTWARE&#160;USE OF&#160;THE VMCS AND RELATED STRUCTURES</p>
<p style="position:absolute;top:579px;left:68px;white-space:nowrap" class="ft08">This section details guidelines&#160;that software&#160;should observe when using&#160;a VMCS and&#160;related structures. It&#160;also&#160;<br/>provides&#160;descriptions of consequences for&#160;failing to follow guidelines.</p>
<p style="position:absolute;top:646px;left:68px;white-space:nowrap" class="ft06">24.11.1&#160;&#160;Software&#160;Use of&#160;Virtual-Machine Control Structures</p>
<p style="position:absolute;top:676px;left:68px;white-space:nowrap" class="ft08">To&#160;ensure&#160;proper processor behavior,&#160;software should&#160;observe certain guidelines&#160;when using&#160;an active VMCS.<br/>No&#160;VMCS&#160;should&#160;ever&#160;be&#160;active&#160;on&#160;more&#160;than&#160;one&#160;logical&#160;processor.&#160;If a&#160;VMCS&#160;is&#160;to be&#160;“migrated” from one&#160;logical&#160;<br/>processor to another,&#160;the first&#160;logical processor should&#160;execute VMCLEAR&#160;for&#160;the&#160;VMCS (to&#160;make&#160;it inactive&#160;on&#160;that&#160;<br/>logical&#160;processor&#160;and to&#160;ensure that&#160;all VMCS&#160;data are&#160;in memory) before&#160;the&#160;other logical processor executes&#160;<br/>VMPTRLD for the&#160;VMCS (to&#160;make&#160;it&#160;active&#160;on the&#160;second&#160;logical processor).</p>
<p style="position:absolute;top:747px;left:574px;white-space:nowrap" class="ft07">1</p>
<p style="position:absolute;top:750px;left:581px;white-space:nowrap" class="ft03">&#160;A&#160;VMCS&#160;that&#160;is&#160;made&#160;active&#160;on&#160;more&#160;</p>
<p style="position:absolute;top:766px;left:68px;white-space:nowrap" class="ft08">than one logical processor may become&#160;<b>corrupted</b>&#160;(see&#160;below).<br/>Software should&#160;not&#160;modify the&#160;shadow-VMCS indicator (see&#160;<a href="o_fe12b1e2a880e0ce-1048.html">Table&#160;24-1</a>)&#160;in the&#160;VMCS&#160;region of a&#160;VMCS&#160;that is&#160;<br/>active. Doing so may cause the&#160;VMCS to become corrupted. Before&#160;modifying the shadow-VMCS indicator,&#160;software&#160;<br/>should&#160;execute VMCLEAR&#160;for&#160;the VMCS&#160;to ensure&#160;that it&#160;is not active.<br/>Software should use&#160;the VMREAD&#160;and VMWRITE instructions&#160;to access the&#160;different&#160;fields&#160;in the current&#160;VMCS&#160;(see&#160;<br/><a href="o_fe12b1e2a880e0ce-1071.html">Section&#160;24.11.2).&#160;</a>Software&#160;should never access or&#160;modify&#160;the&#160;VMCS data&#160;of&#160;an active VMCS&#160;using ordinary&#160;<br/>memory&#160;operations,&#160;in&#160;part because&#160;the format used&#160;to&#160;store&#160;the VMCS data is&#160;implementation-specific and&#160;not&#160;<br/>architecturally defined, and&#160;also because&#160;a logical processor may&#160;maintain some VMCS&#160;data&#160;of&#160;an active&#160;VMCS&#160;on&#160;<br/>the processor and&#160;not&#160;in&#160;the VMCS&#160;region. The following&#160;items detail some&#160;of&#160;the&#160;hazards of accessing VMCS data&#160;<br/>using ordinary&#160;memory&#160;operations:</p>
<p style="position:absolute;top:952px;left:68px;white-space:nowrap" class="ft05">•</p>
<p style="position:absolute;top:952px;left:93px;white-space:nowrap" class="ft08">Any data&#160;read from&#160;a VMCS&#160;with an&#160;ordinary&#160;memory&#160;read does not&#160;reliably reflect the&#160;state&#160;of&#160;the VMCS.&#160;<br/>Results may vary&#160;from&#160;time to&#160;time or&#160;from logical processor to&#160;logical&#160;processor.</p>
<p style="position:absolute;top:1021px;left:68px;white-space:nowrap" class="ft03">1.&#160;As&#160;noted in<a href="o_fe12b1e2a880e0ce-1047.html">&#160;Section 24.1, e</a>xecution of&#160;the VMPTRLD instruction&#160;makes a&#160;VMCS is&#160;active. In&#160;addition, VM&#160;entry makes active&#160;any&#160;</p>
<p style="position:absolute;top:1038px;left:89px;white-space:nowrap" class="ft03">shadow&#160;VMCS&#160;referenced&#160;by the VMCS&#160;link&#160;pointer in&#160;the current VMCS.&#160;If&#160;a shadow&#160;VMCS&#160;is&#160;made&#160;active&#160;by VM&#160;entry,&#160;it is neces-</p>
<p style="position:absolute;top:1054px;left:89px;white-space:nowrap" class="ft03">sary to&#160;execute&#160;VMCLEAR for that&#160;VMCS&#160;before&#160;allowing that&#160;VMCS to&#160;become&#160;active&#160;on&#160;another logical processor.</p>
</div>
</body>
</html>
