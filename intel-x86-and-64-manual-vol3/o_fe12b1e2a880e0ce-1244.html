<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1244</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:14px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:11px;font-family:Times;color:#000000;}
	.ft05{font-size:16px;font-family:Times;color:#0860a8;}
	.ft06{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1244-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1244.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">33-6&#160;Vol. 3C</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">HANDLING&#160;BOUNDARY&#160;CONDITIONS&#160;IN A VIRTUAL MACHINE MONITOR</p>
<p style="position:absolute;top:99px;left:68px;white-space:nowrap" class="ft02">33.3.2.4 &#160;&#160;I/O&#160;APIC Virtualization</p>
<p style="position:absolute;top:127px;left:68px;white-space:nowrap" class="ft06">The&#160;I/O APIC registers are&#160;typically&#160;mapped&#160;to&#160;a 1&#160;MByte&#160;region where each I/O APIC is&#160;allocated a&#160;4K address&#160;<br/>window&#160;within this range. The VMM may utilize physical memory&#160;virtualization&#160;to trap guest accesses to&#160;the&#160;virtual&#160;<br/>I/O&#160;APIC&#160;memory-mapped&#160;registers.&#160;The&#160;I/O APIC virtualization needs to&#160;emulate&#160;the various I/O APIC operations&#160;<br/>and&#160;registers such&#160;as identification/version registers, indirect-I/O-access registers, EOI register,&#160;and&#160;the&#160;I/O&#160;redi-<br/>rection&#160;table.&#160;I/O APIC&#160;virtualization&#160;also need to&#160;emulate various redirection&#160;table&#160;entry settings such&#160;as&#160;delivery&#160;<br/>mode, destination mode,&#160;delivery status, polarity, masking, and trigger mode programmed by the&#160;guest and track&#160;<br/>remote-IRR&#160;state on&#160;guest&#160;EOI&#160;writes&#160;to various virtual local&#160;APICs.</p>
<p style="position:absolute;top:271px;left:68px;white-space:nowrap" class="ft02">33.3.2.5&#160;&#160;&#160;Virtualization of&#160;Message&#160;Signaled&#160;Interrupts</p>
<p style="position:absolute;top:299px;left:68px;white-space:nowrap" class="ft08">The&#160;<i>PCI Local Bus Specification</i>&#160;(Rev.&#160;2.2) introduces&#160;the concept of message&#160;signaled&#160;interrupts (MSI).&#160;MSI&#160;enable&#160;<br/>PCI devices to&#160;request service&#160;by&#160;writing a&#160;system-specified message&#160;to&#160;a system specified address. The transac-<br/>tion&#160;address specifies the&#160;message destination&#160;while the&#160;transaction data specifies the&#160;interrupt&#160;vector,&#160;trigger&#160;<br/>mode&#160;and&#160;delivery mode.&#160;System&#160;software&#160;is&#160;expected&#160;to configure&#160;the message&#160;data and&#160;address&#160;during MSI&#160;<br/>device configuration, allocating one&#160;or&#160;more no-shared&#160;messages to&#160;MSI&#160;capable devices.<a href="˛ˇ">&#160;Chapter&#160;10,&#160;‚ÄúAdvanced&#160;<br/>Programmable Interrupt Controller (APIC),‚Äù</a>&#160;specifies the&#160;MSI&#160;message&#160;address&#160;and data register formats to&#160;be&#160;<br/>followed&#160;on Intel&#160;64&#160;and&#160;IA-32&#160;platforms.&#160;While&#160;MSI is&#160;optional for conventional PCI&#160;devices, it&#160;is the&#160;preferred&#160;<br/>interrupt mechanism for PCI-Express devices.&#160;<br/>Since the MSI address&#160;and data are&#160;configured&#160;through&#160;PCI&#160;configuration space,&#160;to&#160;control these&#160;physical interrupts&#160;<br/>the VMM&#160;needs to assume&#160;ownership of PCI&#160;configuration&#160;space.&#160;This allows the&#160;VMM to&#160;capture&#160;the guest config-<br/>uration of message&#160;address&#160;and&#160;data for&#160;MSI-capable&#160;virtual and&#160;assigned guest devices.&#160;PCI configuration&#160;trans-<br/>actions on PC-compatible&#160;systems are&#160;generated&#160;by&#160;software through&#160;two different&#160;methods:&#160;<br/>1.&#160;The&#160;standard CONFIG_ADDRESS/CONFIG_DATA&#160;register&#160;mechanism&#160;(CFCH/CF8H&#160;ports)&#160;as defined in&#160;the&#160;<i>PCI&#160;</i></p>
<p style="position:absolute;top:529px;left:93px;white-space:nowrap" class="ft04"><i>Local Bus Specification.</i></p>
<p style="position:absolute;top:553px;left:68px;white-space:nowrap" class="ft03">2.&#160;The enhanced&#160;flat memory-mapped (MEMCFG)&#160;configuration mechanism&#160;as&#160;defined in&#160;the&#160;<i>PCI-Express Base&#160;</i></p>
<p style="position:absolute;top:569px;left:93px;white-space:nowrap" class="ft04"><i>Specification</i>&#160;(Rev.&#160;1.0a.).&#160;</p>
<p style="position:absolute;top:593px;left:68px;white-space:nowrap" class="ft06">The CFCH/CF8H&#160;configuration access from&#160;guests&#160;can be&#160;trapped by the VMM&#160;through&#160;use of I/O-bitmap VM-<br/>execution controls. The memory-mapped&#160;PCI-Express MEMCFG guest configuration&#160;accesses&#160;can be trapped by&#160;<br/>VMM through physical memory virtualization.</p>
<p style="position:absolute;top:677px;left:68px;white-space:nowrap" class="ft05">33.3.3&#160;</p>
<p style="position:absolute;top:677px;left:148px;white-space:nowrap" class="ft05">Examples of&#160;Handling of&#160;External Interrupts</p>
<p style="position:absolute;top:707px;left:68px;white-space:nowrap" class="ft06">The&#160;following&#160;sections illustrate interrupt&#160;processing in&#160;a VMM&#160;(when used&#160;to&#160;support&#160;the&#160;external&#160;interrupt virtu-<br/>alization requirements).&#160;</p>
<p style="position:absolute;top:768px;left:68px;white-space:nowrap" class="ft02">33.3.3.1 &#160;&#160;Guest Setup</p>
<p style="position:absolute;top:796px;left:68px;white-space:nowrap" class="ft06">The&#160;VMM sets&#160;up&#160;the guest to&#160;cause a&#160;VM&#160;exit to&#160;the VMM&#160;on external&#160;interrupts.&#160;This is&#160;done&#160;by setting the&#160;<br/>‚Äúexternal-interrupt exiting‚Äù&#160;VM-execution control in&#160;the guest controlling-VMCS.&#160;</p>
<p style="position:absolute;top:857px;left:68px;white-space:nowrap" class="ft02">33.3.3.2 &#160;&#160;Processor Treatment of&#160;External Interrupt</p>
<p style="position:absolute;top:886px;left:68px;white-space:nowrap" class="ft06">Interrupts&#160;are automatically masked by hardware in&#160;the processor on VM&#160;exit by clearing RFLAGS.IF.&#160;The&#160;exit-<br/>reason field in&#160;VMCS&#160;is set to&#160;1 to&#160;indicate&#160;an&#160;external interrupt&#160;as the&#160;exit reason.&#160;<br/>If&#160;the VMM&#160;is utilizing the acknowledge-on-exit&#160;feature (by setting the&#160;‚Äúacknowledge interrupt on exit‚Äù VM-exit&#160;<br/>control),&#160;the processor acknowledges&#160;the interrupt,&#160;retrieves the&#160;host vector, and saves the&#160;interrupt in&#160;the VM-<br/>exit-interruption-information field (in&#160;the VM-exit information&#160;region&#160;of the&#160;VMCS) before transitioning&#160;control to&#160;<br/>the VMM.&#160;</p>
</div>
</body>
</html>
