<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1001</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:14px;font-family:Times;color:#0860a8;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:12px;font-family:Times;color:#0860a8;}
	.ft06{font-size:9px;font-family:Times;color:#000000;}
	.ft07{font-size:8px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1001-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1001.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:768px;white-space:nowrap" class="ft00">Vol. 3B&#160;21-5</p>
<p style="position:absolute;top:47px;left:648px;white-space:nowrap" class="ft01">MIXING&#160;16-BIT AND 32-BIT CODE</p>
<p style="position:absolute;top:714px;left:69px;white-space:nowrap" class="ft08">While executing 32-bit code,&#160;if&#160;a&#160;call is&#160;made&#160;to a&#160;16-bit&#160;code segment which is&#160;at the&#160;same or&#160;a more&#160;privileged&#160;<br/>level&#160;(that is, the&#160;DPL of&#160;the called code segment is&#160;less&#160;than&#160;or equal to&#160;the CPL&#160;of the&#160;calling code segment)&#160;<br/>through&#160;a 16-bit&#160;call gate, then the upper 16-bits&#160;of&#160;the&#160;ESP register&#160;may be&#160;unreliable&#160;upon&#160;returning&#160;to&#160;the&#160;32-<br/>bit code segment (that&#160;is,&#160;after executing a&#160;RET in&#160;the 16-bit&#160;code&#160;segment).<br/>When the CALL&#160;instruction and its matching&#160;RET instruction&#160;are in code segments that&#160;have&#160;D flags with&#160;the same&#160;<br/>values (that is,&#160;both are&#160;32-bit code segments or&#160;both&#160;are&#160;16-bit code segments),&#160;the default settings may&#160;be&#160;<br/>used.&#160;When the&#160;CALL instruction and&#160;its matching&#160;RET instruction are&#160;in&#160;segments which have&#160;different D-flag&#160;<br/>settings,&#160;an operand-size&#160;prefix must be used.</p>
<p style="position:absolute;top:881px;left:69px;white-space:nowrap" class="ft03">21.4.2.1 &#160;&#160;Controlling the Operand-Size&#160;Attribute For&#160;a Call</p>
<p style="position:absolute;top:909px;left:69px;white-space:nowrap" class="ft02">Three things&#160;can determine the operand-size&#160;of&#160;a call:</p>
<p style="position:absolute;top:931px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:932px;left:95px;white-space:nowrap" class="ft02">The&#160;D&#160;flag in&#160;the segment descriptor&#160;for&#160;the calling code&#160;segment.</p>
<p style="position:absolute;top:954px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:954px;left:95px;white-space:nowrap" class="ft02">An&#160;operand-size instruction prefix.</p>
<p style="position:absolute;top:976px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:977px;left:95px;white-space:nowrap" class="ft02">The&#160;type&#160;of call&#160;gate&#160;(16-bit or&#160;32-bit), if&#160;a call&#160;is made&#160;through a&#160;call gate.</p>
<p style="position:absolute;top:1001px;left:69px;white-space:nowrap" class="ft08">When a&#160;call is&#160;made with a&#160;pointer (rather than a&#160;call gate), the&#160;D&#160;flag for the&#160;calling code segment determines the&#160;<br/>operand-size for the&#160;CALL instruction.&#160;This&#160;operand-size&#160;attribute&#160;can be&#160;overridden by prepending&#160;an&#160;operand-<br/>size prefix&#160;to the&#160;CALL instruction.&#160;So,&#160;for&#160;example,&#160;if the&#160;D&#160;flag&#160;for&#160;a code&#160;segment is&#160;set for&#160;16&#160;bits and&#160;the&#160;<br/>operand-size prefix&#160;is used with a CALL&#160;instruction, the processor will&#160;cause&#160;the information stored on&#160;the&#160;stack to&#160;</p>
<p style="position:absolute;top:668px;left:290px;white-space:nowrap" class="ft05">Figure&#160;21-1.&#160;&#160;Stack&#160;after&#160;Far&#160;16-&#160;and&#160;32-Bit&#160;Calls</p>
<p style="position:absolute;top:463px;left:365px;white-space:nowrap" class="ft00">SP</p>
<p style="position:absolute;top:424px;left:303px;white-space:nowrap" class="ft06"><b>After 16-bit Call</b></p>
<p style="position:absolute;top:490px;left:351px;white-space:nowrap" class="ft00">PARM&#160;1</p>
<p style="position:absolute;top:517px;left:367px;white-space:nowrap" class="ft00">IP</p>
<p style="position:absolute;top:517px;left:435px;white-space:nowrap" class="ft00">SP</p>
<p style="position:absolute;top:463px;left:312px;white-space:nowrap" class="ft00">SS</p>
<p style="position:absolute;top:490px;left:298px;white-space:nowrap" class="ft00">PARM&#160;2</p>
<p style="position:absolute;top:517px;left:312px;white-space:nowrap" class="ft00">CS</p>
<p style="position:absolute;top:442px;left:391px;white-space:nowrap" class="ft07">0</p>
<p style="position:absolute;top:442px;left:297px;white-space:nowrap" class="ft07">31</p>
<p style="position:absolute;top:463px;left:577px;white-space:nowrap" class="ft00">SS</p>
<p style="position:absolute;top:598px;left:549px;white-space:nowrap" class="ft00">EIP</p>
<p style="position:absolute;top:424px;left:515px;white-space:nowrap" class="ft06"><b>After 32-bit Call</b></p>
<p style="position:absolute;top:571px;left:577px;white-space:nowrap" class="ft00">CS</p>
<p style="position:absolute;top:598px;left:647px;white-space:nowrap" class="ft00">ESP</p>
<p style="position:absolute;top:490px;left:546px;white-space:nowrap" class="ft00">ESP</p>
<p style="position:absolute;top:517px;left:537px;white-space:nowrap" class="ft00">PARM&#160;2</p>
<p style="position:absolute;top:544px;left:537px;white-space:nowrap" class="ft00">PARM&#160;1</p>
<p style="position:absolute;top:442px;left:604px;white-space:nowrap" class="ft07">0</p>
<p style="position:absolute;top:442px;left:509px;white-space:nowrap" class="ft07">31</p>
<p style="position:absolute;top:396px;left:383px;white-space:nowrap" class="ft06"><b>With Privilege&#160;Transition</b></p>
<p style="position:absolute;top:497px;left:243px;white-space:nowrap" class="ft00">Stack</p>
<p style="position:absolute;top:509px;left:239px;white-space:nowrap" class="ft00">Growth</p>
<p style="position:absolute;top:163px;left:303px;white-space:nowrap" class="ft06"><b>After 16-bit Call</b></p>
<p style="position:absolute;top:229px;left:351px;white-space:nowrap" class="ft00">PARM&#160;1</p>
<p style="position:absolute;top:256px;left:368px;white-space:nowrap" class="ft00">IP</p>
<p style="position:absolute;top:256px;left:435px;white-space:nowrap" class="ft00">SP</p>
<p style="position:absolute;top:229px;left:298px;white-space:nowrap" class="ft00">PARM&#160;2</p>
<p style="position:absolute;top:256px;left:311px;white-space:nowrap" class="ft00">CS</p>
<p style="position:absolute;top:181px;left:391px;white-space:nowrap" class="ft07">0</p>
<p style="position:absolute;top:181px;left:297px;white-space:nowrap" class="ft07">31</p>
<p style="position:absolute;top:135px;left:372px;white-space:nowrap" class="ft06"><b>Without Privilege Transition</b></p>
<p style="position:absolute;top:236px;left:243px;white-space:nowrap" class="ft00">Stack</p>
<p style="position:absolute;top:248px;left:239px;white-space:nowrap" class="ft00">Growth</p>
<p style="position:absolute;top:163px;left:515px;white-space:nowrap" class="ft06"><b>After 32-bit Call</b></p>
<p style="position:absolute;top:256px;left:537px;white-space:nowrap" class="ft00">PARM&#160;1</p>
<p style="position:absolute;top:310px;left:647px;white-space:nowrap" class="ft00">ESP</p>
<p style="position:absolute;top:229px;left:537px;white-space:nowrap" class="ft00">PARM&#160;2</p>
<p style="position:absolute;top:283px;left:577px;white-space:nowrap" class="ft00">CS</p>
<p style="position:absolute;top:181px;left:604px;white-space:nowrap" class="ft07">0</p>
<p style="position:absolute;top:181px;left:509px;white-space:nowrap" class="ft07">31</p>
<p style="position:absolute;top:310px;left:549px;white-space:nowrap" class="ft00">EIP</p>
<p style="position:absolute;top:643px;left:270px;white-space:nowrap" class="ft00">Undefined</p>
</div>
</body>
</html>
