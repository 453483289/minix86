<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 1243</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:11px;font-family:Times;color:#000000;}
	.ft03{font-size:14px;font-family:Times;color:#0860a8;}
	.ft04{font-size:18px;font-family:Times;color:#000000;}
	.ft05{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft06{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;line-height:23px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page1243-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce1243.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:769px;white-space:nowrap" class="ft00">Vol. 3C&#160;33-5</p>
<p style="position:absolute;top:47px;left:436px;white-space:nowrap" class="ft01">HANDLING&#160;BOUNDARY&#160;CONDITIONS&#160;IN A VIRTUAL MACHINE MONITOR</p>
<p style="position:absolute;top:100px;left:69px;white-space:nowrap" class="ft05">bitmap&#160;regions. Bits corresponding&#160;to the&#160;PIC I/O ports&#160;can be&#160;cleared to cause&#160;a VM exit&#160;on&#160;guest access to these&#160;<br/>ports.&#160;<br/>If the&#160;VMM is not supporting direct access to any I/O ports&#160;from a guest, it can set the&#160;unconditional-I/O-exiting in&#160;<br/>the VM-execution control field instead of activating I/O bitmaps. The exit-reason field in VM-exit information allows&#160;<br/>identification of&#160;VM&#160;exits due to&#160;I/O access and can&#160;provide&#160;an&#160;exit-qualification to&#160;identify details&#160;about the&#160;guest&#160;<br/>I/O operation that&#160;caused&#160;the VM&#160;exit.&#160;<br/>The&#160;VMM&#160;PIC virtualization needs to&#160;emulate the&#160;platform&#160;PIC&#160;functionality including interrupt&#160;priority, mask,&#160;<br/>request&#160;and&#160;service states,&#160;and specific guest programmed&#160;modes&#160;of&#160;PIC operation.</p>
<p style="position:absolute;top:275px;left:69px;white-space:nowrap" class="ft03">33.3.2.2 &#160;&#160;xAPIC Virtualization</p>
<p style="position:absolute;top:304px;left:69px;white-space:nowrap" class="ft05">Most modern Intel&#160;64&#160;and IA-32 platforms&#160;include&#160;support&#160;for an&#160;APIC. While the standard PIC is&#160;intended for&#160;use&#160;<br/>on&#160;uniprocessor systems,&#160;APIC&#160;can be used in&#160;either uniprocessor or&#160;multi-processor systems.<br/>APIC based interrupt control consists of two physical components: the interrupt acceptance unit&#160;(Local APIC) which&#160;<br/>is integrated with the processor,&#160;and the interrupt delivery&#160;unit (I/O APIC) which is part of the I/O subsystem. APIC&#160;<br/>virtualization involves&#160;protecting the&#160;platform’s&#160;local&#160;and&#160;I/O APICs&#160;and&#160;emulating them for&#160;the guest.&#160;</p>
<p style="position:absolute;top:421px;left:69px;white-space:nowrap" class="ft03">33.3.2.3 &#160;&#160;Local APIC&#160;Virtualization</p>
<p style="position:absolute;top:450px;left:69px;white-space:nowrap" class="ft05">The&#160;local APIC is&#160;responsible&#160;for the&#160;local interrupt sources, interrupt&#160;acceptance,&#160;dispensing&#160;interrupts&#160;to the&#160;<br/>logical processor,&#160;and generating&#160;inter-processor interrupts.&#160;Software&#160;interacts with the local APIC by reading and&#160;<br/>writing its memory-mapped registers residing within&#160;a 4-KByte uncached memory region&#160;with base address stored&#160;<br/>in&#160;the IA32_APIC_BASE&#160;MSR.&#160;Since the&#160;local APIC registers are&#160;memory-mapped, the&#160;VMM can&#160;utilize memory&#160;<br/>virtualization techniques (such&#160;as page-table virtualization)&#160;to trap guest accesses to&#160;the page&#160;frame hosting&#160;the&#160;<br/>virtual&#160;local APIC registers.&#160;<br/>Local&#160;APIC&#160;virtualization in the&#160;VMM&#160;needs&#160;to emulate&#160;the various local&#160;APIC&#160;operations&#160;and registers,&#160;such as:&#160;<br/>APIC identification/format registers, the&#160;local vector table (LVT),&#160;the interrupt&#160;command&#160;register (ICR), interrupt&#160;<br/>capture registers&#160;(TMR, IRR and&#160;ISR), task&#160;and processor&#160;priority registers&#160;(TPR,&#160;PPR),&#160;the&#160;EOI&#160;register&#160;and&#160;the&#160;<br/>APIC-timer&#160;register.&#160;Since&#160;local APICs are&#160;designed&#160;to operate&#160;with&#160;non-specific EOI, local APIC emulation&#160;also&#160;<br/>needs&#160;to emulate broadcast of EOI to&#160;the guest’s virtual I/O&#160;APICs for&#160;level&#160;triggered&#160;virtual&#160;interrupts.&#160;<br/>A local APIC allows&#160;interrupt masking at two levels: (1) mask bit in the&#160;local vector&#160;table entry for local interrupts&#160;<br/>and (2) raising&#160;processor priority&#160;through the TPR registers for masking lower priority&#160;external interrupts.&#160;The VMM&#160;<br/>needs&#160;to comprehend&#160;these virtual local&#160;APIC mask settings&#160;as programmed by the guest in addition to the&#160;guest&#160;<br/>virtual processor interruptibility&#160;state (when injecting&#160;APIC&#160;routed&#160;external virtual interrupts to&#160;a guest&#160;VM).&#160;<br/>VMX provides several features which help&#160;the VMM&#160;to virtualize&#160;the local&#160;APIC.&#160;These&#160;features allow many&#160;of guest&#160;<br/>TPR&#160;accesses (using&#160;CR8&#160;only) to occur&#160;without VM&#160;exits to the&#160;VMM:</p>
<p style="position:absolute;top:758px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:759px;left:95px;white-space:nowrap" class="ft05">The VMCS contains a “virtual-APIC address”&#160;field. This 64-bit field is&#160;the physical&#160;address&#160;of the&#160;4-KByte&#160;virtual&#160;<br/>APIC page&#160;(4-KByte&#160;aligned).&#160;The&#160;virtual-APIC&#160;page&#160;contains a&#160;TPR shadow, which is&#160;accessed by the&#160;MOV CR8&#160;<br/>instruction. The TPR shadow comprises bits&#160;7:4 in byte&#160;80H of the virtual-APIC&#160;page.</p>
<p style="position:absolute;top:814px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:814px;left:95px;white-space:nowrap" class="ft05">The TPR&#160;threshold: bits 3:0 of this 32-bit field determine the&#160;threshold below&#160;which&#160;the TPR shadow cannot fall.&#160;<br/>A&#160;VM&#160;exit will occur&#160;after an execution&#160;of MOV CR8&#160;that reduces&#160;the&#160;TPR shadow&#160;below this value.</p>
<p style="position:absolute;top:853px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:853px;left:95px;white-space:nowrap" class="ft05">The&#160;processor-based&#160;VM-execution&#160;controls&#160;field contains&#160;a “use&#160;TPR shadow” bit&#160;and&#160;a “CR8-store exiting” bit.&#160;<br/>If the&#160;“use&#160;TPR&#160;shadow” VM-execution control is&#160;1 and the “CR8-store exiting”&#160;VM-execution&#160;control&#160;is 0, then&#160;<br/>a MOV from CR8 reads&#160;from&#160;the&#160;TPR shadow.&#160;If&#160;the&#160;“CR8-store exiting”&#160;VM-execution control is&#160;1, then MOV&#160;<br/>from&#160;CR8 causes&#160;a&#160;VM&#160;exit; the&#160;“use&#160;TPR shadow”&#160;VM-execution control is&#160;ignored&#160;in this&#160;case.</p>
<p style="position:absolute;top:925px;left:69px;white-space:nowrap" class="ft04">•</p>
<p style="position:absolute;top:925px;left:95px;white-space:nowrap" class="ft05">The&#160;processor-based VM-execution&#160;controls&#160;field&#160;contains&#160;a&#160;“CR8-load exiting” bit.&#160;If the&#160;“use&#160;TPR shadow”&#160;<br/>VM-execution control is set and the “CR8-load&#160;exiting” VM-execution&#160;control is clear,&#160;then MOV to&#160;CR8 writes to&#160;<br/>the “TPR shadow”.&#160;A VM exit&#160;will&#160;occur after&#160;this&#160;write&#160;if the value written&#160;is below&#160;the TPR threshold.&#160;If&#160;the&#160;<br/>“CR8-load&#160;exiting” VM-execution control&#160;is set, then&#160;MOV to&#160;CR8 causes&#160;a VM&#160;exit; the&#160;“use&#160;TPR shadow” VM-<br/>execution control is&#160;ignored in this&#160;case.</p>
</div>
</body>
</html>
