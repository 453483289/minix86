<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<title>Page 606</title>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<style type="text/css">
<!--
	p {margin: 0; padding: 0;}	.ft00{font-size:9px;font-family:Times;color:#000000;}
	.ft01{font-size:11px;font-family:Times;color:#0860a8;}
	.ft02{font-size:16px;font-family:Times;color:#0860a8;}
	.ft03{font-size:11px;font-family:Times;color:#000000;}
	.ft04{font-size:12px;font-family:Times;color:#0860a8;}
	.ft05{font-size:18px;font-family:Times;color:#0860a8;}
	.ft06{font-size:18px;font-family:Times;color:#000000;}
	.ft07{font-size:11px;font-family:Times;color:#000000;}
	.ft08{font-size:11px;line-height:16px;font-family:Times;color:#000000;}
	.ft09{font-size:11px;line-height:24px;font-family:Times;color:#000000;}
	.ft010{font-size:11px;line-height:22px;font-family:Times;color:#000000;}
-->
</style>
</head>
<body bgcolor="#A0A0A0" vlink="blue" link="blue">
<div id="page606-div" style="position:relative;width:918px;height:1188px;">
<img width="918" height="1188" src="o_fe12b1e2a880e0ce606.png" alt="background image"/>
<p style="position:absolute;top:1103px;left:68px;white-space:nowrap" class="ft00">17-32&#160;Vol. 3B</p>
<p style="position:absolute;top:47px;left:68px;white-space:nowrap" class="ft01">DEBUG,&#160;BRANCH&#160;PROFILE,&#160;TSC,&#160;AND RESOURCE&#160;MONITORING&#160;FEATURES</p>
<p style="position:absolute;top:98px;left:68px;white-space:nowrap" class="ft02">17.10.2&#160;&#160;Streamlined Freeze_LBRs_On_PMI Operation</p>
<p style="position:absolute;top:129px;left:68px;white-space:nowrap" class="ft09">The&#160;capability&#160;to freeze&#160;the&#160;content of LBR&#160;to maintain&#160;recorded data quality&#160;continues to&#160;use the&#160;same interface&#160;<br/>IA32_DEBUGCTL.Freeze_LBRs_ON_PMI.&#160;Architectural performance monitoring&#160;version 4 and&#160;above supports&#160;a&#160;<br/>streamlined Freeze_LBRs_ON_PMI operation for&#160;PMI service&#160;routine that&#160;replaces the&#160;legacy&#160;<br/>Freeze_LBRs_ON_PMI oper<a href="o_fe12b1e2a880e0ce-588.html">ation (see Section 17.4.7).<br/></a><a href="o_fe12b1e2a880e0ce-606.html">Table&#160;17-17 comp</a>ares&#160;the interaction of the&#160;processor&#160;with&#160;the PMI handler.</p>
<p style="position:absolute;top:236px;left:147px;white-space:nowrap" class="ft04">Table 17-17.&#160;&#160;Legacy and&#160;Streamlined&#160;Operation with&#160;Freeze_LBRs_On_PMI&#160;=&#160;1,&#160;Buffer Full</p>
<p style="position:absolute;top:239px;left:758px;white-space:nowrap" class="ft02">&#160;&#160;</p>
<p style="position:absolute;top:592px;left:68px;white-space:nowrap" class="ft02">17.10.3&#160;&#160;LBR Behavior and Deep C-State</p>
<p style="position:absolute;top:622px;left:68px;white-space:nowrap" class="ft08">When MWAIT is&#160;used&#160;to request&#160;a C-state&#160;that is&#160;numerically higher&#160;than C1,&#160;then LBR&#160;state may be&#160;initialized to&#160;<br/>zero depending on optimized “waiting”&#160;state that&#160;is selected by the&#160;processor&#160;The&#160;affected&#160;LBR states&#160;include&#160;the&#160;<br/>FROM, TO,&#160;INFO, LAST_BRANCH, LER&#160;and&#160;LBR_TOS&#160;registers.&#160;The&#160;LBR&#160;enable&#160;bit&#160;and&#160;LBR_FROZEN&#160;bit are&#160;not&#160;<br/>affected. The&#160;LBR-time&#160;of&#160;the first&#160;LBR record&#160;inserted&#160;after an exit&#160;from&#160;such&#160;a C-state&#160;request will be zero.&#160;</p>
<p style="position:absolute;top:727px;left:68px;white-space:nowrap" class="ft05">17.11&#160;&#160;LAST&#160;BRANCH,&#160;INTERRUPT,&#160;AND&#160;EXCEPTION&#160;RECORDING&#160;(PROCESSORS&#160;</p>
<p style="position:absolute;top:753px;left:146px;white-space:nowrap" class="ft05">BASED ON INTEL NETBURST® MICROARCHITECTURE)</p>
<p style="position:absolute;top:789px;left:68px;white-space:nowrap" class="ft08">Pentium 4 and Intel Xeon&#160;processors&#160;based on Intel NetBurst&#160;microarchitecture provide&#160;the&#160;following&#160;methods&#160;for&#160;<br/>recording taken&#160;branches, interrupts and&#160;exceptions:</p>
<p style="position:absolute;top:827px;left:68px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:828px;left:93px;white-space:nowrap" class="ft08">Store branch records in the&#160;last&#160;branch record&#160;(LBR) stack MSRs&#160;for&#160;the most recent taken branches,&#160;<br/>interrupts, and/or exceptions in&#160;MSRs.&#160;A&#160;branch record&#160;consist&#160;of&#160;a branch-from and a branch-to instruction&#160;<br/>address.&#160;</p>
<p style="position:absolute;top:883px;left:68px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:883px;left:93px;white-space:nowrap" class="ft03">Send&#160;the&#160;branch&#160;records&#160;out on the&#160;system bus&#160;as branch trace&#160;messages (BTMs).</p>
<p style="position:absolute;top:905px;left:68px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:906px;left:93px;white-space:nowrap" class="ft03">Log BTMs&#160;in a&#160;memory-resident branch&#160;trace&#160;store&#160;(BTS) buffer.</p>
<p style="position:absolute;top:930px;left:68px;white-space:nowrap" class="ft03">To&#160;support these functions,&#160;the&#160;processor provides&#160;the&#160;following MSRs&#160;and related&#160;facilities:</p>
<p style="position:absolute;top:952px;left:68px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:952px;left:93px;white-space:nowrap" class="ft08"><b>MSR_DEBUGCTLA MSR</b>&#160;— Enables last branch, interrupt, and exception&#160;recording; single-stepping on taken&#160;<br/>branches; branch trace&#160;messages (BTMs);&#160;and branch&#160;trace&#160;store&#160;(BTS).&#160;This register&#160;is named&#160;DebugCtlMSR&#160;<br/>in&#160;the&#160;P6&#160;family&#160;processors.</p>
<p style="position:absolute;top:1007px;left:68px;white-space:nowrap" class="ft06">•</p>
<p style="position:absolute;top:1008px;left:93px;white-space:nowrap" class="ft08"><b>Debug store (DS) feature flag (CPUID.1:EDX.DS[bit 21])</b>&#160;—&#160;Indicates&#160;that&#160;the processor provides the&#160;<br/>debug&#160;store (DS)&#160;mechanism, which allows BTMs&#160;to&#160;be&#160;stored&#160;in&#160;a&#160;memory-resident&#160;BTS&#160;buffer.</p>
<p style="position:absolute;top:276px;left:70px;white-space:nowrap" class="ft03">Legacy Freeze_LBRs_On_PMI</p>
<p style="position:absolute;top:276px;left:373px;white-space:nowrap" class="ft03">Streamlined Freeze_LBRs_On_PMI</p>
<p style="position:absolute;top:276px;left:677px;white-space:nowrap" class="ft03">Comment</p>
<p style="position:absolute;top:298px;left:70px;white-space:nowrap" class="ft010">Processor freezes the LBR stack on&#160;PEBS&#160;buffer&#160;full&#160;Processor&#160;freezes the&#160;LBR&#160;stack on&#160;PEBS&#160;buffer&#160;full&#160;Unchanged<br/>Processor clears IA32_DEBUGCTRL.LBR&#160;(0x1D9)</p>
<p style="position:absolute;top:321px;left:374px;white-space:nowrap" class="ft03">Processor set&#160;</p>
<p style="position:absolute;top:337px;left:373px;white-space:nowrap" class="ft03">IA32_PERF_GLOBAL_STATUS.LBR_Frz</p>
<p style="position:absolute;top:360px;left:70px;white-space:nowrap" class="ft03">dbgmask&#160;= RDMSR(0x1D9)</p>
<p style="position:absolute;top:360px;left:373px;white-space:nowrap" class="ft03">mask&#160;= RDMSR(0x38E)</p>
<p style="position:absolute;top:382px;left:70px;white-space:nowrap" class="ft03">Handler services the PMI</p>
<p style="position:absolute;top:382px;left:373px;white-space:nowrap" class="ft03">Handler&#160;services&#160;the&#160;PMI</p>
<p style="position:absolute;top:382px;left:678px;white-space:nowrap" class="ft03">Unchanged</p>
<p style="position:absolute;top:405px;left:70px;white-space:nowrap" class="ft03">Updates&#160;dbgmask&#160;to&#160;include&#160;LBR for subsequent&#160;</p>
<p style="position:absolute;top:421px;left:70px;white-space:nowrap" class="ft03">write&#160;to&#160;IA32_DEBUGCTL</p>
<p style="position:absolute;top:405px;left:373px;white-space:nowrap" class="ft03">Handler&#160;writes&#160;mask&#160;into&#160;</p>
<p style="position:absolute;top:421px;left:373px;white-space:nowrap" class="ft03">IA32_PERF_GLOBAL_OVF_RESET&#160;(0x390)&#160;</p>
<p style="position:absolute;top:444px;left:70px;white-space:nowrap" class="ft03">NA</p>
<p style="position:absolute;top:444px;left:373px;white-space:nowrap" class="ft03">Processor clears IA32_PERF_GLOBAL_STATUS</p>
<p style="position:absolute;top:466px;left:70px;white-space:nowrap" class="ft03">Handler&#160;writes&#160;dbgmask&#160;to re-enables&#160;</p>
<p style="position:absolute;top:483px;left:70px;white-space:nowrap" class="ft03">IA32_DEBUGCTL.LBR</p>
<p style="position:absolute;top:466px;left:373px;white-space:nowrap" class="ft03">NA</p>
<p style="position:absolute;top:466px;left:677px;white-space:nowrap" class="ft03">Prevents race condition of&#160;</p>
<p style="position:absolute;top:483px;left:677px;white-space:nowrap" class="ft03">MSR 0x1D9 being updated&#160;</p>
<p style="position:absolute;top:499px;left:677px;white-space:nowrap" class="ft03">by&#160;the processor&#160;and&#160;</p>
<p style="position:absolute;top:516px;left:677px;white-space:nowrap" class="ft03">handler</p>
</div>
</body>
</html>
